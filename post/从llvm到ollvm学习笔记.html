<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>从LLVM到OLLVM学习笔记 | Whitebird&#39;s Home</title>
  <meta name="keywords" content=" OLLVM ">
  <meta name="description" content="从LLVM到OLLVM学习笔记 | Whitebird&#39;s Home">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta property="og:type" content="website">
<meta property="og:title" content="about">
<meta property="og:url" content="https://whitebird0.github.io/about/index.html">
<meta property="og:site_name" content="Whitebird&#39;s Home">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2022-07-09T11:26:44.000Z">
<meta property="article:modified_time" content="2022-07-09T11:26:44.827Z">
<meta property="article:author" content="Whitebird">
<meta name="twitter:card" content="summary">


<link rel="icon" href="/img/avatar.jpg">

<link href="/css/style.css?v=1.1.0" rel="stylesheet">

<link href="/css/hl_theme/github.css?v=1.1.0" rel="stylesheet">

<link href="//cdn.jsdelivr.net/npm/animate.css@4.1.0/animate.min.css" rel="stylesheet">

<script src="//cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js"></script>
<script src="/js/titleTip.js?v=1.1.0" ></script>

<script src="//cdn.jsdelivr.net/npm/highlightjs@9.16.2/highlight.pack.min.js"></script>
<script>
    hljs.initHighlightingOnLoad();
</script>

<script src="//cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.js"></script>



<script src="//cdn.jsdelivr.net/npm/jquery.cookie@1.4.1/jquery.cookie.min.js" ></script>

<script src="/js/iconfont.js?v=1.1.0" ></script>

<meta name="generator" content="Hexo 5.4.2"></head>
<div style="display: none">
  <input class="theme_disqus_on" value="false">
  <input class="theme_preload_comment" value="">
  <input class="theme_blog_path" value="">
  <input id="theme_shortcut" value="true" />
  <input id="theme_highlight_on" value="true" />
  <input id="theme_code_copy" value="true" />
</div>



<body>
<aside class="nav">
    <div class="nav-left">
        <a href="/"
   class="avatar_target">
    <img class="avatar"
         src="/img/avatar.jpg"/>
</a>
<div class="author">
    <span>Whitebird</span>
</div>

<div class="icon">
    
        
            <a title="github"
               href="https://github.com/Whitebird0"
               target="_blank">
                
                    <svg class="iconfont-svg" aria-hidden="true">
                        <use xlink:href="#icon-github"></use>
                    </svg>
                
            </a>
        
    
        
            <a title="csdn"
               href="https://blog.csdn.net/jxnu_666?type=blog"
               target="_blank">
                
                    <svg class="iconfont-svg" aria-hidden="true">
                        <use xlink:href="#icon-csdn"></use>
                    </svg>
                
            </a>
        
    
        
            <a title="email"
               href="mailto:767778848@qq.com"
               target="_blank">
                
                    <svg class="iconfont-svg" aria-hidden="true">
                        <use xlink:href="#icon-email"></use>
                    </svg>
                
            </a>
        
    
        
            <a title="qq"
               href="http://wpa.qq.com/msgrd?v=3&uin=767778848&site=qq&menu=yes"
               target="_blank">
                
                    <svg class="iconfont-svg" aria-hidden="true">
                        <use xlink:href="#icon-qq"></use>
                    </svg>
                
            </a>
        
    
</div>




<ul>
    <li>
        <div class="all active" data-rel="全部文章">全部文章
            
                <small>(33)</small>
            
        </div>
    </li>
    
        
            
                <li>
                    <div data-rel="CTF">
                        
                        CTF
                        <small>(6)</small>
                        
                    </div>
                    
                </li>
            
        
    
        
            
                <li>
                    <div data-rel="Reverse">
                        
                        Reverse
                        <small>(8)</small>
                        
                    </div>
                    
                </li>
            
        
    
        
            
                <li>
                    <div data-rel="Android开发">
                        
                        Android开发
                        <small>(10)</small>
                        
                    </div>
                    
                </li>
            
        
    
        
            
                <li>
                    <div data-rel="Android逆向">
                        
                        Android逆向
                        <small>(6)</small>
                        
                    </div>
                    
                </li>
            
        
    
        
            
                <li>
                    <div data-rel="WEB安全">
                        
                        WEB安全
                        <small>(2)</small>
                        
                    </div>
                    
                </li>
            
        
    
        
            
                <li>
                    <div data-rel="Windows内核">
                        
                        Windows内核
                        <small>(1)</small>
                        
                    </div>
                    
                </li>
            
        
    
</ul>
<div class="left-bottom">
    <div class="menus">
        
            
            
    </div>
    <div>
        
            <a class="about  hasFriend  site_url"
               
               href="/about">关于</a>
        
        <a style="width: 50%"
                
                                           class="friends">友链</a>
        
    </div>
</div>
<input type="hidden" id="yelog_site_posts_number" value="33">
<input type="hidden" id="yelog_site_word_count" value="210.6k">
<div style="display: none">
    <span id="busuanzi_value_site_uv"></span>
    <span id="busuanzi_value_site_pv"></span>
</div>

    </div>
    <div class="nav-right">
        <div class="friends-area">
    <div class="friends-title">
        友情链接
        <i class="iconfont icon-left"></i>
    </div>
    <div class="friends-content">
        <ul>
            
            <li><a target="_blank" href="https://www.codetea.top/">Codetea</a></li>
            
        </ul>
    </div>
</div>
        <div class="title-list">
    <div class="right-top">
        <div id="default-panel">
            <i class="iconfont icon-search" data-title="搜索 快捷键 i"></i>
            <div class="right-title">全部文章</div>
            <i class="iconfont icon-file-tree" data-title="切换到大纲视图 快捷键 w"></i>
        </div>
        <div id="search-panel">
            <i class="iconfont icon-left" data-title="返回"></i>
            <input id="local-search-input" autocomplete="off"/>
            <label class="border-line" for="input"></label>
            <i class="iconfont icon-case-sensitive" data-title="大小写敏感"></i>
            <i class="iconfont icon-tag" data-title="标签"></i>
        </div>
        <div id="outline-panel" style="display: none">
            <div class="right-title">大纲</div>
            <i class="iconfont icon-list" data-title="切换到文章列表"></i>
        </div>
    </div>

    <div class="tags-list">
    <input id="tag-search" />
    <div class="tag-wrapper">
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>Android</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>CTF</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>OLLVM</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>Reverse</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>WEB</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>Windows内核</a>
            </li>
        
    </div>

</div>

    
    <div id="local-search-result">

    </div>
    
    <nav id="title-list-nav">
        
        
        <a  class="全部文章 Android逆向 "
           href="/post/%E4%BB%8Ellvm%E5%88%B0ollvm%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0.html"
           data-tag="OLLVM"
           data-author="" >
            <span class="post-title" title="从LLVM到OLLVM学习笔记">从LLVM到OLLVM学习笔记</span>
            <span class="post-date" title="2024-01-30 22:40:21">2024/01/30</span>
        </a>
        
        
        <a  class="全部文章 Android逆向 "
           href="/post/%E6%8A%93%E5%8C%85%E6%A3%80%E6%B5%8B%E4%B8%8Ehook%E6%8A%93%E5%8C%85.html"
           data-tag="Android"
           data-author="" >
            <span class="post-title" title="Android逆向中抓包检测与hook抓包">Android逆向中抓包检测与hook抓包</span>
            <span class="post-date" title="2023-12-27 11:40:21">2023/12/27</span>
        </a>
        
        
        <a  class="全部文章 WEB安全 "
           href="/post/web%E5%AE%89%E5%85%A8%E5%AD%A6%E4%B9%A0-%E4%BF%A1%E6%81%AF%E6%89%93%E7%82%B9.html"
           data-tag="WEB"
           data-author="" >
            <span class="post-title" title="WEB安全-信息打点">WEB安全-信息打点</span>
            <span class="post-date" title="2023-12-25 12:40:21">2023/12/25</span>
        </a>
        
        
        <a  class="全部文章 WEB安全 "
           href="/post/web%E5%AE%89%E5%85%A8%E5%AD%A6%E4%B9%A0-%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8.html"
           data-tag="WEB"
           data-author="" >
            <span class="post-title" title="WEB安全-基础入门">WEB安全-基础入门</span>
            <span class="post-date" title="2023-12-20 11:40:21">2023/12/20</span>
        </a>
        
        
        <a  class="全部文章 Android逆向 "
           href="/post/Android%E9%80%86%E5%90%91%E4%B8%AD%E5%B8%B8%E8%A7%81%E5%AF%86%E7%A0%81%E5%AD%A6%E5%85%A5%E9%97%A8.html"
           data-tag="Android"
           data-author="" >
            <span class="post-title" title="Android逆向中常见密码学算法入门">Android逆向中常见密码学算法入门</span>
            <span class="post-date" title="2023-11-30 20:40:21">2023/11/30</span>
        </a>
        
        
        <a  class="全部文章 Android逆向 "
           href="/post/Android%E7%B3%BB%E7%BB%9F%E6%B2%99%E7%9B%92%E5%AE%9A%E5%88%B6%E4%B8%93%E9%A2%98.html"
           data-tag="Android"
           data-author="" >
            <span class="post-title" title="Android系统沙盒定制">Android系统沙盒定制</span>
            <span class="post-date" title="2023-09-15 12:40:21">2023/09/15</span>
        </a>
        
        
        <a  class="全部文章 Android逆向 "
           href="/post/unidbg%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0.html"
           data-tag="Android"
           data-author="" >
            <span class="post-title" title="Android逆向学习笔记——Unidbg学习与实战">Android逆向学习笔记——Unidbg学习与实战</span>
            <span class="post-date" title="2023-07-01 09:00:15">2023/07/01</span>
        </a>
        
        
        <a  class="全部文章 Android逆向 "
           href="/post/Frida%E7%9A%84Python%E5%BA%93%E4%BD%BF%E7%94%A8.html"
           data-tag="Android"
           data-author="" >
            <span class="post-title" title="Android逆向学习笔记——使用Python库调用Frida">Android逆向学习笔记——使用Python库调用Frida</span>
            <span class="post-date" title="2023-06-01 09:00:15">2023/06/01</span>
        </a>
        
        
        <a  class="全部文章 Android开发 "
           href="/post/NDK%E5%BC%80%E5%8F%91%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0.html"
           data-tag="Android"
           data-author="" >
            <span class="post-title" title="Android开发学习笔记——NDK开发">Android开发学习笔记——NDK开发</span>
            <span class="post-date" title="2023-03-31 09:00:14">2023/03/31</span>
        </a>
        
        
        <a  class="全部文章 Android开发 "
           href="/post/the_first_code1.html"
           data-tag="Android"
           data-author="" >
            <span class="post-title" title="Android开发学习笔记(1)——初识安卓">Android开发学习笔记(1)——初识安卓</span>
            <span class="post-date" title="2023-03-30 09:00:21">2023/03/30</span>
        </a>
        
        
        <a  class="全部文章 Android开发 "
           href="/post/the_first_code2.html"
           data-tag="Android"
           data-author="" >
            <span class="post-title" title="Android开发学习笔记(2)——探究活动">Android开发学习笔记(2)——探究活动</span>
            <span class="post-date" title="2023-03-30 09:00:20">2023/03/30</span>
        </a>
        
        
        <a  class="全部文章 Android开发 "
           href="/post/the_first_code3.html"
           data-tag="Android"
           data-author="" >
            <span class="post-title" title="Android开发学习笔记(3)——UI开发">Android开发学习笔记(3)——UI开发</span>
            <span class="post-date" title="2023-03-30 09:00:19">2023/03/30</span>
        </a>
        
        
        <a  class="全部文章 Android开发 "
           href="/post/the_first_code4.html"
           data-tag="Android"
           data-author="" >
            <span class="post-title" title="Android开发学习笔记(4)——探究碎片">Android开发学习笔记(4)——探究碎片</span>
            <span class="post-date" title="2023-03-30 09:00:18">2023/03/30</span>
        </a>
        
        
        <a  class="全部文章 Android开发 "
           href="/post/the_first_code5.html"
           data-tag="Android"
           data-author="" >
            <span class="post-title" title="Android开发学习笔记(5)——详解广播机制">Android开发学习笔记(5)——详解广播机制</span>
            <span class="post-date" title="2023-03-30 09:00:17">2023/03/30</span>
        </a>
        
        
        <a  class="全部文章 Android开发 "
           href="/post/the_first_code6.html"
           data-tag="Android"
           data-author="" >
            <span class="post-title" title="Android开发学习笔记(6)——数据存储全方案">Android开发学习笔记(6)——数据存储全方案</span>
            <span class="post-date" title="2023-03-30 09:00:16">2023/03/30</span>
        </a>
        
        
        <a  class="全部文章 Android开发 "
           href="/post/the_first_code7.html"
           data-tag="Android"
           data-author="" >
            <span class="post-title" title="Android开发学习笔记(7)——跨程序共享数据">Android开发学习笔记(7)——跨程序共享数据</span>
            <span class="post-date" title="2023-03-30 09:00:15">2023/03/30</span>
        </a>
        
        
        <a  class="全部文章 Android开发 "
           href="/post/the_first_code8.html"
           data-tag="Android"
           data-author="" >
            <span class="post-title" title="Android开发学习笔记(8)——运用手机多媒体">Android开发学习笔记(8)——运用手机多媒体</span>
            <span class="post-date" title="2023-03-30 09:00:14">2023/03/30</span>
        </a>
        
        
        <a  class="全部文章 Android开发 "
           href="/post/the_first_code9.html"
           data-tag="Android"
           data-author="" >
            <span class="post-title" title="Android开发学习笔记(9)——网络技术">Android开发学习笔记(9)——网络技术</span>
            <span class="post-date" title="2023-03-30 09:00:13">2023/03/30</span>
        </a>
        
        
        <a  class="全部文章 CTF "
           href="/post/2022%E5%B9%B4%E6%B1%9F%E8%A5%BF%E7%9C%81%E2%80%9C%E8%B5%A3%E8%82%B2%E6%9D%AF%E2%80%9D%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%A4%A7%E8%B5%9B.html"
           data-tag="CTF"
           data-author="" >
            <span class="post-title" title="2022年江西省“赣育杯”网络安全大赛初赛 Re WriteUp">2022年江西省“赣育杯”网络安全大赛初赛 Re WriteUp</span>
            <span class="post-date" title="2022-10-08 22:40:21">2022/10/08</span>
        </a>
        
        
        <a  class="全部文章 CTF "
           href="/post/qwb.html"
           data-tag="CTF"
           data-author="" >
            <span class="post-title" title="第六届强网杯全国网络安全挑战赛 Re WriteUp">第六届强网杯全国网络安全挑战赛 Re WriteUp</span>
            <span class="post-date" title="2022-08-08 15:49:21">2022/08/08</span>
        </a>
        
        
        <a  class="全部文章 CTF "
           href="/post/bluecup.html"
           data-tag="CTF"
           data-author="" >
            <span class="post-title" title="第六届蓝帽杯初赛CTF题目 Re WriteUp">第六届蓝帽杯初赛CTF题目 Re WriteUp</span>
            <span class="post-date" title="2022-07-13 22:49:21">2022/07/13</span>
        </a>
        
        
        <a  class="全部文章 CTF "
           href="/post/CISCN2022.html"
           data-tag="CTF"
           data-author="" >
            <span class="post-title" title="第十五届全国大学生信息安全竞赛创新实践能力赛CISCN">第十五届全国大学生信息安全竞赛创新实践能力赛CISCN</span>
            <span class="post-date" title="2022-06-03 20:49:21">2022/06/03</span>
        </a>
        
        
        <a  class="全部文章 CTF "
           href="/post/2022DASCTF%20Apr%20X%20FATE%20%E9%98%B2%E7%96%AB%E6%8C%91%E6%88%98%E8%B5%9B.html"
           data-tag="CTF"
           data-author="" >
            <span class="post-title" title="2022DASCTF Apr X FATE 防疫挑战赛">2022DASCTF Apr X FATE 防疫挑战赛</span>
            <span class="post-date" title="2022-06-01 20:49:21">2022/06/01</span>
        </a>
        
        
        <a  class="全部文章 Reverse "
           href="/post/PE%E6%98%A0%E5%83%8F%E5%88%87%E6%8D%A2.html"
           data-tag="Reverse"
           data-author="" >
            <span class="post-title" title="逆向工程核心原理——PE映像切换">逆向工程核心原理——PE映像切换</span>
            <span class="post-date" title="2022-04-02 10:49:21">2022/04/02</span>
        </a>
        
        
        <a  class="全部文章 Reverse "
           href="/post/%E5%8F%8D%E8%B0%83%E8%AF%95%E6%8A%80%E6%9C%AF.html"
           data-tag="Reverse"
           data-author="" >
            <span class="post-title" title="逆向工程核心原理——反调试技术">逆向工程核心原理——反调试技术</span>
            <span class="post-date" title="2022-03-28 10:30:21">2022/03/28</span>
        </a>
        
        
        <a  class="全部文章 CTF "
           href="/post/2022-3-26-2022DASCTF-X-SU-Re-WriteUp.html"
           data-tag="CTF"
           data-author="" >
            <span class="post-title" title="2022DASCTF X SU Re WriteUp">2022DASCTF X SU Re WriteUp</span>
            <span class="post-date" title="2022-03-26 20:49:21">2022/03/26</span>
        </a>
        
        
        <a  class="全部文章 Reverse "
           href="/post/SEH.html"
           data-tag="Reverse"
           data-author="" >
            <span class="post-title" title="逆向工程核心原理——SEH原理分析">逆向工程核心原理——SEH原理分析</span>
            <span class="post-date" title="2022-03-19 10:49:21">2022/03/19</span>
        </a>
        
        
        <a  class="全部文章 Reverse "
           href="/post/TLS%E5%9B%9E%E8%B0%83%E5%87%BD%E6%95%B0.html"
           data-tag="Reverse"
           data-author="" >
            <span class="post-title" title="逆向工程核心原理——TLS回调函数">逆向工程核心原理——TLS回调函数</span>
            <span class="post-date" title="2022-03-15 22:49:21">2022/03/15</span>
        </a>
        
        
        <a  class="全部文章 Reverse "
           href="/post/%E5%85%A8%E5%B1%80API%E9%92%A9%E5%8F%96-IE%E9%93%BE%E6%8E%A5%E6%8E%A7%E5%88%B6.html"
           data-tag="Reverse"
           data-author="" >
            <span class="post-title" title="逆向工程核心原理——全局API钩取">逆向工程核心原理——全局API钩取</span>
            <span class="post-date" title="2022-03-11 16:49:21">2022/03/11</span>
        </a>
        
        
        <a  class="全部文章 Reverse "
           href="/post/%E8%AE%A1%E7%AE%97%E5%99%A8%E6%98%BE%E7%A4%BA%E4%B8%AD%E6%96%87%E6%95%B0%E5%AD%97.html"
           data-tag="Reverse"
           data-author="" >
            <span class="post-title" title="逆向工程核心原理——IAT_HOOK">逆向工程核心原理——IAT_HOOK</span>
            <span class="post-date" title="2022-03-08 22:49:21">2022/03/08</span>
        </a>
        
        
        <a  class="全部文章 Reverse "
           href="/post/%E9%80%9A%E8%BF%87%E4%BF%AE%E6%94%B9PE%E5%8A%A0%E8%BD%BDDLL.html"
           data-tag="Reverse"
           data-author="" >
            <span class="post-title" title="逆向工程核心原理——通过修改PE加载DLL">逆向工程核心原理——通过修改PE加载DLL</span>
            <span class="post-date" title="2022-02-28 22:49:21">2022/02/28</span>
        </a>
        
        
        <a  class="全部文章 Reverse "
           href="/post/DLL%E6%B3%A8%E5%85%A5.html"
           data-tag="Reverse"
           data-author="" >
            <span class="post-title" title="逆向工程核心原理——DLL注入">逆向工程核心原理——DLL注入</span>
            <span class="post-date" title="2022-02-26 00:49:21">2022/02/26</span>
        </a>
        
        
        <a  class="全部文章 Windows内核 "
           href="/post/%E6%AE%B5%E4%B8%8E%E9%A1%B5%E7%9A%84%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5.html"
           data-tag="Windows内核"
           data-author="" >
            <span class="post-title" title="Windows内核基础知识-段选择子与段描述符">Windows内核基础知识-段选择子与段描述符</span>
            <span class="post-date" title="2021-10-03 12:40:21">2021/10/03</span>
        </a>
        
        <div id="no-item-tips">

        </div>
    </nav>
    <div id="outline-list">
    </div>
</div>

    </div>
    <div class="hide-list">
        <div class="semicircle" data-title="切换全屏 快捷键 s">
            <div class="brackets first"><</div>
            <div class="brackets">&gt;</div>
        </div>
    </div>
</aside>
<div id="post">
    <div class="pjax">
        <article id="post-从llvm到ollvm学习笔记" class="article article-type-post" itemscope itemprop="blogPost">
    
        <h1 class="article-title">从LLVM到OLLVM学习笔记</h1>
    
    <div class="article-meta">
        
        
        
        <span class="book">
            <i class="iconfont icon-category"></i>
            
            
            <a  data-rel="Android逆向">Android逆向</a>
            
        </span>
        
        
        <span class="tag">
            <i class="iconfont icon-tag"></i>
            
            <a class="color1">OLLVM</a>
            
        </span>
        
    </div>
    <div class="article-meta">
        
            发布时间 : <time class="date" title='最后更新: 2024-01-30 23:50:08'>2024-01-30 22:40</time>
        
    </div>
    <div class="article-meta">
        
        <span>字数:18.5k</span>
        
        
        <span id="busuanzi_container_page_pv">
            阅读 :<span id="busuanzi_value_page_pv">
                <span class="count-comment">
                    <span class="spinner">
                      <div class="cube1"></div>
                      <div class="cube2"></div>
                    </span>
                </span>
            </span>
        </span>
        
        
        <span class="top-comment" title="跳转至评论区">
            <a href="#comments">
                评论:<span class="count-comment">
                    <span class="spinner">
                      <div class="cube1"></div>
                      <div class="cube2"></div>
                    </span>
                </span>
            </a>
        </span>
        
    </div>
    
    <div class="toc-ref">
    
        <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#1%E3%80%81%E4%BB%80%E4%B9%88%E6%98%AFLLVM"><span class="toc-text">1、什么是LLVM</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2%E3%80%81%E6%9E%B6%E6%9E%84%E5%8C%BA%E5%88%AB"><span class="toc-text">2、架构区别</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BC%A0%E7%BB%9F%E7%9A%84%E7%BC%96%E8%AF%91%E5%99%A8%E6%9E%B6%E6%9E%84"><span class="toc-text">传统的编译器架构</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#LLVM%E6%9E%B6%E6%9E%84"><span class="toc-text">LLVM架构</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#3%E3%80%81%E4%BB%80%E4%B9%88%E6%98%AFClang"><span class="toc-text">3、什么是Clang</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%9B%B8%E6%AF%94%E4%BA%8EGCC%EF%BC%8CClang%E7%9A%84%E4%BC%98%E7%82%B9"><span class="toc-text">相比于GCC，Clang的优点</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Clang%E4%B8%8ELLVM%E5%85%B3%E7%B3%BB"><span class="toc-text">Clang与LLVM关系</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#4%E3%80%81%E4%BB%A3%E7%A0%81%E6%B7%B7%E6%B7%86"><span class="toc-text">4、代码混淆</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AD%A6%E4%B9%A0%E6%B7%B7%E6%B7%86%E7%9A%84%E6%84%8F%E4%B9%89"><span class="toc-text">学习混淆的意义</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#OLLVM%E6%98%AF%E4%BB%80%E4%B9%88"><span class="toc-text">OLLVM是什么</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#5%E3%80%81LLVM%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA"><span class="toc-text">5、LLVM环境搭建</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E4%B8%80%E6%AD%A5%EF%BC%9A%E4%B8%8B%E8%BD%BD-LLVM-Core-%E5%92%8C-Clang%E6%BA%90%E4%BB%A3%E7%A0%81"><span class="toc-text">第一步：下载 LLVM-Core 和 Clang源代码</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E4%BA%8C%E6%AD%A5%EF%BC%9A%E5%AE%89%E8%A3%85%E7%BC%96%E8%AF%91%E7%8E%AF%E5%A2%83"><span class="toc-text">第二步：安装编译环境</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E4%B8%89%E6%AD%A5%EF%BC%9A%E7%BC%96%E8%AF%91"><span class="toc-text">第三步：编译</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E5%9B%9B%E6%AD%A5%EF%BC%9A%E5%B0%86llvm%E6%BA%90%E7%A0%81%E5%AF%BC%E5%85%A5CLION%E8%BF%9B%E8%A1%8C%E7%BC%96%E8%AF%91"><span class="toc-text">第四步：将llvm源码导入CLION进行编译</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#6%E3%80%81%E5%88%A9%E7%94%A8clang%E8%BF%9B%E8%A1%8C%E7%BC%96%E8%AF%91c%E8%AF%AD%E8%A8%80%E6%BA%90%E7%A0%81"><span class="toc-text">6、利用clang进行编译c语言源码</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#7%E3%80%81%E7%94%A8CLION%E8%B0%83%E8%AF%95clang"><span class="toc-text">7、用CLION调试clang</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#8%E3%80%81llvm%E7%9B%B8%E5%85%B3%E5%B7%A5%E5%85%B7%E4%BD%BF%E7%94%A8"><span class="toc-text">8、llvm相关工具使用</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B0%86C%E8%AF%AD%E8%A8%80%E4%BB%A3%E7%A0%81%E8%BD%AC%E6%8D%A2%E6%88%90LLVM-IR"><span class="toc-text">将C语言代码转换成LLVM IR</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B0%86LLVM-IR%E8%BD%AC%E6%8D%A2%E6%88%90bitcode"><span class="toc-text">将LLVM IR转换成bitcode</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B0%86LLVM-bitcode%E8%BD%AC%E6%8D%A2%E6%88%90%E6%B1%87%E7%BC%96"><span class="toc-text">将LLVM bitcode转换成汇编</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B0%86%E6%B1%87%E7%BC%96%E8%BD%AC%E6%8D%A2%E6%88%90%E5%8F%AF%E6%89%A7%E8%A1%8C%E7%A8%8B%E5%BA%8F"><span class="toc-text">将汇编转换成可执行程序</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B0%86LLVM-bitcode%E8%BD%AC%E6%8D%A2%E6%88%90LLVM-IR"><span class="toc-text">将LLVM bitcode转换成LLVM IR</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#opt%E4%BD%BF%E7%94%A8pass"><span class="toc-text">opt使用pass</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#9%E3%80%81%E5%85%B3%E4%BA%8Epass%E7%9A%84%E7%9B%B8%E5%85%B3%E7%9F%A5%E8%AF%86"><span class="toc-text">9、关于pass的相关知识</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#FunctionPass"><span class="toc-text">FunctionPass</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#10%E3%80%81%E7%94%A8CLION%E8%B0%83%E8%AF%95opt%E5%92%8Cpass"><span class="toc-text">10、用CLION调试opt和pass</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#11%E3%80%81%E5%86%99%E4%B8%80%E4%B8%AAPASS-%E5%87%BD%E6%95%B0%E5%90%8D%E5%8A%A0%E5%AF%86"><span class="toc-text">11、写一个PASS-函数名加密</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#12%E3%80%81%E5%9C%A8LLVM%E6%BA%90%E7%A0%81%E5%A4%96%E5%BC%80%E5%8F%91PASS"><span class="toc-text">12、在LLVM源码外开发PASS</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#13%E3%80%81%E9%80%9A%E8%BF%87clang%E5%8A%A0%E8%BD%BDpass"><span class="toc-text">13、通过clang加载pass</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#14%E3%80%81%E8%84%B1%E7%A6%BB%E6%BA%90%E7%A0%81%E8%B0%83%E8%AF%95opt%E5%92%8Cpass"><span class="toc-text">14、脱离源码调试opt和pass</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#15%E3%80%81%E5%B0%86OLLVM%E7%A7%BB%E6%A4%8D%E5%88%B0LLVM14"><span class="toc-text">15、将OLLVM移植到LLVM14</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#16%E3%80%81OLLVM%E4%BD%BF%E7%94%A8"><span class="toc-text">16、OLLVM使用</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#sub"><span class="toc-text">-sub</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8F%8F%E8%BF%B0"><span class="toc-text">描述</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8A%A0%E6%B3%95"><span class="toc-text">加法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%87%8F%E6%B3%95"><span class="toc-text">减法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#AND%E8%BF%90%E7%AE%97%E6%B7%B7%E6%B7%86"><span class="toc-text">AND运算混淆</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#OR%E8%BF%90%E7%AE%97%E6%B7%B7%E6%B7%86"><span class="toc-text">OR运算混淆</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#XOR%E8%BF%90%E7%AE%97%E6%B7%B7%E6%B7%86"><span class="toc-text">XOR运算混淆</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8"><span class="toc-text">使用</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#mllvm-sub"><span class="toc-text">-mllvm -sub</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#mllvm-sub-loop"><span class="toc-text">-mllvm -sub_loop</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#bcf"><span class="toc-text">-bcf</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8F%8F%E8%BF%B0-1"><span class="toc-text">描述</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%87%BD%E6%95%B0%E8%B0%83%E7%94%A8%E5%9B%BE"><span class="toc-text">函数调用图</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-1"><span class="toc-text">使用</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#mllvm-bcf"><span class="toc-text">-mllvm -bcf</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#mllvm-bcf-loop"><span class="toc-text">-mllvm  -bcf_loop</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#mllvm-bcf-prob"><span class="toc-text">-mllvm -bcf_prob</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#fla"><span class="toc-text">-fla</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8F%8F%E8%BF%B0-2"><span class="toc-text">描述</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E4%BE%8B"><span class="toc-text">实例</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-2"><span class="toc-text">使用</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#mllvm-fla"><span class="toc-text">-mllvm -fla</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#mllvm-fla-mllvm-split"><span class="toc-text">-mllvm -fla -mllvm -split</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#mllvm-split-num-3"><span class="toc-text">-mllvm -split_num&#x3D;3</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Functions-annotations"><span class="toc-text">Functions annotations</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#17%E3%80%81%E8%84%B1%E7%A6%BB%E6%BA%90%E7%A0%81%E7%BC%96%E8%AF%91ollvm%E7%9A%84pass"><span class="toc-text">17、脱离源码编译ollvm的pass</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#18%E3%80%81%E8%B0%83%E8%AF%95ollvm%E6%BA%90%E7%A0%81"><span class="toc-text">18、调试ollvm源码</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#19%E3%80%81%E8%B0%83%E8%AF%95ollvm-fla%E6%BA%90%E7%A0%81"><span class="toc-text">19、调试ollvm-fla源码</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#20%E3%80%81%E8%B0%83%E8%AF%95ollvm-bcf%E6%BA%90%E7%A0%81"><span class="toc-text">20、调试ollvm-bcf源码</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#21%E3%80%81%E8%B0%83%E8%AF%95ollvm-sub%E6%BA%90%E7%A0%81"><span class="toc-text">21、调试ollvm-sub源码</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#22%E3%80%81%E8%B0%83%E8%AF%95ollvm-split%E6%BA%90%E7%A0%81"><span class="toc-text">22、调试ollvm-split源码</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#23%E3%80%81%E7%BC%96%E5%86%99%E5%AD%97%E7%AC%A6%E4%B8%B2%E5%8A%A0%E5%AF%86pass"><span class="toc-text">23、编写字符串加密pass</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#24%E3%80%81%E7%A7%BB%E6%A4%8DOLLVM%E5%88%B0NDK%E4%B8%AD"><span class="toc-text">24、移植OLLVM到NDK中</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#25%E3%80%81%E5%88%A9%E7%94%A8IDA-Trace%E5%88%86%E6%9E%90%E8%A2%ABOLLVM%E6%B7%B7%E6%B7%86%E7%9A%84%E7%AE%97%E6%B3%95"><span class="toc-text">25、利用IDA Trace分析被OLLVM混淆的算法</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#26%E3%80%81%E5%88%A9%E7%94%A8unicorn%E5%88%86%E6%9E%90OLLVM%E6%B7%B7%E6%B7%86%E7%9A%84%E7%AE%97%E6%B3%95"><span class="toc-text">26、利用unicorn分析OLLVM混淆的算法</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#27%E3%80%81%E6%80%BB%E7%BB%93"><span class="toc-text">27、总结</span></a></li></ol>
    
<style>
    .left-col .switch-btn,
    .left-col .switch-area {
        display: none;
    }
    .toc-level-3 i,
    .toc-level-3 ol {
        display: none !important;
    }
</style>
</div>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="1、什么是LLVM"><a href="#1、什么是LLVM" class="headerlink" title="1、什么是LLVM"></a>1、什么是LLVM</h1><p>LLVM最初是Low Level Virtual Machine的缩写，定位是一个比较底层的虚拟机。但是LLVM本身并不是一个完整的编译器，LLVM是一个编译器基础架构（infrastructure，把很多编译器需要的功能以可调用的模块形式实现出来并包装成库，供其他编译器实现者可以根据自己的需要选择使用或者扩展。主要聚焦于编译器后端功能，如代码生成、代码优化、JIT等。</p>
<p>可以参考官网的解释</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240112000253.png"></p>
<p>LLVM最初是在2000年由伊利诺伊大学香槟分校(UUIC)的学生Chris Lattner及其硕士顾问Vikram Adve创建的研究项目，并在2003年发布第一个正式版本，目的是提供一种基于SSA的现代编译策略，这种策略能够支持任何编程语言的静态和动态编译。</p>
<h1 id="2、架构区别"><a href="#2、架构区别" class="headerlink" title="2、架构区别"></a>2、架构区别</h1><h2 id="传统的编译器架构"><a href="#传统的编译器架构" class="headerlink" title="传统的编译器架构"></a>传统的编译器架构</h2><p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240112004332.png"></p>
<ul>
<li><strong>Frontend:前端</strong><br>词法分析、语法分析、语义分析、生成中间代码</li>
<li><strong>Optimizer:优化器</strong><br>中间代码优化</li>
<li><strong>Backend:后端</strong><br>生成机器码</li>
</ul>
<h2 id="LLVM架构"><a href="#LLVM架构" class="headerlink" title="LLVM架构"></a>LLVM架构</h2><p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240112004434.png"></p>
<ul>
<li><p>不同的前端后端使用统一的中间代码LLVM Intermediate Representation (LLVM IR)</p>
</li>
<li><p>如果需要支持一种新的编程语言，那么只需要实现一个新的前端</p>
</li>
<li><p>如果需要支持一种新的硬件设备，那么只需要实现一个新的后端</p>
</li>
<li><p>优化阶段是一个通用的阶段，它针对的是统一的LLVM IR，不论是支持新的编程语言，还是支持新的硬件设备，都不需要对优化阶段做修改</p>
</li>
<li><p>相比之下，GCC的前端和后端没分得太开，前端后端耦合在了一起。所以GCC为了支持一门新的语言，或者为了支持一个新的目标平台，就变得特别困难</p>
</li>
<li><p>LLVM现在被作为实现各种静态和运行时编译语言的通用基础结构(GCC家族、Java、.NET、Python、Ruby、Scheme、Haskell、D等)</p>
</li>
</ul>
<h1 id="3、什么是Clang"><a href="#3、什么是Clang" class="headerlink" title="3、什么是Clang"></a>3、什么是Clang</h1><p>LLVM项目的一个子项目，基于LLVM架构的C&#x2F;C++&#x2F;Objective-C编译器前端。</p>
<h2 id="相比于GCC，Clang的优点"><a href="#相比于GCC，Clang的优点" class="headerlink" title="相比于GCC，Clang的优点"></a>相比于GCC，Clang的优点</h2><ul>
<li>编译速度快:在某些平台上，Clang的编译速度显著的快过GCC(Debug模式下编译OC速度比GGC快3倍)</li>
<li>占用内存小:Clang生成的AST所占用的内存是GCC的五分之一左右</li>
<li>模块化设计:Clang采用基于库的模块化设计，易于 IDE 集成及其他用途的重用</li>
<li>诊断信息可读性强:在编译过程中，Clang创建并保留了大量详细的元数据 (metadata)，有利于调试和错误报告</li>
<li>设计清晰简单，容易理解，易于扩展增强</li>
</ul>
<h2 id="Clang与LLVM关系"><a href="#Clang与LLVM关系" class="headerlink" title="Clang与LLVM关系"></a>Clang与LLVM关系</h2><p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240112005023.png"></p>
<p>LLVM整体架构，前端用的是clang。</p>
<p>广义的LLVM是指整个LLVM架构，一般狭义的LLVM指的是LLVM后端（包含代码优化和目标代码生成）。</p>
<p>源代码（c&#x2F;c++）经过clang–&gt; 中间代码(经过一系列的优化，优化用的是Pass) –&gt; 机器码</p>
<p>这里的Pass是做优化，而对于ollvm来说就是在pass时对ir进行混淆</p>
<h1 id="4、代码混淆"><a href="#4、代码混淆" class="headerlink" title="4、代码混淆"></a>4、代码混淆</h1><p>定义：代码混淆是将计算机程序的代码，转换成一种功能上等价，但是难以阅读和理解的形式的行为。</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240112131111.png"></p>
<p>代码执行由顺序图转为分发器控制，使难以分清原来程序的逻辑。</p>
<h2 id="学习混淆的意义"><a href="#学习混淆的意义" class="headerlink" title="学习混淆的意义"></a>学习混淆的意义</h2><p>对于软件开发者：一定程度上防止代码被逆向破解</p>
<p>对于逆向工程师：帮助我们研究反混淆技术</p>
<h2 id="OLLVM是什么"><a href="#OLLVM是什么" class="headerlink" title="OLLVM是什么"></a>OLLVM是什么</h2><p>OLLVM（Obfuscator-LLVM）是瑞士西北应用科技大学安全实验室于2010年6月份发起的一个项目，这个项目的目标是提供一个LLVM编译套件的开源分支，能够通过代码混淆和防篡改，增加对逆向工程的难度，提供更高的软件安全性。目前，OLLVM已经支持LLVM-4.0.1版本。 </p>
<p>OLLVM的混淆操作就是在中间表示IR层，通过编写Pass来混淆IR，然后后端依据IR来生成的目标代码也就被混淆了。得益于LLVM的设计，OLLVM适用LLVM支持的所有语言（C, C++, Objective-C, Ada 和 Fortran）和目标平台（x86, x86-64, PowerPC, PowerPC-64, ARM, Thumb, SPARC, Alpha, CellSPU,MIPS, MSP430, SystemZ, 和 XCore)</p>
<h1 id="5、LLVM环境搭建"><a href="#5、LLVM环境搭建" class="headerlink" title="5、LLVM环境搭建"></a>5、LLVM环境搭建</h1><p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240112163854.png"></p>
<h2 id="第一步：下载-LLVM-Core-和-Clang源代码"><a href="#第一步：下载-LLVM-Core-和-Clang源代码" class="headerlink" title="第一步：下载 LLVM-Core 和 Clang源代码"></a>第一步：下载 LLVM-Core 和 Clang源代码</h2><p><a target="_blank" rel="noopener" href="https://releases.llvm.org/">https://releases.llvm.org/</a></p>
<p>可以看到llvm的最新版本</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240112164723.png"></p>
<p>我们以9.0.1为例</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240112164915.png"></p>
<p>可以看到有源代码链接、文档链接以及预编译好的文件</p>
<p>总项目在最上面</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240112165214.png"></p>
<p>这个地址:<a target="_blank" rel="noopener" href="https://github.com/llvm/llvm-project.git">https://github.com/llvm/llvm-project.git</a></p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240112165239.png"></p>
<p>这里面就有clang和llvm的源码，右边是打包好的</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240112170521.png"></p>
<p> 由于后续要给安卓的ndk使用，我们先看看安卓ndk里的llvm版本</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240112170855.png"></p>
<p>ndk的路径如上图，看到clang的版本是14.0.7,所以我们下载的llvm版本也得是14.0</p>
<p>这里选择了14.0.6</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240112171105.png"></p>
<p>选择源代码下载</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240112171224.png"></p>
<p>下载完移动到Ubuntu解压</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240112172507.png"></p>
<h2 id="第二步：安装编译环境"><a href="#第二步：安装编译环境" class="headerlink" title="第二步：安装编译环境"></a>第二步：安装编译环境</h2><p>不过在编译之前我们还需要提前安装一些环境</p>
<p> <a target="_blank" rel="noopener" href="https://llvm.org/docs/GettingStarted.html">https://llvm.org/docs/GettingStarted.html</a></p>
<p>硬件需求</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240112175341.png"></p>
<p>软件需求</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240112175428.png"></p>
<p>对于这些软件需求和编译aosp差不多，我们可以参考安卓的</p>
<p><a target="_blank" rel="noopener" href="https://source.android.com/docs/setup/build/initializing?hl=zh-cn">https://source.android.com/docs/setup/build/initializing?hl=zh-cn</a></p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240112175938.png"></p>
<pre class="line-numbers language-none"><code class="language-none">sudo apt-get install git-core gnupg flex bison build-essential zip curl zlib1g-dev gcc-multilib g++-multilib libc6-dev-i386 libncurses5 lib32ncurses5-dev x11proto-core-dev libx11-dev lib32z1-dev libgl1-mesa-dev libxml2-utils xsltproc unzip fontconfig<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h2 id="第三步：编译"><a href="#第三步：编译" class="headerlink" title="第三步：编译"></a>第三步：编译</h2><p>参考:<a target="_blank" rel="noopener" href="https://llvm.org/docs/GettingStarted.html#below">https://llvm.org/docs/GettingStarted.html#below</a></p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240112233608.png"></p>
<pre class="line-numbers language-none"><code class="language-none">sudo apt-get install g++
sudo apt-get install make
sudo apt-get install cmake
sudo apt install ninja-build


cd llvm-project
sudo cmake -S llvm -B build -G Ninja -DCMAKE_BUILD_TYPE&#x3D;Release -DLLVM_ENABLE_PROJECTS&#x3D;&quot;clang&quot;
cd build
ninja -j8<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240113003438.png"></p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240113003538.png"></p>
<h2 id="第四步：将llvm源码导入CLION进行编译"><a href="#第四步：将llvm源码导入CLION进行编译" class="headerlink" title="第四步：将llvm源码导入CLION进行编译"></a>第四步：将llvm源码导入CLION进行编译</h2><p>找到llvm目录下的CMakeLists.txt打开</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240113003924.png"></p>
<p>然后设置编译参数</p>
<p>进入settings，然后CMake里点击+会添加Release版本，我们需要在CMake options里填上我们之前编译时用的命令</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240113004319.png"></p>
<p>多了两个目录</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240113004505.png"></p>
<p>用clion编译会比较慢，因为clion占内存，我们可以进到目录下自己编译</p>
<p>在llvm目录下有新创建的cmake-build-debug和cmake-build-release</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240113004731.png"></p>
<p>直接ninja -j线程数就行了</p>
<p>编译成功</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240113010800.png"></p>
<h1 id="6、利用clang进行编译c语言源码"><a href="#6、利用clang进行编译c语言源码" class="headerlink" title="6、利用clang进行编译c语言源码"></a>6、利用clang进行编译c语言源码</h1><p>先写了一个demo</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240113215512.png"></p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;stdio.h></span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc <span class="token punctuation">,</span><span class="token keyword">char</span> <span class="token keyword">const</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"hello clang"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>我们用gcc编译一下</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240113215522.png"></p>
<p>我们用clang是没有的，需要设置环境变量</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240113215656.png"></p>
<pre class="line-numbers language-none"><code class="language-none">export PATH&#x3D;&#x2F;home&#x2F;whitebird&#x2F;llvm-project-llvmorg-14.0.6&#x2F;llvm&#x2F;cmake-build-release&#x2F;bin:$PATH<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240113215851.png"></p>
<pre class="line-numbers language-none"><code class="language-none">clang hello_clang.c -o hello_clang<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240113215934.png"></p>
<h1 id="7、用CLION调试clang"><a href="#7、用CLION调试clang" class="headerlink" title="7、用CLION调试clang"></a>7、用CLION调试clang</h1><p>根据路径找到main位置</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240113220355.png"></p>
<p>然后设置一下，比较多可以直接搜索clang</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240113220657.png"></p>
<p>设置运行参数</p>
<pre class="line-numbers language-none"><code class="language-none">&#x2F;home&#x2F;whitebird&#x2F;test&#x2F;hello_clang.c -o &#x2F;home&#x2F;whitebird&#x2F;test&#x2F;hello_clang_clion<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240113220818.png"></p>
<p>直接运行</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240113220848.png"></p>
<p>文件夹下也有产物</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240113220910.png"></p>
<h1 id="8、llvm相关工具使用"><a href="#8、llvm相关工具使用" class="headerlink" title="8、llvm相关工具使用"></a>8、llvm相关工具使用</h1><p><a target="_blank" rel="noopener" href="https://llvm.org/docs/GettingStarted.html#llvm-tools">https://llvm.org/docs/GettingStarted.html#llvm-tools</a></p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240113232405.png"></p>
<h2 id="将C语言代码转换成LLVM-IR"><a href="#将C语言代码转换成LLVM-IR" class="headerlink" title="将C语言代码转换成LLVM IR"></a>将C语言代码转换成LLVM IR</h2><pre class="line-numbers language-none"><code class="language-none">clang -emit-llvm -S hello_clang.c -o hello_clang.ll<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240113233700.png"></p>
<p>这是一种用户可读的IR中间码</p>
<p>执行该文件 </p>
<pre class="line-numbers language-none"><code class="language-none">lli hello_clang.ll<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240113234303.png"></p>
<p>参考解释，这里还不是bitcode，所以应该充当即使编译器的效果</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240113234405.png"></p>
<h2 id="将LLVM-IR转换成bitcode"><a href="#将LLVM-IR转换成bitcode" class="headerlink" title="将LLVM IR转换成bitcode"></a>将LLVM IR转换成bitcode</h2><p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240113234547.png"></p>
<p>根据解释我们选择llvm-as</p>
<pre class="line-numbers language-none"><code class="language-none">llvm-as hello_clang.ll -o hello_clang.bc<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>此时人就不能正常解析代码了</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240113234729.png"></p>
<h2 id="将LLVM-bitcode转换成汇编"><a href="#将LLVM-bitcode转换成汇编" class="headerlink" title="将LLVM bitcode转换成汇编"></a>将LLVM bitcode转换成汇编</h2><p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240113235432.png"></p>
<pre class="line-numbers language-none"><code class="language-none">llc hello_clang.bc -o hello_clang.s<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240113235456.png"></p>
<h2 id="将汇编转换成可执行程序"><a href="#将汇编转换成可执行程序" class="headerlink" title="将汇编转换成可执行程序"></a>将汇编转换成可执行程序</h2><pre class="line-numbers language-none"><code class="language-none">clang hello_clang.s -o hello_clang_asm<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240114003103.png"></p>
<h2 id="将LLVM-bitcode转换成LLVM-IR"><a href="#将LLVM-bitcode转换成LLVM-IR" class="headerlink" title="将LLVM bitcode转换成LLVM IR"></a>将LLVM bitcode转换成LLVM IR</h2><p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240114003252.png"></p>
<pre class="line-numbers language-none"><code class="language-none">llvm-dis hello_clang.bc -o hello_clang_dis.ll<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240114003319.png"></p>
<h2 id="opt使用pass"><a href="#opt使用pass" class="headerlink" title="opt使用pass"></a>opt使用pass</h2><p>opt用来读取bitcode，然后执行一些pass，pass就是优化器</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240114003502.png"></p>
<pre class="line-numbers language-none"><code class="language-none">opt --help<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240114003542.png"></p>
<p>对于正常的优化器都是对代码进行精简优化，而ollvm就是在这里把代码变复杂</p>
<pre class="line-numbers language-none"><code class="language-none">opt --print-callgraph hello_clang.bc
opt --print-callgraph hello_clang.ll<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240114004204.png"></p>
<h1 id="9、关于pass的相关知识"><a href="#9、关于pass的相关知识" class="headerlink" title="9、关于pass的相关知识"></a>9、关于pass的相关知识</h1><p>可以参考文档：<a target="_blank" rel="noopener" href="https://llvm.org/docs/WritingAnLLVMPass.html#quick-start-writing-hello-world">https://llvm.org/docs/WritingAnLLVMPass.html#quick-start-writing-hello-world</a></p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240114004806.png"></p>
<p>我们查看一下PASS类</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/classllvm_1_1Pass__inherit__graph.png"></p>
<p>基本上用的最多的就是FunctionPass</p>
<h2 id="FunctionPass"><a href="#FunctionPass" class="headerlink" title="FunctionPass"></a>FunctionPass</h2><p>可以参考文档:<a target="_blank" rel="noopener" href="https://llvm.org/docs/WritingAnLLVMPass.html#writing-an-llvm-pass-functionpass">https://llvm.org/docs/WritingAnLLVMPass.html#writing-an-llvm-pass-functionpass</a></p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240114005117.png"></p>
<p>这里介绍了所有的函数都会执行FunctionPass，重点在于runOnFunction方法，所有的函数都会传入这个函数里</p>
<p>我们看个例子，是llvm自带的pass，路径如下</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240114005346.png"></p>
<p>这里所做的操作就是当执行一个函数时，就输出Hello和函数名</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240114005413.png"></p>
<p>编译好的pass存在位置如下，是一个库文件</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240114005534.png"></p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240114005705.png"></p>
<p>我们如何使用它呢</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240114005814.png"></p>
<pre class="line-numbers language-none"><code class="language-none">opt -load &#x2F;home&#x2F;whitebird&#x2F;llvm-project-llvmorg-14.0.6&#x2F;llvm&#x2F;cmake-build-release&#x2F;lib&#x2F;LLVMHello.so -help |grep hello<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>先查看一下pass是否加载成功</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240114010650.png"></p>
<pre class="line-numbers language-none"><code class="language-none">opt -load &#x2F;home&#x2F;whitebird&#x2F;llvm-project-llvmorg-14.0.6&#x2F;llvm&#x2F;cmake-build-release&#x2F;lib&#x2F;LLVMHello.so --hello hello_clang.ll<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>但是发生了报错，没有打印出来</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240114010705.png"></p>
<p>解决方法:需要添加-enable-new-pm&#x3D;0选项。如果想使用 opt 工具中旧的 Pass 管理器（the legacy pass manager），请添加 -enable-new-pm&#x3D;0 选项。</p>
<pre class="line-numbers language-none"><code class="language-none">opt -load &#x2F;home&#x2F;whitebird&#x2F;llvm-project-llvmorg-14.0.6&#x2F;llvm&#x2F;cmake-build-release&#x2F;lib&#x2F;LLVMHello.so --hello -enable-new-pm&#x3D;0 hello_clang.bc<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240114010912.png"></p>
<p>多测试几个函数</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;stdio.h></span></span>

<span class="token keyword">void</span> <span class="token function">test_hello1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
     <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"test_hello1\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">void</span> <span class="token function">test_hello2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
     <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"test_hello2\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc <span class="token punctuation">,</span><span class="token keyword">char</span> <span class="token keyword">const</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"hello clang\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240114011213.png"></p>
<p>调换一下顺序</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;stdio.h></span></span>


<span class="token keyword">void</span> <span class="token function">test_hello2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
     <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"test_hello2\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc <span class="token punctuation">,</span><span class="token keyword">char</span> <span class="token keyword">const</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"hello clang\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">void</span> <span class="token function">test_hello1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
     <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"test_hello1\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240114011251.png"></p>
<p>打印顺序按照代码实现的顺序来的</p>
<h1 id="10、用CLION调试opt和pass"><a href="#10、用CLION调试opt和pass" class="headerlink" title="10、用CLION调试opt和pass"></a>10、用CLION调试opt和pass</h1><p>先找到opt的源码</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240114011558.png"></p>
<p>在main函数下个断点</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240114011620.png"></p>
<p>然后我们给pass也下个断点</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240114011650.png"></p>
<p>设置调试参数</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240114011716.png"></p>
<pre class="line-numbers language-none"><code class="language-none">-load &#x2F;home&#x2F;whitebird&#x2F;llvm-project-llvmorg-14.0.6&#x2F;llvm&#x2F;cmake-build-release&#x2F;lib&#x2F;LLVMHello.so --hello -enable-new-pm&#x3D;0 &#x2F;home&#x2F;whitebird&#x2F;test&#x2F;hello_clang.ll <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240114011809.png"></p>
<p>注意选择debug，release直接执行完了，点下面图标进行调试</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240114011851.png"></p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240114011932.png"></p>
<p>对于debug的文件编译还是有点慢的，因为文件很大</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240114012957.png"></p>
<p>直接F9跑到pass，不过好像没断下来，目前还没有解决这个问题</p>
<h1 id="11、写一个PASS-函数名加密"><a href="#11、写一个PASS-函数名加密" class="headerlink" title="11、写一个PASS-函数名加密"></a>11、写一个PASS-函数名加密</h1><p>每个版本的写法不太一样，我们先看一下老板的</p>
<p><a target="_blank" rel="noopener" href="https://llvm.org/docs/WritingAnLLVMPass.html">https://llvm.org/docs/WritingAnLLVMPass.html</a></p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240114180501.png"></p>
<p>我们创建一个目录EncodeFunctionName，有EncodeFunctionName.cpp和CMakeLists.txt</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240114180557.png"></p>
<p>按照模板改为EncodeFunctionName.cpp和LLVMEncodeFunctionName</p>
<p>然后在lib&#x2F;Transforms&#x2F;CMakeLists.txt写上add_subdirectory(EncodeFunctionName)</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240114180738.png"></p>
<p>cpp代码根据文档来</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"llvm/Pass.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"llvm/IR/Function.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"llvm/Support/raw_ostream.h"</span></span>


using namespace llvm<span class="token punctuation">;</span>
namespace <span class="token punctuation">&#123;</span>
<span class="token keyword">struct</span> <span class="token class-name">EncodeFunctionName</span> <span class="token operator">:</span> public FunctionPass <span class="token punctuation">&#123;</span>
  <span class="token keyword">static</span> <span class="token keyword">char</span> ID<span class="token punctuation">;</span>
  <span class="token function">EncodeFunctionName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">FunctionPass</span><span class="token punctuation">(</span>ID<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
  bool <span class="token function">runOnFunction</span><span class="token punctuation">(</span>Function <span class="token operator">&amp;</span>F<span class="token punctuation">)</span> override <span class="token punctuation">&#123;</span>
    <span class="token function">errs</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"EncodeFunctionName: "</span><span class="token punctuation">;</span>
    <span class="token function">errs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">write_escaped</span><span class="token punctuation">(</span>F<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token char">'\n'</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> false<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span> <span class="token comment">// end of struct Hello</span>
<span class="token punctuation">&#125;</span>  <span class="token comment">// end of anonymous namespace</span>
<span class="token keyword">char</span> EncodeFunctionName<span class="token operator">::</span>ID <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">static</span> RegisterPass<span class="token operator">&lt;</span>EncodeFunctionName<span class="token operator">></span> <span class="token function">X</span><span class="token punctuation">(</span><span class="token string">"encode"</span><span class="token punctuation">,</span> <span class="token string">"Hello EncodeFunctionName Pass"</span><span class="token punctuation">,</span>
                             false <span class="token comment">/* Only looks at CFG */</span><span class="token punctuation">,</span>
                             false <span class="token comment">/* Analysis Pass */</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240114181414.png"></p>
<p>现在我们需要去编译一下这个pass，首先加载一下cmakelist</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240114181813.png"></p>
<p>或者勾选上</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240114181954.png"></p>
<p>进行ninja LLVMEncodeFunctionName</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240114182023.png"></p>
<p>我们用一下这个pass</p>
<pre class="line-numbers language-none"><code class="language-none">opt -load &#x2F;home&#x2F;whitebird&#x2F;llvm-project-llvmorg-14.0.6&#x2F;llvm&#x2F;cmake-build-release&#x2F;lib&#x2F;LLVMEncodeFunctionName.so --encode -enable-new-pm&#x3D;0 hello_clang.ll -o hello_clang.bc<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240114182545.png"></p>
<p>我们现在稍微修改一下代码</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">bool <span class="token function">runOnFunction</span><span class="token punctuation">(</span>Function <span class="token operator">&amp;</span>F<span class="token punctuation">)</span> override <span class="token punctuation">&#123;</span>
  <span class="token function">errs</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"EncodeFunctionName before: "</span><span class="token operator">&lt;&lt;</span>F<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&lt;&lt;</span><span class="token char">'\n'</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>F<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">compare</span><span class="token punctuation">(</span><span class="token string">"test_hello2"</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    F<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">"whitebird_function"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token function">errs</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"EncodeFunctionName after: "</span><span class="token operator">&lt;&lt;</span>F<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&lt;&lt;</span><span class="token char">'\n'</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> false<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>主要是对test_hello2进行比较，如果是的就利用setName把函数名改为whitebird_function</p>
<p>我们重新编译，再运行一次pass</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240114183242.png"></p>
<p>我们用clang编译一次可执行文件，去ida再看看</p>
<pre class="line-numbers language-none"><code class="language-none">clang hello_clang.bc -o hello_clang<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>bc文件是我们刚才优化完的产物，此时的函数名已经变了</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240114183517.png"></p>
<p>我们再写一个复杂一点的，用一下llvm自带的MD5加密</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240114184018.png"></p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">bool <span class="token function">runOnFunction</span><span class="token punctuation">(</span>Function <span class="token operator">&amp;</span>F<span class="token punctuation">)</span> override <span class="token punctuation">&#123;</span>

   <span class="token keyword">if</span> <span class="token punctuation">(</span>F<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">compare</span><span class="token punctuation">(</span><span class="token string">"main"</span><span class="token punctuation">)</span><span class="token operator">!=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
     <span class="token function">errs</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"EncodeFunctionName before: "</span><span class="token operator">&lt;&lt;</span>F<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&lt;&lt;</span><span class="token char">'\n'</span><span class="token punctuation">;</span>
     llvm<span class="token operator">::</span>MD5 Hasher<span class="token punctuation">;</span>
     llvm<span class="token operator">::</span>MD5<span class="token operator">::</span>MD5Result Hash<span class="token punctuation">;</span>
     Hasher<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token string">"whitebird_"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     Hasher<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>F<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     Hasher<span class="token punctuation">.</span><span class="token function">final</span><span class="token punctuation">(</span>Hash<span class="token punctuation">)</span><span class="token punctuation">;</span>

     SmallString<span class="token operator">&lt;</span><span class="token number">32</span><span class="token operator">></span> HexString<span class="token punctuation">;</span>
     llvm<span class="token operator">::</span>MD5<span class="token operator">::</span><span class="token function">stringifyResult</span><span class="token punctuation">(</span>Hash<span class="token punctuation">,</span> HexString<span class="token punctuation">)</span><span class="token punctuation">;</span>
     F<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span>HexString<span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token function">errs</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"EncodeFunctionName after: "</span><span class="token operator">&lt;&lt;</span>HexString<span class="token operator">&lt;&lt;</span><span class="token char">'\n'</span><span class="token punctuation">;</span>
   <span class="token punctuation">&#125;</span>


   <span class="token keyword">return</span> false<span class="token punctuation">;</span>
 <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>把函数名改为whitebird_xxx，然后进行md5</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240114184501.png"></p>
<p>再编译一次可执行文件，去IDA看看</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240114184617.png"></p>
<h1 id="12、在LLVM源码外开发PASS"><a href="#12、在LLVM源码外开发PASS" class="headerlink" title="12、在LLVM源码外开发PASS"></a>12、在LLVM源码外开发PASS</h1><p>前面的pass是在llvm源码里写的，有时候可能比较麻烦，有一种方法可以脱离LLVM源码</p>
<p>参考:<a target="_blank" rel="noopener" href="https://releases.llvm.org/8.0.1/docs/CMake.html#developing-llvm-passes-out-of-source">https://releases.llvm.org/8.0.1/docs/CMake.html#developing-llvm-passes-out-of-source</a></p>
<p>因为llvm14已经是新的写法了，所以我们采用老版本的文档来写</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240114222857.png"></p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240114222923.png"></p>
<p>不过有一些报错需要处理</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240114222959.png"></p>
<p>效果如下</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240114223011.png"></p>
<p>子目录的CMakeLists.txt</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240114223204.png"></p>
<p>此时还有点问题，需要设置LLVM_DIR,告诉CMake去寻找LLVMConfig.cmake配置文件。这个配置文件包含了LLVM库、头文件等必要的信息。</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240114223902.png"></p>
<p>编译测试</p>
<pre class="line-numbers language-none"><code class="language-none">opt -load &#x2F;home&#x2F;whitebird&#x2F;outPass&#x2F;cmake-build-release&#x2F;EncodeFunctionName2&#x2F;LLVMEncodeFunctionName2.so --encode -enable-new-pm&#x3D;0 hello_clang.ll -o hello_clang.bc<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240114224000.png"></p>
<h1 id="13、通过clang加载pass"><a href="#13、通过clang加载pass" class="headerlink" title="13、通过clang加载pass"></a>13、通过clang加载pass</h1><p>首先得注册一下</p>
<p>参考<a target="_blank" rel="noopener" href="https://releases.llvm.org/9.0.1/docs/WritingAnLLVMPass.html">https://releases.llvm.org/9.0.1/docs/WritingAnLLVMPass.html</a></p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240114233455.png"></p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240114234019.png"></p>
<pre class="line-numbers language-none"><code class="language-none">clang -Xclang -load -Xclang &#x2F;home&#x2F;whitebird&#x2F;outPass&#x2F;cmake-build-release&#x2F;EncodeFunctionName2&#x2F;LLVMEncodeFunctionName2.so -flegacy-pass-manager hello_clang.ll -o hello_clang.bc<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240114233521.png"></p>
<pre class="line-numbers language-none"><code class="language-none">clang -Xclang -load -Xclang &#x2F;home&#x2F;whitebird&#x2F;outPass&#x2F;cmake-build-release&#x2F;EncodeFunctionName2&#x2F;LLVMEncodeFunctionName2.so -flegacy-pass-manager hello_clang.ll -o hello_clang_t<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>也可以编译成可执行文件</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240114233617.png"></p>
<p>还有种注册的方法，直接加入clang的命令行</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240116200247.png"></p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">//</span>
<span class="token comment">// Created by whitebird on 24-1-15.</span>
<span class="token comment">//</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">LLVM_PROJECT_LLVMORG_14_0_6_ENCODEFUNCTIONNAME_H</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">LLVM_PROJECT_LLVMORG_14_0_6_ENCODEFUNCTIONNAME_H</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"llvm/Pass.h"</span></span>
namespace llvm<span class="token punctuation">&#123;</span>
  Pass <span class="token operator">*</span> <span class="token function">createEncodeFunctionName</span><span class="token punctuation">(</span>bool flag<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>


<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">// LLVM_PROJECT_LLVMORG_14_0_6_ENCODEFUNCTIONNAME_H</span></span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>先搞个头文件，然后在EncodeFunctionName.cpp中实现，其实主要是对全局变量enable_flag赋值，然后通过enable_flag来执行我们函数名加密逻辑，而enable_flag其实是判断我们输入了命令行，如果输入了就是true，没输入就是false，对应着不执行</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240116200401.png"></p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"llvm/Pass.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"llvm/IR/Function.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"llvm/Support/raw_ostream.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"llvm/Transforms/EncodeFunctionName/EncodeFunctionName.h"</span></span>

using namespace llvm<span class="token punctuation">;</span>
namespace <span class="token punctuation">&#123;</span>
<span class="token keyword">struct</span> <span class="token class-name">EncodeFunctionName</span> <span class="token operator">:</span> public FunctionPass <span class="token punctuation">&#123;</span>
  <span class="token keyword">static</span> <span class="token keyword">char</span> ID<span class="token punctuation">;</span>
  bool enable_flag<span class="token punctuation">;</span>
  <span class="token function">EncodeFunctionName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">FunctionPass</span><span class="token punctuation">(</span>ID<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
  <span class="token function">EncodeFunctionName</span><span class="token punctuation">(</span>bool flag<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">FunctionPass</span><span class="token punctuation">(</span>ID<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    enable_flag<span class="token operator">=</span>flag<span class="token punctuation">;</span>
    <span class="token function">EncodeFunctionName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  bool <span class="token function">runOnFunction</span><span class="token punctuation">(</span>Function <span class="token operator">&amp;</span>F<span class="token punctuation">)</span> override <span class="token punctuation">&#123;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>enable_flag<span class="token operator">==</span>true<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>F<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">compare</span><span class="token punctuation">(</span><span class="token string">"main"</span><span class="token punctuation">)</span><span class="token operator">!=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token function">errs</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"EncodeFunctionName before: "</span><span class="token operator">&lt;&lt;</span>F<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&lt;&lt;</span><span class="token char">'\n'</span><span class="token punctuation">;</span>
        llvm<span class="token operator">::</span>MD5 Hasher<span class="token punctuation">;</span>
        llvm<span class="token operator">::</span>MD5<span class="token operator">::</span>MD5Result Hash<span class="token punctuation">;</span>
        Hasher<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token string">"whitebird_"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        Hasher<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>F<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        Hasher<span class="token punctuation">.</span><span class="token function">final</span><span class="token punctuation">(</span>Hash<span class="token punctuation">)</span><span class="token punctuation">;</span>

        SmallString<span class="token operator">&lt;</span><span class="token number">32</span><span class="token operator">></span> HexString<span class="token punctuation">;</span>
        llvm<span class="token operator">::</span>MD5<span class="token operator">::</span><span class="token function">stringifyResult</span><span class="token punctuation">(</span>Hash<span class="token punctuation">,</span> HexString<span class="token punctuation">)</span><span class="token punctuation">;</span>
        F<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span>HexString<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">errs</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"EncodeFunctionName after: "</span><span class="token operator">&lt;&lt;</span>HexString<span class="token operator">&lt;&lt;</span><span class="token char">'\n'</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>

    <span class="token punctuation">&#125;</span>

    <span class="token keyword">return</span> false<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span> <span class="token comment">// end of struct Hello</span>
<span class="token punctuation">&#125;</span>  <span class="token comment">// end of anonymous namespace</span>
<span class="token keyword">char</span> EncodeFunctionName<span class="token operator">::</span>ID <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">static</span> RegisterPass<span class="token operator">&lt;</span>EncodeFunctionName<span class="token operator">></span> <span class="token function">X</span><span class="token punctuation">(</span><span class="token string">"encode"</span><span class="token punctuation">,</span> <span class="token string">"Hello EncodeFunctionName Pass"</span><span class="token punctuation">,</span>
                             false <span class="token comment">/* Only looks at CFG */</span><span class="token punctuation">,</span>
                             false <span class="token comment">/* Analysis Pass */</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

Pass<span class="token operator">*</span> llvm<span class="token operator">::</span><span class="token function">createEncodeFunctionName</span><span class="token punctuation">(</span>bool flag<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
  <span class="token keyword">return</span> new <span class="token function">EncodeFunctionName</span><span class="token punctuation">(</span>flag<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>EncodeFunctionName还需要两个比较重要的文件</p>
<pre class="line-numbers language-none"><code class="language-none">add_llvm_library( LLVMEncodeFunctionName
        EncodeFunctionName.cpp

        ADDITIONAL_HEADER_DIRS
        $&#123;LLVM_MAIN_INCLUDE_DIR&#125;&#x2F;llvm&#x2F;Transforms
        $&#123;LLVM_MAIN_INCLUDE_DIR&#125;&#x2F;llvm&#x2F;Transforms&#x2F;EncodeFunctionName

        DEPENDS
        intrinsics_gen
)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240116200702.png"></p>
<p>还有个LLVMBuild.txt,这个测试删了也没啥影响，好像是老版本才用到的</p>
<pre class="line-numbers language-none"><code class="language-none">;&#x3D;&#x3D;&#x3D;- .&#x2F;lib&#x2F;Transforms&#x2F;Scalar&#x2F;LLVMBuild.txt --------------------*- Conf -*--&#x3D;&#x3D;&#x3D;;
;
;                     The LLVM Compiler Infrastructure
;
; This file is distributed under the University of Illinois Open Source
; License. See LICENSE.TXT for details.
;
;&#x3D;&#x3D;&#x3D;------------------------------------------------------------------------&#x3D;&#x3D;&#x3D;;
;
; This is an LLVMBuild description file for the components in this subdirectory.
;
; For more information on the LLVMBuild system, please see:
;
;   http:&#x2F;&#x2F;llvm.org&#x2F;docs&#x2F;LLVMBuild.html
;
;&#x3D;&#x3D;&#x3D;------------------------------------------------------------------------&#x3D;&#x3D;&#x3D;;

[component_0]
type &#x3D; Library
name &#x3D; EncodeFunctionName
parent &#x3D; Transforms
library_name &#x3D; EncodeFunctionName
required_libraries &#x3D; TransformUtils Analysis Core Support<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240116200744.png"></p>
<p>现在我们还需要把pass注册到clang的命令行，在IPO的CMakeLists.txt加入我们的pass模块</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240116200830.png"></p>
<p>我们说了这么久，还不知道clang到底用什么参数来执行pass，现在来定义一下参数名，之后我们在使用clang时输入-encode 就可以执行我们的pass</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">//Flags for my pass</span>
<span class="token keyword">static</span> cl<span class="token operator">::</span>opt<span class="token operator">&lt;</span>bool<span class="token operator">></span> <span class="token function">EncodeFunction</span><span class="token punctuation">(</span><span class="token string">"encode"</span><span class="token punctuation">,</span> cl<span class="token operator">::</span><span class="token function">init</span><span class="token punctuation">(</span>false<span class="token punctuation">)</span><span class="token punctuation">,</span>
                               cl<span class="token operator">::</span><span class="token function">desc</span><span class="token punctuation">(</span><span class="token string">"Enable my pass"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240116200937.png"></p>
<p>使用add把pass加入到manager，createEncodeFunctionName是我们之前定义的，参数是EncodeFunction，是我们上面定义的clang参数名，此时如果我们在clang中使用了-encode，EncodeFunction就表示true，也就是会执行pass</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">MPM<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token function">createEncodeFunctionName</span><span class="token punctuation">(</span>EncodeFunction<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240116201101.png"></p>
<p>最外层的CMakeLists.txt也要修改</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240116201334.png"></p>
<p>然后去编译,在llvm项目根目录下进行配置</p>
<pre class="line-numbers language-none"><code class="language-none">sudo cmake -S llvm -B build -G Ninja -DLLVM_ENABLE_PROJECTS&#x3D;&quot;clang&quot; -DCMAKE_BUILD_TYPE&#x3D;Release -DLLVM_INCLUDE_TESTS&#x3D;OFF -DLLVM_ENABLE_NEW_PASS_MANAGER&#x3D;OFF<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240116201425.png"></p>
<p>编译</p>
<pre class="line-numbers language-none"><code class="language-none">sudo cmake --build build -j16<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240116201518.png"></p>
<p>编译好的clang在&#x2F;llvm-project-llvmorg-14.0.6&#x2F;build&#x2F;bin下</p>
<p>测试效果</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240116201558.png"></p>
<h1 id="14、脱离源码调试opt和pass"><a href="#14、脱离源码调试opt和pass" class="headerlink" title="14、脱离源码调试opt和pass"></a>14、脱离源码调试opt和pass</h1><p>接着用12的项目</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240115202713.png"></p>
<p>参数</p>
<pre class="line-numbers language-none"><code class="language-none">-load &#x2F;home&#x2F;whitebird&#x2F;outPass&#x2F;cmake-build-debug&#x2F;EncodeFunctionName2&#x2F;LLVMEncodeFunctionName2.so -encode -enable-new-pm&#x3D;0 &#x2F;home&#x2F;whitebird&#x2F;test&#x2F;hello_clang.ll -o &#x2F;home&#x2F;whitebird&#x2F;test&#x2F;hello_clang.bc <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>然后下断点就可以直接调试了</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240115202823.png"></p>
<h1 id="15、将OLLVM移植到LLVM14"><a href="#15、将OLLVM移植到LLVM14" class="headerlink" title="15、将OLLVM移植到LLVM14"></a>15、将OLLVM移植到LLVM14</h1><p>最早的ollvm:<a target="_blank" rel="noopener" href="https://github.com/obfuscator-llvm/obfuscator/tree/llvm-4.0">https://github.com/obfuscator-llvm/obfuscator/tree/llvm-4.0</a></p>
<p>只支持到ollvm4.0，我们尝试把它移植到llvm14</p>
<p>项目参考:<a target="_blank" rel="noopener" href="https://github.com/buffcow/ollvm-project/tree/14.x">https://github.com/buffcow/ollvm-project/tree/14.x</a></p>
<p>可以直接下载编译，也可以看他修改了哪些地方</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240116212705.png"></p>
<p>主要分为三步：添加ollvm的*.cpp代码、添加ollvm的*.h代码、注册到clang</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240116212731.png"></p>
<p>就是这些文件，放到图中的目录下</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240116212910.png"></p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240116212948.png"></p>
<p>然后添加头</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240116213023.png"></p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240116213041.png"></p>
<p>接着就是注册到clang，和之前我们自己写的pass注册差不多</p>
<p>都是对着改就行了</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240116213300.png"></p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240116213317.png"></p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240116213327.png"></p>
<p>可以直接搜附近的官方代码进行定位</p>
<p>接着就是编译了</p>
<pre class="line-numbers language-none"><code class="language-none">sudo cmake -S llvm -B build -G Ninja -DLLVM_ENABLE_PROJECTS&#x3D;&quot;clang&quot; -DCMAKE_BUILD_TYPE&#x3D;Release -DLLVM_INCLUDE_TESTS&#x3D;OFF -DLLVM_ENABLE_NEW_PASS_MANAGER&#x3D;OFF
sudo cmake --build build -j16<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>然后就可以正常使用了</p>
<h1 id="16、OLLVM使用"><a href="#16、OLLVM使用" class="headerlink" title="16、OLLVM使用"></a>16、OLLVM使用</h1><p><a target="_blank" rel="noopener" href="https://github.com/obfuscator-llvm/obfuscator/wiki/Installation">https://github.com/obfuscator-llvm/obfuscator/wiki/Installation</a></p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240116225351.png"></p>
<p>主要是这三种</p>
<h2 id="sub"><a href="#sub" class="headerlink" title="-sub"></a>-sub</h2><h3 id="描述"><a href="#描述" class="headerlink" title="描述"></a>描述</h3><p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240116225455.png"></p>
<h3 id="加法"><a href="#加法" class="headerlink" title="加法"></a>加法</h3><p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240116225728.png"></p>
<p>有好几种变换形式，对于有随机数的会复杂一点</p>
<pre class="line-numbers language-none"><code class="language-none">1.  a &#x3D; b - (-c)
2.  a &#x3D; -(-b + (-c))
3.  r &#x3D; rand (); a &#x3D; b + r; a &#x3D; a + c; a &#x3D; a - r
4.  r &#x3D; rand (); a &#x3D; b - r; a &#x3D; a + b; a &#x3D; a + r<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="减法"><a href="#减法" class="headerlink" title="减法"></a>减法</h3><pre class="line-numbers language-none"><code class="language-none">1. a &#x3D; b + (-c)
2. r &#x3D; rand (); a &#x3D; b + r; a &#x3D; a - c; a &#x3D; a - r
3. r &#x3D; rand (); a &#x3D; b - r; a &#x3D; a - c; a &#x3D; a + r<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<h3 id="AND运算混淆"><a href="#AND运算混淆" class="headerlink" title="AND运算混淆"></a>AND运算混淆</h3><p>a &#x3D; b &amp; c &#x3D;&gt; a &#x3D; (b ^ ~c) &amp; b</p>
<h3 id="OR运算混淆"><a href="#OR运算混淆" class="headerlink" title="OR运算混淆"></a>OR运算混淆</h3><p>a &#x3D; b | c &#x3D;&gt; a &#x3D; (b &amp; c) | (b ^ c)</p>
<h3 id="XOR运算混淆"><a href="#XOR运算混淆" class="headerlink" title="XOR运算混淆"></a>XOR运算混淆</h3><p>a &#x3D; a ^ b &#x3D;&gt; a &#x3D; (~a &amp; b) | (a &amp; ~b)</p>
<h3 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h3><p>有两种方法</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240116230603.png"></p>
<h4 id="mllvm-sub"><a href="#mllvm-sub" class="headerlink" title="-mllvm -sub"></a>-mllvm -sub</h4><pre class="line-numbers language-none"><code class="language-none">sudo .&#x2F;clang -mllvm -sub hello.c -o hello_sub<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240116230658.png"></p>
<p>可以看到esi先加一个0D8C641CF，然后又减去0D8C641CF，没影响</p>
<p>F5的时候，IDA自动帮我们优化了</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240116230738.png"></p>
<h4 id="mllvm-sub-loop"><a href="#mllvm-sub-loop" class="headerlink" title="-mllvm -sub_loop"></a>-mllvm -sub_loop</h4><p>加个-mllvm -sub_loop&#x3D;3试试</p>
<pre class="line-numbers language-none"><code class="language-none">sudo .&#x2F;clang -mllvm -sub -mllvm -sub_loop&#x3D;3 hello.c -o hello_sub_loop<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>汇编代码看起来稍微复杂了一些</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240116231349.png"></p>
<p>F5还是自动优化了</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240116231400.png"></p>
<h2 id="bcf"><a href="#bcf" class="headerlink" title="-bcf"></a>-bcf</h2><h3 id="描述-1"><a href="#描述-1" class="headerlink" title="描述"></a>描述</h3><p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240116231634.png"></p>
<p>bogus control flow通过在源程序的控制流中添加一些基本块，这些基本块仅仅起了连接作用，并不影响实际的执行逻辑。</p>
<h3 id="函数调用图"><a href="#函数调用图" class="headerlink" title="函数调用图"></a>函数调用图</h3><p>示例</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">*</span> argv<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">int</span> a <span class="token operator">=</span> <span class="token function">atoi</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>a <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token keyword">else</span>
    <span class="token keyword">return</span> <span class="token number">10</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>看一下他的ir函数调用图</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240116232205.png"></p>
<p>在伪造的控制流传递之后，我们可能会得到以下流程图</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240116232254.png"></p>
<h3 id="使用-1"><a href="#使用-1" class="headerlink" title="使用"></a>使用</h3><p>可以使用的参数</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240116234215.png"></p>
<h4 id="mllvm-bcf"><a href="#mllvm-bcf" class="headerlink" title="-mllvm -bcf"></a>-mllvm -bcf</h4><pre class="line-numbers language-none"><code class="language-none">sudo .&#x2F;clang -mllvm -bcf hello.c -o hello_bcf<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240116232850.png"></p>
<p>F5一下，有点难看了</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240116232913.png"></p>
<h4 id="mllvm-bcf-loop"><a href="#mllvm-bcf-loop" class="headerlink" title="-mllvm  -bcf_loop"></a>-mllvm  -bcf_loop</h4><p>有一些基本块是虚假的，并不会执行。我们继续加参数</p>
<pre class="line-numbers language-none"><code class="language-none">.&#x2F;clang -mllvm -bcf -mllvm -bcf_loop&#x3D;3 hello.c -o hello_bcf_loop1<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>已经很复杂很长了,对比最初的源码还是难看的</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240116234017.png"></p>
<h4 id="mllvm-bcf-prob"><a href="#mllvm-bcf-prob" class="headerlink" title="-mllvm -bcf_prob"></a>-mllvm -bcf_prob</h4><pre class="line-numbers language-none"><code class="language-none">.&#x2F;clang -mllvm -bcf -mllvm -bcf_loop&#x3D;3 -mllvm -bcf_prob&#x3D;80 hello.c -o hello_bcf_loop_prob<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>



<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240116234543.png"></p>
<h2 id="fla"><a href="#fla" class="headerlink" title="-fla"></a>-fla</h2><h3 id="描述-2"><a href="#描述-2" class="headerlink" title="描述"></a>描述</h3><p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240116234619.png"></p>
<p>control flow flattening（控制流平坦化）通过多个case-swich结构将程序的控制流变成扁平形状，打破原有的逻辑结构，增加逆向的难度。</p>
<h3 id="实例"><a href="#实例" class="headerlink" title="实例"></a>实例</h3><p>源码如下</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">*</span> argv<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">int</span> a <span class="token operator">=</span> <span class="token function">atoi</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>a <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token keyword">else</span>
    <span class="token keyword">return</span> <span class="token number">10</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>平坦化过程将把这段代码转换成这样</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">*</span> argv<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">int</span> a <span class="token operator">=</span> <span class="token function">atoi</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">int</span> b <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">switch</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">case</span> <span class="token number">0</span><span class="token operator">:</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>a <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
          b <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span>
          b <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token keyword">case</span> <span class="token number">1</span><span class="token operator">:</span>
        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
      <span class="token keyword">case</span> <span class="token number">2</span><span class="token operator">:</span>
        <span class="token keyword">return</span> <span class="token number">10</span><span class="token punctuation">;</span>
      <span class="token keyword">default</span><span class="token operator">:</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>可以看到，所有基本块都被分割并放入无限循环中，程序流程由 switch和变量b控制。</p>
<p>这是平坦化之前生成的控制流的样子</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240116235030.png"></p>
<p>平坦化后，我们得到如下指令流程</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240116235048.png"></p>
<h3 id="使用-2"><a href="#使用-2" class="headerlink" title="使用"></a>使用</h3><h4 id="mllvm-fla"><a href="#mllvm-fla" class="headerlink" title="-mllvm -fla"></a>-mllvm -fla</h4><pre class="line-numbers language-none"><code class="language-none">.&#x2F;clang -mllvm -fla hello.c -o hello_fla<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240116235446.png"></p>
<p>可以看到扁平化的特征，而且代码变复杂了</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240116235602.png"></p>
<p>通过控制v5的值，跳出循环。其实是一个switch，但是ida没有分析出来</p>
<h4 id="mllvm-fla-mllvm-split"><a href="#mllvm-fla-mllvm-split" class="headerlink" title="-mllvm -fla -mllvm -split"></a>-mllvm -fla -mllvm -split</h4><p>激活基本块分裂。一起使用时可改善平整度</p>
<pre class="line-numbers language-none"><code class="language-none">.&#x2F;clang -mllvm -fla -mllvm -split hello.c -o hello_fla_split<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>



<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240116235808.png"></p>
<p>看起来更加平坦化了</p>
<h4 id="mllvm-split-num-3"><a href="#mllvm-split-num-3" class="headerlink" title="-mllvm -split_num&#x3D;3"></a>-mllvm -split_num&#x3D;3</h4><p>在每个基本块上分裂 3 次</p>
<p>这个会使代码更复杂</p>
<pre class="line-numbers language-none"><code class="language-none">.&#x2F;clang -mllvm -fla -mllvm -split -mllvm -split_num&#x3D;3 hello.c -o hello_fla_split_num3<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240116235952.png"></p>
<p>可能和上个差距不明显，我们把数字改大点，改成10</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240117000057.png"></p>
<h2 id="Functions-annotations"><a href="#Functions-annotations" class="headerlink" title="Functions annotations"></a>Functions annotations</h2><p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240118021644.png"></p>
<h1 id="17、脱离源码编译ollvm的pass"><a href="#17、脱离源码编译ollvm的pass" class="headerlink" title="17、脱离源码编译ollvm的pass"></a>17、脱离源码编译ollvm的pass</h1><p>其实就是和之前脱离源码开发pass差不多，我们先创建一个文件树</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240117210741.png"></p>
<p>对于include没什么要改的，我们需要改的是源码中的一些CMakeLists.txt文件</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240117211053.png"></p>
<p>改成MODULE，这样编译出来是一个so，多了个cpp文件，这个entry.cpp是用来把命令行注册到clang的，后面再说</p>
<p>外层的其实就是把无关的模块给删了</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240117211201.png"></p>
<p>LLVMBuild.txt也同理</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240117211240.png"></p>
<p>同理</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240117211405.png"></p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240117211424.png"></p>
<p>最外层的这个最重要</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240117211503.png"></p>
<pre class="line-numbers language-none"><code class="language-none"># 指定最低的 CMake 版本要求为 3.26
cmake_minimum_required(VERSION 3.26)
# 定义项目名称为 &quot;ollvm&quot;
project(llvm)
# 设置 LLVM 的路径，用于在后续的 find_package 中定位 LLVM
set(LLVM_DIR &#x2F;home&#x2F;whitebird&#x2F;llvm-project-llvmorg-14.0.6&#x2F;llvm&#x2F;cmake-build-release&#x2F;lib&#x2F;cmake&#x2F;llvm&#x2F;)
# 使用 find_package 查找 LLVM，并使用 CONFIG 模式定位其配置信息
find_package(LLVM REQUIRED CONFIG)
# 将 LLVM 的 CMake 模块路径添加到 CMAKE_MODULE_PATH 中
list(APPEND CMAKE_MODULE_PATH &quot;$&#123;LLVM_CMAKE_DIR&#125;&quot;)
# 引入 LLVM 的辅助功能
include(AddLLVM)
# 添加 LLVM 的定义到项目中
add_definitions($&#123;LLVM_DEFINITIONS&#125;)
# 添加 LLVM 的头文件路径到项目中
include_directories($&#123;LLVM_INCLUDE_DIRS&#125;)
# 添加项目自己的头文件路径（ollvm&#x2F;include）
include_directories(ollvm&#x2F;include)
# 在项目中添加子目录 &quot;ollvm&quot;，该目录下应包含项目源代码
add_subdirectory(ollvm)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>尤其是set那里，如果我们使用debug版本的clang+debug版本的LLVMObfuscation1.so就设置cmake-build-debug，否则就是cmake-build-release，切记不能混着用，否则执行混淆的时候会报错</p>
<pre class="line-numbers language-none"><code class="language-none">export PATH&#x3D;&#x2F;home&#x2F;whitebird&#x2F;llvm-project-llvmorg-14.0.6&#x2F;llvm&#x2F;cmake-build-release&#x2F;bin:$PATH

clang -Xclang -load -Xclang &#x2F;home&#x2F;whitebird&#x2F;llvm&#x2F;cmake-build-release&#x2F;ollvm&#x2F;lib&#x2F;Transforms&#x2F;Obfuscation&#x2F;LLVMObfuscation1.so -flegacy-pass-manager -mllvm -fla  hello_clang.c -o hello_clang_tt<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>这边得加个-flegacy-pass-manager，因为llvm14换了新的manager，使用-flegacy-pass-manager参数就是指定使用老版本的manager</p>
<p>我们看一下entry.cpp</p>
<pre class="line-numbers language-none"><code class="language-none">#include &quot;llvm&#x2F;Transforms&#x2F;Obfuscation&#x2F;BogusControlFlow.h&quot;
#include &quot;llvm&#x2F;Transforms&#x2F;Obfuscation&#x2F;Flattening.h&quot;
#include &quot;llvm&#x2F;Transforms&#x2F;Obfuscation&#x2F;Split.h&quot;
#include &quot;llvm&#x2F;Transforms&#x2F;Obfuscation&#x2F;Substitution.h&quot;
#include &quot;llvm&#x2F;Transforms&#x2F;Obfuscation&#x2F;CryptoUtils.h&quot;

#include &quot;llvm&#x2F;IR&#x2F;LegacyPassManager.h&quot;
#include &quot;llvm&#x2F;Transforms&#x2F;IPO&#x2F;PassManagerBuilder.h&quot;

#include &quot;llvm&#x2F;Transforms&#x2F;Utils.h&quot;

using namespace llvm;

&#x2F;&#x2F; Flags for obfuscation
static cl::opt&lt;bool&gt; Flattening(&quot;fla&quot;, cl::init(false),
                                cl::desc(&quot;Enable the flattening pass&quot;));

static cl::opt&lt;bool&gt; BogusControlFlow(&quot;bcf&quot;, cl::init(false),
                                      cl::desc(&quot;Enable bogus control flow&quot;));

static cl::opt&lt;bool&gt; Substitution(&quot;sub&quot;, cl::init(false),
                                  cl::desc(&quot;Enable instruction substitutions&quot;));

static cl::opt&lt;std::string&gt; AesSeed(&quot;aesSeed&quot;, cl::init(&quot;&quot;),
                                    cl::desc(&quot;seed for the AES-CTR PRNG&quot;));

static cl::opt&lt;bool&gt; Split(&quot;split&quot;, cl::init(false),
                           cl::desc(&quot;Enable basic block splitting&quot;));



static llvm::RegisterStandardPasses Y(
        llvm::PassManagerBuilder::EP_EarlyAsPossible,
        [](const llvm::PassManagerBuilder &amp;Builder,
           llvm::legacy::PassManagerBase &amp;PM) &#123;

            if(!AesSeed.empty()) &#123;
                if(!llvm::cryptoutils-&gt;prng_seed(AesSeed.c_str()))
                    exit(1);
            &#125;

            PM.add(createSplitBasicBlock(Split));
            PM.add(createBogus(BogusControlFlow));
            if (Flattening) &#123;
                PM.add(createLowerSwitchPass());
            &#125;

            PM.add(createFlattening(Flattening));
            PM.add(createSubstitution(Substitution));

        &#125;);<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>使用RegisterStandardPasses进行注册</p>
<p><code>PassManagerBuilder::EP_EarlyAsPossible</code> 会在其他优化进行之前调用我们的 pass <code>PassManagerBuilder::EP_FullLinkTimeOptimizationLast</code> 会在链接优化之后调用我们的 pass。</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240117212425.png"></p>
<h1 id="18、调试ollvm源码"><a href="#18、调试ollvm源码" class="headerlink" title="18、调试ollvm源码"></a>18、调试ollvm源码</h1><p>我一开始编译的是release的LLVMObfuscation1.so模块配合release版本的clang进行调试发现断不下来，后来重新编译了一份debug版本的clang，才可以正常调试，原因是release版本的clang去除了符号，导致断点位置不对。</p>
<p>首先我们编译一个debug版本的LLVMObfuscation1.so</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240118020144.png"></p>
<p>然后我们的clang也是debug版本的,进入llvm根目录</p>
<pre class="line-numbers language-none"><code class="language-none">cmake -S llvm -B build_debug -G Ninja -DLLVM_ENABLE_PROJECTS&#x3D;&quot;clang&quot; -DCMAKE_BUILD_TYPE&#x3D;Debug  -DLLVM_INCLUDE_TESTS&#x3D;OFF

cd build_debug&#x2F;

ninja clang<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>完整的编译很慢，所以只编译了clang，可以看到很占内存</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240118020342.png"></p>
<p>我们设置调试参数</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240118020751.png"></p>
<pre class="line-numbers language-none"><code class="language-none">-Xclang -load -Xclang &#x2F;home&#x2F;whitebird&#x2F;llvm&#x2F;cmake-build-debug&#x2F;ollvm&#x2F;lib&#x2F;Transforms&#x2F;Obfuscation&#x2F;LLVMObfuscation1.so -flegacy-pass-manager -mllvm -fla &#x2F;home&#x2F;whitebird&#x2F;test&#x2F;hello_clang.c -o &#x2F;home&#x2F;whitebird&#x2F;test&#x2F;hello_clang_x<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>会发现还是断不下来，但是执行了我们自己写的打印</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240118020923.png"></p>
<p>我们写个异常看看,需要重新编译模块</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token operator">*</span>err<span class="token operator">=</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token number">0</span><span class="token punctuation">;</span>
<span class="token operator">*</span>err<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240118021026.png"></p>
<p>可以发现其实真正用的是clang-14，而且多了一堆参数</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240118021124.png"></p>
<p>我们把这些参数改成我们自己使用</p>
<pre class="line-numbers language-none"><code class="language-none">-cc1 -triple x86_64-unknown-linux-gnu -emit-obj -mrelax-all --mrelax-relocations -disable-free -clear-ast-before-backend -main-file-name hello_clang.c -mrelocation-model static -mframe-pointer&#x3D;all -fmath-errno -ffp-contract&#x3D;on -fno-rounding-math -mconstructor-aliases -funwind-tables&#x3D;2 -target-cpu x86-64 -tune-cpu generic -mllvm -treat-scalable-fixed-error-as-warning -debugger-tuning&#x3D;gdb -fcoverage-compilation-dir&#x3D;&#x2F;home&#x2F;whitebird&#x2F;llvm-project&#x2F;build_debug&#x2F;bin -resource-dir &#x2F;home&#x2F;whitebird&#x2F;llvm-project&#x2F;build_debug&#x2F;lib&#x2F;clang&#x2F;14.0.0 -internal-isystem &#x2F;home&#x2F;whitebird&#x2F;llvm-project&#x2F;build_debug&#x2F;lib&#x2F;clang&#x2F;14.0.0&#x2F;include -internal-isystem &#x2F;usr&#x2F;local&#x2F;include -internal-isystem &#x2F;usr&#x2F;lib&#x2F;gcc&#x2F;x86_64-linux-gnu&#x2F;11&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;x86_64-linux-gnu&#x2F;include -internal-externc-isystem &#x2F;usr&#x2F;include&#x2F;x86_64-linux-gnu -internal-externc-isystem &#x2F;include -internal-externc-isystem &#x2F;usr&#x2F;include -fdebug-compilation-dir&#x3D;&#x2F;home&#x2F;whitebird&#x2F;llvm-project&#x2F;build_debug&#x2F;bin -ferror-limit 19 -fgnuc-version&#x3D;4.2.1 -flegacy-pass-manager -fcolor-diagnostics -load &#x2F;home&#x2F;whitebird&#x2F;llvm&#x2F;cmake-build-debug&#x2F;ollvm&#x2F;lib&#x2F;Transforms&#x2F;Obfuscation&#x2F;LLVMObfuscation1.so -mllvm -fla -faddrsig -D__GCC_HAVE_DWARF2_CFI_ASM&#x3D;1 -o &#x2F;tmp&#x2F;hello_clang-e00a33.o -x c &#x2F;home&#x2F;whitebird&#x2F;test&#x2F;hello_ollvm.c <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240118021224.png"></p>
<p>注意改成clang-14和把参数复制进去</p>
<p>现在需要做的是删除之前的异常代码，重新编译模块。</p>
<p>这个时候就已经可以正常调试了</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240118021322.png"></p>
<h1 id="19、调试ollvm-fla源码"><a href="#19、调试ollvm-fla源码" class="headerlink" title="19、调试ollvm-fla源码"></a>19、调试ollvm-fla源码</h1><p>测试代码</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">*</span> argv<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">int</span> a <span class="token operator">=</span> <span class="token function">atoi</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">switch</span> <span class="token punctuation">(</span>a<span class="token punctuation">)</span>
  <span class="token punctuation">&#123;</span>
  <span class="token keyword">case</span> <span class="token number">1</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"1!\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">break</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token keyword">case</span> <span class="token number">2</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"2!\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">break</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token keyword">case</span> <span class="token number">3</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"3!\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">break</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
    <span class="token keyword">break</span><span class="token punctuation">;</span>
  
  <span class="token keyword">default</span><span class="token operator">:</span>
    <span class="token keyword">break</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">if</span><span class="token punctuation">(</span>a <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token keyword">else</span>
    <span class="token keyword">return</span> <span class="token number">10</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>分别生成fla的ir和没有fla的ir</p>
<pre class="line-numbers language-none"><code class="language-none">clang -emit-llvm -S -mllvm -fla hello_ollvm.c -o hello_ollvm_fla.ll
clang -emit-llvm -S hello_ollvm.c -o hello_ollvm_src.ll<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>使用Beyond Compare查看</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240118172546.png"></p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240118172602.png"></p>
<p>可以看到基本块是一样的</p>
<p>我们看一下注册pass的代码，可以发现当执行fla的时候会执行两个pass</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240118172736.png"></p>
<p>我们把 PM.add(createLowerSwitchPass())移到下面，这样不加参数就会执行createLowerSwitchPass</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240118172959.png"></p>
<pre class="line-numbers language-none"><code class="language-none">clang -emit-llvm -S hello_ollvm.c -o hello_ollvm_no_fla_switch.ll<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>把hello_ollvm_no_fla_switch和hello_ollvm_src.ll进行比较，发现只改变了switch部分</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240118173933.png"></p>
<p>我们调试一下createLowerSwitchPass，它是把源代码中的switch转换成平坦化的操作</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240118175002.png"></p>
<p>看注释的意思也是差不多的</p>
<p>我们在之前的项目中打开LowerSwitch.cpp，然后下断点调试</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240118175445.png"></p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240118175748.png"></p>
<pre class="line-numbers language-none"><code class="language-none">-emit-llvm -S &#x2F;home&#x2F;whitebird&#x2F;test&#x2F;hello_ollvm.c -o &#x2F;home&#x2F;whitebird&#x2F;test&#x2F;hello_ollvm_no_fla_switch.ll<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>没有断下来，还是之前的问题，需要clang-14，直接用上一节的参数</p>
<pre class="line-numbers language-none"><code class="language-none">-cc1 -triple x86_64-unknown-linux-gnu -emit-obj -mrelax-all --mrelax-relocations -disable-free -clear-ast-before-backend -main-file-name hello_clang.c -mrelocation-model static -mframe-pointer&#x3D;all -fmath-errno -ffp-contract&#x3D;on -fno-rounding-math -mconstructor-aliases -funwind-tables&#x3D;2 -target-cpu x86-64 -tune-cpu generic -mllvm -treat-scalable-fixed-error-as-warning -debugger-tuning&#x3D;gdb -fcoverage-compilation-dir&#x3D;&#x2F;home&#x2F;whitebird&#x2F;llvm-project&#x2F;build_debug&#x2F;bin -resource-dir &#x2F;home&#x2F;whitebird&#x2F;llvm-project&#x2F;build_debug&#x2F;lib&#x2F;clang&#x2F;14.0.0 -internal-isystem &#x2F;home&#x2F;whitebird&#x2F;llvm-project&#x2F;build_debug&#x2F;lib&#x2F;clang&#x2F;14.0.0&#x2F;include -internal-isystem &#x2F;usr&#x2F;local&#x2F;include -internal-isystem &#x2F;usr&#x2F;lib&#x2F;gcc&#x2F;x86_64-linux-gnu&#x2F;11&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;x86_64-linux-gnu&#x2F;include -internal-externc-isystem &#x2F;usr&#x2F;include&#x2F;x86_64-linux-gnu -internal-externc-isystem &#x2F;include -internal-externc-isystem &#x2F;usr&#x2F;include -fdebug-compilation-dir&#x3D;&#x2F;home&#x2F;whitebird&#x2F;llvm-project&#x2F;build_debug&#x2F;bin -ferror-limit 19 -fgnuc-version&#x3D;4.2.1 -flegacy-pass-manager -fcolor-diagnostics -load &#x2F;home&#x2F;whitebird&#x2F;llvm&#x2F;cmake-build-debug&#x2F;ollvm&#x2F;lib&#x2F;Transforms&#x2F;Obfuscation&#x2F;LLVMObfuscation1.so -mllvm -fla -faddrsig -D__GCC_HAVE_DWARF2_CFI_ASM&#x3D;1 -o &#x2F;tmp&#x2F;hello_clang-e00a33.o -x c &#x2F;home&#x2F;whitebird&#x2F;test&#x2F;hello_ollvm.c <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>一直按F9就到了这个位置</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240118180340.png"></p>
<p>首先遍历entry，Cur代表着每个基本块</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240118180626.png"></p>
<p>这里是对基本块最后一条指令的地方进行转换成switch指令，如果成功就进入函数体内部</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240118180805.png"></p>
<p>ProcessSwitchInst内部就是把switch语句转换成链式的结构</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240118181239.png"></p>
<p>OrigBlock就是entry块</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240118181354.png"></p>
<p>F就是main块</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240118181428.png"></p>
<p>这个时候我们讲一下整个代码的结构</p>
<p>Module下面有很多Function，而Function下面有很多基本块，基本块是由不同种类的指令组成的，可以参考Instructions.h</p>
<pre class="line-numbers language-none"><code class="language-none">Module
	Function
		BasicBlock
			Instruction
			Instruction
			Instruction
			Instruction
			SwitchInst
			BranchInst
			ReturnInst
			LandingPadInst
			IndirectBrInst
			CatchReturnInst
			CatchSwitchInst
		BasicBlock
		BasicBlock
        BasicBlock
	Function
	Function
	Function
	Function
	Function
	Function<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>继续调试</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240118181926.png"></p>
<p>在经过Clusterify后，Cases的值为3，猜测这个函数的作用是计算switch有多少个分支，我们代码中也是3个</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240118182121.png"></p>
<p>如果case是空就返回了</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240118190416.png"></p>
<p>继续往下执行</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240118190647.png"></p>
<p>这里的Low代表着switch case里最小的值，High是最大的值</p>
<p>这里就是创建一个NewDefault块，然后通过  BranchInst::Create(Default, NewDefault)，让NewDefault跳到sw.default: </p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240118190939.png"></p>
<p>下面的函数是创建case块</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240118191314.png"></p>
<p>删除原来的switch case</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240118191438.png"></p>
<p>然后我们F9就跳到fla的断点处了</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240118191658.png"></p>
<p>这边有个随机的key，用来生成我们控制流平坦化的case值</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240118191730.png"></p>
<p>就是图中的值</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240118191804.png"></p>
<p>在一开始pass注册的时候，我们可以指定key，如果不指定就是随机的。当AesSeed固定后，平坦化中的case值也会固定</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240118191823.png"></p>
<p>设置AesSeed</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240118194030.png"></p>
<p>两次生成的结果是一样的</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240118194017.png"></p>
<p>遍历出14个基本块，这个时候遍历的ir是经过createLowerSwitchPass的</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240118204453.png"></p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240118204615.png"></p>
<p>origBB.erase(origBB.begin())是把entry块从vector中删了</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240118204707.png"></p>
<p>又获取了一次entry块，然后判断最后一行是否是跳转指令</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240118204905.png"></p>
<p>直接跳出判断，因为这里就一个分支，也就是无条件跳转</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240118205017.png"></p>
<p>把最后一行的跳转语句删了，创建了switchVar指令</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240118205120.png"></p>
<p>获取一个随机的整数，因为我们的key是固定了，所以这里获取的值也是固定的。创建了语句：把数字存到switchVar</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240118205419.png"></p>
<p>创建loopEntry和loopEnd</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240118205624.png"></p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240118205656.png"></p>
<p>在loopEntry中生成一条指令：把switchVar的值赋给switchVar</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240118205747.png"></p>
<p>把loopEntry移动到第一个，然后在entry插入一条指令：跳转到loopEntry</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240118205949.png"></p>
<p>在loopEnd创建一条跳转指令:跳转到loopEntry</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240118210103.png"></p>
<p>创建一个switchDefault，里面创建一条指令：跳转到loopEnd</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240118210231.png"></p>
<p>在loopEntry创建一个switch指令，此时还是0个case，此时的f-&gt;begin指向loopEntry</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240118210345.png"></p>
<p>删除跳转指令，然后创建一个跳转到loopEntry</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240118211750.png"></p>
<p>下面的属于重点，遍历所有的基础块，然后放到switch中，因为上面我们创建了一个switch，但是还没有case</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240118211815.png"></p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240118213426.png"></p>
<p>可以看到第一个i是NodeBlock8，也就是我们正常ir的除了entry的第一个基本块</p>
<p>i-&gt;moveBefore(loopEnd)就是把NodeBlock8添加到了loopEnd前面，其实就是尾插</p>
<p>设置case的值</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240118213554.png"></p>
<p>和我们最终的得到的switch case结果一致</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240118213614.png"></p>
<p>跳出这个循环，就是调整原有基本块与后继块的跳转</p>
<p>第一种情况，没有跳转分支了，就只有return指令了</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240118213833.png"></p>
<p>等于1代表非条件跳转，等于2代表条件跳转</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240118213916.png"></p>
<p>此时第一个要分析的就是NodeBlock8，它有两个分支</p>
<p>首先创建两个两个数numCaseTrue和numCaseFalse，对应的结果如图</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240118214701.png"></p>
<p>可以看到两个数分别代表两个case</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240118214913.png"></p>
<p>然后判断是否有一个值是空的，如果是空的代表要走默认分支</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240118214946.png"></p>
<p>通过 br i1 %Pivot9, label %LeafBlock, label %NodeBlock创建一个SelectInst</p>
<pre class="line-numbers language-none"><code class="language-none">%3 &#x3D; select i1 %Pivot9, i32 -1519555718, i32 241816174<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240118215134.png"></p>
<p>然后把br i1 %Pivot9, label %LeafBlock, label %NodeBlock删了</p>
<p>把sel的结果存起来，然后创建一个跳转分支:跳转到loopEnd</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240118215354.png"></p>
<p>我们继续调分支等于1的情况，可以看到sw.bb只有一个无条件跳转</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240118215513.png"></p>
<p>先得到要跳转的基本块是sw.epilog，然后删除  br label %sw.epilog，获取sw.epilog对应的case值</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240118220337.png"></p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240118220437.png"></p>
<p>把case值存起来，然后创建一个跳转到loodEnd的分支</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240118220507.png"></p>
<p>最后就是return跳出循环</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240118220557.png"></p>
<p>代码最后还有个fixstack，作用就是修复栈</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240118220639.png"></p>
<p>首先看看没fla但是经过lowerswitch和fla的寄存器变化，把%2寄存器变成了alloca </p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240118221819.png"></p>
<p>下面的比较都是用的这个声明出来的内存reg2mem</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240118221246.png"></p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240118221332.png"></p>
<p>最主要的判断就是是否已经声明了，并且现在处于entry块，如果没有声明，就看这些寄存器是否是entry和其他块都使用，如果是就加入到tmpReg，最后在DemoteRegToStack进行处理</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240118222004.png"></p>
<p>可以看到%0和%1寄存器都是entry自己使用，所以不处理。%2别的块也会使用，所以就会处理。</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/image-20240118222027929.png"></p>
<h1 id="20、调试ollvm-bcf源码"><a href="#20、调试ollvm-bcf源码" class="headerlink" title="20、调试ollvm-bcf源码"></a>20、调试ollvm-bcf源码</h1><p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240120170219.png"></p>
<p>首先我们先写几个函数，用来调试的时候打印ir</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">printIns</span><span class="token punctuation">(</span>Instruction<span class="token operator">*</span> instruction<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token function">errs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&lt;&lt;</span><span class="token operator">*</span>instruction<span class="token operator">&lt;&lt;</span><span class="token string">"\n"</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">void</span> <span class="token function">printBlock</span><span class="token punctuation">(</span>BasicBlock<span class="token operator">*</span>bb<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token comment">//iterator is Instruction</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>BasicBlock<span class="token operator">::</span>iterator iterator<span class="token operator">=</span>bb<span class="token operator">-></span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> end<span class="token operator">=</span>bb<span class="token operator">-></span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>iterator<span class="token operator">!=</span>end<span class="token punctuation">;</span>iterator<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">printIns</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token operator">*</span>iterator<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token function">errs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&lt;&lt;</span><span class="token string">"\n"</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">void</span> <span class="token function">printFunction</span><span class="token punctuation">(</span>Function <span class="token operator">&amp;</span>f<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token comment">//iterator is BasicBlock</span>
    <span class="token function">errs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&lt;&lt;</span><span class="token string">"\n========================================================================\n"</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>Function<span class="token operator">::</span>iterator iterator<span class="token operator">=</span>f<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>end <span class="token operator">=</span>f<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>end<span class="token operator">!=</span>iterator<span class="token punctuation">;</span>iterator<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">errs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&lt;&lt;</span>iterator<span class="token operator">-></span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&lt;&lt;</span><span class="token string">":\n"</span><span class="token punctuation">;</span>
        <span class="token function">printBlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token operator">*</span>iterator<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token function">errs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&lt;&lt;</span><span class="token string">"\n========================================================================\n"</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240120170312.png"></p>
<p>先看看正常的ir和bcf的ir对比</p>
<pre class="line-numbers language-none"><code class="language-none"> clang -Xclang -load -Xclang &#x2F;home&#x2F;whitebird&#x2F;llvm&#x2F;cmake-build-debug&#x2F;ollvm&#x2F;lib&#x2F;Transforms&#x2F;Obfuscation&#x2F;LLVMObfuscation1.so -flegacy-pass-manager -emit-llvm -S hello_ollvm.c -o hello_ollvm_src.ll


clang -Xclang -load -Xclang &#x2F;home&#x2F;whitebird&#x2F;llvm&#x2F;cmake-build-debug&#x2F;ollvm&#x2F;lib&#x2F;Transforms&#x2F;Obfuscation&#x2F;LLVMObfuscation1.so -flegacy-pass-manager -mllvm -bcf -emit-llvm -S hello_ollvm.c -o hello_ollvm_bcf.ll<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240120170822.png"></p>
<p>为了效果明显，我们加个-bcf_prob&#x3D;100，就是把每个块都混淆一下</p>
<pre class="line-numbers language-none"><code class="language-none">clang -Xclang -load -Xclang &#x2F;home&#x2F;whitebird&#x2F;llvm&#x2F;cmake-build-debug&#x2F;ollvm&#x2F;lib&#x2F;Transforms&#x2F;Obfuscation&#x2F;LLVMObfuscation1.so -flegacy-pass-manager -mllvm -bcf -mllvm -bcf_prob&#x3D;100 -emit-llvm -S hello_ollvm.c -o hello_ollvm_bcf.ll<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240120171748.png"></p>
<p>开始调试</p>
<pre class="line-numbers language-none"><code class="language-none">-Xclang -load -Xclang &#x2F;home&#x2F;whitebird&#x2F;llvm&#x2F;cmake-build-debug&#x2F;ollvm&#x2F;lib&#x2F;Transforms&#x2F;Obfuscation&#x2F;LLVMObfuscation1.so -flegacy-pass-manager -mllvm -bcf -mllvm -bcf_prob&#x3D;100 -emit-llvm -S &#x2F;home&#x2F;whitebird&#x2F;test&#x2F;hello_ollvm.c -o &#x2F;home&#x2F;whitebird&#x2F;test&#x2F;hello_ollvm_bcf_100.ll<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240120172123.png"></p>
<p>不知道为什么这次选clang和正常参数居然可以断下来调试了</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240120172344.png"></p>
<p>ObfTimes是上面注册的，通过参数传递进来，判断是否小于0，如果小于0就返回了。上面还注册了ObfProbRate，表示每个块被混淆的概率。</p>
<p>判断混淆的概率是否在0-100之间</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240120172458.png"></p>
<p>判断是否开启bcf</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240120172750.png"></p>
<p>进入bogus</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240120172737.png"></p>
<p>ObfTimes和ObfProbRate都有默认值，对于数值错误的情况下都会设置成默认值</p>
<p>ObfTimes&#x3D;1；ObfProbRate&#x3D;30</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240120172848.png"></p>
<p>把所有的基本块放到std::list&lt;BasicBlock *&gt;中</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240120173741.png"></p>
<p>size是9，我们看原来没变过的基本块也是9个</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240120173832.png"></p>
<p>因为我们的ObfProbRate&#x3D;100，所以进入分支</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240120174136.png"></p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240120174630.png"></p>
<p>现在我们打印一下两个参数</p>
<p>call printFunction(F)是把之前没有经过任何处理的ir打印出来</p>
<p>call printBlock(basicBlock)是打印了entry块</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240120174700.png"></p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240120174711.png"></p>
<p>BasicBlock::iterator i1 &#x3D; basicBlock-&gt;begin()取出了entry块的第一行指令</p>
<p>basicBlock-&gt;getFirstNonPHIOrDbgOrLifetime()返回基本块中的第一条非 PHI 指令。PHI 指令通常用于表示控制流图中的条件分支，而 getFirstNonPHIOrDbgOrLifetime() 会跳过这些特殊的 PHI 指令，直到找到基本块中的其他类型的指令。</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240120175023.png"></p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">if</span> <span class="token punctuation">(</span>basicBlock<span class="token operator">-></span><span class="token function">getFirstNonPHIOrDbgOrLifetime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
   i1 <span class="token operator">=</span> <span class="token punctuation">(</span>BasicBlock<span class="token operator">::</span>iterator<span class="token punctuation">)</span>basicBlock<span class="token operator">-></span><span class="token function">getFirstNonPHIOrDbgOrLifetime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>如果成立就把这条指令取出来，所以取出来的还是第一条指令，因为它不是控制流图中的条件分支</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">Twine <span class="token operator">*</span>var<span class="token punctuation">;</span>
var <span class="token operator">=</span> new <span class="token function">Twine</span><span class="token punctuation">(</span><span class="token string">"originalBB"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
BasicBlock <span class="token operator">*</span>originalBB <span class="token operator">=</span> basicBlock<span class="token operator">-></span><span class="token function">splitBasicBlock</span><span class="token punctuation">(</span>i1<span class="token punctuation">,</span> <span class="token operator">*</span>var<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>将给定的基本块 basicBlock 在指令 i1 处进行分割，得到一个新的基本块 originalBB，并设置新基本块的名称为 originalBB</p>
<p>可以打印一下现在整个源码的ir，此时entry会跳到originalBB</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240120175715.png"></p>
<p>createAlteredBasicBlock创建了一个alteredBB块，其实和originalBB一样的，只不过变量名发生了改变，这个块是一个虚假块</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240120181022.png"></p>
<p>打印一下整个源码的ir</p>
<pre class="line-numbers language-none"><code class="language-none">&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;
entry:
  br label %originalBB

originalBB:
  %retval &#x3D; alloca i32, align 4
  %argc.addr &#x3D; alloca i32, align 4
  %argv.addr &#x3D; alloca i8**, align 8
  %a &#x3D; alloca i32, align 4
  store i32 0, i32* %retval, align 4
  store i32 %argc, i32* %argc.addr, align 4
  store i8** %argv, i8*** %argv.addr, align 8
  %0 &#x3D; load i8**, i8*** %argv.addr, align 8
  %arrayidx &#x3D; getelementptr inbounds i8*, i8** %0, i64 1
  %1 &#x3D; load i8*, i8** %arrayidx, align 8
  %call &#x3D; call i32 @atoi(i8* noundef %1) #3
  store i32 %call, i32* %a, align 4
  %2 &#x3D; load i32, i32* %a, align 4
  switch i32 %2, label %sw.default [
    i32 1, label %sw.bb
    i32 2, label %sw.bb2
    i32 3, label %sw.bb4
  ]


...
...
...

originalBBalteredBB:
  %retvalalteredBB &#x3D; alloca i32, align 4
  %argc.addralteredBB &#x3D; alloca i32, align 4
  %argv.addralteredBB &#x3D; alloca i8**, align 8
  %aalteredBB &#x3D; alloca i32, align 4
  store i32 0, i32* %retvalalteredBB, align 4
  store i32 %argc, i32* %argc.addralteredBB, align 4
  store i8** %argv, i8*** %argv.addralteredBB, align 8
  %5 &#x3D; load i8**, i8*** %argv.addralteredBB, align 8
  %arrayidxalteredBB &#x3D; getelementptr inbounds i8*, i8** %5, i64 1
  %6 &#x3D; load i8*, i8** %arrayidxalteredBB, align 8
  %callalteredBB &#x3D; call i32 @atoi(i8* noundef %6) #3
  store i32 %callalteredBB, i32* %aalteredBB, align 4
  %7 &#x3D; load i32, i32* %aalteredBB, align 4
  switch i32 %7, label %sw.default [
    i32 1, label %sw.bb
    i32 2, label %sw.bb2
    i32 3, label %sw.bb4
  ]

&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>  alteredBB-&gt;getTerminator()-&gt;eraseFromParent()把originalBBalteredBB最后一行的switch删除了</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240120181447.png"></p>
<p>basicBlock-&gt;getTerminator()-&gt;eraseFromParent()把basicBlock的最后一行删了</p>
<p>entry只有一行指令，所以删完后，打印出来是空的</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240120181621.png"></p>
<p>创建了两个浮点数用作比较</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240120192103.png"></p>
<p>FCmpInst condition &#x3D; new FCmpInst(*basicBlock, FCmpInst::FCMP_TRUE, LHS, RHS, *var4)创建了一个浮点数比较指令，该指令在给定的基本块 basicBlock 中进行，而此时的basicBlock 是entry块。这个指令比较了两个操作数 LHS 和 RHS 的值，并根据指定的比较条件（在此处是 FCmpInst::FCMP_TRUE）来设置条件结果</p>
<p>参考:<a target="_blank" rel="noopener" href="https://llvm.org/docs/LangRef.html#fcmp-instruction">https://llvm.org/docs/LangRef.html#fcmp-instruction</a></p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240120192721.png"></p>
<p>设置成true就是恒成立，看一下现在的entry块</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240120192802.png"></p>
<p>创建一个分支，true跳向originalBB块，false跳向alteredBB块，condition是上面FCmpInst得到的，看似是两个浮点数比较，实际上始终返回true，也就是跳向originalBB</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240120193249.png"></p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240120193510.png"></p>
<p>虚假块的末尾插上 跳转到originalBB</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240120193624.png"></p>
<p>把originalBB块分割出originalBBpart2</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240120194109.png"></p>
<p>originalBB-&gt;getTerminator()-&gt;eraseFromParent()把跳转指令删除了</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240120194210.png"></p>
<p>又创建一个浮点数比较，但是还是恒返回true，插入到originalBB的尾部</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240120194309.png"></p>
<p>然后就结束了，我们比较一下对entry块的所有操作</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240120194806.png"></p>
<p>我们又跳到这个循环中，打印一下此时的basicBlock，也就是第二个基本块</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240120200724.png"></p>
<p>看一下执行完的效果</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240120200922.png"></p>
<p>虚假块</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240120200947.png"></p>
<p>剩下的基本块操作类似，就不展开了。</p>
<p>我们现在回过头调doF函数</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240120201045.png"></p>
<p>此时的ir</p>
<pre class="line-numbers language-none"><code class="language-none">&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;
entry:
  %condition &#x3D; fcmp true float 1.000000e+00, 1.000000e+00
  br i1 %condition, label %originalBB, label %originalBBalteredBB

originalBB:
  %retval &#x3D; alloca i32, align 4
  %argc.addr &#x3D; alloca i32, align 4
  %argv.addr &#x3D; alloca i8**, align 8
  %a &#x3D; alloca i32, align 4
  store i32 0, i32* %retval, align 4
  store i32 %argc, i32* %argc.addr, align 4
  store i8** %argv, i8*** %argv.addr, align 8
  %0 &#x3D; load i8**, i8*** %argv.addr, align 8
  %arrayidx &#x3D; getelementptr inbounds i8*, i8** %0, i64 1
  %1 &#x3D; load i8*, i8** %arrayidx, align 8
  %call &#x3D; call i32 @atoi(i8* noundef %1) #3
  store i32 %call, i32* %a, align 4
  %2 &#x3D; load i32, i32* %a, align 4
  %condition2 &#x3D; fcmp true float 1.000000e+00, 1.000000e+00
  br i1 %condition2, label %originalBBpart2, label %originalBBalteredBB

originalBBpart2:
  switch i32 %2, label %sw.default [
    i32 1, label %sw.bb
    i32 2, label %sw.bb2
    i32 3, label %sw.bb4
  ]

sw.bb:
  %condition7 &#x3D; fcmp true float 1.000000e+00, 1.000000e+00
  br i1 %condition7, label %originalBB6, label %originalBB6alteredBB

originalBB6:
  %call1 &#x3D; call i32 (i8*, ...) @printf(i8* noundef getelementptr inbounds ([5 x i8], [5 x i8]* @.str, i64 0, i64 0))
  %condition29 &#x3D; fcmp true float 1.000000e+00, 1.000000e+00
  br i1 %condition29, label %originalBBpart28, label %originalBB6alteredBB

originalBBpart28:
  br label %sw.epilog

sw.bb2:
  %condition11 &#x3D; fcmp true float 1.000000e+00, 1.000000e+00
  br i1 %condition11, label %originalBB10, label %originalBB10alteredBB

originalBB10:
  %call3 &#x3D; call i32 (i8*, ...) @printf(i8* noundef getelementptr inbounds ([5 x i8], [5 x i8]* @.str.1, i64 0, i64 0))
  %condition213 &#x3D; fcmp true float 1.000000e+00, 1.000000e+00
  br i1 %condition213, label %originalBBpart212, label %originalBB10alteredBB

originalBBpart212:
  br label %sw.epilog

sw.bb4:
  %condition15 &#x3D; fcmp true float 1.000000e+00, 1.000000e+00
  br i1 %condition15, label %originalBB14, label %originalBB14alteredBB

originalBB14:
  %call5 &#x3D; call i32 (i8*, ...) @printf(i8* noundef getelementptr inbounds ([5 x i8], [5 x i8]* @.str.2, i64 0, i64 0))
  %condition217 &#x3D; fcmp true float 1.000000e+00, 1.000000e+00
  br i1 %condition217, label %originalBBpart216, label %originalBB14alteredBB

originalBBpart216:
  br label %sw.epilog

sw.default:
  %condition19 &#x3D; fcmp true float 1.000000e+00, 1.000000e+00
  br i1 %condition19, label %originalBB18, label %originalBB18alteredBB

originalBB18:
  %condition221 &#x3D; fcmp true float 1.000000e+00, 1.000000e+00
  br i1 %condition221, label %originalBBpart220, label %originalBB18alteredBB

originalBBpart220:
  br label %sw.epilog

sw.epilog:
  %condition23 &#x3D; fcmp true float 1.000000e+00, 1.000000e+00
  br i1 %condition23, label %originalBB22, label %originalBB22alteredBB

originalBB22:
  %3 &#x3D; load i32, i32* %a, align 4
  %cmp &#x3D; icmp eq i32 %3, 0
  %condition225 &#x3D; fcmp true float 1.000000e+00, 1.000000e+00
  br i1 %condition225, label %originalBBpart224, label %originalBB22alteredBB

originalBBpart224:
  br i1 %cmp, label %if.then, label %if.else

if.then:
  %condition27 &#x3D; fcmp true float 1.000000e+00, 1.000000e+00
  br i1 %condition27, label %originalBB26, label %originalBB26alteredBB

originalBB26:
  store i32 1, i32* %retval, align 4
  %condition229 &#x3D; fcmp true float 1.000000e+00, 1.000000e+00
  br i1 %condition229, label %originalBBpart228, label %originalBB26alteredBB

originalBBpart228:
  br label %return

if.else:
  %condition31 &#x3D; fcmp true float 1.000000e+00, 1.000000e+00
  br i1 %condition31, label %originalBB30, label %originalBB30alteredBB

originalBB30:
  store i32 10, i32* %retval, align 4
  %condition233 &#x3D; fcmp true float 1.000000e+00, 1.000000e+00
  br i1 %condition233, label %originalBBpart232, label %originalBB30alteredBB

originalBBpart232:
  br label %return

return:
  %condition35 &#x3D; fcmp true float 1.000000e+00, 1.000000e+00
  br i1 %condition35, label %originalBB34, label %originalBB34alteredBB

originalBB34:
  %4 &#x3D; load i32, i32* %retval, align 4
  %condition237 &#x3D; fcmp true float 1.000000e+00, 1.000000e+00
  br i1 %condition237, label %originalBBpart236, label %originalBB34alteredBB

originalBBpart236:
  ret i32 %4

originalBBalteredBB:
  %retvalalteredBB &#x3D; alloca i32, align 4
  %argc.addralteredBB &#x3D; alloca i32, align 4
  %argv.addralteredBB &#x3D; alloca i8**, align 8
  %aalteredBB &#x3D; alloca i32, align 4
  store i32 0, i32* %retvalalteredBB, align 4
  store i32 %argc, i32* %argc.addralteredBB, align 4
  store i8** %argv, i8*** %argv.addralteredBB, align 8
  %5 &#x3D; load i8**, i8*** %argv.addralteredBB, align 8
  %arrayidxalteredBB &#x3D; getelementptr inbounds i8*, i8** %5, i64 1
  %6 &#x3D; load i8*, i8** %arrayidxalteredBB, align 8
  %callalteredBB &#x3D; call i32 @atoi(i8* noundef %6) #3
  store i32 %callalteredBB, i32* %aalteredBB, align 4
  %7 &#x3D; load i32, i32* %aalteredBB, align 4
  br label %originalBB

originalBB6alteredBB:
  %call1alteredBB &#x3D; call i32 (i8*, ...) @printf(i8* noundef getelementptr inbounds ([5 x i8], [5 x i8]* @.str, i64 0, i64 0))
  br label %originalBB6

originalBB10alteredBB:
  %call3alteredBB &#x3D; call i32 (i8*, ...) @printf(i8* noundef getelementptr inbounds ([5 x i8], [5 x i8]* @.str.1, i64 0, i64 0))
  br label %originalBB10

originalBB14alteredBB:
  %call5alteredBB &#x3D; call i32 (i8*, ...) @printf(i8* noundef getelementptr inbounds ([5 x i8], [5 x i8]* @.str.2, i64 0, i64 0))
  br label %originalBB14

originalBB18alteredBB:
  br label %originalBB18

originalBB22alteredBB:
  %8 &#x3D; load i32, i32* %a, align 4
  %cmpalteredBB &#x3D; icmp eq i32 %8, 0
  br label %originalBB22

originalBB26alteredBB:
  store i32 1, i32* %retval, align 4
  br label %originalBB26

originalBB30alteredBB:
  store i32 10, i32* %retval, align 4
  br label %originalBB30

originalBB34alteredBB:
  %9 &#x3D; load i32, i32* %retval, align 4
  br label %originalBB34


&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>创建两个浮点数变量，并且设置为全局变量</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240120201249.png"></p>
<p>第一个Module是最外层的，它的成员是Function</p>
<p> Instruction *tbb &#x3D; fi-&gt;getTerminator()拿出了的第一个基本块的最后一句指令</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240120211033.png"></p>
<p>判断是否是br指令，如果是就转为br指令</p>
<p>然后判断是否是有条件跳转，如果是就拿出它的跳转条件:%condition &#x3D; fcmp true float 1.000000e+00, 1.000000e+00</p>
<p>获取opcode，比较是否使用的fcmp</p>
<p>如果使用的fcmp，就判断是否是FCMP_TRUE，所以第一个基本块成立</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240120211206.png"></p>
<p>接下来处理toEdit，toEdit存放的都是符合条件的br指令</p>
<p>先加载了两个浮点数，x和y</p>
<p>创建sub、Urem、ICMP_EQ、ICMP_SLT指令</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240120211750.png"></p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240120212545.png"></p>
<p>urem是取余</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240120213817.png"></p>
<p>我们翻译成为伪代码 x*(x-1)%2和0作比较，y&lt;10,两者结果or一下</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240120213955.png"></p>
<p>然后在br i1 %condition, label %originalBB, label %originalBBalteredBB后面插入br i1 %7, label %originalBB, label %originalBBalteredBB，用 x*(x-1)%2|y&lt;10结果做条件跳转。</p>
<p>其实x和y在这里都是0，所以这个结果为1，还是恒跳转到originalBB</p>
<p>然后调用(*i)-&gt;eraseFromParent()把br i1 %condition, label %originalBB, label %originalBBalteredBB删了</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240120214244.png"></p>
<p>接下来就是把%condition &#x3D; fcmp true float 1.000000e+00, 1.000000e+00给删了</p>
<p>相当于替换了原先的条件跳转</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240120214505.png"></p>
<p>后面就没有了，bcf执行完毕</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240120214924.png"></p>
<h1 id="21、调试ollvm-sub源码"><a href="#21、调试ollvm-sub源码" class="headerlink" title="21、调试ollvm-sub源码"></a>21、调试ollvm-sub源码</h1><p>先看一下原版ir和sub之后的ir</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token keyword">const</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">int</span> n <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>argc <span class="token operator">+</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">16</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token number">0xF</span><span class="token punctuation">)</span> <span class="token operator">^</span> <span class="token number">33</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>n <span class="token operator">>=</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"hello ollvm:%d\r\n"</span><span class="token punctuation">,</span> n<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"hello whitebird\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240121200011.png"></p>
<p>对加法、减法、布尔运算都进行了指令替换的操作</p>
<p>现在开始调试</p>
<pre class="line-numbers language-none"><code class="language-none">-Xclang -load -Xclang &#x2F;home&#x2F;whitebird&#x2F;llvm&#x2F;cmake-build-debug&#x2F;ollvm&#x2F;lib&#x2F;Transforms&#x2F;Obfuscation&#x2F;LLVMObfuscation1.so -flegacy-pass-manager -mllvm -sub -emit-llvm -S &#x2F;home&#x2F;whitebird&#x2F;test&#x2F;hello_ollvm.c -o &#x2F;home&#x2F;whitebird&#x2F;test&#x2F;hello_ollvm_sub.ll<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240121200321.png"></p>
<p>先检测ObfTimes，默认是1，然后检测sub是否开启，如果开启就执行substitute</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240121200550.png"></p>
<p>遍历每一条指令，找到符合条件的，也就是inst-&gt;isBinaryOp())</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240121201035.png"></p>
<p>从定义中找到binaryOp的定义</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240121201128.png"></p>
<p>可以看到第一条进入处理的指令是%add &#x3D; add nsw i32 %0, 8，add是binaryOp</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240121201237.png"></p>
<p>根据binaryOp进行switch选择走对应的处理函数，不过源码中只实现了Add、Sub、And、Or、Xor对应的处理函数</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240121201410.png"></p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240121201423.png"></p>
<p>用函数指针进行调用，Add对应有四种指令替换，Sub有三种，And两种，Or两种，Xor两种</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240121202350.png"></p>
<p>比如addNeg和addDoubleNeg的实现就不一样</p>
<p>注释上写addNeg:a &#x3D; b - (-c)  addDoubleNeg：a &#x3D; -(-b + (-c))</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240121202507.png"></p>
<p>我们可以给这些函数都下个断点，然后继续调试</p>
<p>这里也是随机调用的</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240121202709.png"></p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">//对原始bo运算的第二个操作数求反,也就是%add = add nsw i32 %0, 8第二个操作数8求反</span>
op <span class="token operator">=</span> BinaryOperator<span class="token operator">::</span><span class="token function">CreateNeg</span><span class="token punctuation">(</span>bo<span class="token operator">-></span><span class="token function">getOperand</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">,</span> bo<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//原运算的第一个bo操作数和求反运算的结果相减</span>
op <span class="token operator">=</span>BinaryOperator<span class="token operator">::</span><span class="token function">Create</span><span class="token punctuation">(</span>Instruction<span class="token operator">::</span>Sub<span class="token punctuation">,</span> bo<span class="token operator">-></span><span class="token function">getOperand</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> op<span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">,</span> bo<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>重点关注这两行，%0-(-8)</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240121203730.png"></p>
<p>接着进入与操作</p>
<pre class="line-numbers language-none"><code class="language-none">&#x2F;&#x2F; Create NOT on second operand &#x3D;&gt; ~c
op &#x3D; BinaryOperator::CreateNot(bo-&gt;getOperand(1), &quot;&quot;, bo);

&#x2F;&#x2F; Create XOR &#x3D;&gt; (b^~c)
BinaryOperator *op1 &#x3D;
  BinaryOperator::Create(Instruction::Xor, bo-&gt;getOperand(0), op, &quot;&quot;, bo);

&#x2F;&#x2F; Create AND &#x3D;&gt; (b^~c) &amp; b
op &#x3D; BinaryOperator::Create(Instruction::And, op1, bo-&gt;getOperand(0), &quot;&quot;, bo);<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240121204306.png"></p>
<p>再接着就是or操作了，or操作替换的指令有点多，但是逻辑是a &#x3D; b | c &#x3D;&gt; a &#x3D; (b &amp; c) | (b ^ c)</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240121204710.png"></p>
<p>xor指令的替换指令也比较多，逻辑是a &#x3D; a ^ b &lt;&#x3D;&gt; (a ^ r) ^ (b ^ r) &lt;&#x3D;&gt; (!a &amp;&amp; r || a &amp;&amp; !r) ^ (!b &amp;&amp; r || b &amp;&amp; !r)</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240121204808.png"></p>
<p>对于加上-mllvm -sub_loop其实和上面类似，不过因为我们第一次指令替换完引入的新指令中都有add、xor等，所以在第二次指令替换时，就会对这些add、xor指令也做替换，就会导致代码很大，有点类似于代码膨胀</p>
<h1 id="22、调试ollvm-split源码"><a href="#22、调试ollvm-split源码" class="headerlink" title="22、调试ollvm-split源码"></a>22、调试ollvm-split源码</h1><p>测试代码</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token keyword">const</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">int</span> n <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>argc <span class="token operator">+</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">16</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token number">0xF</span><span class="token punctuation">)</span> <span class="token operator">^</span> <span class="token number">33</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>n <span class="token operator">>=</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"hello ollvm:%d\r\n"</span><span class="token punctuation">,</span> n<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"hello whitebird\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>对比原来的ir和split的ir</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240121210337.png"></p>
<pre class="line-numbers language-none"><code class="language-none">-Xclang -load -Xclang &#x2F;home&#x2F;whitebird&#x2F;llvm&#x2F;cmake-build-debug&#x2F;ollvm&#x2F;lib&#x2F;Transforms&#x2F;Obfuscation&#x2F;LLVMObfuscation1.so -flegacy-pass-manager -mllvm -split -emit-llvm -S &#x2F;home&#x2F;whitebird&#x2F;test&#x2F;hello_ollvm.c -o &#x2F;home&#x2F;whitebird&#x2F;test&#x2F;hello_ollvm_split.ll<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>判断要分割的数量是否在1-10之间</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240121224759.png"></p>
<p>默认值是2</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240121224744.png"></p>
<p>保存所有的基本块</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240121224907.png"></p>
<p>我们原来的ir就是4个基本块，现在取出第一个</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240121225058.png"></p>
<p>判断该基本块的大小是否小于2，可以看到我们有16行指令，也就是大小为16，如果小于2表示只有一行指令，自然不能分割。</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240121225147.png"></p>
<p>splitN太大就会被设置成基本块大小-1，防止不够分割</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240121225249.png"></p>
<p>把1到基本块大小的数放到test中，然后再进行打乱</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240121225928.png"></p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240121230025.png"></p>
<p>第一层循环是要分割的块数，是我们自己传入的，默认是2，第二层循环就是遍历指令找切割点</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240121230555.png"></p>
<p>没分割的ir</p>
<pre class="line-numbers language-none"><code class="language-none">%retval &#x3D; alloca i32, align 4
%argc.addr &#x3D; alloca i32, align 4
%argv.addr &#x3D; alloca i8**, align 8
%n &#x3D; alloca i32, align 4
store i32 0, i32* %retval, align 4
store i32 %argc, i32* %argc.addr, align 4
store i8** %argv, i8*** %argv.addr, align 8
%0 &#x3D; load i32, i32* %argc.addr, align 4
%add &#x3D; add nsw i32 %0, 8
%and &#x3D; and i32 %add, 16
%or &#x3D; or i32 %and, 15
%xor &#x3D; xor i32 %or, 33
store i32 %xor, i32* %n, align 4
%1 &#x3D; load i32, i32* %n, align 4
%cmp &#x3D; icmp sge i32 %1, 10
br i1 %cmp, label %if.then, label %if.else<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>BasicBlock::iterator it &#x3D; curr-&gt;begin()得到ir的第一行指令</p>
<pre class="line-numbers language-none"><code class="language-none">%retval &#x3D; alloca i32, align 4<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>test[i] - last为test[0]-0&#x3D;5,所以分割点在store i32 %argc, i32* %argc.addr, align 4</p>
<p>再把last设置为test[i]，用于下一次分割使用</p>
<p>toSplit &#x3D; toSplit-&gt;splitBasicBlock(it, toSplit-&gt;getName() + “.split”)开始对基本块进行分割，下面是分割完第一次的toSplit </p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240121231032.png"></p>
<p>第二次分割时，test[1]为13，last为5，所以j小于8，我们的it移动到toSplit+8的位置</p>
<p>可以看到是 %1 &#x3D; load i32, i32* %n, align 4</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240121231350.png"></p>
<p>执行分割，还剩一个基本块里面有三条指令，此时外层循环2次分割已经达到，所以就跳出循环了</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240121231536.png"></p>
<p>此时的整个源码的ir</p>
<pre class="line-numbers language-none"><code class="language-none">&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;
entry:
  %retval &#x3D; alloca i32, align 4
  %argc.addr &#x3D; alloca i32, align 4
  %argv.addr &#x3D; alloca i8**, align 8
  %n &#x3D; alloca i32, align 4
  store i32 0, i32* %retval, align 4
  br label %entry.split

entry.split:
  store i32 %argc, i32* %argc.addr, align 4
  store i8** %argv, i8*** %argv.addr, align 8
  %0 &#x3D; load i32, i32* %argc.addr, align 4
  %add &#x3D; add nsw i32 %0, 8
  %and &#x3D; and i32 %add, 16
  %or &#x3D; or i32 %and, 15
  %xor &#x3D; xor i32 %or, 33
  store i32 %xor, i32* %n, align 4
  br label %entry.split.split

entry.split.split:
  %1 &#x3D; load i32, i32* %n, align 4
  %cmp &#x3D; icmp sge i32 %1, 10
  br i1 %cmp, label %if.then, label %if.else

if.then:
  %2 &#x3D; load i32, i32* %n, align 4
  %call &#x3D; call i32 (i8*, ...) @printf(i8* noundef getelementptr inbounds ([17 x i8], [17 x i8]* @.str, i64 0, i64 0), i32 noundef %2)
  br label %if.end

if.else:
  %call1 &#x3D; call i32 (i8*, ...) @printf(i8* noundef getelementptr inbounds ([18 x i8], [18 x i8]* @.str.1, i64 0, i64 0))
  br label %if.end

if.end:
  ret i32 0


&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>每个新分割的块名都是原块名+.split，每多一次分割，.split也会多一次</p>
<p>取出第二个基本块开始分割</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240121231936.png"></p>
<p>size大小是2，成员分别是1和2</p>
<p>第二次分割的基本块还是大于2，所以可以继续执行分割</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240121232138.png"></p>
<p>两次分割完的ir</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240121232243.png"></p>
<p>后面的过程类似，就不展开分析了</p>
<h1 id="23、编写字符串加密pass"><a href="#23、编写字符串加密pass" class="headerlink" title="23、编写字符串加密pass"></a>23、编写字符串加密pass</h1><p>我们先准备一下pass的基本代码</p>
<p>Stringobf.h</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">OLLVM_STRINGOBF_H</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">OLLVM_STRINGOBF_H</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"llvm/ADT/Statistic.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"llvm/IR/Function.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"llvm/IR/Module.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"llvm/Pass.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"llvm/Support/CommandLine.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"llvm/Transforms/IPO.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"llvm/Transforms/Obfuscation/CryptoUtils.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"llvm/Transforms/Obfuscation/Utils.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"llvm/Transforms/Scalar.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"llvm/Transforms/Utils/Local.h"</span> <span class="token comment">// For DemoteRegToStack and DemotePHIToStack</span></span>

namespace llvm <span class="token punctuation">&#123;</span>
    Pass <span class="token operator">*</span><span class="token function">createStringObf</span><span class="token punctuation">(</span>bool flag<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span> <span class="token comment">// namespace llvm</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">//OLLVM_STRINGOBF_H</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>Stringobf.cpp</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"llvm/Transforms/Obfuscation/Stringobf.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"llvm/Transforms/Obfuscation/Utils.h"</span></span>
using namespace llvm<span class="token punctuation">;</span>

namespace <span class="token punctuation">&#123;</span>
    <span class="token keyword">struct</span> <span class="token class-name">StringObf</span> <span class="token operator">:</span> public FunctionPass <span class="token punctuation">&#123;</span>
        <span class="token keyword">static</span> <span class="token keyword">char</span> ID<span class="token punctuation">;</span> <span class="token comment">// Pass identification, replacement for typeid</span>
        bool flag<span class="token punctuation">;</span>

        <span class="token function">StringObf</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">FunctionPass</span><span class="token punctuation">(</span>ID<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
        <span class="token function">StringObf</span><span class="token punctuation">(</span>bool flag<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">FunctionPass</span><span class="token punctuation">(</span>ID<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> this<span class="token operator">-></span>flag <span class="token operator">=</span> flag<span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>

        bool <span class="token function">runOnFunction</span><span class="token punctuation">(</span>Function <span class="token operator">&amp;</span>F<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">toObfuscate</span><span class="token punctuation">(</span>flag<span class="token punctuation">,</span> <span class="token operator">&amp;</span>F<span class="token punctuation">,</span> <span class="token string">"enc_str"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>



            <span class="token punctuation">&#125;</span>
            <span class="token keyword">return</span> false<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">char</span> StringObf<span class="token operator">::</span>ID <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">static</span> RegisterPass<span class="token operator">&lt;</span>StringObf<span class="token operator">></span> <span class="token function">X</span><span class="token punctuation">(</span><span class="token string">"enc_str"</span><span class="token punctuation">,</span> <span class="token string">"String obf"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

Pass <span class="token operator">*</span>llvm<span class="token operator">::</span><span class="token function">createStringObf</span><span class="token punctuation">(</span>bool flag<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> new <span class="token function">StringObf</span><span class="token punctuation">(</span>flag<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>enrty.cpp</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> cl<span class="token operator">::</span>opt<span class="token operator">&lt;</span>bool<span class="token operator">></span> <span class="token function">StringEnc</span><span class="token punctuation">(</span><span class="token string">"enc_str"</span><span class="token punctuation">,</span> cl<span class="token operator">::</span><span class="token function">init</span><span class="token punctuation">(</span>false<span class="token punctuation">)</span><span class="token punctuation">,</span>
                           cl<span class="token operator">::</span><span class="token function">desc</span><span class="token punctuation">(</span><span class="token string">"String encode"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                           
PM<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token function">createStringObf</span><span class="token punctuation">(</span>StringEnc<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                           <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>剩下最重要的核心逻辑,如何把c++的加密方式在pass中实现</p>
<p>我们的功能是实现字符串加密，那么第一步应该是取得这个函数中的全部字符串，那么我们先看看ir中字符串的特征</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240124202954.png"></p>
<p>可以看到，这个str是一个操作数，想要获取全部字符串，就得先遍历所有指令块中的操作数。然后再根据字符串的特征来进行过滤。</p>
<p>下面先看如何遍历所有指令块。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">bool <span class="token function">runOnFunction</span><span class="token punctuation">(</span>Function <span class="token operator">&amp;</span>F<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">toObfuscate</span><span class="token punctuation">(</span>flag<span class="token punctuation">,</span> <span class="token operator">&amp;</span>F<span class="token punctuation">,</span> <span class="token string">"enc_str"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token comment">//遍历函数中每一个基本块</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span>BasicBlock <span class="token operator">&amp;</span>bb <span class="token operator">:</span>F<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token comment">//遍历基本块中每一条指令</span>
                   <span class="token comment">// errs() &lt;&lt;  bb.getName() &lt;&lt; "\r\n";</span>
                    <span class="token keyword">for</span><span class="token punctuation">(</span>Instruction <span class="token operator">&amp;</span> ins <span class="token operator">:</span>bb<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
                       <span class="token comment">// errs() &lt;&lt; ins &lt;&lt; "\r\n";</span>
                        <span class="token comment">//访问指令（Instruction）的操作数（operands）</span>
                        <span class="token keyword">for</span><span class="token punctuation">(</span>Value <span class="token operator">*</span>val<span class="token operator">:</span>ins<span class="token punctuation">.</span><span class="token function">operands</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
                            <span class="token comment">//相当于val但删除了任何指针强制转换</span>
                            Value<span class="token operator">*</span> stripOp<span class="token operator">=</span>val<span class="token operator">-></span><span class="token function">stripPointerCasts</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token keyword">if</span><span class="token punctuation">(</span>stripOp<span class="token operator">-></span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token string">".str"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
                                <span class="token function">errs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&lt;&lt;</span>ins<span class="token operator">&lt;&lt;</span><span class="token string">"\n"</span><span class="token punctuation">;</span>
                                <span class="token function">errs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&lt;&lt;</span><span class="token operator">*</span>val<span class="token operator">&lt;&lt;</span><span class="token string">"\n"</span><span class="token punctuation">;</span>
                                <span class="token function">errs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&lt;&lt;</span><span class="token operator">*</span>stripOp<span class="token operator">&lt;&lt;</span><span class="token string">"\n"</span><span class="token punctuation">;</span>
                            <span class="token punctuation">&#125;</span>
                        <span class="token punctuation">&#125;</span>
                    <span class="token punctuation">&#125;</span>
                <span class="token punctuation">&#125;</span>


            <span class="token punctuation">&#125;</span>
            <span class="token keyword">return</span> false<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>然后开始运行</p>
<pre class="line-numbers language-none"><code class="language-none">-Xclang -load -Xclang &#x2F;home&#x2F;whitebird&#x2F;llvm&#x2F;cmake-build-debug&#x2F;ollvm&#x2F;lib&#x2F;Transforms&#x2F;Obfuscation&#x2F;LLVMObfuscation1.so -flegacy-pass-manager -mllvm -enc_str -emit-llvm -S &#x2F;home&#x2F;whitebird&#x2F;test&#x2F;hello_ollvm.c -o &#x2F;home&#x2F;whitebird&#x2F;test&#x2F;hello_ollvm_enc_str.ll<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>上面遍历了函数中的所有基本快，然后遍历所有指令块，然后遍历所有操作数，然后获取操作数的值，判断该操作数是否是一个字符串，并且打印这个指令块，操作数，以及取到的操作数的值，下面看看打印的结果</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240124204138.png"></p>
<p>那么看到了，我们想获取的字符串是在stripOp中。那么接下来就把所有字符串全部获取出来并转换成string</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">//封装一个转换操作数值为字符串的函数</span>
std<span class="token operator">::</span>string  <span class="token function">ConvertOpToString</span><span class="token punctuation">(</span>Value<span class="token operator">*</span> op<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    GlobalVariable<span class="token operator">*</span> globalVar<span class="token operator">=</span> dyn_cast<span class="token operator">&lt;</span>GlobalVariable<span class="token operator">></span><span class="token punctuation">(</span>op<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>globalVar<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token function">errs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&lt;&lt;</span><span class="token string">"dyn cast gloabl err"</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token string">""</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    ConstantDataSequential<span class="token operator">*</span> cds<span class="token operator">=</span>dyn_cast<span class="token operator">&lt;</span>ConstantDataSequential<span class="token operator">></span><span class="token punctuation">(</span>globalVar<span class="token operator">-></span><span class="token function">getInitializer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>cds<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token function">errs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&lt;&lt;</span><span class="token string">"dyn cast constant data err"</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token string">""</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">return</span> cds<span class="token operator">-></span><span class="token function">getRawDataValues</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>之前看到的字符串的ir代码看到所有字符串都是全局的，所以要先转换成全局的对象，然后再转换成数值。然后看这里的打印结果</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240124205334.png"></p>
<p>获取到所有的字符串了之后。接下来。我们要先把这个字符串加密，然后再用插入指令块来进行解密。下面继续完善，先把之前搞好的加密算法迁移进来。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token class-name">uint8_t</span> randkey<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
randkey<span class="token operator">=</span>llvm<span class="token operator">::</span>cryptoutils<span class="token operator">-></span><span class="token class-name">get_uint8_t</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>strdata<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    strdata<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">^=</span>randkey<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240124235231.png"></p>
<p>接下来的处理就是插入指令块来对这个加密数据strdata进行解密还原处理。</p>
<p>我们想要处理这个加密后的数据，首先要申请内存来存放这个加密后的数据,然后再对加密后的数据遍历进行还原。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">//创建一个LLVM数组类型 (ArrayType)，其元素类型为i8（8位整数，通常用于表示字符）和指定的大小(strdata.size())</span>
ArrayType<span class="token operator">*</span> arrType<span class="token operator">=</span>ArrayType<span class="token operator">::</span><span class="token function">get</span><span class="token punctuation">(</span>Type<span class="token operator">::</span><span class="token function">getInt8Ty</span><span class="token punctuation">(</span>F<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>strdata<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//创建一个LLVM分配指令 (AllocaInst)，用于在堆栈上保留内存以存储数组</span>
AllocaInst<span class="token operator">*</span> allocaInst<span class="token operator">=</span>new <span class="token function">AllocaInst</span><span class="token punctuation">(</span>
        arrType<span class="token punctuation">,</span>
        <span class="token number">0</span><span class="token punctuation">,</span>
        llvm<span class="token operator">::</span>ConstantInt<span class="token operator">::</span><span class="token function">get</span><span class="token punctuation">(</span>Type<span class="token operator">::</span><span class="token function">getInt32Ty</span><span class="token punctuation">(</span>F<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> strdata<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">Twine</span><span class="token punctuation">(</span>stripOp<span class="token operator">-></span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">".array"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token operator">&amp;</span>ins
<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//创建一个Twine对象，它是一个轻量级字符串表示形式</span>
Twine<span class="token operator">*</span> twine_bitcast <span class="token operator">=</span> new <span class="token function">Twine</span><span class="token punctuation">(</span>stripOp<span class="token operator">-></span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">".bitcast"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//创建一个位广播指令(BitCastInst)，用于转换指针类型。它将指针“allocaInst”转换为“i8*”类型的指针（指向8位整数的指针，通常用于表示字节地址）</span>
BitCastInst<span class="token operator">*</span> bitCastInst_str <span class="token operator">=</span> new <span class="token function">BitCastInst</span><span class="token punctuation">(</span>allocaInst<span class="token punctuation">,</span> Type<span class="token operator">::</span><span class="token function">getInt8PtrTy</span><span class="token punctuation">(</span>F<span class="token punctuation">.</span><span class="token function">getParent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> twine_bitcast<span class="token operator">-></span><span class="token function">str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>ins<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240124232550.png"></p>
<p>接下来就是解密的逻辑处理</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">bool <span class="token function">runOnFunction</span><span class="token punctuation">(</span>Function <span class="token operator">&amp;</span>F<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            IRBuilder<span class="token operator">&lt;</span><span class="token operator">></span> <span class="token function">builder</span><span class="token punctuation">(</span>F<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">toObfuscate</span><span class="token punctuation">(</span>flag<span class="token punctuation">,</span> <span class="token operator">&amp;</span>F<span class="token punctuation">,</span> <span class="token string">"enc_str"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token comment">//遍历函数中每一个基本块</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span>BasicBlock <span class="token operator">&amp;</span>bb <span class="token operator">:</span>F<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token comment">//遍历基本块中每一条指令</span>
                   <span class="token comment">// errs() &lt;&lt;  bb.getName() &lt;&lt; "\r\n";</span>
                    <span class="token keyword">for</span><span class="token punctuation">(</span>Instruction <span class="token operator">&amp;</span> ins <span class="token operator">:</span>bb<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
                       <span class="token comment">// errs() &lt;&lt; ins &lt;&lt; "\r\n";</span>
                        <span class="token comment">//访问指令（Instruction）的操作数（operands）</span>
                        <span class="token keyword">for</span><span class="token punctuation">(</span>Value <span class="token operator">*</span>val<span class="token operator">:</span>ins<span class="token punctuation">.</span><span class="token function">operands</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
                            <span class="token comment">//相当于val但删除了任何指针强制转换</span>
                            Value<span class="token operator">*</span> stripOp<span class="token operator">=</span>val<span class="token operator">-></span><span class="token function">stripPointerCasts</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            GlobalVariable<span class="token operator">*</span> globalVar<span class="token operator">=</span> dyn_cast<span class="token operator">&lt;</span>GlobalVariable<span class="token operator">></span><span class="token punctuation">(</span>stripOp<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token keyword">if</span><span class="token punctuation">(</span>stripOp<span class="token operator">-></span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token string">".str"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
                                <span class="token function">errs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&lt;&lt;</span>ins<span class="token operator">&lt;&lt;</span><span class="token string">"\n"</span><span class="token punctuation">;</span>
<span class="token comment">//                                errs()&lt;&lt;*val&lt;&lt;"\n";</span>
<span class="token comment">//                                errs()&lt;&lt;*stripOp&lt;&lt;"\n";</span>
                                std<span class="token operator">::</span>string strdata<span class="token operator">=</span><span class="token function">ConvertOpToString</span><span class="token punctuation">(</span>stripOp<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token function">errs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&lt;&lt;</span>strdata<span class="token operator">&lt;&lt;</span><span class="token string">"\n"</span><span class="token punctuation">;</span>

                                <span class="token class-name">uint8_t</span> randkey<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
                                randkey<span class="token operator">=</span>llvm<span class="token operator">::</span>cryptoutils<span class="token operator">-></span><span class="token class-name">get_uint8_t</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                                <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>strdata<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                                    strdata<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">^=</span>randkey<span class="token punctuation">;</span>
                                <span class="token punctuation">&#125;</span>


                                ArrayType<span class="token operator">*</span> arrType<span class="token operator">=</span>ArrayType<span class="token operator">::</span><span class="token function">get</span><span class="token punctuation">(</span>Type<span class="token operator">::</span><span class="token function">getInt8Ty</span><span class="token punctuation">(</span>F<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>strdata<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                AllocaInst<span class="token operator">*</span> allocaInst<span class="token operator">=</span>new <span class="token function">AllocaInst</span><span class="token punctuation">(</span>
                                        arrType<span class="token punctuation">,</span>
                                        <span class="token number">0</span><span class="token punctuation">,</span>
                                        llvm<span class="token operator">::</span>ConstantInt<span class="token operator">::</span><span class="token function">get</span><span class="token punctuation">(</span>Type<span class="token operator">::</span><span class="token function">getInt32Ty</span><span class="token punctuation">(</span>F<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> strdata<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                        <span class="token function">Twine</span><span class="token punctuation">(</span>stripOp<span class="token operator">-></span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">".array"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                        <span class="token operator">&amp;</span>ins
                                <span class="token punctuation">)</span><span class="token punctuation">;</span>
                              Twine<span class="token operator">*</span> twine_bitcast <span class="token operator">=</span> new <span class="token function">Twine</span><span class="token punctuation">(</span>stripOp<span class="token operator">-></span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">".bitcast"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                              BitCastInst<span class="token operator">*</span> bitCastInst_str <span class="token operator">=</span> new <span class="token function">BitCastInst</span><span class="token punctuation">(</span>allocaInst<span class="token punctuation">,</span> Type<span class="token operator">::</span><span class="token function">getInt8PtrTy</span><span class="token punctuation">(</span>F<span class="token punctuation">.</span><span class="token function">getParent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> twine_bitcast<span class="token operator">-></span><span class="token function">str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>ins<span class="token punctuation">)</span><span class="token punctuation">;</span>

                              ConstantInt<span class="token operator">*</span> constantInt_xor_key <span class="token operator">=</span> ConstantInt<span class="token operator">::</span><span class="token function">get</span><span class="token punctuation">(</span>Type<span class="token operator">::</span><span class="token function">getInt8Ty</span><span class="token punctuation">(</span>F<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> randkey<span class="token punctuation">)</span><span class="token punctuation">;</span>
                              AllocaInst<span class="token operator">*</span> allocaInst_xor_key <span class="token operator">=</span> new <span class="token function">AllocaInst</span><span class="token punctuation">(</span>
                                      Type<span class="token operator">::</span><span class="token function">getInt8Ty</span><span class="token punctuation">(</span>F<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                      <span class="token number">0</span><span class="token punctuation">,</span>
                                      nullptr<span class="token punctuation">,</span>
                                      <span class="token function">Twine</span><span class="token punctuation">(</span>stripOp<span class="token operator">-></span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">".key"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                      <span class="token operator">&amp;</span>ins
                                      <span class="token punctuation">)</span><span class="token punctuation">;</span>

                              StoreInst<span class="token operator">*</span> storeInst1_xor_key <span class="token operator">=</span> new <span class="token function">StoreInst</span><span class="token punctuation">(</span>constantInt_xor_key<span class="token punctuation">,</span> allocaInst_xor_key<span class="token punctuation">,</span><span class="token operator">&amp;</span>ins<span class="token punctuation">)</span><span class="token punctuation">;</span>
                              LoadInst<span class="token operator">*</span> loadInst_xor_key <span class="token operator">=</span> new <span class="token function">LoadInst</span><span class="token punctuation">(</span>Type<span class="token operator">::</span><span class="token function">getInt8Ty</span><span class="token punctuation">(</span>F<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>allocaInst_xor_key<span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>ins<span class="token punctuation">)</span><span class="token punctuation">;</span>

                                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> strdata<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                                    <span class="token comment">//创建了一个表示8位整数值i的常量整数指令</span>
                                    ConstantInt<span class="token operator">*</span> index <span class="token operator">=</span> ConstantInt<span class="token operator">::</span><span class="token function">get</span><span class="token punctuation">(</span>Type<span class="token operator">::</span><span class="token function">getInt8Ty</span><span class="token punctuation">(</span>F<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                    <span class="token comment">//创建一个 GetElementPtrInst 指令，用于从数组中取元素</span>
                                    GetElementPtrInst<span class="token operator">*</span> getElementPtrInst <span class="token operator">=</span> GetElementPtrInst<span class="token operator">::</span><span class="token function">CreateInBounds</span><span class="token punctuation">(</span>
                                            arrType<span class="token punctuation">,</span>
                                            allocaInst<span class="token punctuation">,</span>
                                            index<span class="token punctuation">,</span>
                                            <span class="token function">Twine</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span>
                                            <span class="token punctuation">)</span><span class="token punctuation">;</span>
                                    getElementPtrInst<span class="token operator">-></span><span class="token function">insertBefore</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ins<span class="token punctuation">)</span><span class="token punctuation">;</span>


                                    <span class="token comment">//创建一 ConstantInt实例，表示一个8位整数的常量，其值是 strdata[i] 中的一个字符的 ASCII 值，将每个字符转换为相应的ASCII</span>
                                    ConstantInt<span class="token operator">*</span> enc_ch <span class="token operator">=</span> ConstantInt<span class="token operator">::</span><span class="token function">get</span><span class="token punctuation">(</span>Type<span class="token operator">::</span><span class="token function">getInt8Ty</span><span class="token punctuation">(</span>F<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> strdata<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                    BinaryOperator<span class="token operator">*</span> xor_inst <span class="token operator">=</span> BinaryOperator<span class="token operator">::</span><span class="token function">CreateXor</span><span class="token punctuation">(</span>enc_ch<span class="token punctuation">,</span> loadInst_xor_key<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                    <span class="token comment">//这里有bug，在llvm14上用不了，还没有修好bug</span>
                                    StoreInst<span class="token operator">*</span> storeInst <span class="token operator">=</span>  new <span class="token function">StoreInst</span><span class="token punctuation">(</span>xor_inst<span class="token punctuation">,</span> getElementPtrInst<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                    storeInst<span class="token operator">-></span><span class="token function">insertAfter</span><span class="token punctuation">(</span>xor_inst<span class="token punctuation">)</span><span class="token punctuation">;</span>

                               <span class="token punctuation">&#125;</span>
                                    val<span class="token operator">-></span><span class="token function">replaceAllUsesWith</span><span class="token punctuation">(</span>bitCastInst_str<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                    globalVar<span class="token operator">-></span><span class="token function">eraseFromParent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token punctuation">&#125;</span>
                        <span class="token punctuation">&#125;</span>
                    <span class="token punctuation">&#125;</span>
                <span class="token punctuation">&#125;</span>


            <span class="token punctuation">&#125;</span>
            <span class="token keyword">return</span> false<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240125194631.png"></p>
<h1 id="24、移植OLLVM到NDK中"><a href="#24、移植OLLVM到NDK中" class="headerlink" title="24、移植OLLVM到NDK中"></a>24、移植OLLVM到NDK中</h1><p>1、将ollvm移植到llvm源码中<br>2、将llvm编译：Release版本</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240125205235.png"></p>
<p>3、下载AndroidNDK，将编译的Relase版本的bin，lib，include目录复制到AndroidNDK的android-ndk&#x2F;toolchains&#x2F;llvm&#x2F;prebuilt&#x2F;linux-86_64&#x2F;目录下</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240125205532.png">4、Android studio项目，在Gradle Scripts目录下的local.properties文件中添加ndk.dir&#x3D;步骤3中配置的ndk路径</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240125210059.png"></p>
<p>5、在cpp目录下的CMakeLists.txt中添加 add_definitions(“-mllvm -fla”)</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240125210630.png"></p>
<p>经过覆盖后，打开AS编译项目会报找不到 libunwind 等库的错，原因就是缺少lib&#x2F;clang&#x2F;…这些库</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240125220729.png"></p>
<p>将 lib64 里的 clang 复制到 lib 目录</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240125222218.png"></p>
<p>把名字改成与clang版本相同</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240125222242.png"></p>
<p>现在把编译好的app拿出来进行分析</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240125222355.png"></p>
<p>放到ida发现没效果，换了另外一个方法</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240126000515.png"></p>
<pre class="line-numbers language-none"><code class="language-none">set(CMAKE_C_FLAGS &quot;$&#123;CMAKE_C_FLAGS&#125; -mllvm -fla -mllvm -split -mllvm -split_num&#x3D;3&quot;)
set(CMAKE_CXX_FLAGS &quot;$&#123;CMAKE_CXX_FLAGS&#125; -mllvm -fla -mllvm -split -mllvm -split_num&#x3D;3&quot;)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240126000456.png"></p>
<h1 id="25、利用IDA-Trace分析被OLLVM混淆的算法"><a href="#25、利用IDA-Trace分析被OLLVM混淆的算法" class="headerlink" title="25、利用IDA Trace分析被OLLVM混淆的算法"></a>25、利用IDA Trace分析被OLLVM混淆的算法</h1><p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240127224725.png"></p>
<p>随机生成一个字符串，在 UUIDCheckSum中处理，而 UUIDCheckSum是一个native函数，所以我们重点分析native</p>
<p>存在ollvm</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240127224817.png"></p>
<p>对于ollvm，我们一般都是交叉引用跟</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240127224925.png"></p>
<p>r	46	62	            v16 &#x3D; (*(*p_ReleaseStringUTFChars + 1352LL))(env, uuid, 0LL);解析的有问题</p>
<p>我们按Y改一下类型</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240127225036.png"></p>
<p>可以看到就是获取uuid的长度和内容</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240127225242.png"></p>
<p>我们继续跟native_uuid</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240127225328.png"></p>
<p>strdup()函数:将字符串复制到新建立的空间,所以我们继续跟random_str</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240127225418.png"></p>
<p>这时候就得进入uuid_checksum分析了</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240127225500.png"></p>
<p>也是比较复杂的，得慢慢跟，现在我们介绍trace分析的方法</p>
<p>先介绍一下ida的trace</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240127230127.png"></p>
<pre class="line-numbers language-none"><code class="language-none">（1）Instruction tracing
调试器将为每条指令保存所有修改后的寄存器值。
https:&#x2F;&#x2F;www.hex-rays.com&#x2F;products&#x2F;ida&#x2F;support&#x2F;idadoc&#x2F;1446.shtml

（2）Basic block tracing
调试器将保存到达临时基本块断点的所有地址。
https:&#x2F;&#x2F;www.hex-rays.com&#x2F;products&#x2F;ida&#x2F;support&#x2F;idadoc&#x2F;1628.shtml

（3）Function tracing
调试器将保存发生函数调用或函数返回的所有地址。
https:&#x2F;&#x2F;www.hex-rays.com&#x2F;products&#x2F;ida&#x2F;support&#x2F;idadoc&#x2F;1447.shtml<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>我们现在开始trace,首先创建一个空的ida，然后开启ida的调试server:android_server64</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240127231108.png"></p>
<p>这边我们转发了端口是为了防止有一些app会检测ida的调试端口</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240127231313.png"></p>
<p>然后搜索我们要调试的app</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240127231418.png"></p>
<p>现在按F9就可以运行起来</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240127231543.png"></p>
<p>我们分析java层代码发现有个logcat会记录输入输出，所以我们也监控一下</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240127231651.png"></p>
<p>现在需要加载我们的trace脚本</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># -*- coding: utf-8 -*-</span>

<span class="token keyword">import</span> idaapi
<span class="token keyword">import</span> idc
<span class="token keyword">import</span> re
<span class="token keyword">import</span> ida_dbg
<span class="token keyword">import</span> ida_idd
<span class="token keyword">from</span> idaapi <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token keyword">from</span> collections <span class="token keyword">import</span> OrderedDict
<span class="token keyword">import</span> logging
<span class="token keyword">import</span> time
<span class="token keyword">import</span> datetime
<span class="token keyword">import</span> os


debughook <span class="token operator">=</span> <span class="token boolean">None</span>

<span class="token keyword">def</span> <span class="token function">xx_hex</span><span class="token punctuation">(</span>ea<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> <span class="token builtin">hex</span><span class="token punctuation">(</span>ea<span class="token punctuation">)</span><span class="token punctuation">.</span>rstrip<span class="token punctuation">(</span><span class="token string">"L"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>lstrip<span class="token punctuation">(</span><span class="token string">"0x"</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">set_breakpoint</span><span class="token punctuation">(</span>ea<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment">#idc.SetReg(ea, "T", 1)</span>
    idc<span class="token punctuation">.</span>MakeCode<span class="token punctuation">(</span>ea<span class="token punctuation">)</span>
    idc<span class="token punctuation">.</span>add_bpt<span class="token punctuation">(</span>ea<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">my_get_reg_value</span><span class="token punctuation">(</span>register<span class="token punctuation">)</span><span class="token punctuation">:</span>
    rv <span class="token operator">=</span> ida_idd<span class="token punctuation">.</span>regval_t<span class="token punctuation">(</span><span class="token punctuation">)</span>
    ida_dbg<span class="token punctuation">.</span>get_reg_val<span class="token punctuation">(</span>register<span class="token punctuation">,</span> rv<span class="token punctuation">)</span>
    current_addr <span class="token operator">=</span> rv<span class="token punctuation">.</span>ival
    <span class="token keyword">return</span> current_addr


<span class="token keyword">def</span> <span class="token function">suspend_other_thread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    current_thread <span class="token operator">=</span> idc<span class="token punctuation">.</span>get_current_thread<span class="token punctuation">(</span><span class="token punctuation">)</span>
    thread_count <span class="token operator">=</span> idc<span class="token punctuation">.</span>get_thread_qty<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> thread_count<span class="token punctuation">)</span><span class="token punctuation">:</span>
        other_thread <span class="token operator">=</span> idc<span class="token punctuation">.</span>getn_thread<span class="token punctuation">(</span>i<span class="token punctuation">)</span>
        <span class="token keyword">if</span> other_thread <span class="token operator">!=</span> current_thread<span class="token punctuation">:</span>
            idc<span class="token punctuation">.</span>suspend_thread<span class="token punctuation">(</span>other_thread<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">resume_process</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    current_thread <span class="token operator">=</span> idc<span class="token punctuation">.</span>get_current_thread<span class="token punctuation">(</span><span class="token punctuation">)</span>
    thread_count <span class="token operator">=</span> idc<span class="token punctuation">.</span>get_thread_qty<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> thread_count<span class="token punctuation">)</span><span class="token punctuation">:</span>
        other_thread <span class="token operator">=</span> idc<span class="token punctuation">.</span>getn_thread<span class="token punctuation">(</span>i<span class="token punctuation">)</span>
        <span class="token keyword">if</span> other_thread <span class="token operator">!=</span> current_thread<span class="token punctuation">:</span>
            idc<span class="token punctuation">.</span>resume_thread<span class="token punctuation">(</span>other_thread<span class="token punctuation">)</span>
    idc<span class="token punctuation">.</span>resume_thread<span class="token punctuation">(</span>current_thread<span class="token punctuation">)</span>
    idc<span class="token punctuation">.</span>resume_process<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">class</span> <span class="token class-name">MyDbgHook</span><span class="token punctuation">(</span>DBG_Hooks<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">""" Own debug hook class that implementd the callback functions """</span>

    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> modules_info<span class="token punctuation">,</span> skip_functions<span class="token punctuation">,</span> end_ea<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>MyDbgHook<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>modules_info <span class="token operator">=</span> modules_info
        self<span class="token punctuation">.</span>skip_functions <span class="token operator">=</span> skip_functions
        self<span class="token punctuation">.</span>trace_step_into_count <span class="token operator">=</span> <span class="token number">0</span>
        self<span class="token punctuation">.</span>trace_step_into_size <span class="token operator">=</span> <span class="token number">1</span>
        self<span class="token punctuation">.</span>trace_total_size <span class="token operator">=</span> <span class="token number">300000</span>
        self<span class="token punctuation">.</span>trace_size <span class="token operator">=</span> <span class="token number">0</span>
        self<span class="token punctuation">.</span>trace_lr <span class="token operator">=</span> <span class="token number">0</span>
        self<span class="token punctuation">.</span>end_ea <span class="token operator">=</span> end_ea
        self<span class="token punctuation">.</span>bpt_trace <span class="token operator">=</span> <span class="token number">0</span>
        self<span class="token punctuation">.</span>Logger <span class="token operator">=</span> <span class="token boolean">None</span>
        self<span class="token punctuation">.</span>line_trace <span class="token operator">=</span> <span class="token number">0</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"__init__"</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">start_line_trace</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>bpt_trace <span class="token operator">=</span> <span class="token number">0</span>
        self<span class="token punctuation">.</span>line_trace <span class="token operator">=</span> <span class="token number">1</span>
        self<span class="token punctuation">.</span>start_hook<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">start_hook</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>hook<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"start_hook"</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">dbg_process_start</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> pid<span class="token punctuation">,</span> tid<span class="token punctuation">,</span> ea<span class="token punctuation">,</span> name<span class="token punctuation">,</span> base<span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Process started, pid=%d tid=%d name=%s"</span> <span class="token operator">%</span> <span class="token punctuation">(</span>pid<span class="token punctuation">,</span> tid<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">dbg_process_exit</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> pid<span class="token punctuation">,</span> tid<span class="token punctuation">,</span> ea<span class="token punctuation">,</span> code<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>unhook<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>Logger<span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>Logger<span class="token punctuation">.</span>log_close<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Process exited pid=%d tid=%d ea=0x%x code=%d"</span> <span class="token operator">%</span> <span class="token punctuation">(</span>pid<span class="token punctuation">,</span> tid<span class="token punctuation">,</span> ea<span class="token punctuation">,</span> code<span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">dbg_process_detach</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> pid<span class="token punctuation">,</span> tid<span class="token punctuation">,</span> ea<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>unhook<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>Logger<span class="token punctuation">.</span>log_close<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token number">0</span>

    <span class="token keyword">def</span> <span class="token function">dbg_bpt</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> tid<span class="token punctuation">,</span> ea<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Break point at 0x%x tid=%d"</span> <span class="token operator">%</span> <span class="token punctuation">(</span>ea<span class="token punctuation">,</span> tid<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> ea <span class="token keyword">in</span> self<span class="token punctuation">.</span>end_ea<span class="token punctuation">:</span>
            ida_dbg<span class="token punctuation">.</span>enable_insn_trace<span class="token punctuation">(</span><span class="token boolean">False</span><span class="token punctuation">)</span>
            ida_dbg<span class="token punctuation">.</span>enable_step_trace<span class="token punctuation">(</span><span class="token boolean">False</span><span class="token punctuation">)</span>
            ida_dbg<span class="token punctuation">.</span>suspend_process<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token number">0</span>
        <span class="token keyword">return</span> <span class="token number">0</span>

    <span class="token keyword">def</span> <span class="token function">dbg_trace</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> tid<span class="token punctuation">,</span> ea<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment">#print("Trace tid=%d ea=0x%x" % (tid, ea))</span>
        <span class="token comment"># return values:</span>
        <span class="token comment">#   1  - do not log this trace event;</span>
        <span class="token comment">#   0  - log it</span>
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>line_trace<span class="token punctuation">:</span>
            in_mine_so <span class="token operator">=</span> <span class="token boolean">False</span>
            <span class="token keyword">for</span> module_info <span class="token keyword">in</span> self<span class="token punctuation">.</span>modules_info<span class="token punctuation">:</span>
                <span class="token comment"># print (module_info)</span>
                so_base <span class="token operator">=</span> module_info<span class="token punctuation">[</span><span class="token string">"base"</span><span class="token punctuation">]</span>
                so_size <span class="token operator">=</span> module_info<span class="token punctuation">[</span><span class="token string">"size"</span><span class="token punctuation">]</span>
                <span class="token keyword">if</span> so_base <span class="token operator">&lt;=</span> ea <span class="token operator">&lt;=</span> <span class="token punctuation">(</span>so_base <span class="token operator">+</span> so_size<span class="token punctuation">)</span><span class="token punctuation">:</span>
                    in_mine_so <span class="token operator">=</span> <span class="token boolean">True</span>
                    <span class="token keyword">break</span>

            self<span class="token punctuation">.</span>trace_size <span class="token operator">+=</span> <span class="token number">1</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">not</span> in_mine_so<span class="token punctuation">)</span> <span class="token keyword">or</span> <span class="token punctuation">(</span>ea <span class="token keyword">in</span> self<span class="token punctuation">.</span>skip_functions<span class="token punctuation">)</span><span class="token punctuation">:</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>self<span class="token punctuation">.</span>trace_lr <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">and</span> <span class="token punctuation">(</span>self<span class="token punctuation">.</span>trace_step_into_count <span class="token operator">&lt;</span> self<span class="token punctuation">.</span>trace_step_into_size<span class="token punctuation">)</span><span class="token punctuation">:</span>
                    self<span class="token punctuation">.</span>trace_step_into_count <span class="token operator">+=</span> <span class="token number">1</span>
                    <span class="token keyword">return</span> <span class="token number">0</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span>self<span class="token punctuation">.</span>trace_lr <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">and</span> <span class="token punctuation">(</span>self<span class="token punctuation">.</span>trace_step_into_count <span class="token operator">==</span> self<span class="token punctuation">.</span>trace_step_into_size<span class="token punctuation">)</span><span class="token punctuation">:</span>
                    ida_dbg<span class="token punctuation">.</span>enable_insn_trace<span class="token punctuation">(</span><span class="token boolean">False</span><span class="token punctuation">)</span>
                    ida_dbg<span class="token punctuation">.</span>enable_step_trace<span class="token punctuation">(</span><span class="token boolean">False</span><span class="token punctuation">)</span>
                    ida_dbg<span class="token punctuation">.</span>suspend_process<span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token keyword">if</span> self<span class="token punctuation">.</span>trace_size <span class="token operator">></span> self<span class="token punctuation">.</span>trace_total_size<span class="token punctuation">:</span>
                        self<span class="token punctuation">.</span>trace_size <span class="token operator">=</span> <span class="token number">0</span>
                        ida_dbg<span class="token punctuation">.</span>request_clear_trace<span class="token punctuation">(</span><span class="token punctuation">)</span>
                        ida_dbg<span class="token punctuation">.</span>run_requests<span class="token punctuation">(</span><span class="token punctuation">)</span>

                    ida_dbg<span class="token punctuation">.</span>request_run_to<span class="token punctuation">(</span>self<span class="token punctuation">.</span>trace_lr<span class="token punctuation">)</span>
                    ida_dbg<span class="token punctuation">.</span>run_requests<span class="token punctuation">(</span><span class="token punctuation">)</span>
                    self<span class="token punctuation">.</span>trace_lr <span class="token operator">=</span> <span class="token number">0</span>
                    self<span class="token punctuation">.</span>trace_step_into_count <span class="token operator">=</span> <span class="token number">0</span>
                    <span class="token keyword">return</span> <span class="token number">0</span>

                <span class="token keyword">if</span> self<span class="token punctuation">.</span>trace_lr <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
                    self<span class="token punctuation">.</span>trace_lr <span class="token operator">=</span> my_get_reg_value<span class="token punctuation">(</span><span class="token string">"X30"</span><span class="token punctuation">)</span>  <span class="token comment">#arm thumb LR, arm64 X30</span>
            <span class="token keyword">return</span> <span class="token number">0</span>

    <span class="token keyword">def</span> <span class="token function">dbg_run_to</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> pid<span class="token punctuation">,</span> tid<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> ea<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># print("dbg_run_to 0x%x pid=%d" % (ea, pid))</span>
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>line_trace<span class="token punctuation">:</span>
            ida_dbg<span class="token punctuation">.</span>enable_insn_trace<span class="token punctuation">(</span><span class="token boolean">True</span><span class="token punctuation">)</span>
            ida_dbg<span class="token punctuation">.</span>enable_step_trace<span class="token punctuation">(</span><span class="token boolean">True</span><span class="token punctuation">)</span>
            ida_dbg<span class="token punctuation">.</span>request_continue_process<span class="token punctuation">(</span><span class="token punctuation">)</span>
            ida_dbg<span class="token punctuation">.</span>run_requests<span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">unhook</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">global</span> debughook
    <span class="token comment"># Remove an existing debug hook</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> debughook<span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Removing previous hook ..."</span><span class="token punctuation">)</span>
            debughook<span class="token punctuation">.</span>unhook<span class="token punctuation">(</span><span class="token punctuation">)</span>
            debughook<span class="token punctuation">.</span>Logger<span class="token punctuation">.</span>log_close<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">except</span><span class="token punctuation">:</span>
        <span class="token keyword">pass</span>


<span class="token keyword">def</span> <span class="token function">starthook</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">global</span> debughook
    <span class="token keyword">if</span> debughook<span class="token punctuation">:</span>
        debughook<span class="token punctuation">.</span>start_line_trace<span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">global</span> debughook
    unhook<span class="token punctuation">(</span><span class="token punctuation">)</span>
    skip_functions <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    modules_info <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    start_ea <span class="token operator">=</span> <span class="token number">0</span>
    end_ea <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    so_modules <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"libnative-lib.so"</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> module <span class="token keyword">in</span> idc<span class="token punctuation">.</span>_get_modules<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        module_name <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>basename<span class="token punctuation">(</span>module<span class="token punctuation">.</span>name<span class="token punctuation">)</span>
        <span class="token keyword">for</span> so_module <span class="token keyword">in</span> so_modules<span class="token punctuation">:</span>
            <span class="token keyword">if</span> re<span class="token punctuation">.</span>search<span class="token punctuation">(</span>so_module<span class="token punctuation">,</span> module_name<span class="token punctuation">,</span> re<span class="token punctuation">.</span>IGNORECASE<span class="token punctuation">)</span><span class="token punctuation">:</span>
                <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"modules_info append %08X %s %08X"</span> <span class="token operator">%</span> <span class="token punctuation">(</span>module<span class="token punctuation">.</span>base<span class="token punctuation">,</span> module<span class="token punctuation">.</span>name<span class="token punctuation">,</span> module<span class="token punctuation">.</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword">if</span> module_name <span class="token operator">==</span> <span class="token string">"libnative-lib.so"</span><span class="token punctuation">:</span>
                    modules_info<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token string">"base"</span><span class="token punctuation">:</span> module<span class="token punctuation">.</span>base<span class="token punctuation">,</span> <span class="token string">"size"</span><span class="token punctuation">:</span> module<span class="token punctuation">.</span>size<span class="token punctuation">,</span> <span class="token string">"name"</span><span class="token punctuation">:</span> module<span class="token punctuation">.</span>name<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
                    start_ea <span class="token operator">=</span> <span class="token punctuation">(</span>module<span class="token punctuation">.</span>base <span class="token operator">+</span> <span class="token number">0xDB4</span><span class="token punctuation">)</span>      <span class="token comment">#UUIDCheckSum</span>
                    end_ea <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token punctuation">(</span>module<span class="token punctuation">.</span>base <span class="token operator">+</span> <span class="token number">0x1284</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span>   
                    <span class="token keyword">break</span>

    <span class="token keyword">if</span> start_ea<span class="token punctuation">:</span>
        set_breakpoint<span class="token punctuation">(</span>start_ea<span class="token punctuation">)</span>
    <span class="token keyword">if</span> end_ea<span class="token punctuation">:</span>
        <span class="token keyword">for</span> ea <span class="token keyword">in</span> end_ea<span class="token punctuation">:</span>
            set_breakpoint<span class="token punctuation">(</span>ea<span class="token punctuation">)</span>

    <span class="token keyword">if</span> skip_functions<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"skip_functions"</span><span class="token punctuation">)</span>
        <span class="token keyword">for</span> skip_function <span class="token keyword">in</span> skip_functions<span class="token punctuation">:</span>
            <span class="token keyword">print</span> <span class="token punctuation">(</span><span class="token string">"%08X"</span> <span class="token operator">%</span> skip_function<span class="token punctuation">)</span>
    
    debughook <span class="token operator">=</span> MyDbgHook<span class="token punctuation">(</span>modules_info<span class="token punctuation">,</span> skip_functions<span class="token punctuation">,</span> end_ea<span class="token punctuation">)</span>
    
    <span class="token keyword">pass</span>


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>
    main<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">pass</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这个脚本正常不用改，我们需要修改的地方如下，主要是trace的so和偏移</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240127231858.png"></p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240127231948.png"></p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240127232002.png"></p>
<p>有个报错，我们修改一下</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240127232318.png"></p>
<p>新版本ida不兼容旧版本的api</p>
<p><a target="_blank" rel="noopener" href="https://hex-rays.com/products/ida/support/ida74_idapython_no_bc695_porting_guide.shtml">https://hex-rays.com/products/ida/support/ida74_idapython_no_bc695_porting_guide.shtml</a></p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240127232352.png"></p>
<p>我们做一个替换</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240127232430.png"></p>
<p>现在正常了</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240127232458.png"></p>
<p>自动帮我们在函数开始和结尾下了断点</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240127232535.png"></p>
<p>当我现在点击check后就断了下来</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240127232639.png"></p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240127232615.png"></p>
<p>先开启starthook()</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240127232854.png"></p>
<p>然后挂起其他无关线程，防止有检测的线程</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240127234552.png"></p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240127233005.png"></p>
<p>设置trace</p>
<p>取消勾选和设置保存log的路径</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240127233245.png"></p>
<p>我们选择指令级trace，点击一下就行</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240127233356.png"></p>
<p>这个时候我们继续运行</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240127234319.png"></p>
<p>可以看到有些指令变色了，这个变色的就是已经执行到的指令</p>
<p>等个十几秒跑完，此时暂停在ret了</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240127234741.png"></p>
<p>此时恢复所有的线程</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240127234928.png"></p>
<p>现在的input</p>
<pre class="line-numbers language-none"><code class="language-none">01-27 10:50:23.759  8839  8839 E kanxue  : input: fxylU6VJAqyRI6rwQ9UjQHWYLMTfCFErIlnA output: fxylU6VJ-qyRI-4wQ9-jQHWL-MTfCFErIl67<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>我们的日志用010打开，因为搜索方便，而且速度快</p>
<p>现在分析log</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240128234411.png"></p>
<p>通过之前的分析我们知道加密逻辑在uuid_checksum中</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240128234528.png"></p>
<p>我们从这开始分析，x0是参数1:字符串地址，x1是参数2:字符串长度</p>
<p>我们写了个注释</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240128234720.png"></p>
<p>字符串长度-2</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240128235721.png"></p>
<p>我们搜索x0，发现x9&#x3D;x9+x0，而此时的x9&#x3D;0，所以x9&#x3D;x0，然后继续搜x9，又发现[x9]取出了值0x66，对应字符是f</p>
<p>我们的输入中第一个字符就是f,加密的结果第一个也是f，可能是赋值操作</p>
<pre class="line-numbers language-none"><code class="language-none">01-27 10:50:23.759  8839  8839 E kanxue  : input: fxylU6VJAqyRI6rwQ9UjQHWYLMTfCFErIlnA output: fxylU6VJ-qyRI-4wQ9-jQHWL-MTfCFErIl67<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240129000022.png"></p>
<p>我们搜索了取值指令，发现有多处调用</p>
<pre class="line-numbers language-none"><code class="language-none">libnative_lib.so:uuid_checksum(char *,int)+5F0<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240129000458.png"></p>
<p>发现第二个取值0x78，而且索引是1，对应字符是x</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240129001254.png"></p>
<p>我们现在搜索libnative_lib.so:unk_774D8D6CC0	LDR             X9, [SP,#0x50]</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240129001338.png" alt=" "></p>
<p>可以发现少了000000774C0A2118，有些地方做了处理，我们继续分析</p>
<p>先观察一下输入输出</p>
<pre class="line-numbers language-none"><code class="language-none">input:  fxylU6VJAqyRI6rwQ9UjQHWYLMTfCFErIlnA 
output: fxylU6VJ-qyRI-4wQ9-jQHWL-MTfCFErIl67<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>fxylU6VJ猜测是直接复制的，对A进行了特殊处理，也就是索引是8的时候</p>
<p>可以看到把-进行了赋值替换A</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240129001742.png"></p>
<p>qyRI猜测也是直接复制的，我们看6怎么变成-,和上面一样直接进行了赋值操作</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240129001851.png"></p>
<p>接下来看r怎么变成4,也是直接赋值的</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240129002012.png"></p>
<pre class="line-numbers language-none"><code class="language-none">input:  fxylU6VJAqyRI6rwQ9U		jQHWYLMTfCFErIlnA 
output: fxylU6VJ-qyRI-4wQ9-		jQHWL-MTfCFErIl67<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>现在前面部分已经分析完了，我们继续分析后面的部分，wQ9很显然也是直接复制</p>
<p>然后看U变成-，也是直接赋值的，索引是0x12，可以自己数一下</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240129002155.png"></p>
<p>jQHW猜测也是直接复制，现在看一下Y变成L的过程，索引0x17，直接赋值0x4c，对应ASCII是L</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240129002526.png"></p>
<pre class="line-numbers language-none"><code class="language-none">input:  fxylU6VJAqyRI6rwQ9UjQHWY	LMTfCFErIlnA 
output: fxylU6VJ-qyRI-4wQ9-jQHWL	-MTfCFErIl67<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>看一下0x18的位置，应该也是直接赋值-</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240129002658.png"></p>
<p>MTfCFErIl是直接复制的的，我们现在还差最后两位</p>
<pre class="line-numbers language-none"><code class="language-none">input:  fxylU6VJ A qyRI 6 r wQ9 U jQHW Y L MTfCFErIl nA 
output: fxylU6VJ - qyRI - 4 wQ9 - jQHW L - MTfCFErIl 67

input:  EejEzH6W E EWMi L r pWZ Y xTAD U F XJ1biCkfx Dt 
output: EejEzH6W - EWMi - 4 pWZ - xTAD F - XJ1biCkfx c9

input:  QzNfJPHh P doFc n y ewb P nOl0 G i kddw7p7c9 ih 
output: QzNfJPHh - doFc - 4 ewb - nOl0 i - kddw7p7c9 9a

input:  0pvvK1r1 s iPtY Z V IVy T 3uV7 H 8 27jA313cd VJ 
output: 0pvvK1r1 - iPtY - 4 IVy - 3uV7 8 - 27jA313cd 83

input:  mCMCAlEH 9 ZDOd 2 W c26 x q4om 1 L 7ZGBGHWhE Yh 
output: mCMCAlEH - ZDOd - 4 c26 - q4om L - 7ZGBGHWhE 0b

input:  lq19d6tS h FYoC q 2 c2T f yTcR 2 i 0PfY843d0 f3 
output: lq19d6tS - FYoC - 4 c2T - yTcR i - 0PfY843d0 f8<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>我们先验证一下前面的分析，可以多弄几组数据</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240129003510.png"></p>
<p>索引8、0xd、0x12、0x18都是直接替换成-，索引0xe的位置全部替换成4</p>
<p>但是最后一组有些问题，Y-&gt;L、U-&gt;F、G-&gt;i、H-&gt;8、1-&gt;L、2-&gt;i不是固定的，仔细看发现是赋值为后一位字符:Y的下一位是L</p>
<p>我们分析log验证一下</p>
<p>我们搜索一下0x4c的来源</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240129004905.png"></p>
<p>直接搜的04c，然后定位到下面LDRB            W28, [SP,#0xC] ，再搜索[SP,#0xC]，找到上面的位置,X28&#x3D;X0+0x18,而x0就是我们字符串的首地址，0x18是偏移，刚好是0x17的后一位</p>
<p>现在我们分析最后两位来源，由于最开始我们的循环长度-2了，所以最后两位不在这个循环里了</p>
<p>尝试用之前赋值指令搜索，没有找到</p>
<pre class="line-numbers language-none"><code class="language-none">libnative_lib.so:uuid_checksum(char *,int)+5F0<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240129181910.png"></p>
<p>直接搜000000774C0A2110+0x22，也不行</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240129181941.png"></p>
<p>使用[x0,寻址方式找到了</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240129181953.png"></p>
<p>我们现在要找到X9的来源和6的来源，继续往上分析</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240129182311.png"></p>
<p>我们看一下ida，发现这里最后两位的索引表偏移是0x1288，和trace中直接赋值X9的地址有点相似</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240129182747.png"></p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240129182836.png"></p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240129183419.png"></p>
<p>现在找一下这个索引的来源W23&#x3D;W28 - W23 &#x3D; 0000000000000A16-0000000000000A10&#x3D;6</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240129183513.png"></p>
<p>所以我们还得看看这个W28和W23怎么来的</p>
<p>W23&#x3D;W28&amp;0xFFFFFFF0，所以现在我们只需要关注W28就行了</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240129183653.png"></p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240129190341.png"></p>
<p>0xA16&#x3D;0x9AA+0x6c</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240129190448.png"></p>
<p>看样子是一个累加的过程，x23从0开始，然后加上0x66，而这个0x66是我们输入的第一个字符</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240129190626.png"></p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240129190937.png"></p>
<p>我们现在先写个还原算法，前面的分析都是正确的</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240129193118.png"></p>
<p>计算一下x23累加的过程</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240129200647.png"></p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream></span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">//input:  fxylU6VJAqyRI6rwQ9UjQHWYLMTfCFErIlnA</span>
    <span class="token comment">//output: fxylU6VJ-qyRI-4wQ9-jQHWL-MTfCFErIl67</span>
    <span class="token comment">//        fxylU6VJ-qyRI-4wQ9-jQHWL-MTfCFErIl</span>
    std<span class="token operator">::</span>string input <span class="token operator">=</span> <span class="token string">"fxylU6VJAqyRI6rwQ9UjQHWYLMTfCFErIlnA"</span><span class="token punctuation">;</span>
    std<span class="token operator">::</span>string  table <span class="token operator">=</span> <span class="token string">"0123456789abcdef"</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> input_len <span class="token operator">=</span> input<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    std<span class="token operator">::</span>string output<span class="token punctuation">;</span>
    output<span class="token punctuation">.</span><span class="token function">resize</span><span class="token punctuation">(</span>input_len<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> add_result<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> input_len <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">==</span> <span class="token number">8</span> <span class="token operator">||</span> i <span class="token operator">==</span> <span class="token number">0xD</span> <span class="token operator">||</span> i <span class="token operator">==</span> <span class="token number">0x12</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            output<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token char">'-'</span><span class="token punctuation">;</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
   
        <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">==</span> <span class="token number">0x17</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            output<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> input<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">==</span> <span class="token number">0xE</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            output<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token char">'4'</span><span class="token punctuation">;</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        output<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> input<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>i<span class="token operator">==</span><span class="token number">0x18</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            output<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token char">'-'</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        add_result <span class="token operator">+=</span> input<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token comment">//std::cout&lt;&lt;"add_result:"&lt;&lt; std::hex &lt;&lt;add_result&lt;&lt;std::endl;</span>
    <span class="token punctuation">&#125;</span>

    output<span class="token punctuation">[</span><span class="token number">0x22</span><span class="token punctuation">]</span><span class="token operator">=</span>table<span class="token punctuation">[</span>add_result<span class="token operator">-</span><span class="token punctuation">(</span>add_result<span class="token operator">&amp;</span><span class="token number">0xFFFFFFF0</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    std<span class="token operator">::</span>cout<span class="token operator">&lt;&lt;</span>output<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&lt;&lt;</span>std<span class="token operator">::</span>endl<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>倒数第二位复现完了，我们继续分析最后一位</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240129203056.png"></p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240129201251.png"></p>
<p>和上面类似，但是这里x23取值是7，x9还是table，我们继续跟x23来源</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240129201456.png"></p>
<p>x23&#x3D;x23&amp;0xF&#x3D;0x87&amp;0xF&#x3D;7,跟一下0x87的来源，也就是跟W1</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240129201716.png"></p>
<p>W1&#x3D;W4&#x3D;W4^W9&#x3D;0xEB^0x6c</p>
<p>搜搜一下libnative_lib.so:uuid_checksum(char *,int)+328，类似上面的add，这里是xor</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240129201820.png"></p>
<p>默认初始值0xff,我们第一个字符就是0x66</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240129201852.png"></p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream></span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">//input:  fxylU6VJAqyRI6rwQ9UjQHWYLMTfCFErIlnA</span>
    <span class="token comment">//output: fxylU6VJ-qyRI-4wQ9-jQHWL-MTfCFErIl67</span>
    <span class="token comment">//        fxylU6VJ-qyRI-4wQ9-jQHWL-MTfCFErIl</span>

    std<span class="token operator">::</span>string input <span class="token operator">=</span> <span class="token string">"fxylU6VJAqyRI6rwQ9UjQHWYLMTfCFErIlnA"</span><span class="token punctuation">;</span>
    std<span class="token operator">::</span>string  table <span class="token operator">=</span> <span class="token string">"0123456789abcdef"</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> input_len <span class="token operator">=</span> input<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    std<span class="token operator">::</span>string output<span class="token punctuation">;</span>
    output<span class="token punctuation">.</span><span class="token function">resize</span><span class="token punctuation">(</span>input_len<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> add_result<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> xor_result<span class="token operator">=</span><span class="token number">0xff</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> input_len <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">==</span> <span class="token number">8</span> <span class="token operator">||</span> i <span class="token operator">==</span> <span class="token number">0xD</span> <span class="token operator">||</span> i <span class="token operator">==</span> <span class="token number">0x12</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            output<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token char">'-'</span><span class="token punctuation">;</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">==</span> <span class="token number">0x17</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            output<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> input<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">==</span> <span class="token number">0xE</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            output<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token char">'4'</span><span class="token punctuation">;</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        output<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> input<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">==</span> <span class="token number">0x18</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            output<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token char">'-'</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        add_result <span class="token operator">+=</span> input<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
        xor_result <span class="token operator">^=</span> input<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token comment">//std::cout&lt;&lt;std::hex&lt;&lt;i&lt;&lt;"   xor_result:"&lt;&lt; std::hex &lt;&lt;xor_result&lt;&lt;std::endl;</span>
    <span class="token punctuation">&#125;</span>

    output<span class="token punctuation">[</span><span class="token number">0x22</span><span class="token punctuation">]</span><span class="token operator">=</span>table<span class="token punctuation">[</span>add_result<span class="token operator">-</span><span class="token punctuation">(</span>add_result<span class="token operator">&amp;</span><span class="token number">0xFFFFFFF0</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    output<span class="token punctuation">[</span><span class="token number">0x23</span><span class="token punctuation">]</span><span class="token operator">=</span>table<span class="token punctuation">[</span>xor_result<span class="token operator">&amp;</span><span class="token number">0xf</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    std<span class="token operator">::</span>cout<span class="token operator">&lt;&lt;</span>output<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&lt;&lt;</span>std<span class="token operator">::</span>endl<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240129202142.png"></p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240129203134.png"></p>
<p>我们现在去app多拿几组数据做验证</p>
<pre class="line-numbers language-none"><code class="language-none">input: dOYWGxKmig8YJgr9jqMSEk9t2VyWhKObkbgt output: dOYWGxKm-g8YJ-49jq-SEk92-VyWhKObkb54
input: 43ddQZ4xR2taRGOxmFdlUsk3yGw2tDHgNGHZ output: 43ddQZ4x-2taR-4xmF-lUsky-Gw2tDHgNGe5<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240129203216.png"></p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240129203241.png"></p>
<p>所以我们的算法还原正确。</p>
<h1 id="26、利用unicorn分析OLLVM混淆的算法"><a href="#26、利用unicorn分析OLLVM混淆的算法" class="headerlink" title="26、利用unicorn分析OLLVM混淆的算法"></a>26、利用unicorn分析OLLVM混淆的算法</h1><p>unicorn相当于是一个cpu的模拟器，可以用来执行so中的代码段，一般不要直接使用apk中的so文件，直接使用是需要修复上下文的，这样会比较复杂。最好是直接从内存中直接dump一个so出来。然后就可以直接执行so里面的代码段。</p>
<p>我们先把apk跑起来，还是上一节的demo，然后从内存中把so给dump出来</p>
<p>用了这个项目<a target="_blank" rel="noopener" href="https://github.com/lasting-yang/frida_dump/">https://github.com/lasting-yang/frida_dump/</a></p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240130185424.png"></p>
<p>此时的so已经被pull到当前目录下了</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240130185743.png"></p>
<p>现在创建一个目录，里面存放脚本和dump下来的so</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240130190229.png"></p>
<p>我们需要安装unicorn</p>
<pre class="line-numbers language-none"><code class="language-none">pip install unicorn<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240130192136.png"></p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> unicorn
<span class="token keyword">import</span> binascii
<span class="token keyword">import</span> string

<span class="token keyword">if</span> __name__ <span class="token operator">==</span><span class="token string">"__main__"</span><span class="token punctuation">:</span>
    uc <span class="token operator">=</span> unicorn<span class="token punctuation">.</span>Uc<span class="token punctuation">(</span>unicorn<span class="token punctuation">.</span>UC_ARCH_ARM64<span class="token punctuation">,</span> unicorn<span class="token punctuation">.</span>UC_MODE_ARM<span class="token punctuation">)</span>

    <span class="token comment"># libnative-lib.so_0x774d850000_12288_fix.so</span>
    <span class="token comment">#申请内存用来存放代码段</span>
    code_base <span class="token operator">=</span> <span class="token number">0x774d850000</span>
    code_size <span class="token operator">=</span> <span class="token number">8</span> <span class="token operator">*</span> <span class="token number">0x1000</span> <span class="token operator">*</span> <span class="token number">0x1000</span>
    uc<span class="token punctuation">.</span>mem_map<span class="token punctuation">(</span>code_base<span class="token punctuation">,</span> code_size<span class="token punctuation">)</span>

    <span class="token comment">#申请内存用来当堆栈</span>
    stack_addr <span class="token operator">=</span> code_base <span class="token operator">+</span> code_size
    stack_size <span class="token operator">=</span> <span class="token number">0x1000</span> <span class="token operator">*</span> <span class="token number">0x1000</span>
    stack_top <span class="token operator">=</span> stack_addr <span class="token operator">+</span> stack_size <span class="token operator">-</span> <span class="token number">8</span>
    uc<span class="token punctuation">.</span>mem_map<span class="token punctuation">(</span>stack_addr<span class="token punctuation">,</span> stack_size<span class="token punctuation">)</span>

    <span class="token comment">#申请内存用来存放参数</span>
    param_addr <span class="token operator">=</span> stack_addr <span class="token operator">+</span> stack_size
    param_size <span class="token operator">=</span> <span class="token number">0x1000</span> <span class="token operator">*</span> <span class="token number">0x1000</span>
    uc<span class="token punctuation">.</span>mem_map<span class="token punctuation">(</span>param_addr<span class="token punctuation">,</span> param_size<span class="token punctuation">)</span>

    <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">"libnative-lib.so_0x774d850000_12288_fix.so"</span><span class="token punctuation">,</span> <span class="token string">"rb"</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
        so_data <span class="token operator">=</span> f<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment">#把dump的so写入到我们申请的内存中</span>
        uc<span class="token punctuation">.</span>mem_write<span class="token punctuation">(</span>code_base<span class="token punctuation">,</span> so_data<span class="token punctuation">)</span>

        <span class="token comment">#要调用的函数起始位置与结束位置</span>
        start_addr <span class="token operator">=</span> code_base <span class="token operator">+</span> <span class="token number">0x6DC</span>
        end_addr <span class="token operator">=</span> code_base <span class="token operator">+</span> <span class="token number">0xDB0</span>

        <span class="token comment">#input: dOYWGxKmig8YJgr9jqMSEk9t2VyWhKObkbgt output: dOYWGxKm-g8YJ-49jq-SEk92-VyWhKObkb54</span>
        input_str <span class="token operator">=</span> <span class="token string">"dOYWGxKmig8YJgr9jqMSEk9t2VyWhKObkbgt"</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>input_str<span class="token punctuation">,</span> end<span class="token operator">=</span><span class="token string">" -> "</span><span class="token punctuation">)</span>

        <span class="token comment">#写入参数</span>
        input_bytes <span class="token operator">=</span> <span class="token builtin">str</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span>input_str<span class="token punctuation">)</span>
        uc<span class="token punctuation">.</span>mem_write<span class="token punctuation">(</span>param_addr<span class="token punctuation">,</span> input_bytes<span class="token punctuation">)</span>

        <span class="token comment">#设置参数0，也就是给x0寄存器赋值，是input的地址</span>
        uc<span class="token punctuation">.</span>reg_write<span class="token punctuation">(</span>unicorn<span class="token punctuation">.</span>arm64_const<span class="token punctuation">.</span>UC_ARM64_REG_X0<span class="token punctuation">,</span> param_addr<span class="token punctuation">)</span>

        <span class="token comment">#设置参数1，也就是给x1寄存器赋值，是input的长度</span>
        uc<span class="token punctuation">.</span>reg_write<span class="token punctuation">(</span>unicorn<span class="token punctuation">.</span>arm64_const<span class="token punctuation">.</span>UC_ARM64_REG_X1<span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>input_str<span class="token punctuation">)</span><span class="token punctuation">)</span>

        <span class="token comment">#设置堆栈的栈顶，也就是sp寄存器</span>
        uc<span class="token punctuation">.</span>reg_write<span class="token punctuation">(</span>unicorn<span class="token punctuation">.</span>arm64_const<span class="token punctuation">.</span>UC_ARM64_REG_SP<span class="token punctuation">,</span> stack_top<span class="token punctuation">)</span>

        <span class="token comment">#开始调用函数</span>
        uc<span class="token punctuation">.</span>emu_start<span class="token punctuation">(</span>start_addr<span class="token punctuation">,</span> end_addr<span class="token punctuation">)</span>

        <span class="token comment">#把结果再读取出来</span>
        result <span class="token operator">=</span> uc<span class="token punctuation">.</span>mem_read<span class="token punctuation">(</span>param_addr<span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>input_str<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token comment">#解码打印</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">pass</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240130204847.png"></p>
<p>得到的结果和logcat里生成的结果是一样的，调用成功</p>
<p>现在我们装一个工具**<a target="_blank" rel="noopener" href="https://github.com/capstone-engine/capstone">capstone</a>**</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240130220807.png"></p>
<p>capstone是一个反汇编引擎 ，最重要功能是把二进制转化为汇编语言</p>
<p>trace实现代码如下</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> unicorn
<span class="token keyword">import</span> binascii
<span class="token keyword">import</span> string
<span class="token keyword">from</span> capstone <span class="token keyword">import</span> <span class="token operator">*</span>



reg_name <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
    unicorn<span class="token punctuation">.</span>arm64_const<span class="token punctuation">.</span>UC_ARM64_REG_X0<span class="token punctuation">:</span> <span class="token string">"X0"</span><span class="token punctuation">,</span>
    unicorn<span class="token punctuation">.</span>arm64_const<span class="token punctuation">.</span>UC_ARM64_REG_X1<span class="token punctuation">:</span> <span class="token string">"X1"</span><span class="token punctuation">,</span>
    unicorn<span class="token punctuation">.</span>arm64_const<span class="token punctuation">.</span>UC_ARM64_REG_X2<span class="token punctuation">:</span> <span class="token string">"X2"</span><span class="token punctuation">,</span>
    unicorn<span class="token punctuation">.</span>arm64_const<span class="token punctuation">.</span>UC_ARM64_REG_X3<span class="token punctuation">:</span> <span class="token string">"X3"</span><span class="token punctuation">,</span>
    unicorn<span class="token punctuation">.</span>arm64_const<span class="token punctuation">.</span>UC_ARM64_REG_X4<span class="token punctuation">:</span> <span class="token string">"X4"</span><span class="token punctuation">,</span>
    unicorn<span class="token punctuation">.</span>arm64_const<span class="token punctuation">.</span>UC_ARM64_REG_X5<span class="token punctuation">:</span> <span class="token string">"X5"</span><span class="token punctuation">,</span>
    unicorn<span class="token punctuation">.</span>arm64_const<span class="token punctuation">.</span>UC_ARM64_REG_X6<span class="token punctuation">:</span> <span class="token string">"X6"</span><span class="token punctuation">,</span>
    unicorn<span class="token punctuation">.</span>arm64_const<span class="token punctuation">.</span>UC_ARM64_REG_X7<span class="token punctuation">:</span> <span class="token string">"X7"</span><span class="token punctuation">,</span>
    unicorn<span class="token punctuation">.</span>arm64_const<span class="token punctuation">.</span>UC_ARM64_REG_X8<span class="token punctuation">:</span> <span class="token string">"X8"</span><span class="token punctuation">,</span>
    unicorn<span class="token punctuation">.</span>arm64_const<span class="token punctuation">.</span>UC_ARM64_REG_X9<span class="token punctuation">:</span> <span class="token string">"X9"</span><span class="token punctuation">,</span>
    unicorn<span class="token punctuation">.</span>arm64_const<span class="token punctuation">.</span>UC_ARM64_REG_X10<span class="token punctuation">:</span> <span class="token string">"X10"</span><span class="token punctuation">,</span>
    unicorn<span class="token punctuation">.</span>arm64_const<span class="token punctuation">.</span>UC_ARM64_REG_X11<span class="token punctuation">:</span> <span class="token string">"X11"</span><span class="token punctuation">,</span>
    unicorn<span class="token punctuation">.</span>arm64_const<span class="token punctuation">.</span>UC_ARM64_REG_X12<span class="token punctuation">:</span> <span class="token string">"X12"</span><span class="token punctuation">,</span>
    unicorn<span class="token punctuation">.</span>arm64_const<span class="token punctuation">.</span>UC_ARM64_REG_X13<span class="token punctuation">:</span> <span class="token string">"X13"</span><span class="token punctuation">,</span>
    unicorn<span class="token punctuation">.</span>arm64_const<span class="token punctuation">.</span>UC_ARM64_REG_X14<span class="token punctuation">:</span> <span class="token string">"X14"</span><span class="token punctuation">,</span>
    unicorn<span class="token punctuation">.</span>arm64_const<span class="token punctuation">.</span>UC_ARM64_REG_X15<span class="token punctuation">:</span> <span class="token string">"X15"</span><span class="token punctuation">,</span>
    unicorn<span class="token punctuation">.</span>arm64_const<span class="token punctuation">.</span>UC_ARM64_REG_X16<span class="token punctuation">:</span> <span class="token string">"X16"</span><span class="token punctuation">,</span>
    unicorn<span class="token punctuation">.</span>arm64_const<span class="token punctuation">.</span>UC_ARM64_REG_X17<span class="token punctuation">:</span> <span class="token string">"X17"</span><span class="token punctuation">,</span>
    unicorn<span class="token punctuation">.</span>arm64_const<span class="token punctuation">.</span>UC_ARM64_REG_X18<span class="token punctuation">:</span> <span class="token string">"X18"</span><span class="token punctuation">,</span>
    unicorn<span class="token punctuation">.</span>arm64_const<span class="token punctuation">.</span>UC_ARM64_REG_X19<span class="token punctuation">:</span> <span class="token string">"X19"</span><span class="token punctuation">,</span>
    unicorn<span class="token punctuation">.</span>arm64_const<span class="token punctuation">.</span>UC_ARM64_REG_X20<span class="token punctuation">:</span> <span class="token string">"X20"</span><span class="token punctuation">,</span>
    unicorn<span class="token punctuation">.</span>arm64_const<span class="token punctuation">.</span>UC_ARM64_REG_X21<span class="token punctuation">:</span> <span class="token string">"X21"</span><span class="token punctuation">,</span>
    unicorn<span class="token punctuation">.</span>arm64_const<span class="token punctuation">.</span>UC_ARM64_REG_X22<span class="token punctuation">:</span> <span class="token string">"X22"</span><span class="token punctuation">,</span>
    unicorn<span class="token punctuation">.</span>arm64_const<span class="token punctuation">.</span>UC_ARM64_REG_X23<span class="token punctuation">:</span> <span class="token string">"X23"</span><span class="token punctuation">,</span>
    unicorn<span class="token punctuation">.</span>arm64_const<span class="token punctuation">.</span>UC_ARM64_REG_X24<span class="token punctuation">:</span> <span class="token string">"X24"</span><span class="token punctuation">,</span>
    unicorn<span class="token punctuation">.</span>arm64_const<span class="token punctuation">.</span>UC_ARM64_REG_X25<span class="token punctuation">:</span> <span class="token string">"X25"</span><span class="token punctuation">,</span>
    unicorn<span class="token punctuation">.</span>arm64_const<span class="token punctuation">.</span>UC_ARM64_REG_X26<span class="token punctuation">:</span> <span class="token string">"X26"</span><span class="token punctuation">,</span>
    unicorn<span class="token punctuation">.</span>arm64_const<span class="token punctuation">.</span>UC_ARM64_REG_X27<span class="token punctuation">:</span> <span class="token string">"X27"</span><span class="token punctuation">,</span>
    unicorn<span class="token punctuation">.</span>arm64_const<span class="token punctuation">.</span>UC_ARM64_REG_X28<span class="token punctuation">:</span> <span class="token string">"X28"</span>
<span class="token punctuation">&#125;</span>

md <span class="token operator">=</span>Cs<span class="token punctuation">(</span>CS_ARCH_ARM64<span class="token punctuation">,</span> CS_MODE_ARM<span class="token punctuation">)</span>
md<span class="token punctuation">.</span>detail<span class="token operator">=</span><span class="token boolean">True</span>
all_regs <span class="token operator">=</span> <span class="token boolean">None</span>

<span class="token keyword">def</span> <span class="token function">hook_code</span><span class="token punctuation">(</span>uc<span class="token punctuation">:</span> unicorn<span class="token punctuation">.</span>Uc<span class="token punctuation">,</span> address<span class="token punctuation">,</span> size<span class="token punctuation">,</span> user_data<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">global</span> all_regs
    <span class="token keyword">if</span><span class="token punctuation">(</span>all_regs <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        all_regs<span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
        <span class="token comment">#遍历每个寄存器</span>
        <span class="token keyword">for</span> reg_index <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>unicorn<span class="token punctuation">.</span>arm64_const<span class="token punctuation">.</span>UC_ARM64_REG_X0<span class="token punctuation">,</span> unicorn<span class="token punctuation">.</span>arm64_const<span class="token punctuation">.</span>UC_ARM64_REG_X28<span class="token punctuation">)</span><span class="token punctuation">:</span>
            reg_value <span class="token operator">=</span> uc<span class="token punctuation">.</span>reg_read<span class="token punctuation">(</span>reg_index<span class="token punctuation">)</span>
            <span class="token comment">#对每个寄存器进行赋值</span>
            all_regs<span class="token punctuation">[</span>reg_index<span class="token punctuation">]</span> <span class="token operator">=</span> reg_value
            <span class="token keyword">if</span> <span class="token punctuation">(</span>reg_value <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token comment">#如果寄存器值不为0，就打印出来    </span>
                <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"%s=0x%x"</span> <span class="token operator">%</span> <span class="token punctuation">(</span>reg_name<span class="token punctuation">[</span>reg_index<span class="token punctuation">]</span><span class="token punctuation">,</span> reg_value<span class="token punctuation">)</span><span class="token punctuation">,</span> end<span class="token operator">=</span><span class="token string">" "</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span>        
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        is_changed <span class="token operator">=</span> <span class="token boolean">False</span>
        <span class="token comment">#遍历每个寄存器</span>
        <span class="token keyword">for</span> reg_index <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>unicorn<span class="token punctuation">.</span>arm64_const<span class="token punctuation">.</span>UC_ARM64_REG_X0<span class="token punctuation">,</span> unicorn<span class="token punctuation">.</span>arm64_const<span class="token punctuation">.</span>UC_ARM64_REG_X28<span class="token punctuation">)</span><span class="token punctuation">:</span>
            reg_value <span class="token operator">=</span> uc<span class="token punctuation">.</span>reg_read<span class="token punctuation">(</span>reg_index<span class="token punctuation">)</span>
            <span class="token comment">#判断寄存器原来的值和现在的值是否相同，不同进入循环</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>all_regs<span class="token punctuation">[</span>reg_index<span class="token punctuation">]</span> <span class="token operator">!=</span> reg_value<span class="token punctuation">)</span><span class="token punctuation">:</span>
                is_changed <span class="token operator">=</span> <span class="token boolean">True</span>
                <span class="token comment">#把新的值赋值给原来的寄存器</span>
                all_regs<span class="token punctuation">[</span>reg_index<span class="token punctuation">]</span> <span class="token operator">=</span> reg_value
                <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span>
                <span class="token comment">#打印寄存器中新的值</span>
                <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"%s=0x%x"</span> <span class="token operator">%</span> <span class="token punctuation">(</span>reg_name<span class="token punctuation">[</span>reg_index<span class="token punctuation">]</span><span class="token punctuation">,</span> reg_value<span class="token punctuation">)</span><span class="token punctuation">,</span> end<span class="token operator">=</span><span class="token string">" "</span><span class="token punctuation">)</span>
                <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> is_changed<span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span>

    inst_code <span class="token operator">=</span> uc<span class="token punctuation">.</span>mem_read<span class="token punctuation">(</span>address<span class="token punctuation">,</span>size<span class="token punctuation">)</span>
    <span class="token keyword">for</span> insn <span class="token keyword">in</span> md<span class="token punctuation">.</span>disasm<span class="token punctuation">(</span>inst_code<span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"0x%x:\t%s\t%s"</span> <span class="token operator">%</span> <span class="token punctuation">(</span>address<span class="token punctuation">,</span> insn<span class="token punctuation">.</span>mnemonic<span class="token punctuation">,</span> insn<span class="token punctuation">.</span>op_str<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment">#print(hex(address),size,binascii.b2a_hex(inst_code))</span>
    <span class="token keyword">pass</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span><span class="token string">"__main__"</span><span class="token punctuation">:</span>
    uc <span class="token operator">=</span> unicorn<span class="token punctuation">.</span>Uc<span class="token punctuation">(</span>unicorn<span class="token punctuation">.</span>UC_ARCH_ARM64<span class="token punctuation">,</span> unicorn<span class="token punctuation">.</span>UC_MODE_ARM<span class="token punctuation">)</span>

    <span class="token comment"># libnative-lib.so_0x774d850000_12288_fix.so</span>
    <span class="token comment">#申请内存用来存放代码段</span>
    code_base <span class="token operator">=</span> <span class="token number">0x774d850000</span>
    code_size <span class="token operator">=</span> <span class="token number">8</span> <span class="token operator">*</span> <span class="token number">0x1000</span> <span class="token operator">*</span> <span class="token number">0x1000</span>
    uc<span class="token punctuation">.</span>mem_map<span class="token punctuation">(</span>code_base<span class="token punctuation">,</span> code_size<span class="token punctuation">)</span>

    <span class="token comment">#申请内存用来当堆栈</span>
    stack_addr <span class="token operator">=</span> code_base <span class="token operator">+</span> code_size
    stack_size <span class="token operator">=</span> <span class="token number">0x1000</span> <span class="token operator">*</span> <span class="token number">0x1000</span>
    stack_top <span class="token operator">=</span> stack_addr <span class="token operator">+</span> stack_size <span class="token operator">-</span> <span class="token number">8</span>
    uc<span class="token punctuation">.</span>mem_map<span class="token punctuation">(</span>stack_addr<span class="token punctuation">,</span> stack_size<span class="token punctuation">)</span>

    <span class="token comment">#申请内存用来存放参数</span>
    param_addr <span class="token operator">=</span> stack_addr <span class="token operator">+</span> stack_size
    param_size <span class="token operator">=</span> <span class="token number">0x1000</span> <span class="token operator">*</span> <span class="token number">0x1000</span>
    uc<span class="token punctuation">.</span>mem_map<span class="token punctuation">(</span>param_addr<span class="token punctuation">,</span> param_size<span class="token punctuation">)</span>

    uc<span class="token punctuation">.</span>hook_add<span class="token punctuation">(</span>unicorn<span class="token punctuation">.</span>UC_HOOK_CODE<span class="token punctuation">,</span>hook_code<span class="token punctuation">)</span>
    uc<span class="token punctuation">.</span>hook_add<span class="token punctuation">(</span>unicorn<span class="token punctuation">.</span>UC_HOOK_CODE<span class="token punctuation">,</span> hook_code<span class="token punctuation">)</span>
    <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">"libnative-lib.so_0x774d850000_12288_fix.so"</span><span class="token punctuation">,</span> <span class="token string">"rb"</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
        so_data <span class="token operator">=</span> f<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment">#把dump的so写入到我们申请的内存中</span>
        uc<span class="token punctuation">.</span>mem_write<span class="token punctuation">(</span>code_base<span class="token punctuation">,</span> so_data<span class="token punctuation">)</span>

        <span class="token comment">#要调用的函数起始位置与结束位置</span>
        start_addr <span class="token operator">=</span> code_base <span class="token operator">+</span> <span class="token number">0x6DC</span>
        end_addr <span class="token operator">=</span> code_base <span class="token operator">+</span> <span class="token number">0xDB0</span>

        <span class="token comment">#input: dOYWGxKmig8YJgr9jqMSEk9t2VyWhKObkbgt output: dOYWGxKm-g8YJ-49jq-SEk92-VyWhKObkb54</span>
        input_str <span class="token operator">=</span> <span class="token string">"dOYWGxKmig8YJgr9jqMSEk9t2VyWhKObkbgt"</span>
        <span class="token comment">#print(input_str, end=" -> ")</span>

        <span class="token comment">#写入参数</span>
        input_bytes <span class="token operator">=</span> <span class="token builtin">str</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span>input_str<span class="token punctuation">)</span>
        uc<span class="token punctuation">.</span>mem_write<span class="token punctuation">(</span>param_addr<span class="token punctuation">,</span> input_bytes<span class="token punctuation">)</span>

        <span class="token comment">#设置参数0，也就是给x0寄存器赋值，是input的地址</span>
        uc<span class="token punctuation">.</span>reg_write<span class="token punctuation">(</span>unicorn<span class="token punctuation">.</span>arm64_const<span class="token punctuation">.</span>UC_ARM64_REG_X0<span class="token punctuation">,</span> param_addr<span class="token punctuation">)</span>

        <span class="token comment">#设置参数1，也就是给x1寄存器赋值，是input的长度</span>
        uc<span class="token punctuation">.</span>reg_write<span class="token punctuation">(</span>unicorn<span class="token punctuation">.</span>arm64_const<span class="token punctuation">.</span>UC_ARM64_REG_X1<span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>input_str<span class="token punctuation">)</span><span class="token punctuation">)</span>

        <span class="token comment">#设置堆栈的栈顶，也就是sp寄存器</span>
        uc<span class="token punctuation">.</span>reg_write<span class="token punctuation">(</span>unicorn<span class="token punctuation">.</span>arm64_const<span class="token punctuation">.</span>UC_ARM64_REG_SP<span class="token punctuation">,</span> stack_top<span class="token punctuation">)</span>

        <span class="token comment">#开始调用函数</span>
        uc<span class="token punctuation">.</span>emu_start<span class="token punctuation">(</span>start_addr<span class="token punctuation">,</span> end_addr<span class="token punctuation">)</span>

        <span class="token comment">#把结果再读取出来</span>
        result <span class="token operator">=</span> uc<span class="token punctuation">.</span>mem_read<span class="token punctuation">(</span>param_addr<span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>input_str<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token comment">#解码打印</span>
        <span class="token comment">#print(result.decode())</span>
        uc<span class="token punctuation">.</span>mem_unmap<span class="token punctuation">(</span>param_addr<span class="token punctuation">,</span> param_size<span class="token punctuation">)</span>
        uc<span class="token punctuation">.</span>mem_unmap<span class="token punctuation">(</span>stack_addr<span class="token punctuation">,</span> stack_size<span class="token punctuation">)</span>
        uc<span class="token punctuation">.</span>mem_unmap<span class="token punctuation">(</span>code_base<span class="token punctuation">,</span> code_size<span class="token punctuation">)</span>
    <span class="token keyword">pass</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>得到执行的汇编代码和对应的寄存器值</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20240130233457.png"></p>
<p>剩下的分析过程和之前的类似，就不展开了。</p>
<h1 id="27、总结"><a href="#27、总结" class="headerlink" title="27、总结"></a>27、总结</h1><p>到此LLVM与OLLVM的基础知识已经具备，回过头来思考仍有许多不足，需要加强的地方:</p>
<p>1、开发OLLVM-Pass，在IR层做处理时对于LLVM操作IR的API不熟悉</p>
<p>2、尝试阅读理解OLLVM自带的字符串加密Pass</p>
<p>3、深入学习unicorn和capstone</p>
<p>4、阅读一些网上关于去混淆的文章，总结去混淆的经验和技巧</p>
<p>这些问题会在后面的学习过程中逐步解决并写成文章。</p>

      
       <hr><span style="font-style: italic;color: gray;"> 转载请注明来源，欢迎对文章中的引用来源进行考证，欢迎指出任何有错误或不够清晰的表达。可以在下面评论区评论，也可以邮件至 767778848@qq.com </span>
    </div>
</article>





    <div id="comments"></div>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css">

<script type="text/javascript">
    $.getScript('/js/gitalk.js', function () {
        var gitalk = new Gitalk({
            clientID: '6c49373fe3729f3c2b02',
            clientSecret: '4b38338216282f43430b6118f27ae24e4732ecec',
            repo: 'Whitebird0.github.io',
            owner: 'Whitebird0',
            admin: ['Whitebird0'],
            id: decodeURI(location.pathname),
            distractionFreeMode: 'true',
            language: 'zh-CN',
            perPage: parseInt('10',10)
        })
        gitalk.render('comments')
    })
</script>




    




    </div>
    <div class="copyright">
        <p class="footer-entry">
    ©2020-2022 Whitebird
</p>
<p class="footer-entry">Built with <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/yelog/hexo-theme-3-hexo" target="_blank">3-hexo</a> theme</p>

    </div>
    <div class="full-toc">
        <button class="full" data-title="切换全屏 快捷键 s"><span class="min "></span></button>
<a class="" id="rocket" ></a>

    </div>
</div>

</body>
<script src="/js/jquery.pjax.js?v=1.1.0" ></script>

<script src="/js/script.js?v=1.1.0" ></script>
<script>
    var img_resize = 'default';
    function initArticle() {
        /*渲染对应的表格样式*/
        
            $("#post .pjax table").addClass("green_title");
        

        /*渲染打赏样式*/
        

        /*高亮代码块行号*/
        

        /*访问数量*/
        
        $.getScript("//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js");
        

        /*代码高亮，行号对齐*/
        $('.pre-numbering').css('line-height',$('.has-numbering').css('line-height'));

        
        
    }

    /*打赏页面隐藏与展示*/
    

</script>

<!--加入行号的高亮代码块样式-->

<!--自定义样式设置-->
<style>
    
    
    .nav {
        width: 542px;
    }
    .nav.fullscreen {
        margin-left: -542px;
    }
    .nav-left {
        width: 120px;
    }
    
    
    @media screen and (max-width: 1468px) {
        .nav {
            width: 492px;
        }
        .nav.fullscreen {
            margin-left: -492px;
        }
        .nav-left {
            width: 100px;
        }
    }
    
    
    @media screen and (max-width: 1024px) {
        .nav {
            width: 492px;
            margin-left: -492px
        }
        .nav.fullscreen {
            margin-left: 0;
        }
    }
    
    @media screen and (max-width: 426px) {
        .nav {
            width: 100%;
        }
        .nav-left {
            width: 100%;
        }
    }
    
    
    .nav-right .title-list nav a .post-title, .nav-right .title-list #local-search-result a .post-title {
        color: #383636;
    }
    
    
    .nav-right .title-list nav a .post-date, .nav-right .title-list #local-search-result a .post-date {
        color: #5e5e5f;
    }
    
    
    .nav-right nav a.hover, #local-search-result a.hover{
        background-color: #e2e0e0;
    }
    
    

    /*列表样式*/
    

    /* 背景图样式 */
    
    


    /*引用块样式*/
    

    /*文章列表背景图*/
    

    
</style>







</html>
