<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Android系统沙盒定制 | Whitebird&#39;s Home</title>
  <meta name="keywords" content=" Android ">
  <meta name="description" content="Android系统沙盒定制 | Whitebird&#39;s Home">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta property="og:type" content="website">
<meta property="og:title" content="about">
<meta property="og:url" content="https://whitebird0.github.io/about/index.html">
<meta property="og:site_name" content="Whitebird&#39;s Home">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2022-07-09T11:26:44.000Z">
<meta property="article:modified_time" content="2022-07-09T11:26:44.827Z">
<meta property="article:author" content="Whitebird">
<meta name="twitter:card" content="summary">


<link rel="icon" href="/img/avatar.jpg">

<link href="/css/style.css?v=1.1.0" rel="stylesheet">

<link href="/css/hl_theme/github.css?v=1.1.0" rel="stylesheet">

<link href="//cdn.jsdelivr.net/npm/animate.css@4.1.0/animate.min.css" rel="stylesheet">

<script src="//cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js"></script>
<script src="/js/titleTip.js?v=1.1.0" ></script>

<script src="//cdn.jsdelivr.net/npm/highlightjs@9.16.2/highlight.pack.min.js"></script>
<script>
    hljs.initHighlightingOnLoad();
</script>

<script src="//cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.js"></script>



<script src="//cdn.jsdelivr.net/npm/jquery.cookie@1.4.1/jquery.cookie.min.js" ></script>

<script src="/js/iconfont.js?v=1.1.0" ></script>

<meta name="generator" content="Hexo 5.4.2"></head>
<div style="display: none">
  <input class="theme_disqus_on" value="false">
  <input class="theme_preload_comment" value="">
  <input class="theme_blog_path" value="">
  <input id="theme_shortcut" value="true" />
  <input id="theme_highlight_on" value="true" />
  <input id="theme_code_copy" value="true" />
</div>



<body>
<aside class="nav">
    <div class="nav-left">
        <a href="/"
   class="avatar_target">
    <img class="avatar"
         src="/img/avatar.jpg"/>
</a>
<div class="author">
    <span>Whitebird</span>
</div>

<div class="icon">
    
        
            <a title="github"
               href="https://github.com/Whitebird0"
               target="_blank">
                
                    <svg class="iconfont-svg" aria-hidden="true">
                        <use xlink:href="#icon-github"></use>
                    </svg>
                
            </a>
        
    
        
            <a title="csdn"
               href="https://blog.csdn.net/jxnu_666?type=blog"
               target="_blank">
                
                    <svg class="iconfont-svg" aria-hidden="true">
                        <use xlink:href="#icon-csdn"></use>
                    </svg>
                
            </a>
        
    
        
            <a title="email"
               href="mailto:767778848@qq.com"
               target="_blank">
                
                    <svg class="iconfont-svg" aria-hidden="true">
                        <use xlink:href="#icon-email"></use>
                    </svg>
                
            </a>
        
    
        
            <a title="qq"
               href="http://wpa.qq.com/msgrd?v=3&uin=767778848&site=qq&menu=yes"
               target="_blank">
                
                    <svg class="iconfont-svg" aria-hidden="true">
                        <use xlink:href="#icon-qq"></use>
                    </svg>
                
            </a>
        
    
</div>




<ul>
    <li>
        <div class="all active" data-rel="全部文章">全部文章
            
                <small>(32)</small>
            
        </div>
    </li>
    
        
            
                <li>
                    <div data-rel="CTF">
                        
                        CTF
                        <small>(6)</small>
                        
                    </div>
                    
                </li>
            
        
    
        
            
                <li>
                    <div data-rel="Reverse">
                        
                        Reverse
                        <small>(8)</small>
                        
                    </div>
                    
                </li>
            
        
    
        
            
                <li>
                    <div data-rel="Android开发">
                        
                        Android开发
                        <small>(10)</small>
                        
                    </div>
                    
                </li>
            
        
    
        
            
                <li>
                    <div data-rel="Android逆向">
                        
                        Android逆向
                        <small>(5)</small>
                        
                    </div>
                    
                </li>
            
        
    
        
            
                <li>
                    <div data-rel="WEB安全">
                        
                        WEB安全
                        <small>(2)</small>
                        
                    </div>
                    
                </li>
            
        
    
        
            
                <li>
                    <div data-rel="Windows内核">
                        
                        Windows内核
                        <small>(1)</small>
                        
                    </div>
                    
                </li>
            
        
    
</ul>
<div class="left-bottom">
    <div class="menus">
        
            
            
    </div>
    <div>
        
            <a class="about  hasFriend  site_url"
               
               href="/about">关于</a>
        
        <a style="width: 50%"
                
                                           class="friends">友链</a>
        
    </div>
</div>
<input type="hidden" id="yelog_site_posts_number" value="32">
<input type="hidden" id="yelog_site_word_count" value="192.1k">
<div style="display: none">
    <span id="busuanzi_value_site_uv"></span>
    <span id="busuanzi_value_site_pv"></span>
</div>

    </div>
    <div class="nav-right">
        <div class="friends-area">
    <div class="friends-title">
        友情链接
        <i class="iconfont icon-left"></i>
    </div>
    <div class="friends-content">
        <ul>
            
            <li><a target="_blank" href="https://www.codetea.top/">Codetea</a></li>
            
        </ul>
    </div>
</div>
        <div class="title-list">
    <div class="right-top">
        <div id="default-panel">
            <i class="iconfont icon-search" data-title="搜索 快捷键 i"></i>
            <div class="right-title">全部文章</div>
            <i class="iconfont icon-file-tree" data-title="切换到大纲视图 快捷键 w"></i>
        </div>
        <div id="search-panel">
            <i class="iconfont icon-left" data-title="返回"></i>
            <input id="local-search-input" autocomplete="off"/>
            <label class="border-line" for="input"></label>
            <i class="iconfont icon-case-sensitive" data-title="大小写敏感"></i>
            <i class="iconfont icon-tag" data-title="标签"></i>
        </div>
        <div id="outline-panel" style="display: none">
            <div class="right-title">大纲</div>
            <i class="iconfont icon-list" data-title="切换到文章列表"></i>
        </div>
    </div>

    <div class="tags-list">
    <input id="tag-search" />
    <div class="tag-wrapper">
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>Android</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>CTF</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>Reverse</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>WEB</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>Windows内核</a>
            </li>
        
    </div>

</div>

    
    <div id="local-search-result">

    </div>
    
    <nav id="title-list-nav">
        
        
        <a  class="全部文章 Android逆向 "
           href="/post/%E6%8A%93%E5%8C%85%E6%A3%80%E6%B5%8B%E4%B8%8Ehook%E6%8A%93%E5%8C%85.html"
           data-tag="Android"
           data-author="" >
            <span class="post-title" title="Android逆向中抓包检测与hook抓包">Android逆向中抓包检测与hook抓包</span>
            <span class="post-date" title="2023-12-27 11:40:21">2023/12/27</span>
        </a>
        
        
        <a  class="全部文章 WEB安全 "
           href="/post/web%E5%AE%89%E5%85%A8%E5%AD%A6%E4%B9%A0-%E4%BF%A1%E6%81%AF%E6%89%93%E7%82%B9.html"
           data-tag="WEB"
           data-author="" >
            <span class="post-title" title="WEB安全-信息打点">WEB安全-信息打点</span>
            <span class="post-date" title="2023-12-25 12:40:21">2023/12/25</span>
        </a>
        
        
        <a  class="全部文章 WEB安全 "
           href="/post/web%E5%AE%89%E5%85%A8%E5%AD%A6%E4%B9%A0-%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8.html"
           data-tag="WEB"
           data-author="" >
            <span class="post-title" title="WEB安全-基础入门">WEB安全-基础入门</span>
            <span class="post-date" title="2023-12-20 11:40:21">2023/12/20</span>
        </a>
        
        
        <a  class="全部文章 Android逆向 "
           href="/post/Android%E9%80%86%E5%90%91%E4%B8%AD%E5%B8%B8%E8%A7%81%E5%AF%86%E7%A0%81%E5%AD%A6%E5%85%A5%E9%97%A8.html"
           data-tag="Android"
           data-author="" >
            <span class="post-title" title="Android逆向中常见密码学算法入门">Android逆向中常见密码学算法入门</span>
            <span class="post-date" title="2023-11-30 20:40:21">2023/11/30</span>
        </a>
        
        
        <a  class="全部文章 Android逆向 "
           href="/post/Android%E7%B3%BB%E7%BB%9F%E6%B2%99%E7%9B%92%E5%AE%9A%E5%88%B6%E4%B8%93%E9%A2%98.html"
           data-tag="Android"
           data-author="" >
            <span class="post-title" title="Android系统沙盒定制">Android系统沙盒定制</span>
            <span class="post-date" title="2023-09-15 12:40:21">2023/09/15</span>
        </a>
        
        
        <a  class="全部文章 Android逆向 "
           href="/post/unidbg%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0.html"
           data-tag="Android"
           data-author="" >
            <span class="post-title" title="Android逆向学习笔记——Unidbg学习与实战">Android逆向学习笔记——Unidbg学习与实战</span>
            <span class="post-date" title="2023-07-01 09:00:15">2023/07/01</span>
        </a>
        
        
        <a  class="全部文章 Android逆向 "
           href="/post/Frida%E7%9A%84Python%E5%BA%93%E4%BD%BF%E7%94%A8.html"
           data-tag="Android"
           data-author="" >
            <span class="post-title" title="Android逆向学习笔记——使用Python库调用Frida">Android逆向学习笔记——使用Python库调用Frida</span>
            <span class="post-date" title="2023-06-01 09:00:15">2023/06/01</span>
        </a>
        
        
        <a  class="全部文章 Android开发 "
           href="/post/NDK%E5%BC%80%E5%8F%91%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0.html"
           data-tag="Android"
           data-author="" >
            <span class="post-title" title="Android开发学习笔记——NDK开发">Android开发学习笔记——NDK开发</span>
            <span class="post-date" title="2023-03-31 09:00:14">2023/03/31</span>
        </a>
        
        
        <a  class="全部文章 Android开发 "
           href="/post/the_first_code1.html"
           data-tag="Android"
           data-author="" >
            <span class="post-title" title="Android开发学习笔记(1)——初识安卓">Android开发学习笔记(1)——初识安卓</span>
            <span class="post-date" title="2023-03-30 09:00:21">2023/03/30</span>
        </a>
        
        
        <a  class="全部文章 Android开发 "
           href="/post/the_first_code2.html"
           data-tag="Android"
           data-author="" >
            <span class="post-title" title="Android开发学习笔记(2)——探究活动">Android开发学习笔记(2)——探究活动</span>
            <span class="post-date" title="2023-03-30 09:00:20">2023/03/30</span>
        </a>
        
        
        <a  class="全部文章 Android开发 "
           href="/post/the_first_code3.html"
           data-tag="Android"
           data-author="" >
            <span class="post-title" title="Android开发学习笔记(3)——UI开发">Android开发学习笔记(3)——UI开发</span>
            <span class="post-date" title="2023-03-30 09:00:19">2023/03/30</span>
        </a>
        
        
        <a  class="全部文章 Android开发 "
           href="/post/the_first_code4.html"
           data-tag="Android"
           data-author="" >
            <span class="post-title" title="Android开发学习笔记(4)——探究碎片">Android开发学习笔记(4)——探究碎片</span>
            <span class="post-date" title="2023-03-30 09:00:18">2023/03/30</span>
        </a>
        
        
        <a  class="全部文章 Android开发 "
           href="/post/the_first_code5.html"
           data-tag="Android"
           data-author="" >
            <span class="post-title" title="Android开发学习笔记(5)——详解广播机制">Android开发学习笔记(5)——详解广播机制</span>
            <span class="post-date" title="2023-03-30 09:00:17">2023/03/30</span>
        </a>
        
        
        <a  class="全部文章 Android开发 "
           href="/post/the_first_code6.html"
           data-tag="Android"
           data-author="" >
            <span class="post-title" title="Android开发学习笔记(6)——数据存储全方案">Android开发学习笔记(6)——数据存储全方案</span>
            <span class="post-date" title="2023-03-30 09:00:16">2023/03/30</span>
        </a>
        
        
        <a  class="全部文章 Android开发 "
           href="/post/the_first_code7.html"
           data-tag="Android"
           data-author="" >
            <span class="post-title" title="Android开发学习笔记(7)——跨程序共享数据">Android开发学习笔记(7)——跨程序共享数据</span>
            <span class="post-date" title="2023-03-30 09:00:15">2023/03/30</span>
        </a>
        
        
        <a  class="全部文章 Android开发 "
           href="/post/the_first_code8.html"
           data-tag="Android"
           data-author="" >
            <span class="post-title" title="Android开发学习笔记(8)——运用手机多媒体">Android开发学习笔记(8)——运用手机多媒体</span>
            <span class="post-date" title="2023-03-30 09:00:14">2023/03/30</span>
        </a>
        
        
        <a  class="全部文章 Android开发 "
           href="/post/the_first_code9.html"
           data-tag="Android"
           data-author="" >
            <span class="post-title" title="Android开发学习笔记(9)——网络技术">Android开发学习笔记(9)——网络技术</span>
            <span class="post-date" title="2023-03-30 09:00:13">2023/03/30</span>
        </a>
        
        
        <a  class="全部文章 CTF "
           href="/post/2022%E5%B9%B4%E6%B1%9F%E8%A5%BF%E7%9C%81%E2%80%9C%E8%B5%A3%E8%82%B2%E6%9D%AF%E2%80%9D%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%A4%A7%E8%B5%9B.html"
           data-tag="CTF"
           data-author="" >
            <span class="post-title" title="2022年江西省“赣育杯”网络安全大赛初赛 Re WriteUp">2022年江西省“赣育杯”网络安全大赛初赛 Re WriteUp</span>
            <span class="post-date" title="2022-10-08 22:40:21">2022/10/08</span>
        </a>
        
        
        <a  class="全部文章 CTF "
           href="/post/qwb.html"
           data-tag="CTF"
           data-author="" >
            <span class="post-title" title="第六届强网杯全国网络安全挑战赛 Re WriteUp">第六届强网杯全国网络安全挑战赛 Re WriteUp</span>
            <span class="post-date" title="2022-08-08 15:49:21">2022/08/08</span>
        </a>
        
        
        <a  class="全部文章 CTF "
           href="/post/bluecup.html"
           data-tag="CTF"
           data-author="" >
            <span class="post-title" title="第六届蓝帽杯初赛CTF题目 Re WriteUp">第六届蓝帽杯初赛CTF题目 Re WriteUp</span>
            <span class="post-date" title="2022-07-13 22:49:21">2022/07/13</span>
        </a>
        
        
        <a  class="全部文章 CTF "
           href="/post/CISCN2022.html"
           data-tag="CTF"
           data-author="" >
            <span class="post-title" title="第十五届全国大学生信息安全竞赛创新实践能力赛CISCN">第十五届全国大学生信息安全竞赛创新实践能力赛CISCN</span>
            <span class="post-date" title="2022-06-03 20:49:21">2022/06/03</span>
        </a>
        
        
        <a  class="全部文章 CTF "
           href="/post/2022DASCTF%20Apr%20X%20FATE%20%E9%98%B2%E7%96%AB%E6%8C%91%E6%88%98%E8%B5%9B.html"
           data-tag="CTF"
           data-author="" >
            <span class="post-title" title="2022DASCTF Apr X FATE 防疫挑战赛">2022DASCTF Apr X FATE 防疫挑战赛</span>
            <span class="post-date" title="2022-06-01 20:49:21">2022/06/01</span>
        </a>
        
        
        <a  class="全部文章 Reverse "
           href="/post/PE%E6%98%A0%E5%83%8F%E5%88%87%E6%8D%A2.html"
           data-tag="Reverse"
           data-author="" >
            <span class="post-title" title="逆向工程核心原理——PE映像切换">逆向工程核心原理——PE映像切换</span>
            <span class="post-date" title="2022-04-02 10:49:21">2022/04/02</span>
        </a>
        
        
        <a  class="全部文章 Reverse "
           href="/post/%E5%8F%8D%E8%B0%83%E8%AF%95%E6%8A%80%E6%9C%AF.html"
           data-tag="Reverse"
           data-author="" >
            <span class="post-title" title="逆向工程核心原理——反调试技术">逆向工程核心原理——反调试技术</span>
            <span class="post-date" title="2022-03-28 10:30:21">2022/03/28</span>
        </a>
        
        
        <a  class="全部文章 CTF "
           href="/post/2022-3-26-2022DASCTF-X-SU-Re-WriteUp.html"
           data-tag="CTF"
           data-author="" >
            <span class="post-title" title="2022DASCTF X SU Re WriteUp">2022DASCTF X SU Re WriteUp</span>
            <span class="post-date" title="2022-03-26 20:49:21">2022/03/26</span>
        </a>
        
        
        <a  class="全部文章 Reverse "
           href="/post/SEH.html"
           data-tag="Reverse"
           data-author="" >
            <span class="post-title" title="逆向工程核心原理——SEH原理分析">逆向工程核心原理——SEH原理分析</span>
            <span class="post-date" title="2022-03-19 10:49:21">2022/03/19</span>
        </a>
        
        
        <a  class="全部文章 Reverse "
           href="/post/TLS%E5%9B%9E%E8%B0%83%E5%87%BD%E6%95%B0.html"
           data-tag="Reverse"
           data-author="" >
            <span class="post-title" title="逆向工程核心原理——TLS回调函数">逆向工程核心原理——TLS回调函数</span>
            <span class="post-date" title="2022-03-15 22:49:21">2022/03/15</span>
        </a>
        
        
        <a  class="全部文章 Reverse "
           href="/post/%E5%85%A8%E5%B1%80API%E9%92%A9%E5%8F%96-IE%E9%93%BE%E6%8E%A5%E6%8E%A7%E5%88%B6.html"
           data-tag="Reverse"
           data-author="" >
            <span class="post-title" title="逆向工程核心原理——全局API钩取">逆向工程核心原理——全局API钩取</span>
            <span class="post-date" title="2022-03-11 16:49:21">2022/03/11</span>
        </a>
        
        
        <a  class="全部文章 Reverse "
           href="/post/%E8%AE%A1%E7%AE%97%E5%99%A8%E6%98%BE%E7%A4%BA%E4%B8%AD%E6%96%87%E6%95%B0%E5%AD%97.html"
           data-tag="Reverse"
           data-author="" >
            <span class="post-title" title="逆向工程核心原理——IAT_HOOK">逆向工程核心原理——IAT_HOOK</span>
            <span class="post-date" title="2022-03-08 22:49:21">2022/03/08</span>
        </a>
        
        
        <a  class="全部文章 Reverse "
           href="/post/%E9%80%9A%E8%BF%87%E4%BF%AE%E6%94%B9PE%E5%8A%A0%E8%BD%BDDLL.html"
           data-tag="Reverse"
           data-author="" >
            <span class="post-title" title="逆向工程核心原理——通过修改PE加载DLL">逆向工程核心原理——通过修改PE加载DLL</span>
            <span class="post-date" title="2022-02-28 22:49:21">2022/02/28</span>
        </a>
        
        
        <a  class="全部文章 Reverse "
           href="/post/DLL%E6%B3%A8%E5%85%A5.html"
           data-tag="Reverse"
           data-author="" >
            <span class="post-title" title="逆向工程核心原理——DLL注入">逆向工程核心原理——DLL注入</span>
            <span class="post-date" title="2022-02-26 00:49:21">2022/02/26</span>
        </a>
        
        
        <a  class="全部文章 Windows内核 "
           href="/post/%E6%AE%B5%E4%B8%8E%E9%A1%B5%E7%9A%84%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5.html"
           data-tag="Windows内核"
           data-author="" >
            <span class="post-title" title="Windows内核基础知识-段选择子与段描述符">Windows内核基础知识-段选择子与段描述符</span>
            <span class="post-date" title="2021-10-03 12:40:21">2021/10/03</span>
        </a>
        
        <div id="no-item-tips">

        </div>
    </nav>
    <div id="outline-list">
    </div>
</div>

    </div>
    <div class="hide-list">
        <div class="semicircle" data-title="切换全屏 快捷键 s">
            <div class="brackets first"><</div>
            <div class="brackets">&gt;</div>
        </div>
    </div>
</aside>
<div id="post">
    <div class="pjax">
        <article id="post-Android系统沙盒定制专题" class="article article-type-post" itemscope itemprop="blogPost">
    
        <h1 class="article-title">Android系统沙盒定制</h1>
    
    <div class="article-meta">
        
        
        
        <span class="book">
            <i class="iconfont icon-category"></i>
            
            
            <a  data-rel="Android逆向">Android逆向</a>
            
        </span>
        
        
        <span class="tag">
            <i class="iconfont icon-tag"></i>
            
            <a class="color3">Android</a>
            
        </span>
        
    </div>
    <div class="article-meta">
        
            发布时间 : <time class="date" title='最后更新: 2023-09-29 01:04:04'>2023-09-15 12:40</time>
        
    </div>
    <div class="article-meta">
        
        <span>字数:18.3k</span>
        
        
        <span id="busuanzi_container_page_pv">
            阅读 :<span id="busuanzi_value_page_pv">
                <span class="count-comment">
                    <span class="spinner">
                      <div class="cube1"></div>
                      <div class="cube2"></div>
                    </span>
                </span>
            </span>
        </span>
        
        
        <span class="top-comment" title="跳转至评论区">
            <a href="#comments">
                评论:<span class="count-comment">
                    <span class="spinner">
                      <div class="cube1"></div>
                      <div class="cube2"></div>
                    </span>
                </span>
            </a>
        </span>
        
    </div>
    
    <div class="toc-ref">
    
        <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%80%E3%80%81Frida%E6%8C%81%E4%B9%85%E5%8C%96"><span class="toc-text">一、Frida持久化</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1%E3%80%81%E6%A6%82%E8%BF%B0"><span class="toc-text">1、概述</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2%E3%80%81%E5%8A%9F%E8%83%BD"><span class="toc-text">2、功能</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3%E3%80%81%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE"><span class="toc-text">3、环境配置</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4%E3%80%81%E9%85%8D%E7%BD%AEgit"><span class="toc-text">4、配置git</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5%E3%80%81%E4%B8%8B%E8%BD%BDrepo"><span class="toc-text">5、下载repo</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6%E3%80%81%E4%BF%AE%E6%94%B9%E9%BB%98%E8%AE%A4python"><span class="toc-text">6、修改默认python</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7%E3%80%81%E5%90%8C%E6%AD%A5%E6%8C%87%E5%AE%9A%E7%89%88%E6%9C%AC%E6%BA%90%E7%A0%81"><span class="toc-text">7、同步指定版本源码</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8%E3%80%81%E5%AE%89%E8%A3%85JDK8"><span class="toc-text">8、安装JDK8</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#9%E3%80%81%E5%AE%89%E8%A3%85%E6%89%80%E9%9C%80%E4%BE%9D%E8%B5%96-Ubuntu-20-04"><span class="toc-text">9、安装所需依赖 (Ubuntu 20.04)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#10%E3%80%81%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8%E7%9A%84%E5%87%86%E5%A4%87"><span class="toc-text">10、设备驱动的准备</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#11%E3%80%81%E7%BC%96%E8%AF%91%E6%BA%90%E7%A0%81"><span class="toc-text">11、编译源码</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#12%E3%80%81AOSP%E6%BA%90%E7%A0%81%E5%AF%BC%E5%85%A5%E5%88%B0AndroidStudio"><span class="toc-text">12、AOSP源码导入到AndroidStudio</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#13%E3%80%81Frida%E6%8C%81%E4%B9%85%E5%8C%96%E4%BB%8B%E7%BB%8D"><span class="toc-text">13、Frida持久化介绍</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#14%E3%80%81%E7%BC%96%E8%AF%91%E8%A1%A5%E5%85%85"><span class="toc-text">14、编译补充</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#15%E3%80%81%E4%BF%AE%E6%94%B9APP%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B"><span class="toc-text">15、修改APP启动流程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#16%E3%80%81%E5%AE%9E%E7%8E%B0doWhitebirdPersist%E5%92%8CisEnablePersist"><span class="toc-text">16、实现doWhitebirdPersist和isEnablePersist</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#17%E3%80%81%E5%B0%86frida-gadget%E9%9B%86%E6%88%90%E5%88%B0%E7%B3%BB%E7%BB%9F"><span class="toc-text">17、将frida-gadget集成到系统</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#18%E3%80%81%E8%87%AA%E5%AE%9A%E4%B9%89%E7%9B%AE%E5%BD%95%E8%AE%BE%E8%AE%A1"><span class="toc-text">18、自定义目录设计</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#19%E3%80%81%E5%88%9B%E5%BB%BA%E6%96%87%E4%BB%B6%E7%B1%BB%E5%9E%8BSeLinux%E6%A0%87%E7%AD%BE"><span class="toc-text">19、创建文件类型SeLinux标签</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#20%E3%80%81%E4%B8%BA%E8%87%AA%E5%AE%9A%E4%B9%89%E7%9B%AE%E5%BD%95%E5%85%B3%E8%81%94%E6%96%87%E4%BB%B6%E7%B1%BB%E5%9E%8B%E6%A0%87%E7%AD%BE-whitebird-file"><span class="toc-text">20、为自定义目录关联文件类型标签: whitebird_file</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#21%E3%80%81%E9%85%8D%E7%BD%AEsystem-app%E8%AE%BF%E9%97%AE-whitebird-file-%E6%A0%87%E7%AD%BE%E6%96%87%E4%BB%B6%E7%9A%84%E6%9D%83%E9%99%90"><span class="toc-text">21、配置system app访问 whitebird_file 标签文件的权限</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#22%E3%80%81%E9%85%8D%E7%BD%AE%E7%94%A8%E6%88%B7app%E8%AE%BF%E9%97%AE-whitebird-file%E6%A0%87%E7%AD%BE%E6%96%87%E4%BB%B6%E7%9A%84%E6%9D%83%E9%99%90"><span class="toc-text">22、配置用户app访问 whitebird_file标签文件的权限</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#23%E3%80%81%E7%BC%96%E8%AF%91%E4%BB%A5%E5%8F%8A%E8%A7%A3%E5%86%B3%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98"><span class="toc-text">23、编译以及解决常见问题</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#24%E3%80%81Frida%E6%8C%81%E4%B9%85%E5%8C%96%E7%AE%A1%E7%90%86App"><span class="toc-text">24、Frida持久化管理App</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BA%8C%E3%80%81%E5%8A%A0%E5%9B%BA%E4%B8%8E%E8%84%B1%E5%A3%B3"><span class="toc-text">二、加固与脱壳</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1%E3%80%81%E4%BB%80%E4%B9%88%E6%98%AF%E5%8A%A0%E5%9B%BA"><span class="toc-text">1、什么是加固</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9C%AA%E5%8A%A0%E5%AF%86"><span class="toc-text">未加密</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#360%E5%8A%A0%E5%9B%BA%E2%80%94%E2%80%94%E6%95%B4%E4%BD%93%E5%8A%A0%E5%9B%BA"><span class="toc-text">360加固——整体加固</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%88%B1%E5%8A%A0%E5%AF%86%E2%80%94%E2%80%94%E6%8A%BD%E5%8F%96%E5%A3%B3"><span class="toc-text">爱加密——抽取壳</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2%E3%80%81%E4%BB%80%E4%B9%88%E6%98%AF%E8%84%B1%E5%A3%B3"><span class="toc-text">2、什么是脱壳</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3%E3%80%81%E4%B8%BA%E4%BB%80%E4%B9%88%E8%A6%81%E8%84%B1%E5%A3%B3"><span class="toc-text">3、为什么要脱壳</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4%E3%80%81%E5%88%86%E6%9E%90%E5%8A%A0%E5%9B%BA%E7%9A%84app%E6%98%AF%E4%B8%8D%E6%98%AF%E5%BF%85%E9%A1%BB%E8%84%B1%E5%A3%B3"><span class="toc-text">4、分析加固的app是不是必须脱壳</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5%E3%80%81%E6%80%8E%E4%B9%88%E5%88%A4%E6%96%ADapp%E6%98%AF%E5%90%A6%E5%8A%A0%E5%9B%BA"><span class="toc-text">5、怎么判断app是否加固</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6%E3%80%81%E5%8A%A0%E5%9B%BA%E7%9A%84%E5%88%86%E7%B1%BB"><span class="toc-text">6、加固的分类</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7%E3%80%81%E6%95%B4%E4%BD%93%E5%8A%A0%E5%9B%BA"><span class="toc-text">7、整体加固</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%8B%E7%BB%8D"><span class="toc-text">介绍</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88"><span class="toc-text">解决方案</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8%E3%80%81ART%E4%B8%8B%E7%9A%84%E8%84%B1%E5%A3%B3%E5%8E%9F%E7%90%86%E2%80%94%E6%95%B4%E4%BD%93%E5%8A%A0%E5%9B%BA"><span class="toc-text">8、ART下的脱壳原理—整体加固</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1%E3%80%81%E5%9C%A8%E7%BA%BF%E6%BA%90%E7%A0%81%E6%9F%A5%E7%9C%8B"><span class="toc-text">1、在线源码查看</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%E3%80%81ART%E4%B8%8B%E7%9A%84%E8%84%B1%E5%A3%B3%E7%82%B9"><span class="toc-text">2、ART下的脱壳点</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3%E3%80%81InMemoryDexClassLoader%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90"><span class="toc-text">3、InMemoryDexClassLoader源码分析</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#InMemoryDexClassLoader"><span class="toc-text">InMemoryDexClassLoader</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#BaseDexClassLoader"><span class="toc-text">BaseDexClassLoader</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#initByteBufferDexPath"><span class="toc-text">initByteBufferDexPath</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#DexFile"><span class="toc-text">DexFile</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#openInMemoryDexFiles"><span class="toc-text">openInMemoryDexFiles</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#DexFile-openInMemoryDexFilesNative"><span class="toc-text">DexFile_openInMemoryDexFilesNative</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#CreateCookieFromOatFileManagerResult"><span class="toc-text">CreateCookieFromOatFileManagerResult</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ConvertDexFilesToJavaArray"><span class="toc-text">ConvertDexFilesToJavaArray</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ConvertJavaArrayToDexFiles"><span class="toc-text">ConvertJavaArrayToDexFiles</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#OpenDexFilesFromOat"><span class="toc-text">OpenDexFilesFromOat</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#OpenDexFilesFromOat-Impl"><span class="toc-text">OpenDexFilesFromOat_Impl</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ArtDexFileLoader-Open"><span class="toc-text">ArtDexFileLoader.Open</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#DexFileLoader-OpenCommon"><span class="toc-text">DexFileLoader::OpenCommon</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4%E3%80%81DexClassLoader%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90"><span class="toc-text">4、DexClassLoader源码分析</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#DexClassLoader"><span class="toc-text">DexClassLoader</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#DexPathList"><span class="toc-text">DexPathList</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#makeDexElements"><span class="toc-text">makeDexElements</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#loadDexFile"><span class="toc-text">loadDexFile</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#DexFile-1"><span class="toc-text">DexFile</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#DexFile-loadDex"><span class="toc-text">DexFile.loadDex</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#openDexFile"><span class="toc-text">openDexFile</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#openDexFileNative"><span class="toc-text">openDexFileNative</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#OpenDexFilesFromOat-1"><span class="toc-text">OpenDexFilesFromOat</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ArtDexFileLoader-Open-1"><span class="toc-text">ArtDexFileLoader::Open</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#OpenWithMagic"><span class="toc-text">OpenWithMagic</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#OpenFile"><span class="toc-text">OpenFile</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5%E3%80%81youpk%E8%84%B1%E5%A3%B3%E5%8E%9F%E7%90%86"><span class="toc-text">5、youpk脱壳原理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6%E3%80%81dex2oat%E7%9A%84%E8%84%B1%E5%A3%B3%E5%8E%9F%E7%90%86"><span class="toc-text">6、dex2oat的脱壳原理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7%E3%80%81FDex2"><span class="toc-text">7、FDex2</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8%E3%80%81%E5%B8%B8%E8%A7%81%E8%84%B1%E5%A3%B3%E7%82%B9"><span class="toc-text">8、常见脱壳点</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#9%E3%80%81aosp%E5%AF%BC%E5%85%A5Clion"><span class="toc-text">9、aosp导入Clion</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1%E3%80%81Clion%E7%9A%84%E5%AE%89%E8%A3%85"><span class="toc-text">1、Clion的安装</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2%E3%80%81%E7%94%9F%E6%88%90%E7%94%A8%E4%BA%8E%E5%B0%86%E6%BA%90%E7%A0%81%E5%AF%BC%E5%85%A5Clion%E7%9A%84CMakeLists-txt"><span class="toc-text">2、生成用于将源码导入Clion的CMakeLists.txt</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3%E3%80%81%E7%94%A8Clion%E6%89%93%E5%BC%80%E8%AF%A5CMakeLists-txt"><span class="toc-text">3、用Clion打开该CMakeLists.txt</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4%E3%80%81tools-%E2%80%93-cmake-%E2%80%93-Change-Project-Root"><span class="toc-text">4、tools –&gt; cmake –&gt; Change Project Root</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#10%E3%80%81fart%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90"><span class="toc-text">10、fart源码分析</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#9%E3%80%81%E6%8A%BD%E5%8F%96%E5%8A%A0%E5%9B%BA"><span class="toc-text">9、抽取加固</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%8B%E7%BB%8D-1"><span class="toc-text">介绍</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1%E3%80%81%E6%8A%BD%E5%8F%96%E5%8A%A0%E5%9B%BA%E6%9C%AC%E8%B4%A8%EF%BC%9A"><span class="toc-text">1、抽取加固本质：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2%E3%80%81%E6%8A%BD%E5%8F%96%E5%8A%A0%E5%9B%BA%E7%9A%84%E5%AE%9E%E7%8E%B0%E5%BD%A2%E5%BC%8F"><span class="toc-text">2、抽取加固的实现形式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3%E3%80%81%E6%8A%BD%E5%8F%96%E5%8A%A0%E5%9B%BA%E5%AF%B9%E5%8E%9F%E6%9C%89dex%E7%9A%84%E5%A4%84%E7%90%86%E5%BD%A2%E5%BC%8F"><span class="toc-text">3、抽取加固对原有dex的处理形式</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88-1"><span class="toc-text">解决方案</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1%E3%80%81%E8%A7%A3%E5%86%B3%E6%80%9D%E8%B7%AF%EF%BC%9A"><span class="toc-text">1、解决思路：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2%E3%80%81%E8%A2%AB%E5%8A%A8%E8%B0%83%E7%94%A8"><span class="toc-text">2、被动调用</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3%E3%80%81%E4%B8%BB%E5%8A%A8%E8%B0%83%E7%94%A8"><span class="toc-text">3、主动调用</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4%E3%80%81%E5%B8%B8%E8%A7%81%E7%9A%84%E6%8A%BD%E5%8F%96%E5%8A%A0%E5%9B%BA%E8%84%B1%E5%A3%B3%E7%B3%BB%E7%BB%9F"><span class="toc-text">4、常见的抽取加固脱壳系统</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#10%E3%80%81%E7%B1%BB%E5%8A%A0%E8%BD%BD%E5%99%A8"><span class="toc-text">10、类加载器</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1%E3%80%81%E6%8A%BD%E5%8F%96%E5%8A%A0%E5%9B%BA%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88"><span class="toc-text">1、抽取加固解决方案</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%E3%80%81%E5%A6%82%E4%BD%95%E8%B0%83%E7%94%A8app%E4%B8%AD%E7%9A%84%E6%89%80%E6%9C%89%E5%87%BD%E6%95%B0%E5%91%A2%EF%BC%9F"><span class="toc-text">2、如何调用app中的所有函数呢？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3%E3%80%81%E5%AE%89%E5%8D%93%E4%B8%AD%E5%B8%B8%E8%A7%81%E7%9A%84%E7%B1%BB%E5%8A%A0%E8%BD%BD%E5%99%A8"><span class="toc-text">3、安卓中常见的类加载器</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#3-1%E3%80%81BootClassLoader"><span class="toc-text">3.1、BootClassLoader</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-2%E3%80%81BaseDexClassLoader"><span class="toc-text">3.2、BaseDexClassLoader</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-3%E3%80%81PathClassLoader%EF%BC%9A"><span class="toc-text">3.3、PathClassLoader：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-4%E3%80%81DexClassLoader%EF%BC%9A"><span class="toc-text">3.4、DexClassLoader：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-5%E3%80%81InMemoryDexClassLoader%EF%BC%9A"><span class="toc-text">3.5、InMemoryDexClassLoader：</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4%E3%80%81%E4%BB%A3%E7%A0%81%E6%B5%8B%E8%AF%95"><span class="toc-text">4、代码测试</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#11%E3%80%81%E5%8F%8C%E4%BA%B2%E5%A7%94%E6%B4%BE%E6%9C%BA%E5%88%B6"><span class="toc-text">11、双亲委派机制</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1%E3%80%81%E7%B1%BB%E5%8A%A0%E8%BD%BD"><span class="toc-text">1、类加载</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%E3%80%81%E5%8F%8C%E4%BA%B2%E5%A7%94%E6%B4%BE%E6%9C%BA%E5%88%B6%E7%9A%84%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86"><span class="toc-text">2、双亲委派机制的工作原理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3%E3%80%81%E4%B8%BA%E4%BB%80%E4%B9%88%E8%A6%81%E6%9C%89%E5%8F%8C%E4%BA%B2%E5%A7%94%E6%B4%BE"><span class="toc-text">3、为什么要有双亲委派</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4%E3%80%81%E5%8A%A0%E5%9B%BA%E5%AF%B9%E7%B1%BB%E5%8A%A0%E8%BD%BD%E5%99%A8%E7%9A%84%E5%BD%B1%E5%93%8D"><span class="toc-text">4、加固对类加载器的影响</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#4-1%E3%80%81%E5%A6%82%E4%BD%95%E8%8E%B7%E5%8F%96%E6%89%80%E6%9C%89%E7%9A%84ClassLoader"><span class="toc-text">4.1、如何获取所有的ClassLoader</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-2%E3%80%81%E5%A6%82%E4%BD%95%E5%85%88%E5%BE%97%E5%88%B0%E4%B8%80%E4%B8%AAClassLoader"><span class="toc-text">4.2、如何先得到一个ClassLoader</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-3%E3%80%81%E6%99%AE%E9%80%9Aapp%E8%BF%90%E8%A1%8C%E6%B5%81%E7%A8%8B"><span class="toc-text">4.3、普通app运行流程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-4%E3%80%81%E5%8A%A0%E5%9B%BAapp%E8%BF%90%E8%A1%8C%E6%B5%81%E7%A8%8B"><span class="toc-text">4.4、加固app运行流程</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-5%E3%80%81%E5%8A%A0%E5%9B%BA%E5%AF%B9%E7%B1%BB%E5%8A%A0%E8%BD%BD%E5%99%A8%E7%9A%84%E4%BF%AE%E6%AD%A3%E6%96%B9%E5%BC%8F"><span class="toc-text">4.5、加固对类加载器的修正方式</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#12%E3%80%81fart%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90"><span class="toc-text">12、fart源码分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%81%8D%E5%8E%86%E6%89%80%E6%9C%89ClassLoader"><span class="toc-text">遍历所有ClassLoader</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%81%8D%E5%8E%86%E6%89%80%E6%9C%89%E7%9A%84%E7%B1%BB"><span class="toc-text">遍历所有的类</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%81%8D%E5%8E%86%E7%B1%BB%E4%B8%AD-%E6%89%80%E6%9C%89%E7%9A%84%E5%87%BD%E6%95%B0"><span class="toc-text">遍历类中 所有的函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%B1%BB%E7%9A%84%E5%8A%A0%E8%BD%BD%E5%92%8C%E5%88%9D%E5%A7%8B%E5%8C%96%E6%B5%81%E7%A8%8B"><span class="toc-text">类的加载和初始化流程</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%B1%BB%E5%8A%A0%E8%BD%BD"><span class="toc-text">类加载</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%B1%BB%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="toc-text">类初始化</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%B9%E6%B3%95%E8%B0%83%E7%94%A8%E6%B5%81%E7%A8%8B"><span class="toc-text">方法调用流程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#dumpMethodCode-method"><span class="toc-text">dumpMethodCode_method</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B0%86FART%E8%BF%81%E7%A7%BB%E5%88%B0%E5%AE%89%E5%8D%9310"><span class="toc-text">将FART迁移到安卓10</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#13%E3%80%81dex%E9%87%8D%E6%9E%84"><span class="toc-text">13、dex重构</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#14%E3%80%81FART%E5%AD%98%E5%9C%A8%E7%9A%84%E9%97%AE%E9%A2%98"><span class="toc-text">14、FART存在的问题</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#15%E3%80%81FART%E6%94%B9%E8%BF%9B%E6%96%B9%E6%A1%88"><span class="toc-text">15、FART改进方案</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#16%E3%80%81%E4%BD%BF%E7%94%A8frida%E8%B0%83%E7%94%A8fart%E5%87%BD%E6%95%B0%E6%8E%A5%E5%8F%A3"><span class="toc-text">16、使用frida调用fart函数接口</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AF%B9%E6%9F%90%E4%B8%AAdex%E8%BF%9B%E8%A1%8C%E8%84%B1%E5%A3%B3"><span class="toc-text">对某个dex进行脱壳</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AF%B9%E6%9F%90%E4%B8%AA%E7%B1%BB%E8%BF%9B%E8%A1%8C%E8%84%B1%E5%A3%B3"><span class="toc-text">对某个类进行脱壳</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#17%E3%80%81%E5%85%B6%E4%BB%96%E5%8A%A0%E5%9B%BA%E5%BD%A2%E5%BC%8F"><span class="toc-text">17、其他加固形式</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1%E3%80%81VMP"><span class="toc-text">1、VMP</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%E3%80%81dex2c"><span class="toc-text">2、dex2c</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3%E3%80%81%E5%A4%9A%E7%A7%8D%E6%96%B9%E5%BC%8F%E6%B7%B7%E5%90%88%E5%8A%A0%E5%9B%BA"><span class="toc-text">3、多种方式混合加固</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%89%E3%80%81%E4%BB%A3%E7%A0%81%E8%BF%BD%E8%B8%AA"><span class="toc-text">三、代码追踪</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1%E3%80%81%E6%96%B9%E6%B3%95%E8%B0%83%E7%94%A8%E6%B5%81%E7%A8%8B%E5%9B%9E%E9%A1%BE"><span class="toc-text">1、方法调用流程回顾</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#java%E5%B1%82%E7%9B%B4%E6%8E%A5%E8%B0%83%E7%94%A8"><span class="toc-text">java层直接调用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%80%9A%E8%BF%87jni%E8%B0%83%E7%94%A8"><span class="toc-text">通过jni调用</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2%E3%80%81%E6%96%B9%E6%B3%95%E7%9A%84%E8%A7%A3%E9%87%8A%E6%89%A7%E8%A1%8C%E6%B5%81%E7%A8%8B"><span class="toc-text">2、方法的解释执行流程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3%E3%80%81invoke%E6%8C%87%E4%BB%A4%E7%9A%84%E6%89%A7%E8%A1%8C%E6%B5%81%E7%A8%8B"><span class="toc-text">3、invoke指令的执行流程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4%E3%80%81%E5%BC%BA%E5%88%B6%E8%A7%A3%E9%87%8A%E6%89%A7%E8%A1%8C%E5%8E%9F%E7%90%86"><span class="toc-text">4、强制解释执行原理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5%E3%80%81%E8%BF%BD%E8%B8%AAJava%E5%87%BD%E6%95%B0%E8%B0%83%E7%94%A8%E5%85%B3%E7%B3%BB"><span class="toc-text">5、追踪Java函数调用关系</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6%E3%80%81%E8%BF%BD%E8%B8%AAjni%E5%87%BD%E6%95%B0%E8%B0%83%E7%94%A8%E5%85%B3%E7%B3%BB"><span class="toc-text">6、追踪jni函数调用关系</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#ManagerStack%E4%BB%8B%E7%BB%8D"><span class="toc-text">ManagerStack介绍</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7%E3%80%81%E5%BC%BA%E5%88%B6%E8%BF%90%E8%A1%8C%E5%9C%A8%E8%A7%A3%E9%87%8A%E6%A8%A1%E5%BC%8F%E4%B8%8B"><span class="toc-text">7、强制运行在解释模式下</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8%E3%80%81%E8%BF%BD%E8%B8%AA%E6%AF%8F%E4%B8%80%E6%9D%A1smali%E6%8C%87%E4%BB%A4"><span class="toc-text">8、追踪每一条smali指令</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%9B%9B%E3%80%81%E7%9B%91%E6%8E%A7%E7%BD%91%E7%BB%9C%E8%AE%BF%E9%97%AE"><span class="toc-text">四、监控网络访问</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1%E3%80%81%E5%B8%B8%E8%A7%81%E7%9A%84%E6%8A%93%E5%8C%85%E6%96%B9%E5%BC%8F"><span class="toc-text">1、常见的抓包方式</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1%E3%80%81%E4%BD%BF%E7%94%A8%E6%8A%93%E5%8C%85%E5%B7%A5%E5%85%B7"><span class="toc-text">1.1、使用抓包工具</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2%E3%80%81Hook%E6%8A%93%E5%8C%85"><span class="toc-text">1.2、Hook抓包</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-3%E3%80%81%E7%9B%91%E6%8E%A7%E7%BD%91%E7%BB%9C%E8%AE%BF%E9%97%AE"><span class="toc-text">1.3、监控网络访问</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2%E3%80%81okhttp3%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90"><span class="toc-text">2、okhttp3源码分析</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BA%94%E3%80%81%E5%AE%9A%E5%88%B6%E5%86%85%E6%A0%B8"><span class="toc-text">五、定制内核</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1%E3%80%81%E5%AE%89%E5%8D%93%E7%B3%BB%E7%BB%9F%E7%BB%84%E6%88%90%E7%BB%93%E6%9E%84"><span class="toc-text">1、安卓系统组成结构</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2%E3%80%81%E4%BB%80%E4%B9%88%E6%98%AFLinux%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8-syscall"><span class="toc-text">2、什么是Linux系统调用(syscall)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3%E3%80%81%E5%A6%82%E4%BD%95hook-Linux%E5%86%85%E6%A0%B8%E7%BA%A7%E5%88%AB%E7%9A%84%E5%87%BD%E6%95%B0"><span class="toc-text">3、如何hook Linux内核级别的函数</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4%E3%80%81%E9%80%86%E5%90%91%E5%88%86%E6%9E%90%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8"><span class="toc-text">4、逆向分析系统调用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5%E3%80%81%E8%8E%B7%E5%8F%96%E6%BA%90%E7%A0%81%E7%BC%96%E8%AF%91%E5%86%85%E6%A0%B8"><span class="toc-text">5、获取源码编译内核</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6%E3%80%81%E4%BF%AE%E6%94%B9%E5%86%85%E6%A0%B8%E6%BA%90%E7%A0%81%EF%BC%8C%E5%AE%9E%E7%8E%B0SVC%E7%9B%91%E6%8E%A7"><span class="toc-text">6、修改内核源码，实现SVC监控</span></a></li></ol></li></ol>
    
<style>
    .left-col .switch-btn,
    .left-col .switch-area {
        display: none;
    }
    .toc-level-3 i,
    .toc-level-3 ol {
        display: none !important;
    }
</style>
</div>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="一、Frida持久化"><a href="#一、Frida持久化" class="headerlink" title="一、Frida持久化"></a>一、Frida持久化</h1><h2 id="1、概述"><a href="#1、概述" class="headerlink" title="1、概述"></a>1、概述</h2><p>定制安卓系统其实就是修改安卓系统源码，达到辅助app逆向分析的目的</p>
<h2 id="2、功能"><a href="#2、功能" class="headerlink" title="2、功能"></a>2、功能</h2><p>1、frida-gadget免root、脱离PC、持久化Hook</p>
<p>2、追踪函数调用关系</p>
<p>3、代码追踪</p>
<p>4、整体壳和抽取壳的脱壳</p>
<h2 id="3、环境配置"><a href="#3、环境配置" class="headerlink" title="3、环境配置"></a>3、环境配置</h2><p>Ubuntu20.04：<a target="_blank" rel="noopener" href="http://mirrors.aliyun.com/ubuntu-releases/20.04/">http://mirrors.aliyun.com/ubuntu-releases/20.04/</a></p>
<p>aosp源码：<a target="_blank" rel="noopener" href="https://mirrors.ustc.edu.cn/aosp-monthly">https://mirrors.ustc.edu.cn/aosp-monthly</a></p>
<pre class="line-numbers language-markdown" data-language="markdown"><code class="language-markdown">//下载aosp源码
mkdir <span class="token strike"><span class="token punctuation">~</span><span class="token content">/bin
cd </span><span class="token punctuation">~</span></span>/bin
wget https://mirrors.ustc.edu.cn/aosp-monthly/aosp-latest.tar
wget可以使用-c选项，来支持断点下载
//先计算md5与https://mirrors.ustc.edu.cn/aosp-monthly/aosp-latest.tar.md5是否一致
md5sum aosp-latest.tar
tar xvf aosp-latest.tar<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="4、配置git"><a href="#4、配置git" class="headerlink" title="4、配置git"></a>4、配置git</h2><pre class="line-numbers language-markdown" data-language="markdown"><code class="language-markdown">sudo apt-get install git	安装git

git config --global user.email 767778848@qq.com	配置邮箱

git config --global user.name "whitebird"	配置用户名<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/202307041439698.png"></p>
<h2 id="5、下载repo"><a href="#5、下载repo" class="headerlink" title="5、下载repo"></a>5、下载repo</h2><pre class="line-numbers language-markdown" data-language="markdown"><code class="language-markdown">echo "PATH=<span class="token strike"><span class="token punctuation">~</span><span class="token content">/bin:\$PATH" >> </span><span class="token punctuation">~</span></span>/.bashrc
source <span class="token strike"><span class="token punctuation">~</span><span class="token content">/.bashrc
sudo apt-get install curl
curl -sSL  'https://gerrit-googlesource.proxy.ustclug.org/git-repo/+/master/repo?format=TEXT' |base64 -d > </span><span class="token punctuation">~</span></span>/bin/repo
chmod a+x ~/bin/repo
export REPO_URL='https://gerrit-googlesource.proxy.ustclug.org/git-repo'
cd aosp<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="6、修改默认python"><a href="#6、修改默认python" class="headerlink" title="6、修改默认python"></a>6、修改默认python</h2><pre class="line-numbers language-markdown" data-language="markdown"><code class="language-markdown">sudo unlink /usr/bin/python
sudo ln -s /usr/bin/python3.8 /usr/bin/python<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/202307041452911.png"></p>
<h2 id="7、同步指定版本源码"><a href="#7、同步指定版本源码" class="headerlink" title="7、同步指定版本源码"></a>7、同步指定版本源码</h2><pre class="line-numbers language-markdown" data-language="markdown"><code class="language-markdown">repo init -u https://mirrors.tuna.tsinghua.edu.cn/git/AOSP/platform/manifest -b android-10.0.0_r4
repo sync

a) 代号和细分版本号可查看以下链接
    https://source.android.com/setup/start/build-numbers?hl=zh_cn
b) 选个有驱动的，支持机型多的分支
c) 谷歌手机设备驱动下载地址
		https://developers.google.com/android/drivers
d)同步之前先打个虚拟机快照<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/202307041459601.png"></p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/202307052056170.png"></p>
<p>然后等一会就行了,这个时间比较漫长</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/202307052107726.png"></p>
<p>repo sync的时候有可能会遇到的问题</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">info: A new version of repo is available
repo: Updating release signing keys to keyset ver <span class="token number">2.3</span>
warning: repo is not tracking a remote branch, so it will not receive updates
repo reset: error: Entry <span class="token string">'.github/workflows/test-ci.yml'</span> not uptodate. Cannot merge.
fatal: 不能重置索引文件至版本 <span class="token string">'v2.16^0'</span>。

解决方案：

<span class="token builtin class-name">cd</span> ~/bin/aosp/.repo/repo
<span class="token function">git</span> pull
<span class="token builtin class-name">cd</span> ~/bin/aosp
再次repo init 和 repo <span class="token function">sync</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="8、安装JDK8"><a href="#8、安装JDK8" class="headerlink" title="8、安装JDK8"></a>8、安装JDK8</h2><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">apt-get</span> update
<span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> openjdk-8-jdk<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<h2 id="9、安装所需依赖-Ubuntu-20-04"><a href="#9、安装所需依赖-Ubuntu-20-04" class="headerlink" title="9、安装所需依赖 (Ubuntu 20.04)"></a>9、安装所需依赖 (Ubuntu 20.04)</h2><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> git-core gnupg flex bison build-essential <span class="token function">zip</span> <span class="token function">curl</span> zlib1g-dev gcc-multilib g++-multilib libc6-dev-i386 lib32ncurses5-dev x11proto-core-dev libx11-dev lib32z1-dev libgl1-mesa-dev libxml2-utils xsltproc <span class="token function">unzip</span> fontconfig libncurses5<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>参考以下地址</p>
<p>  <a target="_blank" rel="noopener" href="https://source.android.com/setup/build/initializing?hl=zh-cn">https://source.android.com/setup/build/initializing?hl=zh-cn</a></p>
<h2 id="10、设备驱动的准备"><a href="#10、设备驱动的准备" class="headerlink" title="10、设备驱动的准备"></a>10、设备驱动的准备</h2><p>谷歌手机设备驱动下载地址</p>
<p><a target="_blank" rel="noopener" href="https://developers.google.com/android/drivers">https://developers.google.com/android/drivers</a></p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/202307052226491.png"></p>
<p>移动到ubuntu中bin&#x2F;aosp下</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/202307052227291.png"></p>
<p>在ubuntu下中解压后会有两个sh文件，需要我们运行，且均需要回车键往下阅读到8.d左右的位置输入I ACCEPT </p>
<p>运行完的效果</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/202307052248776.png"></p>
<h2 id="11、编译源码"><a href="#11、编译源码" class="headerlink" title="11、编译源码"></a>11、编译源码</h2><p>参考<a target="_blank" rel="noopener" href="https://source.android.com/docs/setup/build/building?hl=zh-cn">https://source.android.com/docs/setup/build/building?hl=zh-cn</a></p>
<pre class="line-numbers language-markdown" data-language="markdown"><code class="language-markdown">make clobber
source build/envsetup.sh
lunch	# 选择设备内核和编译版本
		<span class="token title important"><span class="token punctuation">#</span> 增加编译产品选项 修改aosp/device/google/marlin/AndroidProducts.mk</span>
make -j8<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/202307060027802.png"></p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/202307060035376.png"></p>
<p>pixel3的代号是，也就是blueline</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/202307060042061.png"></p>
<p>我们编译的选项其实有三个版本 </p>
<pre class="line-numbers language-markdown" data-language="markdown"><code class="language-markdown">user	无root权限
userdebug	带有调试和root权限，su获取超级权限
usereng 带有调试和root权限，超级adb<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>但是我们看上面的种类不全，可以通过指令修改</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/202307060057289.png"></p>
<p>现在已经选完了，我们再输入choosecombo</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/202307060100326.png"></p>
<p>然后make -j8开始编译</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/202307060101740.png"></p>
<h2 id="12、AOSP源码导入到AndroidStudio"><a href="#12、AOSP源码导入到AndroidStudio" class="headerlink" title="12、AOSP源码导入到AndroidStudio"></a>12、AOSP源码导入到AndroidStudio</h2><p>1、进入源码根目录，运行如下命令, 会在源码目录下的out&#x2F;host&#x2F;linux-x86&#x2F;framework目录下生成idegen.jar文件</p>
<pre class="line-numbers language-markdown" data-language="markdown"><code class="language-markdown">source build/envsetup.sh
mmm development/tools/idegen/<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/202307062256248.png"></p>
<p>2、在源码根目录下继续执行如下命令，会在根目录下生成android.iml和android.ipr两个文件，这两个文件是AndroidStudio的工程配置文件</p>
<pre class="line-numbers language-markdown" data-language="markdown"><code class="language-markdown">development/tools/idegen/idegen.sh<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/202307062331963.png"></p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/202307062333509.png"></p>
<p>3、下载Android Studio linux版本</p>
<pre class="line-numbers language-markdown" data-language="markdown"><code class="language-markdown">wget https://redirector.gvt1.com/edgedl/android/studio/ide-zips/2022.2.1.20/android-studio-2022.2.1.20-linux.tar.gz<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/202307062337860.png"></p>
<p>4、解压Android Studio压缩包 </p>
<pre class="line-numbers language-markdown" data-language="markdown"><code class="language-markdown">tar -zxvf android-studio-2022.2.1.20-linux.tar.gz<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/202307062347040.png"></p>
<p>5、运行studio.sh</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/202307062349675.png"></p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/202307062353848.png"></p>
<p>不用导入，默认初始化就行了，安装完成后先自己构建一个demo，为了让android studio下载好gradle</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/202307070022401.png"></p>
<p>下载好后我们修改sdk为API29，也就是Android10，还有安装ndk和cmake</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/202307070039067.png"></p>
<p>之后就是build一下apk，没有问题就可以导入AOSP了</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/202307070057126.png"></p>
<p>这个大概要半个小时以上</p>
<h2 id="13、Frida持久化介绍"><a href="#13、Frida持久化介绍" class="headerlink" title="13、Frida持久化介绍"></a>13、Frida持久化介绍</h2><p>1、Hook的前提</p>
<p>需要将代码或者能够完成Hook功能的东西，注入到目标进程中</p>
<p>安卓中注入的方式：zygote注入、ptrace注入、文件感染等</p>
<p>2、frida-server</p>
<p>利用ptrace注入，需要root权限，为了方便Hook代码修改，还设计成了需要与PC端连接</p>
<p>3、frida-gadget</p>
<p>当Hook代码修改测试完毕，可以通过它来实现免root、脱离PC，但是它本身没有注入功能，需要将其打包到app中</p>
<p>4、魔改系统</p>
<p>在app启动过程中，自动加载frida-gadget，就可以不用修改app了，更通用</p>
<h2 id="14、编译补充"><a href="#14、编译补充" class="headerlink" title="14、编译补充"></a>14、编译补充</h2><p>1、编译报错或者修改系统文件以后，都可以直接make，已经编译的部分会跳过</p>
<p>2、make clean 会清除已经编译的，全部重来，在编译不同lunch选项时使用</p>
<p>3、单独编译system.img，在根目录下</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">source</span> build/envsetup.sh
lunch xxx
<span class="token function">make</span> systemimage <span class="token parameter variable">-j4</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>4、单独编译某个模块 mmm packages&#x2F;apps&#x2F;whitebird</p>
<p>​	  将单独编译的模块打包到img镜像中 make snod</p>
<p>5、更多其他编译方式参考百度</p>
<h2 id="15、修改APP启动流程"><a href="#15、修改APP启动流程" class="headerlink" title="15、修改APP启动流程"></a>15、修改APP启动流程</h2><p>为什么要在程序的MainActivity最开始就加载frida-gadget</p>
<p>因为如果我们运行一段时间再加载，可能在加载之前的一些执行函数我们就无法hook了</p>
<p>当我们点击图标启动APP时，最终会走到ActivityThread，所以我们可以在这里加入加载frida-gadget的代码，实现打开app时判断是否启用持久化&#x2F;frameworks&#x2F;base&#x2F;core&#x2F;java&#x2F;android&#x2F;app&#x2F;ActivityThread.java</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/202307100104707.png"></p>
<p>在这里加入代码，具体的app启动流程我们后面再分析</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">// add start</span>
        <span class="token comment">//packageName</span>
        <span class="token class-name">String</span> curPkgName <span class="token operator">=</span> data<span class="token punctuation">.</span>appInfo<span class="token punctuation">.</span>packageName<span class="token punctuation">;</span>
        <span class="token keyword">int</span> curUid <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">android<span class="token punctuation">.</span>os<span class="token punctuation">.</span></span>Build</span><span class="token punctuation">.</span><span class="token constant">VERSION</span><span class="token punctuation">.</span><span class="token constant">SDK_INT</span> <span class="token operator">>=</span> <span class="token class-name"><span class="token namespace">android<span class="token punctuation">.</span>os<span class="token punctuation">.</span></span>Build</span><span class="token punctuation">.</span><span class="token constant">VERSION_CODES</span><span class="token punctuation">.</span><span class="token constant">BASE_1_1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            curUid <span class="token operator">=</span> <span class="token class-name">Process</span><span class="token punctuation">.</span><span class="token function">myUid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>curUid <span class="token operator">></span> <span class="token number">10000</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token function">LOGD</span><span class="token punctuation">(</span><span class="token string">"curPkgName: "</span> <span class="token operator">+</span> curPkgName <span class="token operator">+</span> <span class="token string">" curUid: "</span> <span class="token operator">+</span> curUid<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Boolean</span> isPersist <span class="token operator">=</span> <span class="token function">isEnablePersist</span><span class="token punctuation">(</span>curPkgName<span class="token punctuation">,</span> <span class="token string">"whitebird_persist"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">LOGD</span><span class="token punctuation">(</span><span class="token string">"isPersist: "</span> <span class="token operator">+</span> isPersist<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>isPersist<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token comment">//todo copy so and js path</span>
                <span class="token class-name">String</span> <span class="token class-name">JSPath</span> <span class="token operator">=</span> <span class="token function">getAppJSPath</span><span class="token punctuation">(</span>curPkgName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">LOGD</span><span class="token punctuation">(</span><span class="token string">"JSPath: "</span> <span class="token operator">+</span> <span class="token class-name">JSPath</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">JSPath</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token keyword">boolean</span> isOk <span class="token operator">=</span> <span class="token function">doWhitebirdPersist</span><span class="token punctuation">(</span>appContext<span class="token punctuation">,</span> <span class="token constant">LIB32_WHITEBIRD</span><span class="token punctuation">,</span> <span class="token constant">LIB64_WHITEBIRD</span><span class="token punctuation">,</span> <span class="token class-name">JSPath</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token function">LOGD</span><span class="token punctuation">(</span><span class="token string">"doWhitebirdPersist: "</span> <span class="token operator">+</span> isOk<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
                    <span class="token function">LOGD</span><span class="token punctuation">(</span><span class="token string">"JSPath is null"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
<span class="token comment">// add end</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/QQ%E6%88%AA%E5%9B%BE20230911225556.png"></p>
<p>首先获取当前应用程序的包名，然后获取当前进程的用户 ID (UID) ，一般大于10000属于用户进程，小于10000的通常是系统进程，然后判断是否想要进行持久化，如果想要进行持久化，就通过doWhitebirdPersist(appContext, LIB32_WHITEBIRD, LIB64_WHITEBIRD, JSPath);进行持久化的操作</p>
<h2 id="16、实现doWhitebirdPersist和isEnablePersist"><a href="#16、实现doWhitebirdPersist和isEnablePersist" class="headerlink" title="16、实现doWhitebirdPersist和isEnablePersist"></a>16、实现doWhitebirdPersist和isEnablePersist</h2><p>上面的isEnablePersist和doWhitebirdPersist都没有实现，所以我们要去实现这些方法</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">// add start</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">boolean</span> isDebug <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">LOGD</span><span class="token punctuation">(</span><span class="token class-name">String</span> msg<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>isDebug<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">LIB32_WHITEBIRD</span> <span class="token operator">=</span> <span class="token string">"/system/lib/libwhitebird.so"</span><span class="token punctuation">;</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">LIB64_WHITEBIRD</span> <span class="token operator">=</span> <span class="token string">"/system/lib64/libwhitebird.so"</span><span class="token punctuation">;</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">SETTINGS_DIR</span> <span class="token operator">=</span> <span class="token string">"/data/system/xsettings/tmp/persist"</span><span class="token punctuation">;</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">CONFIG_JS_DIR</span> <span class="token operator">=</span> <span class="token string">"/data/system/xsettings/tmp/jscfg"</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">boolean</span> <span class="token function">saveFile</span><span class="token punctuation">(</span><span class="token class-name">String</span> filePath<span class="token punctuation">,</span> <span class="token class-name">String</span> textMsg<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">try</span><span class="token punctuation">&#123;</span>
        <span class="token class-name">FileOutputStream</span> fileOutputStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileOutputStream</span><span class="token punctuation">(</span>filePath<span class="token punctuation">)</span><span class="token punctuation">;</span>
        fileOutputStream<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>textMsg<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token string">"utf-8"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        fileOutputStream<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        fileOutputStream<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">boolean</span> <span class="token function">copyFile</span><span class="token punctuation">(</span><span class="token class-name">File</span> srcFile<span class="token punctuation">,</span> <span class="token class-name">File</span> dstFile<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">try</span><span class="token punctuation">&#123;</span>
        <span class="token class-name">FileInputStream</span> fileInputStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileInputStream</span><span class="token punctuation">(</span>srcFile<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">FileOutputStream</span> fileOutputStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileOutputStream</span><span class="token punctuation">(</span>dstFile<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> data <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token number">16</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> len <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token punctuation">(</span>len <span class="token operator">=</span> fileInputStream<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            fileOutputStream<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>
            fileOutputStream<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        fileInputStream<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        fileOutputStream<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">//判断app是否打开自动注入脚本功能</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">boolean</span> <span class="token function">isEnablePersist</span><span class="token punctuation">(</span><span class="token class-name">String</span> pkgName<span class="token punctuation">,</span> <span class="token class-name">String</span> methodType<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">File</span> enableFile <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span><span class="token constant">SETTINGS_DIR</span><span class="token punctuation">,</span> pkgName <span class="token operator">+</span> <span class="token string">"/"</span> <span class="token operator">+</span> methodType<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> enableFile<span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">getAppJSPath</span><span class="token punctuation">(</span><span class="token class-name">String</span> pkgName<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">File</span> file <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span><span class="token constant">CONFIG_JS_DIR</span><span class="token punctuation">,</span> pkgName <span class="token operator">+</span> <span class="token string">"/config.js"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> file<span class="token punctuation">.</span><span class="token function">getAbsolutePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">boolean</span> <span class="token function">doWhitebirdPersist</span><span class="token punctuation">(</span><span class="token class-name">Context</span> context<span class="token punctuation">,</span> <span class="token class-name">String</span> so32Path<span class="token punctuation">,</span> <span class="token class-name">String</span> so64Path<span class="token punctuation">,</span> <span class="token class-name">String</span> srcJSPath<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// where is gadget from</span>
    <span class="token comment">// /system/lib/libwhitebird.so</span>
    <span class="token class-name">File</span> srcSoFile <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>so32Path<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Build</span><span class="token punctuation">.</span><span class="token constant">VERSION</span><span class="token punctuation">.</span><span class="token constant">SDK_INT</span> <span class="token operator">>=</span> <span class="token class-name">Build<span class="token punctuation">.</span>VERSION_CODES<span class="token punctuation">.</span>M</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token class-name">Process</span><span class="token punctuation">.</span><span class="token function">is64Bit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> srcSoFile <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>so64Path<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>srcSoFile<span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">LOGD</span><span class="token punctuation">(</span><span class="token string">"srcSoFile not exists"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token comment">//where is gadget to</span>
    <span class="token comment">// /data/data/pkgName/files/libwhitebird.so</span>
    <span class="token class-name">File</span> dstSoFile <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">getFilesDir</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"libwhitebird.so"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// copy so to current directory</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>srcSoFile<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> dstSoFile<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">boolean</span> isCopyFileOk <span class="token operator">=</span> <span class="token function">copyFile</span><span class="token punctuation">(</span>srcSoFile<span class="token punctuation">,</span> dstSoFile<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>isCopyFileOk<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            <span class="token function">LOGD</span><span class="token punctuation">(</span><span class="token string">"copySoFile fail: "</span> <span class="token operator">+</span> srcSoFile <span class="token operator">+</span> <span class="token string">" -> "</span> <span class="token operator">+</span> dstSoFile<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token comment">// /data/system/xsettings/tmp/jscfg/config.js</span>
    <span class="token class-name">File</span> srcJSFile <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>srcJSPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>srcJSFile<span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">LOGD</span><span class="token punctuation">(</span><span class="token string">"srcJSFile not exists"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token comment">// /data/data/pkgName/files/config.js</span>
    <span class="token class-name">File</span> dstJSFile <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">getFilesDir</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"config.js"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">boolean</span> isCopyJSOk <span class="token operator">=</span> <span class="token function">copyFile</span><span class="token punctuation">(</span>srcJSFile<span class="token punctuation">,</span> dstJSFile<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>isCopyJSOk<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token function">LOGD</span><span class="token punctuation">(</span><span class="token string">"copyJSFile fail: "</span> <span class="token operator">+</span> srcJSFile <span class="token operator">+</span> <span class="token string">" -> "</span> <span class="token operator">+</span> dstJSFile<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token class-name">String</span> configFilePath <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getFilesDir</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token class-name">File</span><span class="token punctuation">.</span>separator <span class="token operator">+</span> <span class="token string">"libwhitebird.config.so"</span><span class="token punctuation">;</span>
    <span class="token comment">// gen config</span>
    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">JSONObject</span> jsonObject <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JSONObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">JSONObject</span> childObj <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JSONObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        childObj<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"type"</span><span class="token punctuation">,</span> <span class="token string">"script"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        childObj<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"path"</span><span class="token punctuation">,</span> dstJSFile<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        jsonObject<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"interaction"</span><span class="token punctuation">,</span> childObj<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">boolean</span> isSaveOk <span class="token operator">=</span> <span class="token function">saveFile</span><span class="token punctuation">(</span>configFilePath<span class="token punctuation">,</span> jsonObject<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>isSaveOk<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            <span class="token function">LOGD</span><span class="token punctuation">(</span><span class="token string">"saveFile fail: "</span> <span class="token operator">+</span> configFilePath<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token comment">// load gadget</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>dstSoFile<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">LOGD</span><span class="token punctuation">(</span><span class="token string">"happen error: "</span> <span class="token operator">+</span> e<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="17、将frida-gadget集成到系统"><a href="#17、将frida-gadget集成到系统" class="headerlink" title="17、将frida-gadget集成到系统"></a>17、将frida-gadget集成到系统</h2><p>我们上面的代码中有一步是把&#x2F;system&#x2F;lib64和&#x2F;system&#x2F;lib下的libwhitebird.so复制到app的私有目录下，而这个libwhitebird.so需要我们在编译系统的时候放进去，libwhitebird.so是frida-gadget改的名字。</p>
<p>1、首先将 frida-gadget 放到源码目录，比如如下文件夹中</p>
<p>&#x2F;frameworks&#x2F;base&#x2F;cmds&#x2F;libwhitebird</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/202307121818131.png"></p>
<p>2、修改源码以下文件，将 frida-gadget 拷贝到编译以后的系统中</p>
<p>&#x2F;build&#x2F;make&#x2F;target&#x2F;product&#x2F;handheld_system.mk</p>
<p>添加以下数据，自动拷贝文件</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># // add</span>
PRODUCT_COPY_FILES <span class="token operator">+=</span> <span class="token punctuation">\</span>
    frameworks/base/cmds/libwhitebird/frida-gadget-16.0.11-android-arm.so:system/lib/libwhitebird.so <span class="token punctuation">\</span>
    frameworks/base/cmds/libwhitebird/frida-gadget-16.0.11-android-arm64.so:system/lib64/libwhitebird.so
<span class="token comment"># // add  </span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/QQ%E6%88%AA%E5%9B%BE20230911192106.png"></p>
<h2 id="18、自定义目录设计"><a href="#18、自定义目录设计" class="headerlink" title="18、自定义目录设计"></a>18、自定义目录设计</h2><p>我们前面设计的目录都比较长和复杂，其实可以写在aosp里面，让系统帮我们生成好路径</p>
<p>&#x2F;system&#x2F;core&#x2F;rootdir&#x2F;init.rc 文件中添加以下数据</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># // add</span>

    <span class="token comment"># /data/system/xsettings/tmp/persist</span>
    <span class="token function">mkdir</span> /data/system/xsettings 0775 system system
    <span class="token function">mkdir</span> /data/system/xsettings/tmp 0775 system system
    <span class="token function">mkdir</span> /data/system/xsettings/tmp/persist 0775 system system
    <span class="token function">mkdir</span> /data/system/xsettings/tmp/jscfg 0775 system system
    <span class="token comment"># // add</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/202307122241292.png"></p>
<h2 id="19、创建文件类型SeLinux标签"><a href="#19、创建文件类型SeLinux标签" class="headerlink" title="19、创建文件类型SeLinux标签"></a>19、创建文件类型SeLinux标签</h2><p>创建文件类型SeLinux标签：whitebird_file</p>
<p>在下面两个路径添加数据</p>
<pre class="line-numbers language-markdown" data-language="markdown"><code class="language-markdown">/system/sepolicy/public/file.te
/system/sepolicy/prebuilts/api/29.0/public/file.te<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>两个文件必须完全一样</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># // add</span>
<span class="token comment"># /data/system/xsettings/tmp/persist</span>
<span class="token builtin class-name">type</span> whitebird_file, file_type, data_file_type, core_data_file_type, mlstrustedobject<span class="token punctuation">;</span>
<span class="token comment"># // add end</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/202307122337382.png"></p>
<h2 id="20、为自定义目录关联文件类型标签-whitebird-file"><a href="#20、为自定义目录关联文件类型标签-whitebird-file" class="headerlink" title="20、为自定义目录关联文件类型标签: whitebird_file"></a>20、为自定义目录关联文件类型标签: whitebird_file</h2><p>在下面两个路径添加数据</p>
<pre class="line-numbers language-markdown" data-language="markdown"><code class="language-markdown">/system/sepolicy/private/file_contexts
/system/sepolicy/prebuilts/api/29.0/private/file_contexts<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>两个文件必须完全一样</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># // add</span>
<span class="token comment"># /data/system/xsettings/tmp/persist</span>
/data/system/xsettings<span class="token punctuation">(</span>/.*<span class="token punctuation">)</span>?	u:object_r:whitebird_file:s0
<span class="token comment"># // add</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/202307122340089.png"></p>
<h2 id="21、配置system-app访问-whitebird-file-标签文件的权限"><a href="#21、配置system-app访问-whitebird-file-标签文件的权限" class="headerlink" title="21、配置system app访问 whitebird_file 标签文件的权限"></a>21、配置system app访问 whitebird_file 标签文件的权限</h2><p>在下面的两个路径中添加数据</p>
<pre class="line-numbers language-markdown" data-language="markdown"><code class="language-markdown">/system/sepolicy/private/system_app.te
/system/sepolicy/prebuilts/api/29.0/private/system_app.te<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>两个文件的内容必须完全一致</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># // add</span>
<span class="token comment"># add for accessing whitebird_file</span>
allow system_app whitebird_file:dir  <span class="token punctuation">&#123;</span> getattr setattr <span class="token function">open</span> <span class="token builtin class-name">read</span> <span class="token function">write</span> remove_name create add_name search <span class="token function">rmdir</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
allow system_app whitebird_file:file <span class="token punctuation">&#123;</span> getattr setattr <span class="token function">open</span> <span class="token builtin class-name">read</span> <span class="token function">write</span> create unlink <span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>给目录和文件都设置了权限，当然只有系统APP拥有对该路径的权限是不够的，我们还需要给用户APP设置访问权限</p>
<h2 id="22、配置用户app访问-whitebird-file标签文件的权限"><a href="#22、配置用户app访问-whitebird-file标签文件的权限" class="headerlink" title="22、配置用户app访问 whitebird_file标签文件的权限"></a>22、配置用户app访问 whitebird_file标签文件的权限</h2><pre class="line-numbers language-markdown" data-language="markdown"><code class="language-markdown">/system/sepolicy/private/untrusted_app.te
/system/sepolicy/private/untrusted_app_25.te
/system/sepolicy/private/untrusted_app_27.te
/system/sepolicy/private/untrusted_app_all.te

/system/sepolicy/prebuilts/api/29.0/private/untrusted_app.te
/system/sepolicy/prebuilts/api/29.0/private/untrusted_app_25.te
/system/sepolicy/prebuilts/api/29.0/private/untrusted_app_27.te
/system/sepolicy/prebuilts/api/29.0/private/untrusted_app_all.te<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>与上面一样，修改文件都是同步进行的</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># // add</span>
<span class="token comment"># add for accessing whitebird_file</span>
allow untrusted_app whitebird_file:dir  <span class="token punctuation">&#123;</span> getattr <span class="token function">open</span> <span class="token builtin class-name">read</span> <span class="token function">write</span> search <span class="token function">rmdir</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
allow untrusted_app whitebird_file:file <span class="token punctuation">&#123;</span> getattr <span class="token function">open</span> <span class="token builtin class-name">read</span> <span class="token function">write</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="23、编译以及解决常见问题"><a href="#23、编译以及解决常见问题" class="headerlink" title="23、编译以及解决常见问题"></a>23、编译以及解决常见问题</h2><p>如果报:文件 system&#x2F;sepolicy&#x2F;prebuilts&#x2F;api&#x2F;29.0&#x2F;private&#x2F;untrusted_app_all.te 和 system&#x2F;sepolicy&#x2F;private&#x2F;untrusted_app_all.te 不同</p>
<p>那就说明我们需要查看两个文件是否相同，通常情况下可能是打错了单词、或者多了一个换行，建议把其中一个文件的内容全部拷贝到另外一个文件中。</p>
<p>编译流程</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">source</span> build/envsetup.sh
lunch
<span class="token function">make</span> -j6//根据虚拟机性能来，我这里选择6个线程<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/202307131019985.png"></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">修改以下文件，防止报错：whitebird_file 未定义
/system/sepolicy/private/compat/26.0/26.0.ignore.cil <span class="token number">17</span>
/system/sepolicy/private/compat/27.0/27.0.ignore.cil <span class="token number">16</span>
/system/sepolicy/private/compat/28.0/28.0.ignore.cil <span class="token number">15</span>

/system/sepolicy/prebuilts/api/29.0/private/compat/26.0/26.0.ignore.cil <span class="token number">17</span>
/system/sepolicy/prebuilts/api/29.0/private/compat/27.0/27.0.ignore.cil <span class="token number">16</span>
/system/sepolicy/prebuilts/api/29.0/private/compat/28.0/28.0.ignore.cil <span class="token number">15</span>

在以上文件中加入数据 whitebird_file
两个文件添加的内容需要一致<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="24、Frida持久化管理App"><a href="#24、Frida持久化管理App" class="headerlink" title="24、Frida持久化管理App"></a>24、Frida持久化管理App</h2><p>源码地址：<a target="_blank" rel="noopener" href="https://github.com/Whitebird0/Frida_Gadget_Manager">https://github.com/Whitebird0/Frida_Gadget_Manager</a></p>
<pre class="line-numbers language-none"><code class="language-none">1. 管理app的功能
    显示已安装app列表
    可以对每个app指定需要注入的JS
    可以设置是否启用持久化

2. 相应功能实现原理
    2.1 创建表示启用的文件
	&#x2F;data&#x2F;system&#x2F;xsettings&#x2F;tmp&#x2F;persist&#x2F;pkgName&#x2F;whitebird_persist
    2.2 指定的JS文件复制到以下目录
	&#x2F;data&#x2F;system&#x2F;xsettings&#x2F;tmp&#x2F;jscfg&#x2F;pkgName&#x2F;config.js
    2.3 剩下的复制so、JS文件和加载so的操作，由魔改的doWhitebirdPersist函数完成
    
3. system权限app的开发
3.1 在 manifest 中加入 android:sharedUserId&#x3D;&quot;android.uid.system&quot;
3.2 将编译出来的app放入 &#x2F;packages&#x2F;apps&#x2F;whitebirdPersistDemo
3.3 编写Android.mk
3.4 单独编译指定模块 mmm packages&#x2F;apps&#x2F;whitebirdPersistDemo
3.5 编译后的模块在 &#x2F;out&#x2F;target&#x2F;product&#x2F;sailfish&#x2F;system&#x2F;app&#x2F;ControlAPP
3.6 使用 make snod 将编译出来的文件打包成镜像，刷入system.img即可

4. 如果要在编译整个系统时，一起编译这个模块，需要将模块 ControlAPP 加入源码编译链
4.1 增加的内置模块，如果为APP，加入到如下文件中
&#x2F;build&#x2F;make&#x2F;target&#x2F;product&#x2F;handheld_product.mk
4.2 增加的内置模块，如果为可执行程序，加入到如下文件中
&#x2F;build&#x2F;make&#x2F;target&#x2F;product&#x2F;base_system.mk<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>android.mk</p>
<pre class="line-numbers language-none"><code class="language-none"># &#x2F;&#x2F;&#x2F;ADD START
# &#x2F;&#x2F;&#x2F;ADD END
# 设置当前工作路径
LOCAL_PATH:&#x3D; $(call my-dir)


# 清除变量值
include $(CLEAR_VARS)
# 生成的模块名称
LOCAL_MODULE :&#x3D; ControlAPP


# 生成的模块类型
LOCAL_MODULE_CLASS :&#x3D; APPS
# 生成的模块后缀名,此处为apk
LOCAL_MODULE_SUFFIX :&#x3D; $(COMMON_ANDROID_PACKAGE_SUFFIX)
# 设置模块tag，tags取值可以为:user debug eng tests optional
# optional表示全平台编译
LOCAL_MODULE_TAGS :&#x3D; optional

# LOCAL_PRIVILEGED_MODULE :&#x3D; true

LOCAL_BUILT_MODULE_STEM :&#x3D; package.apk

LOCAL_DEX_PREOPT :&#x3D; false

# 设置源文件
LOCAL_SRC_FILES :&#x3D; $(LOCAL_MODULE).apk

LOCAL_CERTIFICATE :&#x3D; platform

# 设置签名，此处表示保持apk原有签名
# LOCAL_CERTIFICATE :&#x3D; PRESIGNED
# 此处表示预编译方式
include $(BUILD_PREBUILT)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/A.png"></p>
<p>编译后的模块在 &#x2F;out&#x2F;target&#x2F;product&#x2F;sailfish&#x2F;system&#x2F;app&#x2F;ControlAPP</p>
<p>现在我们可以直接把app拿出来放在之前魔改的系统上运行，因为编译该app时的系统和之前刷的系统是同一个，所以可以不用重新打包</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/QQ%E6%88%AA%E5%9B%BE20230913141314.png"></p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/QQ%E6%88%AA%E5%9B%BE20230913141425.png"></p>
<h1 id="二、加固与脱壳"><a href="#二、加固与脱壳" class="headerlink" title="二、加固与脱壳"></a>二、加固与脱壳</h1><h2 id="1、什么是加固"><a href="#1、什么是加固" class="headerlink" title="1、什么是加固"></a>1、什么是加固</h2><p>其实就是将原先app的dex文件加密，app运行过程中，解密后再加载，反编译时看到的就是壳的代码，或者被抽空的代码</p>
<h3 id="未加密"><a href="#未加密" class="headerlink" title="未加密"></a>未加密</h3><p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/202307081139386.png"></p>
<h3 id="360加固——整体加固"><a href="#360加固——整体加固" class="headerlink" title="360加固——整体加固"></a>360加固——整体加固</h3><p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/202307081142240.png"></p>
<h3 id="爱加密——抽取壳"><a href="#爱加密——抽取壳" class="headerlink" title="爱加密——抽取壳"></a>爱加密——抽取壳</h3><p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/202307081142923.png"></p>
<p>程序中的类都还在，但是函数体的代码都没了，也就是被抽取了，看smali代码，发现函数体都被nop了</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/202307081144140.png"></p>
<h2 id="2、什么是脱壳"><a href="#2、什么是脱壳" class="headerlink" title="2、什么是脱壳"></a>2、什么是脱壳</h2><p>本质上就是将加固app在运行过程中，解密后加载的dex文件保存下来。与加密算法差不多，一个加密的是字符&#x2F;字节数据，一个加密的是文件(也是字节数据)。逆向加密算法主要要的是过程，做算法还原，而脱壳要的是解密后的dex文件。</p>
<h2 id="3、为什么要脱壳"><a href="#3、为什么要脱壳" class="headerlink" title="3、为什么要脱壳"></a>3、为什么要脱壳</h2><p>不脱壳反编译时，通常只能看到壳的代码，或者被抽取后的代码</p>
<p>360：整体加固以及被vmp化的onCreate</p>
<p>ijiami：函数体指令被抽取，用nop填充原有数据，或者干脆就变成空函数</p>
<h2 id="4、分析加固的app是不是必须脱壳"><a href="#4、分析加固的app是不是必须脱壳" class="headerlink" title="4、分析加固的app是不是必须脱壳"></a>4、分析加固的app是不是必须脱壳</h2><p>能直接逆向出算法的不需要</p>
<p>比如自吐算法</p>
<p>比如能快速定位到关键代码所在so的</p>
<p>虽然app被加固了，但是不影响hook，所以我们依然可以跑沙盒</p>
<h2 id="5、怎么判断app是否加固"><a href="#5、怎么判断app是否加固" class="headerlink" title="5、怎么判断app是否加固"></a>5、怎么判断app是否加固</h2><p>1、反编译查看类数量、类中的方法特征</p>
<p>2、反编译查看类名特征、so特征 libjiagu.so、qihoo</p>
<p>3、查壳工具</p>
<p>4、没有加固的，也可以脱壳</p>
<h2 id="6、加固的分类"><a href="#6、加固的分类" class="headerlink" title="6、加固的分类"></a>6、加固的分类</h2><p>dex加固：整体加固、抽取加固、VMP、dex2c等</p>
<p>so加固：对so结构进行处理、对so数据进行加密、自定义linker</p>
<p>一般处理方式就是so dump，然后so修复</p>
<h2 id="7、整体加固"><a href="#7、整体加固" class="headerlink" title="7、整体加固"></a>7、整体加固</h2><h3 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h3><p>1、可分为落地加载、内存加载</p>
<p>落地加载会在本地生成dex文件，内存加载不会在本地生成dex文件</p>
<p>2、本质上都是将app自身的dex整体加密，app运行过程中解密后加载</p>
<p>3、 有些壳还会抹掉dex文件头、dex的文件大小filesize等</p>
<p>一般会有字符串加密、资源加密、反调试、签名验证</p>
<h3 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h3><p>1、脱壳工具fdex2</p>
<p>通过Class类的getDex方法得到DexFile，再通过DexFile的getBytes方法得到dex文件</p>
<p>2、脱壳工具blackdex</p>
<p>通过mCookie来脱壳</p>
<p>3、脱壳工具FRIDA-DEXDump</p>
<p>从内存中搜索dex文件，保存下来</p>
<p>4、脱壳系统FART、youpk</p>
<p>在dex加载、解析、解释执行过程中，找一个合适的时机，得到DexFile内存地址和大小，将解密状态的dex保存下来，还可以通过artMethod来得到DexFile</p>
<h2 id="8、ART下的脱壳原理—整体加固"><a href="#8、ART下的脱壳原理—整体加固" class="headerlink" title="8、ART下的脱壳原理—整体加固"></a>8、ART下的脱壳原理—整体加固</h2><h3 id="1、在线源码查看"><a href="#1、在线源码查看" class="headerlink" title="1、在线源码查看"></a>1、在线源码查看</h3><pre class="line-numbers language-markdown" data-language="markdown"><code class="language-markdown">http://androidxref.com/
https://cs.android.com/ 需要科学上网<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<h3 id="2、ART下的脱壳点"><a href="#2、ART下的脱壳点" class="headerlink" title="2、ART下的脱壳点"></a>2、ART下的脱壳点</h3><p>1、dex的加载流程</p>
<p>通过mCookie脱壳的</p>
<p>通过openCommen函数脱壳的</p>
<p>通过DexFile构造函数脱壳的</p>
<p>youpk：通过ClassLinker的DexCacheData进一步得到DexFile</p>
<p>壳可能会自己实现上面的函数，绕过系统函数</p>
<p>2、dex2oat的编译流程</p>
<p>通过修改dex2oat脱壳的，安卓10默认不支持dex2oat</p>
<p><a target="_blank" rel="noopener" href="https://developer.android.com/about/versions/10/behavior-changes-10?hl=zh-cn#system-only-oat">https://developer.android.com/about/versions/10/behavior-changes-10?hl=zh-cn#system-only-oat</a></p>
<p>3、 类的加载和初始化流程</p>
<p>DexHunter在defineClass进行类解析</p>
<p>LoadMethod、LinkCode</p>
<p> 函数执行过程中的脱壳点</p>
<p>FART: Execute整体脱壳</p>
<p>FART：ArtMethod::invoke函数中进行dump CodeItem</p>
<p>youpk：直接到解释执行的函数中进行dump CodeItem</p>
<h3 id="3、InMemoryDexClassLoader源码分析"><a href="#3、InMemoryDexClassLoader源码分析" class="headerlink" title="3、InMemoryDexClassLoader源码分析"></a>3、InMemoryDexClassLoader源码分析</h3><h4 id="InMemoryDexClassLoader"><a href="#InMemoryDexClassLoader" class="headerlink" title="InMemoryDexClassLoader"></a>InMemoryDexClassLoader</h4><p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/202307101203518.png">将dexBuffer包装到了一个数组里，最终调用父类的构造函数BaseDexClassLoader</p>
<h4 id="BaseDexClassLoader"><a href="#BaseDexClassLoader" class="headerlink" title="BaseDexClassLoader"></a>BaseDexClassLoader</h4><p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/202307101204211.png"></p>
<p>第一行是又调用了父类的构造函数，BaseDexClassLoader 的父类是ClassLoader </p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/202307101205728.png"></p>
<p>调用自身的构造函数，也就是赋值操作</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/202307101206268.png"></p>
<p>现在我们回到BaseDexClassLoader</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">this</span><span class="token punctuation">.</span>sharedLibraryLoaders <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>pathList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DexPathList</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> librarySearchPath<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>这两句和dex关系不大，我们看最后一行代码this.pathList.initByteBufferDexPath(dexFiles);</p>
<h4 id="initByteBufferDexPath"><a href="#initByteBufferDexPath" class="headerlink" title="initByteBufferDexPath"></a>initByteBufferDexPath</h4><p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/202307101308638.png"></p>
<p>上面的代码没什么用，主要看下面框的两行代码，将dexFiles封装成dex对象， 然后把dex对象又封装成dexElements,所以DexFile就是进行dex加载的地方，我们可以进去分析一下</p>
<h4 id="DexFile"><a href="#DexFile" class="headerlink" title="DexFile"></a>DexFile</h4><p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/202307101353341.png"></p>
<p>这里就是打开dex并赋值给了mCookie，我们之前聊的mCookie就在这</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/QQ%E6%88%AA%E5%9B%BE20230914134154.png"></p>
<p>mCookie这里其实是java long类型的数组</p>
<h4 id="openInMemoryDexFiles"><a href="#openInMemoryDexFiles" class="headerlink" title="openInMemoryDexFiles"></a>openInMemoryDexFiles</h4><p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/202307101356645.png"></p>
<p>底层是走openInMemoryDexFilesNative，看名字知道是一个native函数·</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/202307101358541.png"></p>
<p>函数注册</p>
<h4 id="DexFile-openInMemoryDexFilesNative"><a href="#DexFile-openInMemoryDexFilesNative" class="headerlink" title="DexFile_openInMemoryDexFilesNative"></a>DexFile_openInMemoryDexFilesNative</h4><p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/202307101425625.png"></p>
<p>通过AllocateDexMemoryMap申请内存dex_data，如果array是空的，就从buffer获取dex并复制到dex_data中，如果array不为空，就从array复制到dex_data</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/202307101428803.png"></p>
<p>OpenDexFilesFromOat结束后，dex已经加载完成，返回dex_files，传入CreateCookieFromOatFileManagerResult生成cookie返回。</p>
<h4 id="CreateCookieFromOatFileManagerResult"><a href="#CreateCookieFromOatFileManagerResult" class="headerlink" title="CreateCookieFromOatFileManagerResult"></a>CreateCookieFromOatFileManagerResult</h4><p>我们在这个函数里看看如何把dex_files转换成mCookie</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/202307101438434.png"></p>
<p>返回一个array作为cookie，所以cookie的类型就是java的long类型的数组，array的来源是ConvertDexFilesToJavaArray</p>
<h4 id="ConvertDexFilesToJavaArray"><a href="#ConvertDexFilesToJavaArray" class="headerlink" title="ConvertDexFilesToJavaArray"></a>ConvertDexFilesToJavaArray</h4><p>我们需要看一下这个数组中的成员到底是什么</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/202307101442259.png"></p>
<p>vec是dex_files</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/202307101540943.png"></p>
<p>生成了java的long aray数组，数组中的每一个成员是vec[i].get()，也就是取出了vec中的dex，并转为指针</p>
<h4 id="ConvertJavaArrayToDexFiles"><a href="#ConvertJavaArrayToDexFiles" class="headerlink" title="ConvertJavaArrayToDexFiles"></a>ConvertJavaArrayToDexFiles</h4><p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/202307101543825.png"></p>
<p>在上面还有个ConvertJavaArrayToDexFiles，是把java array转换成DexFiles，其实也就是把array中每一个成员强转为DexFile*，所以我们可以通过mcookie得到每一个dex的指针.</p>
<p>OpenDexFilesFromOat我们在上面没有分析，现在来分析一下</p>
<h4 id="OpenDexFilesFromOat"><a href="#OpenDexFilesFromOat" class="headerlink" title="OpenDexFilesFromOat"></a>OpenDexFilesFromOat</h4><p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/202307101610724.png"></p>
<h4 id="OpenDexFilesFromOat-Impl"><a href="#OpenDexFilesFromOat-Impl" class="headerlink" title="OpenDexFilesFromOat_Impl"></a>OpenDexFilesFromOat_Impl</h4><p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/202307101616761.png"></p>
<p>先对dex头获取，并且进行校验。</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/202307101617345.png"></p>
<p>对dex_mem_maps进行遍历，加载每一个dex，调用了Open进行加载</p>
<pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">std::unique_ptr&lt;const DexFile&gt; dex_file(dex_file_loader.Open	(
      DexFileLoader::GetMultiDexLocation(i, dex_location.c_str()),
      location_checksum,
      std::move(dex_mem_maps[i]),
      (vdex_file &#x3D;&#x3D; nullptr) &amp;&amp; Runtime::Current()-&gt;IsVerificationEnabled(),
      kVerifyChecksum,
      &amp;error_msg));<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这里其实有两个函数， std::unique_ptr&lt;const DexFile&gt;::dex_file()和dex_file_loader.Open() </p>
<p> std::unique_ptr&lt;const DexFile&gt;::dex_file()会调用DexFile的构造函数，这里是一个脱壳点</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/202307101627285.png"></p>
<p>先看dex_file_loader.Open，其实是ArtDexFileLoader.Open</p>
<h4 id="ArtDexFileLoader-Open"><a href="#ArtDexFileLoader-Open" class="headerlink" title="ArtDexFileLoader.Open"></a>ArtDexFileLoader.Open</h4><p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/202307101632858.png"></p>
<p>得到dex的起始地址和大小，所以这个地方也是脱壳点。由于OpenCommon传入了begin和size，所以OpenCommon也是一个脱壳点</p>
<h4 id="DexFileLoader-OpenCommon"><a href="#DexFileLoader-OpenCommon" class="headerlink" title="DexFileLoader::OpenCommon"></a>DexFileLoader::OpenCommon</h4><p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/202307101723036.png"></p>
<p>跟进去看看</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/202307101724137.png"></p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/202307101724484.png">底层都是调用DexFile</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/202307101738865.png"></p>
<h3 id="4、DexClassLoader源码分析"><a href="#4、DexClassLoader源码分析" class="headerlink" title="4、DexClassLoader源码分析"></a>4、DexClassLoader源码分析</h3><h4 id="DexClassLoader"><a href="#DexClassLoader" class="headerlink" title="DexClassLoader"></a>DexClassLoader</h4><p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/202307101758061.png"></p>
<p>调用了父类的构造函数</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/202307101801810.png"></p>
<p>调用自身的构造函数</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/202307101807606.png"></p>
<p>重点关注DexPathList</p>
<h4 id="DexPathList"><a href="#DexPathList" class="headerlink" title="DexPathList"></a>DexPathList</h4><p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/202307101934177.png"></p>
<h4 id="makeDexElements"><a href="#makeDexElements" class="headerlink" title="makeDexElements"></a>makeDexElements</h4><p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/202307101938065.png"></p>
<p>先判断是否是目录，如果不是就判断是否以.dex结尾，然后尝试loadDexFile</p>
<h4 id="loadDexFile"><a href="#loadDexFile" class="headerlink" title="loadDexFile"></a>loadDexFile</h4><p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/202307101943617.png"></p>
<h4 id="DexFile-1"><a href="#DexFile-1" class="headerlink" title="DexFile"></a>DexFile</h4><p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/202307101948145.png"></p>
<h4 id="DexFile-loadDex"><a href="#DexFile-loadDex" class="headerlink" title="DexFile.loadDex"></a>DexFile.loadDex</h4><p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/202307111030302.png"></p>
<p>最后也是走DexFile</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/202307111031654.png"></p>
<p>也是openDexFile</p>
<h4 id="openDexFile"><a href="#openDexFile" class="headerlink" title="openDexFile"></a>openDexFile</h4><p>这里就需要进入so层进行分析了</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/202307111034048.png"></p>
<h4 id="openDexFileNative"><a href="#openDexFileNative" class="headerlink" title="openDexFileNative"></a>openDexFileNative</h4><p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/202307111036466.png"></p>
<p>第三个参数是dex，现在还没有加载，可以发现CreateCookieFromOatFileManagerResult和OpenDexFilesFromOat之前都分析过了，只不过参数不一样而已，所以我们也跟进去看看吧</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/202307111047897.png"></p>
<h4 id="OpenDexFilesFromOat-1"><a href="#OpenDexFilesFromOat-1" class="headerlink" title="OpenDexFilesFromOat"></a>OpenDexFilesFromOat</h4><p>由于Android10删除了oat，所以这下面的if是不走的，不过系统App是有aot的</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/202307111049413.png"></p>
<p>这里的执行流程已经和之前的差不多了</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/202307111051016.png"></p>
<h4 id="ArtDexFileLoader-Open-1"><a href="#ArtDexFileLoader-Open-1" class="headerlink" title="ArtDexFileLoader::Open"></a>ArtDexFileLoader::Open</h4><p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/202307111054443.png"></p>
<h4 id="OpenWithMagic"><a href="#OpenWithMagic" class="headerlink" title="OpenWithMagic"></a>OpenWithMagic</h4><p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/202307111059143.png"></p>
<p>OpenFile会打开加载dex，所以我们可以再进入OpenFIle里面看看</p>
<h4 id="OpenFile"><a href="#OpenFile" class="headerlink" title="OpenFile"></a>OpenFile</h4><p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/202307111112085.png"></p>
<p>通过MemMap::MapFile把dex加载到内存中，我们也得到了map.Size()和map.Begin()</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/202307111114775.png"></p>
<p>OpenCommon是我们分析InMemoryDexClassLoader时找到的脱壳点，所以后面的流程是一样的了。OpenCommon是一个通用的脱壳点。</p>
<h3 id="5、youpk脱壳原理"><a href="#5、youpk脱壳原理" class="headerlink" title="5、youpk脱壳原理"></a>5、youpk脱壳原理</h3><p><a target="_blank" rel="noopener" href="https://github.com/Youlor/unpacker">https://github.com/Youlor/unpacker</a></p>
<pre class="line-numbers language-none"><code class="language-none">std::list&lt;const DexFile*&gt; Unpacker::getDexFiles() &#123;
  std::list&lt;const DexFile*&gt; dex_files;
  Thread* const self &#x3D; Thread::Current();
  ClassLinker* class_linker &#x3D; Runtime::Current()-&gt;GetClassLinker();
  ReaderMutexLock mu(self, *class_linker-&gt;DexLock());
  const std::list&lt;ClassLinker::DexCacheData&gt;&amp; dex_caches &#x3D; class_linker-&gt;GetDexCachesData();
  for (auto it &#x3D; dex_caches.begin(); it !&#x3D; dex_caches.end(); ++it) &#123;
    ClassLinker::DexCacheData data &#x3D; *it;
    const DexFile* dex_file &#x3D; data.dex_file;
    dex_files.push_back(dex_file);
  &#125;
  return dex_files;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这里获取了DexFile*的dex_file，里面包含size和begin，所以可以直接dump下来dex</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/202307111648865.png"></p>
<p>之前我们在分析CreateCookieFromOatFileManagerResult的时候就遇到过GetClassLinker</p>
<p>当array是空的时候，就会进行linker-&gt;IsDexFileRegistered(soa.Self(), *dex_file)</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/202307111654531.png"></p>
<p>继续看FindDexCacheDataLocked</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/202307111656614.png"></p>
<p>这里拿dex_file和DexCacheData进行对比，DexCacheData是一个结构体，里面有dex_file</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/202307111657419.png"></p>
<p>我们看一下class_linker-&gt;GetDexCachesData()的GetDexCachesData</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/202307111756024.png"></p>
<p>返回的就是DexCacheData的list，而DexCacheData就是结构体，里面的DexFile*dex_file就是我们想要的</p>
<h3 id="6、dex2oat的脱壳原理"><a href="#6、dex2oat的脱壳原理" class="headerlink" title="6、dex2oat的脱壳原理"></a>6、dex2oat的脱壳原理</h3><p>Android10已经 不存在了，仅适用于Android6以下</p>
<p><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/7af31cc5130e">https://www.jianshu.com/p/7af31cc5130e</a>	</p>
<pre class="line-numbers language-c+" data-language="c+"><code class="language-c+">    &#x2F;&#x2F; Ensure opened dex files are writable for dex-to-dex transformations.
    for (const auto&amp; dex_file : dex_files_) &#123;
      if (!dex_file-&gt;EnableWrite()) &#123;
        PLOG(ERROR) &lt;&lt; &quot;Failed to make .dex file writeable &#39;&quot; &lt;&lt; dex_file-&gt;GetLocation() &lt;&lt; &quot;&#39;\n&quot;;
      &#125;
&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;分割线 以下为添加的代码&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;
      std::string dex_name &#x3D; dex_file-&gt;GetLocation();
      LOG(INFO) &lt;&lt; &quot;dex2oat::dex_file name--&gt;&quot; &lt;&lt; dex_name;

      if (dex_name.find(&quot;jiagu&quot;) !&#x3D; std::string::npos
        || dex_name.find(&quot;cache&quot;) !&#x3D; std::string::npos
        || dex_name.find(&quot;files&quot;) !&#x3D; std::string::npos
        || dex_name.find(&quot;tx_shell&quot;) !&#x3D; std::string::npos
        || dex_name.find(&quot;app_dex&quot;) !&#x3D; std::string::npos
        || dex_name.find(&quot;nagain&quot;) !&#x3D; std::string::npos) &#123;
        int nDexLen &#x3D; dex_file-&gt;Size();
        char pszDexFileName[260] &#x3D; &#123;0&#125;;
        sprintf(pszDexFileName, &quot;%s_%d&quot;, dex_name.c_str(), nDexLen);
        int fd &#x3D; open(pszDexFileName, O_WRONLY | O_CREAT | O_TRUNC, S_IRWXU);
        if (fd &gt; 0) &#123;
          if (write(fd, (char*)dex_file-&gt;Begin(), nDexLen) &lt;&#x3D; 0) &#123;
            LOG(INFO) &lt;&lt; &quot;dex2oat::write dex file failed--&gt;&quot; &lt;&lt; pszDexFileName;
          &#125; else &#123;
            LOG(INFO) &lt;&lt; &quot;dex2oat::write dex file success--&gt;&quot; &lt;&lt; pszDexFileName;
          &#125;
          close(fd);
        &#125; else &#123;
          LOG(INFO) &lt;&lt; &quot;dex2oat::open dex file failed--&gt;&quot; &lt;&lt; pszDexFileName;
        &#125;
      &#125;
&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;分割线 以上为添加的代码&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;
    &#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>其实也就是获取了dex_file，得到了dex_file.begin和dex_file.Size，然后直接写出就行了。dex_file位于setup函数里面</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/202307112339076.png"></p>
<h3 id="7、FDex2"><a href="#7、FDex2" class="headerlink" title="7、FDex2"></a>7、FDex2</h3><p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/202307120039288.png"></p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/202307120039232.png"></p>
<p>通过Class下的getDex获取Dex，再调用Dex下的getBytes获得Dex</p>
<h3 id="8、常见脱壳点"><a href="#8、常见脱壳点" class="headerlink" title="8、常见脱壳点"></a>8、常见脱壳点</h3><p>1、函数解释执行Execute</p>
<p>2、通过ClassLinker的DexCacheData进一步得到DexFile</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/202307120045958.png"></p>
<p>3、内存搜索dex文件来dump</p>
<p>4、通过mCookie脱壳的</p>
<p>5、通过DexFile构造函数脱壳的</p>
<p>6、LoadMethod传入的DexFile</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/202307120047444.png"></p>
<p>dex_file是DexFile&amp;类型，也就是DexFile*</p>
<p>7、LinkCode传入的ArtMethod进一步得到DexFile, ArtMethod-&gt;getDexFile()</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/202307120051157.png"></p>
<h3 id="9、aosp导入Clion"><a href="#9、aosp导入Clion" class="headerlink" title="9、aosp导入Clion"></a>9、aosp导入Clion</h3><p>我们利用clion更容易查看和修改代码</p>
<h4 id="1、Clion的安装"><a href="#1、Clion的安装" class="headerlink" title="1、Clion的安装"></a>1、Clion的安装</h4><p>直接官网下载解压安装就行了</p>
<h4 id="2、生成用于将源码导入Clion的CMakeLists-txt"><a href="#2、生成用于将源码导入Clion的CMakeLists-txt" class="headerlink" title="2、生成用于将源码导入Clion的CMakeLists.txt"></a>2、生成用于将源码导入Clion的CMakeLists.txt</h4><pre class="line-numbers language-none"><code class="language-none">&#x2F;&#x2F; 打开开关，编译时生成CMakeLists.txt

export SOONG_GEN_CMAKEFILES&#x3D;1
export SOONG_GEN_CMAKEFILES_DEBUG&#x3D;1<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/12xxa.png"></p>
<p>CMakeLists.txt会生成在out&#x2F;development&#x2F;ide&#x2F;clion&#x2F;art&#x2F;runtime&#x2F;libart-arm64-android&#x2F;CMakeLists.txt</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/QQ%E6%88%AA%E5%9B%BE20230915004552.png"></p>
<h4 id="3、用Clion打开该CMakeLists-txt"><a href="#3、用Clion打开该CMakeLists-txt" class="headerlink" title="3、用Clion打开该CMakeLists.txt"></a>3、用Clion打开该CMakeLists.txt</h4><p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/QQ%E6%88%AA%E5%9B%BE20230915004922.png"></p>
<h4 id="4、tools-–-cmake-–-Change-Project-Root"><a href="#4、tools-–-cmake-–-Change-Project-Root" class="headerlink" title="4、tools –&gt; cmake –&gt; Change Project Root"></a>4、tools –&gt; cmake –&gt; Change Project Root</h4><p>选择aosp源码根路径，等解析完毕即可</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/QQ%E6%88%AA%E5%9B%BE20230915005011.png"></p>
<h3 id="10、fart源码分析"><a href="#10、fart源码分析" class="headerlink" title="10、fart源码分析"></a>10、fart源码分析</h3><p>类的初始化函数始终运行在ART下的inpterpreter模式，那么最终必然进入到interpreter.cc文件中的Execute函数，进而进入ART下的解释器解释执行，因此，我们便可以选择在Execute或者其他解释执行流程中的函数中进行dex的dump操作。</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/QQ%E6%88%AA%E5%9B%BE20230915161055.png"></p>
<p>在Execute函数中，通过判断函数名称中是否为<clinit>决定要不要调用dumpDexFileByExecute，即判断传入的是否为静态代码块，对于加了壳的App来说静态代码块是肯定存在的。如果Execute传入的是静态代码块则调用dumpDexFileByExecute函数，并传入一个ArtMethod指针。</p>
<p>shadow_frame.GetMethod()其实就是ArtMethod-&gt;GetMethod()</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">extern</span> <span class="token string">"C"</span> <span class="token keyword">void</span> <span class="token function">dumpdexfilebyExecute</span><span class="token punctuation">(</span>ArtMethod<span class="token operator">*</span> artmethod<span class="token punctuation">)</span>  <span class="token function">REQUIRES_SHARED</span><span class="token punctuation">(</span>Locks<span class="token operator">::</span>mutator_lock_<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    		<span class="token comment">//申请buffer</span>
			<span class="token keyword">char</span> <span class="token operator">*</span>dexfilepath<span class="token operator">=</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	
    		<span class="token comment">//判断buffer是否申请成功</span>
			<span class="token keyword">if</span><span class="token punctuation">(</span>dexfilepath<span class="token operator">==</span>nullptr<span class="token punctuation">)</span>
			<span class="token punctuation">&#123;</span>
				<span class="token function">LOG</span><span class="token punctuation">(</span>ERROR<span class="token punctuation">)</span><span class="token operator">&lt;&lt;</span> <span class="token string">"ArtMethod::dumpdexfilebyArtMethod,methodname:"</span><span class="token operator">&lt;&lt;</span>artmethod<span class="token operator">-></span><span class="token function">PrettyMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&lt;&lt;</span><span class="token string">"malloc 1000 byte failed"</span><span class="token punctuation">;</span>
				<span class="token keyword">return</span><span class="token punctuation">;</span>
			<span class="token punctuation">&#125;</span>
			<span class="token keyword">int</span> result<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
			<span class="token keyword">int</span> fcmdline <span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
			<span class="token keyword">char</span> szCmdline<span class="token punctuation">[</span><span class="token number">64</span><span class="token punctuation">]</span><span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token number">0</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
			<span class="token keyword">char</span> szProcName<span class="token punctuation">[</span><span class="token number">256</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token number">0</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
			<span class="token keyword">int</span> procid <span class="token operator">=</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    		<span class="token comment">// 获取进程名，也就是包名</span>
			<span class="token function">sprintf</span><span class="token punctuation">(</span>szCmdline<span class="token punctuation">,</span><span class="token string">"/proc/%d/cmdline"</span><span class="token punctuation">,</span> procid<span class="token punctuation">)</span><span class="token punctuation">;</span>
    		<span class="token comment">// 打开一个名为“szCmdline”的文件进行读取</span>
			fcmdline <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span>szCmdline<span class="token punctuation">,</span> O_RDONLY<span class="token punctuation">,</span><span class="token number">0644</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">if</span><span class="token punctuation">(</span>fcmdline <span class="token operator">></span><span class="token number">0</span><span class="token punctuation">)</span>
			<span class="token punctuation">&#123;</span>
				result<span class="token operator">=</span><span class="token function">read</span><span class="token punctuation">(</span>fcmdline<span class="token punctuation">,</span> szProcName<span class="token punctuation">,</span><span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">if</span><span class="token punctuation">(</span>result<span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span>
				<span class="token punctuation">&#123;</span>
					<span class="token function">LOG</span><span class="token punctuation">(</span>ERROR<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"ArtMethod::dumpdexfilebyArtMethod,open cmdline file error"</span><span class="token punctuation">;</span>
					<span class="token punctuation">&#125;</span>
				<span class="token function">close</span><span class="token punctuation">(</span>fcmdline<span class="token punctuation">)</span><span class="token punctuation">;</span>
				
			<span class="token punctuation">&#125;</span>
			<span class="token comment">// 判断szProcName是否存在</span>
			<span class="token keyword">if</span><span class="token punctuation">(</span>szProcName<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
			<span class="token punctuation">&#123;</span>
					  <span class="token comment">// 获取dex_file</span>
					  <span class="token keyword">const</span> DexFile<span class="token operator">*</span> dex_file <span class="token operator">=</span> artmethod<span class="token operator">-></span><span class="token function">GetDexFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                	  <span class="token comment">// 得到dex_file在内存中的起始地址</span>
					  <span class="token keyword">const</span> <span class="token class-name">uint8_t</span><span class="token operator">*</span> begin_<span class="token operator">=</span>dex_file<span class="token operator">-></span><span class="token function">Begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// Start of data.</span>
                	  <span class="token comment">// 得到dex_file在内存中的大小</span>
					  <span class="token class-name">size_t</span> size_<span class="token operator">=</span>dex_file<span class="token operator">-></span><span class="token function">Size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// Length of data.</span>
					  <span class="token comment">// 清空buffer</span>
					  <span class="token function">memset</span><span class="token punctuation">(</span>dexfilepath<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					  <span class="token keyword">int</span> size_int_<span class="token operator">=</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>size_<span class="token punctuation">;</span>
					  
					  <span class="token function">memset</span><span class="token punctuation">(</span>dexfilepath<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                 	 <span class="token comment">// dexfilepath=/sdcard/fart</span>
					  <span class="token function">sprintf</span><span class="token punctuation">(</span>dexfilepath<span class="token punctuation">,</span><span class="token string">"%s"</span><span class="token punctuation">,</span><span class="token string">"/sdcard/fart"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                	 <span class="token comment">// 创建该目录，并赋予权限</span>
					  <span class="token function">mkdir</span><span class="token punctuation">(</span>dexfilepath<span class="token punctuation">,</span><span class="token number">0777</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					 <span class="token comment">// 清空buffer		  </span>
					  <span class="token function">memset</span><span class="token punctuation">(</span>dexfilepath<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                	 <span class="token comment">// dexfilepath=/sdcard/fart/%s 即app的进程名</span>
					  <span class="token function">sprintf</span><span class="token punctuation">(</span>dexfilepath<span class="token punctuation">,</span><span class="token string">"/sdcard/fart/%s"</span><span class="token punctuation">,</span>szProcName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                	 <span class="token comment">// 创建该目录，并赋予权限</span>
					  <span class="token function">mkdir</span><span class="token punctuation">(</span>dexfilepath<span class="token punctuation">,</span><span class="token number">0777</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
							  	  
					  <span class="token function">memset</span><span class="token punctuation">(</span>dexfilepath<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                	 <span class="token comment">// dexfilepath=/sdcard/fart/%s/%d_dexfile_execute.dex" 即app的进程名 +dex的大小	</span>
					  <span class="token function">sprintf</span><span class="token punctuation">(</span>dexfilepath<span class="token punctuation">,</span><span class="token string">"/sdcard/fart/%s/%d_dexfile_execute.dex"</span><span class="token punctuation">,</span>szProcName<span class="token punctuation">,</span>size_int_<span class="token punctuation">)</span><span class="token punctuation">;</span>
                	 <span class="token comment">// 如果已经存在就不用再dump了</span>
					  <span class="token keyword">int</span> dexfilefp<span class="token operator">=</span><span class="token function">open</span><span class="token punctuation">(</span>dexfilepath<span class="token punctuation">,</span>O_RDONLY<span class="token punctuation">,</span><span class="token number">0666</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					  <span class="token keyword">if</span><span class="token punctuation">(</span>dexfilefp<span class="token operator">></span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
						  <span class="token function">close</span><span class="token punctuation">(</span>dexfilefp<span class="token punctuation">)</span><span class="token punctuation">;</span>
						  dexfilefp<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
						  
						  <span class="token punctuation">&#125;</span><span class="token keyword">else</span><span class="token punctuation">&#123;</span>
									  <span class="token keyword">int</span> fp<span class="token operator">=</span><span class="token function">open</span><span class="token punctuation">(</span>dexfilepath<span class="token punctuation">,</span>O_CREAT<span class="token operator">|</span>O_APPEND<span class="token operator">|</span>O_RDWR<span class="token punctuation">,</span><span class="token number">0666</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
									  <span class="token keyword">if</span><span class="token punctuation">(</span>fp<span class="token operator">></span><span class="token number">0</span><span class="token punctuation">)</span>
									  <span class="token punctuation">&#123;</span>
                                          <span class="token comment">// dump dex文件</span>
										  result<span class="token operator">=</span><span class="token function">write</span><span class="token punctuation">(</span>fp<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span>begin_<span class="token punctuation">,</span>size_<span class="token punctuation">)</span><span class="token punctuation">;</span>
										  <span class="token keyword">if</span><span class="token punctuation">(</span>result<span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span>
										  <span class="token punctuation">&#123;</span>
											  <span class="token function">LOG</span><span class="token punctuation">(</span>ERROR<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"ArtMethod::dumpdexfilebyArtMethod,open dexfilepath error"</span><span class="token punctuation">;</span>
											  <span class="token punctuation">&#125;</span>
										  <span class="token function">fsync</span><span class="token punctuation">(</span>fp<span class="token punctuation">)</span><span class="token punctuation">;</span> 
										  <span class="token function">close</span><span class="token punctuation">(</span>fp<span class="token punctuation">)</span><span class="token punctuation">;</span>  
										  <span class="token function">memset</span><span class="token punctuation">(</span>dexfilepath<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                          <span class="token comment">// dexfilepath=/sdcard/fart/%s/%d_classlist_execute.txt 创建一个txt保存dex中的类名</span>
										  <span class="token function">sprintf</span><span class="token punctuation">(</span>dexfilepath<span class="token punctuation">,</span><span class="token string">"/sdcard/fart/%s/%d_classlist_execute.txt"</span><span class="token punctuation">,</span>szProcName<span class="token punctuation">,</span>size_int_<span class="token punctuation">)</span><span class="token punctuation">;</span>
										  <span class="token keyword">int</span> classlistfile<span class="token operator">=</span><span class="token function">open</span><span class="token punctuation">(</span>dexfilepath<span class="token punctuation">,</span>O_CREAT<span class="token operator">|</span>O_APPEND<span class="token operator">|</span>O_RDWR<span class="token punctuation">,</span><span class="token number">0666</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
											<span class="token keyword">if</span><span class="token punctuation">(</span>classlistfile<span class="token operator">></span><span class="token number">0</span><span class="token punctuation">)</span>
											<span class="token punctuation">&#123;</span>
                                                <span class="token comment">//获取dex中的类数量</span>
												<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">size_t</span> ii<span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> ii<span class="token operator">&lt;</span> dex_file<span class="token operator">-></span><span class="token function">NumClassDefs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">++</span>ii<span class="token punctuation">)</span> 
												<span class="token punctuation">&#123;</span>
                                                    <span class="token comment">// 获取类的描述符，也就是类名</span>
													<span class="token keyword">const</span> DexFile<span class="token operator">::</span>ClassDef<span class="token operator">&amp;</span> class_def <span class="token operator">=</span> dex_file<span class="token operator">-></span><span class="token function">GetClassDef</span><span class="token punctuation">(</span>ii<span class="token punctuation">)</span><span class="token punctuation">;</span>
													<span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> descriptor <span class="token operator">=</span> dex_file<span class="token operator">-></span><span class="token function">GetClassDescriptor</span><span class="token punctuation">(</span>class_def<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                                    <span class="token comment">// 循环写入类名</span>
													result<span class="token operator">=</span><span class="token function">write</span><span class="token punctuation">(</span>classlistfile<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span>descriptor<span class="token punctuation">,</span><span class="token function">strlen</span><span class="token punctuation">(</span>descriptor<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
													<span class="token keyword">if</span><span class="token punctuation">(</span>result<span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span>
													<span class="token punctuation">&#123;</span>
														<span class="token function">LOG</span><span class="token punctuation">(</span>ERROR<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"ArtMethod::dumpdexfilebyArtMethod,write classlistfile file error"</span><span class="token punctuation">;</span>
														
														<span class="token punctuation">&#125;</span>
													<span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> temp<span class="token operator">=</span><span class="token string">"\n"</span><span class="token punctuation">;</span>
													result<span class="token operator">=</span><span class="token function">write</span><span class="token punctuation">(</span>classlistfile<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span>temp<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
													<span class="token keyword">if</span><span class="token punctuation">(</span>result<span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span>
													<span class="token punctuation">&#123;</span>
														<span class="token function">LOG</span><span class="token punctuation">(</span>ERROR<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"ArtMethod::dumpdexfilebyArtMethod,write classlistfile file error"</span><span class="token punctuation">;</span>
														
														<span class="token punctuation">&#125;</span>
													<span class="token punctuation">&#125;</span>
												  <span class="token function">fsync</span><span class="token punctuation">(</span>classlistfile<span class="token punctuation">)</span><span class="token punctuation">;</span> 
												  <span class="token function">close</span><span class="token punctuation">(</span>classlistfile<span class="token punctuation">)</span><span class="token punctuation">;</span> 
												
												<span class="token punctuation">&#125;</span>
										  <span class="token punctuation">&#125;</span>


									  <span class="token punctuation">&#125;</span>

					
			<span class="token punctuation">&#125;</span>
			
			<span class="token keyword">if</span><span class="token punctuation">(</span>dexfilepath<span class="token operator">!=</span>nullptr<span class="token punctuation">)</span>
			<span class="token punctuation">&#123;</span>
				<span class="token function">free</span><span class="token punctuation">(</span>dexfilepath<span class="token punctuation">)</span><span class="token punctuation">;</span>
				dexfilepath<span class="token operator">=</span>nullptr<span class="token punctuation">;</span>
			<span class="token punctuation">&#125;</span>
		
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/QQ%E6%88%AA%E5%9B%BE20230915172555.png"></p>
<p>先导入这一段，我们把名字改了，防止有些厂商会检测函数名</p>
<p>进行函数导入声明，saveDexFileByExecute是在art_method.cc中实现的</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/QQ%E6%88%AA%E5%9B%BE20230915172730.png"></p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/QQ%E6%88%AA%E5%9B%BE20230915212116.png"></p>
<p>修改好后直接编译刷入手机就行了</p>
<p>360的整体加固效果</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/QQ%E6%88%AA%E5%9B%BE20230915212952.png"></p>
<p>现在放入我们的脱壳机里</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/QQ%E6%88%AA%E5%9B%BE202309152122730.png"></p>
<p>app运行后在我们自定义目录下已经有dex文件和包含类名的txt文件了，现在拿出来放到jadx看看</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/QQ%E6%88%AA%E5%9B%BE202301915213811.png"></p>
<p>已经恢复了</p>
<pre class="line-numbers language-none"><code class="language-none">tips:
Linux C语言中的open函数
https:&#x2F;&#x2F;blog.csdn.net&#x2F;weixin_39296438&#x2F;article&#x2F;details&#x2F;79422068

Linux C语言判断文件是否存在
https:&#x2F;&#x2F;blog.csdn.net&#x2F;kunkliu&#x2F;article&#x2F;details&#x2F;108294089<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="9、抽取加固"><a href="#9、抽取加固" class="headerlink" title="9、抽取加固"></a>9、抽取加固</h2><h3 id="介绍-1"><a href="#介绍-1" class="headerlink" title="介绍"></a>介绍</h3><h4 id="1、抽取加固本质："><a href="#1、抽取加固本质：" class="headerlink" title="1、抽取加固本质："></a>1、抽取加固本质：</h4><p>提取出dex中方法体的字节码，并在方法运行时还原</p>
<h4 id="2、抽取加固的实现形式"><a href="#2、抽取加固的实现形式" class="headerlink" title="2、抽取加固的实现形式"></a>2、抽取加固的实现形式</h4><p>抽空方法体代码，运行方法后回填，运行完后不再抽取 –&gt; 延时保存</p>
<p>抽空方法体代码，运行方法后回填，运行完后又抽取 –&gt; FART、youpk主动调用</p>
<p>抽空方法体代码，将原有函数体替换为解密代码，运行时解密执行</p>
<h4 id="3、抽取加固对原有dex的处理形式"><a href="#3、抽取加固对原有dex的处理形式" class="headerlink" title="3、抽取加固对原有dex的处理形式"></a>3、抽取加固对原有dex的处理形式</h4><p>原有函数体数据空间置0，保留原有空间</p>
<p>对dex文件进行重构，不保留原有空间，在还原数据时，修改CodeItemOffest</p>
<h3 id="解决方案-1"><a href="#解决方案-1" class="headerlink" title="解决方案"></a>解决方案</h3><h4 id="1、解决思路："><a href="#1、解决思路：" class="headerlink" title="1、解决思路："></a>1、解决思路：</h4><p>在函数运行时，保存被抽取的数据</p>
<h4 id="2、被动调用"><a href="#2、被动调用" class="headerlink" title="2、被动调用"></a>2、被动调用</h4><p>app正常运行过程中所发生的函数调用</p>
<p>只对dex中部分的类完成加载，只对dex中的部分函数完成调用</p>
<p>调用函数不全，导致能够恢复的函数有限</p>
<h4 id="3、主动调用"><a href="#3、主动调用" class="headerlink" title="3、主动调用"></a>3、主动调用</h4><p>构造虚拟调用，对app中所有函数完成调用</p>
<p>在这些函数执行时，保存函数体CodeItem数据</p>
<p>保存数据的时机越晚，效果越好</p>
<h4 id="4、常见的抽取加固脱壳系统"><a href="#4、常见的抽取加固脱壳系统" class="headerlink" title="4、常见的抽取加固脱壳系统"></a>4、常见的抽取加固脱壳系统</h4><p>DexHunter、Fupk3、FART、youpk</p>
<h2 id="10、类加载器"><a href="#10、类加载器" class="headerlink" title="10、类加载器"></a>10、类加载器</h2><h3 id="1、抽取加固解决方案"><a href="#1、抽取加固解决方案" class="headerlink" title="1、抽取加固解决方案"></a>1、抽取加固解决方案</h3><p>主动调用app中的所有函数，在函数执行过程中，将方法体的CodeItem保存下来</p>
<h3 id="2、如何调用app中的所有函数呢？"><a href="#2、如何调用app中的所有函数呢？" class="headerlink" title="2、如何调用app中的所有函数呢？"></a>2、如何调用app中的所有函数呢？</h3><p>所有函数 – 所有类 – 所有dex – 所有ClassLoader</p>
<p>因为ClassLoader是用来加载dex的，所以找到所有的ClassLoader就能找到所有的dex，而找到所有的dex就能找到所有的类，同时也能找到所有的类中的所有函数</p>
<h3 id="3、安卓中常见的类加载器"><a href="#3、安卓中常见的类加载器" class="headerlink" title="3、安卓中常见的类加载器"></a>3、安卓中常见的类加载器</h3><h4 id="3-1、BootClassLoader"><a href="#3-1、BootClassLoader" class="headerlink" title="3.1、BootClassLoader"></a>3.1、BootClassLoader</h4><p>单例模式，用来加载系统类</p>
<h4 id="3-2、BaseDexClassLoader"><a href="#3-2、BaseDexClassLoader" class="headerlink" title="3.2、BaseDexClassLoader"></a>3.2、BaseDexClassLoader</h4><p>是PathClassLoader、DexClassLoader、InMemoryDexClassLoader的父类，dex和类加载的主要逻辑都是在BaseDexClassLoader完成的</p>
<h4 id="3-3、PathClassLoader："><a href="#3-3、PathClassLoader：" class="headerlink" title="3.3、PathClassLoader："></a>3.3、PathClassLoader：</h4><p> 是默认使用的类加载器，用于加载app自身的dex，比如我们写的一些关键代码</p>
<h4 id="3-4、DexClassLoader："><a href="#3-4、DexClassLoader：" class="headerlink" title="3.4、DexClassLoader："></a>3.4、DexClassLoader：</h4><p>用于实现插件化、热修复、dex加固等，常在代码中调用</p>
<h4 id="3-5、InMemoryDexClassLoader："><a href="#3-5、InMemoryDexClassLoader：" class="headerlink" title="3.5、InMemoryDexClassLoader："></a>3.5、InMemoryDexClassLoader：</h4><p>安卓8.0以后引入，用于内存加载dex，dex不落地</p>
<h3 id="4、代码测试"><a href="#4、代码测试" class="headerlink" title="4、代码测试"></a>4、代码测试</h3><p>简单演示动态加载</p>
<p>层级关系:DexClassLoader - PathClassLoader - BootClassLoader</p>
 <pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">this</span><span class="token punctuation">.</span>dynamicDex <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DexClassLoader</span><span class="token punctuation">(</span>
        <span class="token class-name">DexPath</span><span class="token punctuation">,</span>
        context<span class="token punctuation">.</span><span class="token function">getCacheDir</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAbsolutePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">getApplicationInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>nativeLibraryDir<span class="token punctuation">,</span>
        <span class="token class-name">MainActivity</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">MainActivity</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span><span class="token string">"whitebird"</span><span class="token punctuation">,</span> <span class="token string">"path: "</span> <span class="token operator">+</span> <span class="token class-name">MainActivity</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span><span class="token string">"whitebird"</span><span class="token punctuation">,</span> <span class="token string">"path parent: "</span> <span class="token operator">+</span> <span class="token class-name">MainActivity</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getParent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span><span class="token string">"whitebird"</span><span class="token punctuation">,</span> <span class="token string">"boot: "</span> <span class="token operator">+</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span><span class="token string">"whitebird"</span><span class="token punctuation">,</span> <span class="token string">"boot parent: "</span> <span class="token operator">+</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getParent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span><span class="token string">"whitebird"</span><span class="token punctuation">,</span> <span class="token string">"dex: "</span> <span class="token operator">+</span> dynamicDex<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span><span class="token string">"whitebird"</span><span class="token punctuation">,</span> <span class="token string">"dex parent: "</span> <span class="token operator">+</span> dynamicDex<span class="token punctuation">.</span><span class="token function">getParent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/QQ%E6%88%AA%E5%9B%BE20230916164331.png"></p>
<p>parent需要聊到双亲委派机制，这个我们后面再说</p>
<p>通过getParent可以获取父类加载器</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/QQ%E6%88%AA%E5%9B%BE20230916164604.png"></p>
<p>上面的代码中，我们将DexClassLoader的最后一个参数改为了MainActivity.class.getClassLoader()，其实就是我们自己写的代码所属于的类加载器，也就是PathClassLoader，我们打印一下验证</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/QQ%E6%88%AA%E5%9B%BE20230916171719.png"></p>
<p>层级关系是符合的，而且BootClassLoader没有父类加载器了</p>
<h2 id="11、双亲委派机制"><a href="#11、双亲委派机制" class="headerlink" title="11、双亲委派机制"></a>11、双亲委派机制</h2><h3 id="1、类加载"><a href="#1、类加载" class="headerlink" title="1、类加载"></a>1、类加载</h3><p>隐式加载</p>
<p>显示加载：Class.forName加载、使用loadClass加载</p>
<h3 id="2、双亲委派机制的工作原理"><a href="#2、双亲委派机制的工作原理" class="headerlink" title="2、双亲委派机制的工作原理"></a>2、双亲委派机制的工作原理</h3><p>2.1、如果一个类加载器收到了类加载请求，会先把这个请求委托给父类的加载器去执行</p>
<p>2.2、如果父类加载器还存在其父类加载器，则进一步向上委托，依次类推，最终到达顶层的启动类加载器</p>
<p>2.3、如果父类加载器可以完成类加载任务，就成功返回，倘若父类加载器无法完成此加载任务，子加载器才会尝试自己去加载</p>
<h3 id="3、为什么要有双亲委派"><a href="#3、为什么要有双亲委派" class="headerlink" title="3、为什么要有双亲委派"></a>3、为什么要有双亲委派</h3><p>3.1、避免重复加载，已经加载的Class，可以直接读取</p>
<p>3.2、更加安全，无法自定义类来替代系统的类，可以防止核心API库被随意篡改</p>
<p>3.3、方便脱壳机主动调用</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">protected</span> <span class="token keyword">synchronized</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> <span class="token function">loadClass</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">,</span> <span class="token keyword">boolean</span> resolve<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ClassNotFoundException</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 首先，检查请求的类是否已经被加载过了</span>
    <span class="token class-name">Class</span> c <span class="token operator">=</span> <span class="token function">findLoadedClass</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>c <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>parent <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                c <span class="token operator">=</span> parent<span class="token punctuation">.</span><span class="token function">loadClass</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
                c <span class="token operator">=</span> <span class="token function">findBootstrapClassOrNull</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ClassNotFoundException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 如果父类加载器抛出ClassNotFoundException</span>
        <span class="token comment">// 说明父类加载器无法完成加载请求</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>c <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">// 在父类加载器无法加载的时候</span>
            <span class="token comment">// 再调用本身的findClass方法来进行类加载</span>
            c <span class="token operator">=</span> <span class="token function">findClass</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>resolve<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">resolveClass</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">return</span> c<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="4、加固对类加载器的影响"><a href="#4、加固对类加载器的影响" class="headerlink" title="4、加固对类加载器的影响"></a>4、加固对类加载器的影响</h3><h4 id="4-1、如何获取所有的ClassLoader"><a href="#4-1、如何获取所有的ClassLoader" class="headerlink" title="4.1、如何获取所有的ClassLoader"></a>4.1、如何获取所有的ClassLoader</h4><p>先得到一个ClassLoader，再通过ClassLoader的parent属性向上遍历</p>
<h4 id="4-2、如何先得到一个ClassLoader"><a href="#4-2、如何先得到一个ClassLoader" class="headerlink" title="4.2、如何先得到一个ClassLoader"></a>4.2、如何先得到一个ClassLoader</h4><p>PathClassLoader加载dex以后，会记录在LoadedApk的mClassLoader属性中，默认使用这个ClassLoader去寻找类</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/QQ%E6%88%AA%E5%9B%BE20230916203847.png"></p>
<h4 id="4-3、普通app运行流程"><a href="#4-3、普通app运行流程" class="headerlink" title="4.3、普通app运行流程"></a>4.3、普通app运行流程</h4><p>BootClassLoader加载系统核心库</p>
<p>PathClassLoader加载app自身dex，然后放到mClassLoader中</p>
<h4 id="4-4、加固app运行流程"><a href="#4-4、加固app运行流程" class="headerlink" title="4.4、加固app运行流程"></a>4.4、加固app运行流程</h4><p>BootClassLoader加载系统核心库</p>
<p>PathClassLoader加载壳的dex ，此时mClassLoader还是存放PathClassLoader</p>
<p>壳的dex&#x2F;so加载原先app自身dex，比如使用DexClassLoader、InMemoryDexClassLoader，不过大概率不会使用这些api，因为系统api可能会成为脱壳点，基本上都是会自己实现。</p>
<h3 id="4-5、加固对类加载器的修正方式"><a href="#4-5、加固对类加载器的修正方式" class="headerlink" title="4.5、加固对类加载器的修正方式"></a>4.5、加固对类加载器的修正方式</h3><p>对于普通app，用mClassLoader去加载app自身dex是可以找到的，但是对于加固app，如果我们用mClassLoader去加载app自身dex，很显然是找不到的，而此时会触发双亲委派机制，往上找，也就是用BootClassLoader去加载，但是肯定也是找不到的。因此，我们需要修正类加载器。</p>
<p>第一种方式：插入ClassLoader</p>
<pre class="line-numbers language-none"><code class="language-none">BootClassLoader
DexClassLoader
PathClassLoader  mClassLoader<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>这样子当mClassLoader加载不了app自身的dex时，就会调用DexClassLoader来加载dex</p>
<p>第二种方式：替换ClassLoader</p>
<pre class="line-numbers language-none"><code class="language-none">BootClassLoader
PathClassLoader
DexClassLoader mClassLoader<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<h2 id="12、fart源码分析"><a href="#12、fart源码分析" class="headerlink" title="12、fart源码分析"></a>12、fart源码分析</h2><h3 id="遍历所有ClassLoader"><a href="#遍历所有ClassLoader" class="headerlink" title="遍历所有ClassLoader"></a>遍历所有ClassLoader</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">//通过反射调用函数</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Object</span> <span class="token function">invokeStaticMethod</span><span class="token punctuation">(</span><span class="token class-name">String</span> class_name<span class="token punctuation">,</span>
                                        <span class="token class-name">String</span> method_name<span class="token punctuation">,</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span> pareTyple<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> pareVaules<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">Class</span> obj_class <span class="token operator">=</span> <span class="token class-name">Class</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span>class_name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Method</span> method <span class="token operator">=</span> obj_class<span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span>method_name<span class="token punctuation">,</span> pareTyple<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> method<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> pareVaules<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">SecurityException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IllegalArgumentException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IllegalAccessException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">NoSuchMethodException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InvocationTargetException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ClassNotFoundException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

<span class="token punctuation">&#125;</span>

<span class="token comment">//通过反射获取成员</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Object</span> <span class="token function">getFieldOjbect</span><span class="token punctuation">(</span><span class="token class-name">String</span> class_name<span class="token punctuation">,</span> <span class="token class-name">Object</span> obj<span class="token punctuation">,</span>
                                    <span class="token class-name">String</span> filedName<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">//动态加载类</span>
        <span class="token class-name">Class</span> obj_class <span class="token operator">=</span> <span class="token class-name">Class</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span>class_name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//使用Java反射来获取fieldName加载类中字符串指定的字段</span>
        <span class="token class-name">Field</span> field <span class="token operator">=</span> obj_class<span class="token punctuation">.</span><span class="token function">getDeclaredField</span><span class="token punctuation">(</span>filedName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//将字段的可访问性更改为true</span>
        field<span class="token punctuation">.</span><span class="token function">setAccessible</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//从给定对象中检索字段的值</span>
        <span class="token keyword">return</span> field<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">SecurityException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">NoSuchFieldException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IllegalArgumentException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IllegalAccessException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ClassNotFoundException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">NullPointerException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

<span class="token punctuation">&#125;</span>

<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">ClassLoader</span> <span class="token function">getClassloader</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">ClassLoader</span> resultClassloader <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token comment">//调用了currentActivityThread静态方法，获取 sCurrentActivityThread，是一个ActivityThread对象</span>
    <span class="token class-name">Object</span> currentActivityThread <span class="token operator">=</span> <span class="token function">invokeStaticMethod</span><span class="token punctuation">(</span>
            <span class="token string">"android.app.ActivityThread"</span><span class="token punctuation">,</span> <span class="token string">"currentActivityThread"</span><span class="token punctuation">,</span>
            <span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//从android.app.ActivityThread类的实例currentActivityThread中获取了mBoundApplication字段</span>
    <span class="token class-name">Object</span> mBoundApplication <span class="token operator">=</span> <span class="token function">getFieldOjbect</span><span class="token punctuation">(</span>
            <span class="token string">"android.app.ActivityThread"</span><span class="token punctuation">,</span> currentActivityThread<span class="token punctuation">,</span>
            <span class="token string">"mBoundApplication"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//从android.app.ActivityThread类的实例currentActivityThread获得了mInitialApplication</span>
    <span class="token class-name">Application</span> mInitialApplication <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Application</span><span class="token punctuation">)</span> <span class="token function">getFieldOjbect</span><span class="token punctuation">(</span><span class="token string">"android.app.ActivityThread"</span><span class="token punctuation">,</span>
            currentActivityThread<span class="token punctuation">,</span> <span class="token string">"mInitialApplication"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//从android.app.ActivityThread$AppBindData内部类的实例mBoundApplication中获取了info属性</span>
    <span class="token class-name">Object</span> loadedApkInfo <span class="token operator">=</span> <span class="token function">getFieldOjbect</span><span class="token punctuation">(</span>
            <span class="token string">"android.app.ActivityThread$AppBindData"</span><span class="token punctuation">,</span>
            mBoundApplication<span class="token punctuation">,</span> <span class="token string">"info"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//从android.app.LoadedApp类的实例loadedApkInfo中获取了mApplication</span>
    <span class="token class-name">Application</span> mApplication <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Application</span><span class="token punctuation">)</span> <span class="token function">getFieldOjbect</span><span class="token punctuation">(</span><span class="token string">"android.app.LoadedApk"</span><span class="token punctuation">,</span> loadedApkInfo<span class="token punctuation">,</span> <span class="token string">"mApplication"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//调用了mApplication的getClassLoader获取类加载器</span>
    resultClassloader <span class="token operator">=</span> mApplication<span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> resultClassloader<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">fart</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">//获取一个Classloader</span>
    <span class="token class-name">ClassLoader</span> appClassloader <span class="token operator">=</span> <span class="token function">getClassloader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//将父类加载器赋值给了parentClassloader</span>
    <span class="token class-name">ClassLoader</span> parentClassloader<span class="token operator">=</span>appClassloader<span class="token punctuation">.</span><span class="token function">getParent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//判断是否是BootClassLoader</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>appClassloader<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">"java.lang.BootClassLoader"</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token comment">//如果不是 BootClassLoader 的实例，执行这里的代码</span>
        <span class="token function">fartwithClassloader</span><span class="token punctuation">(</span>appClassloader<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token comment">//遍历父类加载器</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span>parentClassloader<span class="token operator">!=</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>parentClassloader<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">"java.lang.BootClassLoader"</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            <span class="token comment">// 如果不是 BootClassLoader 的实例，执行这里的代码</span>
            <span class="token function">fartwithClassloader</span><span class="token punctuation">(</span>parentClassloader<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
  
        parentClassloader<span class="token operator">=</span>parentClassloader<span class="token punctuation">.</span><span class="token function">getParent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>如果仅仅只是动态加载，没有加入到双亲委派关系中，只能用Frida枚举类加载器</p>
<h3 id="遍历所有的类"><a href="#遍历所有的类" class="headerlink" title="遍历所有的类"></a>遍历所有的类</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Object</span> <span class="token function">getFieldOjbect</span><span class="token punctuation">(</span><span class="token class-name">String</span> class_name<span class="token punctuation">,</span> <span class="token class-name">Object</span> obj<span class="token punctuation">,</span>
                                    <span class="token class-name">String</span> filedName<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">Class</span> obj_class <span class="token operator">=</span> <span class="token class-name">Class</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span>class_name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Field</span> field <span class="token operator">=</span> obj_class<span class="token punctuation">.</span><span class="token function">getDeclaredField</span><span class="token punctuation">(</span>filedName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        field<span class="token punctuation">.</span><span class="token function">setAccessible</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> field<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">SecurityException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">NoSuchFieldException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IllegalArgumentException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IllegalAccessException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ClassNotFoundException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">NullPointerException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

<span class="token punctuation">&#125;</span>

 <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Object</span> <span class="token function">getClassFieldObject</span><span class="token punctuation">(</span><span class="token class-name">ClassLoader</span> classloader<span class="token punctuation">,</span> <span class="token class-name">String</span> class_name<span class="token punctuation">,</span> <span class="token class-name">Object</span> obj<span class="token punctuation">,</span>
                                             <span class="token class-name">String</span> filedName<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">Class</span> obj_class <span class="token operator">=</span> classloader<span class="token punctuation">.</span><span class="token function">loadClass</span><span class="token punctuation">(</span>class_name<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//Class.forName(class_name);</span>
            <span class="token class-name">Field</span> field <span class="token operator">=</span> obj_class<span class="token punctuation">.</span><span class="token function">getDeclaredField</span><span class="token punctuation">(</span>filedName<span class="token punctuation">)</span><span class="token punctuation">;</span>
            field<span class="token punctuation">.</span><span class="token function">setAccessible</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Object</span> result <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            result <span class="token operator">=</span> field<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> result<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">SecurityException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">NoSuchFieldException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IllegalArgumentException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ClassNotFoundException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IllegalAccessException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

    <span class="token punctuation">&#125;</span>

<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Field</span> <span class="token function">getClassField</span><span class="token punctuation">(</span><span class="token class-name">ClassLoader</span> classloader<span class="token punctuation">,</span> <span class="token class-name">String</span> class_name<span class="token punctuation">,</span>
                                  <span class="token class-name">String</span> filedName<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">Class</span> obj_class <span class="token operator">=</span> classloader<span class="token punctuation">.</span><span class="token function">loadClass</span><span class="token punctuation">(</span>class_name<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//Class.forName(class_name);</span>
        <span class="token class-name">Field</span> field <span class="token operator">=</span> obj_class<span class="token punctuation">.</span><span class="token function">getDeclaredField</span><span class="token punctuation">(</span>filedName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        field<span class="token punctuation">.</span><span class="token function">setAccessible</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> field<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">SecurityException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">NoSuchFieldException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IllegalArgumentException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ClassNotFoundException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

<span class="token punctuation">&#125;</span>

<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">fartwithClassloader</span><span class="token punctuation">(</span><span class="token class-name">ClassLoader</span> appClassloader<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
     <span class="token comment">//申请List存放所有的dex</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">></span></span> dexFilesArray <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//加载dalvik.system.BaseDexClassLoader类，从中获取appClassloader对象的pathList局部变量</span>
        <span class="token class-name">Object</span> pathList_object <span class="token operator">=</span> <span class="token function">getFieldOjbect</span><span class="token punctuation">(</span><span class="token string">"dalvik.system.BaseDexClassLoader"</span><span class="token punctuation">,</span> appClassloader<span class="token punctuation">,</span> <span class="token string">"pathList"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//加载dalvik.system.DexPathList类，从中获取pathList_object对象的dexElements</span>
        <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token class-name">ElementsArray</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token function">getFieldOjbect</span><span class="token punctuation">(</span><span class="token string">"dalvik.system.DexPathList"</span><span class="token punctuation">,</span> pathList_object<span class="token punctuation">,</span> <span class="token string">"dexElements"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//此时的ElementsArray每一个成员都是一个Element</span>
        <span class="token class-name">Field</span> dexFile_fileField <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">//获取dexFile的字段ID，便于后期的遍历</span>
            dexFile_fileField <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Field</span><span class="token punctuation">)</span> <span class="token function">getClassField</span><span class="token punctuation">(</span>appClassloader<span class="token punctuation">,</span> <span class="token string">"dalvik.system.DexPathList$Element"</span><span class="token punctuation">,</span> <span class="token string">"dexFile"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Error</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token class-name">Class</span> <span class="token class-name">DexFileClazz</span> <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">DexFileClazz</span> <span class="token operator">=</span> appClassloader<span class="token punctuation">.</span><span class="token function">loadClass</span><span class="token punctuation">(</span><span class="token string">"dalvik.system.DexFile"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Error</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token class-name">Method</span> getClassNameList_method <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token class-name">Method</span> defineClass_method <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token class-name">Method</span> dumpDexFile_method <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token class-name">Method</span> dumpMethodCode_method <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
		<span class="token comment">//遍历获得DexFile的方法，可以主动调用</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Method</span> field <span class="token operator">:</span> <span class="token class-name">DexFileClazz</span><span class="token punctuation">.</span><span class="token function">getDeclaredMethods</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>field<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"getClassNameList"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                getClassNameList_method <span class="token operator">=</span> field<span class="token punctuation">;</span>
                getClassNameList_method<span class="token punctuation">.</span><span class="token function">setAccessible</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>field<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"defineClassNative"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                defineClass_method <span class="token operator">=</span> field<span class="token punctuation">;</span>
                defineClass_method<span class="token punctuation">.</span><span class="token function">setAccessible</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>field<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"dumpDexFile"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                dumpDexFile_method <span class="token operator">=</span> field<span class="token punctuation">;</span>
                dumpDexFile_method<span class="token punctuation">.</span><span class="token function">setAccessible</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>field<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"dumpMethodCode"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                dumpMethodCode_method <span class="token operator">=</span> field<span class="token punctuation">;</span>
                dumpMethodCode_method<span class="token punctuation">.</span><span class="token function">setAccessible</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token class-name">Field</span> mCookiefield <span class="token operator">=</span> <span class="token function">getClassField</span><span class="token punctuation">(</span>appClassloader<span class="token punctuation">,</span> <span class="token string">"dalvik.system.DexFile"</span><span class="token punctuation">,</span> <span class="token string">"mCookie"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span><span class="token string">"ActivityThread->methods"</span><span class="token punctuation">,</span> <span class="token string">"dalvik.system.DexPathList.ElementsArray.length:"</span> <span class="token operator">+</span> <span class="token class-name">ElementsArray</span><span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//5个</span>
    <span class="token comment">//循环遍历dex，长度从ElementsArray获取，每一个成员就是一个Element</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> <span class="token class-name">ElementsArray</span><span class="token punctuation">.</span>length<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">Object</span> element <span class="token operator">=</span> <span class="token class-name">ElementsArray</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token class-name">Object</span> dexfile <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
                <span class="token comment">//从对象中取出dexFile</span>
                dexfile <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Object</span><span class="token punctuation">)</span> dexFile_fileField<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Error</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>dexfile <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span><span class="token string">"ActivityThread"</span><span class="token punctuation">,</span> <span class="token string">"dexfile is null"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>dexfile <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token comment">//把得到的dex对象放到dexFilesArray</span>
                dexFilesArray<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>dexfile<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//通过appClassloader加载dalvik.system.DexFile，然后获取dexfile对象中的mCookie</span>
                <span class="token class-name">Object</span> mcookie <span class="token operator">=</span> <span class="token function">getClassFieldObject</span><span class="token punctuation">(</span>appClassloader<span class="token punctuation">,</span> <span class="token string">"dalvik.system.DexFile"</span><span class="token punctuation">,</span> dexfile<span class="token punctuation">,</span> <span class="token string">"mCookie"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//mCookie和mInternalCookie是一样的</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>mcookie <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token comment">//通过appClassloader加载dalvik.system.DexFile，然后获取dexfile对象中的mInternalCookie</span>
                    <span class="token class-name">Object</span> mInternalCookie <span class="token operator">=</span> <span class="token function">getClassFieldObject</span><span class="token punctuation">(</span>appClassloader<span class="token punctuation">,</span> <span class="token string">"dalvik.system.DexFile"</span><span class="token punctuation">,</span> dexfile<span class="token punctuation">,</span> <span class="token string">"mInternalCookie"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span><span class="token punctuation">(</span>mInternalCookie<span class="token operator">!=</span><span class="token keyword">null</span><span class="token punctuation">)</span>
                    <span class="token punctuation">&#123;</span>
						mcookie<span class="token operator">=</span>mInternalCookie<span class="token punctuation">;</span>
					<span class="token punctuation">&#125;</span><span class="token keyword">else</span><span class="token punctuation">&#123;</span>
							<span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span><span class="token string">"ActivityThread->err"</span><span class="token punctuation">,</span> <span class="token string">"get mInternalCookie is null"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
							<span class="token keyword">continue</span><span class="token punctuation">;</span>
							<span class="token punctuation">&#125;</span>
                    
                <span class="token punctuation">&#125;</span>
                <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> classnames <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
                    <span class="token comment">//主动调用getClassNameList，传入我们获得的mcookie，得到所有的类名</span>
                    classnames <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> getClassNameList_method<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>dexfile<span class="token punctuation">,</span> mcookie<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">continue</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Error</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">continue</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>classnames <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> eachclassname <span class="token operator">:</span> classnames<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                        <span class="token comment">//获取dex中所有的函数和主动调用，还有dumpMethodCode</span>
                        <span class="token function">loadClassAndInvoke</span><span class="token punctuation">(</span>appClassloader<span class="token punctuation">,</span> eachclassname<span class="token punctuation">,</span> dumpMethodCode_method<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">&#125;</span>
                <span class="token punctuation">&#125;</span>

            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/QQ%E6%88%AA%E5%9B%BE2ss0230917145944.png"></p>
<p>DexPathList的构造函数，在BaseDexClassLoader类中被调用赋值给了pathList</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/QQ%E6%88%AA%E5%9B%BE20230917150430.png"></p>
<p>pathList是DexPathList类型，我们进去看看</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/QQ%E6%88%AA%E5%9B%BE20230917150130.png"></p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/QQ%E6%88%AA%E5%9B%BE20230917150259.png"></p>
<p>dexElements就是 DexPathList构造函数的返回值，我们现在进入makeDexElements分析</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/QQ%E6%88%AA%E5%9B%BE20230917150802.png"></p>
<p>dexElements就是elements，而elements是Element类型的数组，将加载后的dex封装成Element对象，然后加入数组中。</p>
<p>关系如下：</p>
<p>dex-&gt;Element-&gt;dexElements-&gt;pathList</p>
<p>所有要想获得dex，先获取pathList，然后获取dexElements</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/QQ%E6%88%AA%E5%9B%BE20230917151641.png"></p>
<p>Element是一个内部类，我们用构造函数创建Element对象时，里面其实把dex赋值给了它的成员dexFile</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/QQ%E6%88%AA%E5%9B%BE20230917165255.png"></p>
<p>mInternalCookie是由mCookie赋值来的</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/QQ%E6%88%AA%E5%9B%BE20230917165409.png"></p>
<p>getClassNameList通过传入mCookie，也就是是dexFile*,就可以获取所有的类名</p>
<h3 id="遍历类中-所有的函数"><a href="#遍历类中-所有的函数" class="headerlink" title="遍历类中 所有的函数"></a>遍历类中 所有的函数</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">loadClassAndInvoke</span><span class="token punctuation">(</span><span class="token class-name">ClassLoader</span> appClassloader<span class="token punctuation">,</span> <span class="token class-name">String</span> eachclassname<span class="token punctuation">,</span> <span class="token class-name">Method</span> dumpMethodCode_method<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">Class</span> resultclass <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">i</span><span class="token punctuation">(</span><span class="token string">"ActivityThread"</span><span class="token punctuation">,</span> <span class="token string">"go into loadClassAndInvoke->"</span> <span class="token operator">+</span> <span class="token string">"classname:"</span> <span class="token operator">+</span> eachclassname<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">//加载dex中的每一个类</span>
            resultclass <span class="token operator">=</span> appClassloader<span class="token punctuation">.</span><span class="token function">loadClass</span><span class="token punctuation">(</span>eachclassname<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Error</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>resultclass <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
                <span class="token comment">//得到所有的构造函数</span>
                <span class="token class-name">Constructor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> cons<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> resultclass<span class="token punctuation">.</span><span class="token function">getDeclaredConstructors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Constructor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> constructor <span class="token operator">:</span> cons<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>dumpMethodCode_method <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
                            <span class="token comment">//对构造函数进行主动调用+dump</span>
                            dumpMethodCode_method<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> constructor<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token keyword">continue</span><span class="token punctuation">;</span>
                        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Error</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token keyword">continue</span><span class="token punctuation">;</span>
                        <span class="token punctuation">&#125;</span>
                    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
                        <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span><span class="token string">"ActivityThread"</span><span class="token punctuation">,</span> <span class="token string">"dumpMethodCode_method is null "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">&#125;</span>

                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Error</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
                <span class="token comment">//得到所有的方法</span>
                <span class="token class-name">Method</span><span class="token punctuation">[</span><span class="token punctuation">]</span> methods <span class="token operator">=</span> resultclass<span class="token punctuation">.</span><span class="token function">getDeclaredMethods</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>methods <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Method</span> m <span class="token operator">:</span> methods<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>dumpMethodCode_method <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                            <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
                                <span class="token comment">//对方法进行主动调用+dump</span>
                               dumpMethodCode_method<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> m<span class="token punctuation">)</span><span class="token punctuation">;</span>
                             <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token keyword">continue</span><span class="token punctuation">;</span>
                            <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Error</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token keyword">continue</span><span class="token punctuation">;</span>
                            <span class="token punctuation">&#125;</span>
                        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
                            <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span><span class="token string">"ActivityThread"</span><span class="token punctuation">,</span> <span class="token string">"dumpMethodCode_method is null "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">&#125;</span>
                    <span class="token punctuation">&#125;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Error</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="类的加载和初始化流程"><a href="#类的加载和初始化流程" class="headerlink" title="类的加载和初始化流程"></a>类的加载和初始化流程</h3><h4 id="类加载"><a href="#类加载" class="headerlink" title="类加载"></a>类加载</h4><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">protected</span> <span class="token keyword">synchronized</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> <span class="token function">loadClass</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">,</span> <span class="token keyword">boolean</span> resolve<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ClassNotFoundException</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 首先，检查请求的类是否已经被加载过了</span>
    <span class="token class-name">Class</span> c <span class="token operator">=</span> <span class="token function">findLoadedClass</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>c <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>parent <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                c <span class="token operator">=</span> parent<span class="token punctuation">.</span><span class="token function">loadClass</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
                c <span class="token operator">=</span> <span class="token function">findBootstrapClassOrNull</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ClassNotFoundException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 如果父类加载器抛出ClassNotFoundException</span>
        <span class="token comment">// 说明父类加载器无法完成加载请求</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>c <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">// 在父类加载器无法加载的时候</span>
            <span class="token comment">// 再调用本身的findClass方法来进行类加载</span>
            c <span class="token operator">=</span> <span class="token function">findClass</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>resolve<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">resolveClass</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">return</span> c<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>findClass是被重载的，需要我们去查看安卓源代码</p>
<p>basedexclassloader里有findClass</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/QQ%E6%88%AA%E5%9B%BE20230917203327.png"></p>
<p>pathList就是DexPathList</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/QQ%E6%88%AA%E5%9B%BE20230917204211.png"></p>
<p>现在我们要找 element的findClass</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/QQ%E6%88%AA%E5%9B%BE20230917210214.png"></p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/QQ%E6%88%AA%E5%9B%BE20230917220811.png"></p>
<p>跟到loadClassBinaryName</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/QQ%E6%88%AA%E5%9B%BE20230917220900.png"></p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/QQ%E6%88%AA%E5%9B%BE20230917220921.png"></p>
<p>注意 result &#x3D; defineClassNative(name, loader, cookie, dexFile);</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/QQ%E6%88%AA%E5%9B%BE20230917220946.png"></p>
<p>是一个native函数</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/QQ%E6%88%AA%E5%9B%BE20230917221416.png"></p>
<p>这个函数先通过ConvertJavaArrayToDexFiles把mCookie转为dexFiles，然后获取类描述符，通过循环遍历dexFiles，FindClassDef，同时也把dexFile放到了dex_cache中</p>
<p>注意函数,进行dex重构</p>
<pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">ObjPtr&lt;mirror::Class&gt; result &#x3D; class_linker-&gt;DefineClass(soa.Self(),
                                                         descriptor.c_str(),
                                                         hash,
                                                         class_loader,
                                                         *dex_file,
                                                         *dex_class_def);<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/QQ%E6%88%AA%E5%9B%BE20230917221804.png"></p>
<p>我们主要看LoadClass</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/QQ%E6%88%AA2%E5%9B%BE20230917221946.png"></p>
<p>加载了静态字段和实例字段，加载了VirtualMethod和DirectMethod</p>
<p>继续分析LoadMethod，设置了CodeItemOffset，执行完LoadMethod后，我们会得到一个ArtMethod</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/QQ%E6%88%AA%E5%9B%BE20230917222203.png"></p>
<p>LinkCode</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/QQ%E6%88%AA%E5%9B%BE20230917222840.png"></p>
<p>先获取quick_code，类似oat，jit，如果有判断是否启动解释模式</p>
<p>看一下ShouldUseInterpreterEntrypoint</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/QQ%E6%88%AA%E5%9B%BE20230917223110.png"></p>
<p>判断是否是native方法，如果是则返回false</p>
<p>判断是否是quick_code，如果是则返回true</p>
<p>判断是否只在解释模式下执行，如果是则返回true</p>
<h4 id="类初始化"><a href="#类初始化" class="headerlink" title="类初始化"></a>类初始化</h4><p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/QQs1%E6%88%AA%E5%9B%BE20230917223558.png"></p>
<p>先判断是否已经初始化了，防止多线程，然后判断是否能进行初始化，后面就是类验证</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/QQ%E6%88%AA%E5%9B%BE20230917223722.png"></p>
<p>判断是否是一个接口，或者是否是一个父类，如果是一个父类就先初始化父类</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/QQ%E6%88%AA%E5%9B%BE20230917224026.png"></p>
<p>对类静态字段进行初始化和调用了类的初始化函数</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/QQ%E6%88%AA%E5%9B%BE20230917224136.png"></p>
<p>得到之后通过invoke调用</p>
<h3 id="方法调用流程"><a href="#方法调用流程" class="headerlink" title="方法调用流程"></a>方法调用流程</h3><p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/QQ%E6%88%AA%E5%9B%BE20230917224448.png"></p>
<p>native函数直接去源代码里看，命名规则 类_方法名 Method_invoke</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/QQ%E6%88%AA%E5%9B%BE20230917224619.png"></p>
<p>分析一下InvokeMethod</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/QQ%E6%88%AA%E5%9B%BE20230917232656.png"></p>
<p>最后将javaMethod变成了ArtMethod</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/QQ%E6%88%AA%E5%9B%BE20230917232906.png"></p>
<p>往下走分析下InvokeMethodImpl</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/QQ%E6%88%AA%E5%9B%BE20230917232949.png"></p>
<p>这里的 InvokeWithArgArray在使用jni调用javaMethod时也会使用到</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/QQ%E6%88%AA%E5%9B%BE20230917233118.png"></p>
<p>所以java的方法最终会走到 ArtMethod的invoke执行</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/QQ%E6%88%AA%E5%9B%BE20230917233313.png"></p>
<p>这里可以作为抽取加固的脱壳点，保存codeitem之后然后返回</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/QQ%E6%88%AA%E5%9B%BE20230918002059.png"></p>
<p>判断是否解释执行、是否是native函数，然后进入EnterInterpreterFromInvoke</p>
<p>其中有 Execute，是我们之前整体加固的脱壳点</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/QQ%E6%88%AA%E5%9B%BE20230918002220.png"></p>
<h3 id="dumpMethodCode-method"><a href="#dumpMethodCode-method" class="headerlink" title="dumpMethodCode_method"></a>dumpMethodCode_method</h3><p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/QQ%E6%88%AA%E5%9B%BE20230918002921.png"></p>
<p>native函数</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">extern</span> <span class="token string">"C"</span> ArtMethod<span class="token operator">*</span> <span class="token function">jobject2ArtMethod</span><span class="token punctuation">(</span>JNIEnv<span class="token operator">*</span> env<span class="token punctuation">,</span> jobject javaMethod<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  ScopedFastNativeObjectAccess <span class="token function">soa</span><span class="token punctuation">(</span>env<span class="token punctuation">)</span><span class="token punctuation">;</span>
  ArtMethod<span class="token operator">*</span> method <span class="token operator">=</span> ArtMethod<span class="token operator">::</span><span class="token function">FromReflectedMethod</span><span class="token punctuation">(</span>soa<span class="token punctuation">,</span> javaMethod<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> method<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">extern</span> <span class="token string">"C"</span> <span class="token keyword">void</span> <span class="token function">myfartInvoke</span><span class="token punctuation">(</span>ArtMethod<span class="token operator">*</span> artmethod<span class="token punctuation">)</span>  <span class="token function">REQUIRES_SHARED</span><span class="token punctuation">(</span>Locks<span class="token operator">::</span>mutator_lock_<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	JValue <span class="token operator">*</span>result<span class="token operator">=</span>nullptr<span class="token punctuation">;</span><span class="token comment">//结果</span>
	Thread <span class="token operator">*</span>self<span class="token operator">=</span>nullptr<span class="token punctuation">;</span><span class="token comment">//线程</span>
	<span class="token class-name">uint32_t</span> temp<span class="token operator">=</span><span class="token number">6</span><span class="token punctuation">;</span>
	<span class="token class-name">uint32_t</span><span class="token operator">*</span> args<span class="token operator">=</span><span class="token operator">&amp;</span>temp<span class="token punctuation">;</span><span class="token comment">//参数数组</span>
	<span class="token class-name">uint32_t</span> args_size<span class="token operator">=</span><span class="token number">6</span><span class="token punctuation">;</span><span class="token comment">//参数数量</span>
	artmethod<span class="token operator">-></span><span class="token function">Invoke</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> args<span class="token punctuation">,</span> args_size<span class="token punctuation">,</span> result<span class="token punctuation">,</span> <span class="token string">"fart"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">DexFile_dumpMethodCode</span><span class="token punctuation">(</span>JNIEnv<span class="token operator">*</span> env<span class="token punctuation">,</span> jclass<span class="token punctuation">,</span>jobject method<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>method<span class="token operator">!=</span>nullptr<span class="token punctuation">)</span>
  <span class="token punctuation">&#123;</span>
		  ArtMethod<span class="token operator">*</span> proxy_method <span class="token operator">=</span> <span class="token function">jobject2ArtMethod</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> method<span class="token punctuation">)</span><span class="token punctuation">;</span>
		  <span class="token function">myfartInvoke</span><span class="token punctuation">(</span>proxy_method<span class="token punctuation">)</span><span class="token punctuation">;</span>
	  <span class="token punctuation">&#125;</span>	 

  <span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>其实就是把传入的jobject的method转换成了ArtMethod，然后调用ArtMethod的Invoke</p>
<p>Invoke里加了代码</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/QQ%E6%88%AA%E5%9B%BE20230918003550.png"></p>
<p>如果传入的self是nullptr，就会执行dumpArtMethod</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">extern</span> <span class="token string">"C"</span> <span class="token keyword">void</span> <span class="token function">dumpArtMethod</span><span class="token punctuation">(</span>ArtMethod<span class="token operator">*</span> artmethod<span class="token punctuation">)</span>  <span class="token function">REQUIRES_SHARED</span><span class="token punctuation">(</span>Locks<span class="token operator">::</span>mutator_lock_<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">char</span> <span class="token operator">*</span>dexfilepath<span class="token operator">=</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	
        <span class="token keyword">if</span><span class="token punctuation">(</span>dexfilepath<span class="token operator">==</span>nullptr<span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            <span class="token function">LOG</span><span class="token punctuation">(</span>ERROR<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"ArtMethod::dumpArtMethodinvoked,methodname:"</span><span class="token operator">&lt;&lt;</span>artmethod<span class="token operator">-></span><span class="token function">PrettyMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&lt;&lt;</span><span class="token string">"malloc 1000 byte failed"</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">int</span> result<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> fcmdline <span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">char</span> szCmdline<span class="token punctuation">[</span><span class="token number">64</span><span class="token punctuation">]</span><span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token number">0</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
        <span class="token keyword">char</span> szProcName<span class="token punctuation">[</span><span class="token number">256</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token number">0</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> procid <span class="token operator">=</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">sprintf</span><span class="token punctuation">(</span>szCmdline<span class="token punctuation">,</span><span class="token string">"/proc/%d/cmdline"</span><span class="token punctuation">,</span> procid<span class="token punctuation">)</span><span class="token punctuation">;</span>
        fcmdline <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span>szCmdline<span class="token punctuation">,</span> O_RDONLY<span class="token punctuation">,</span><span class="token number">0644</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>fcmdline <span class="token operator">></span><span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            result<span class="token operator">=</span><span class="token function">read</span><span class="token punctuation">(</span>fcmdline<span class="token punctuation">,</span> szProcName<span class="token punctuation">,</span><span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>result<span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token punctuation">&#123;</span>
                <span class="token function">LOG</span><span class="token punctuation">(</span>ERROR<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"ArtMethod::dumpdexfilebyArtMethod,open cmdline file file error"</span><span class="token punctuation">;</span>									
            <span class="token punctuation">&#125;</span>
            <span class="token function">close</span><span class="token punctuation">(</span>fcmdline<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">if</span><span class="token punctuation">(</span>szProcName<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
                  <span class="token keyword">const</span> DexFile<span class="token operator">*</span> dex_file <span class="token operator">=</span> artmethod<span class="token operator">-></span><span class="token function">GetDexFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                  <span class="token keyword">const</span> <span class="token class-name">uint8_t</span><span class="token operator">*</span> begin_<span class="token operator">=</span>dex_file<span class="token operator">-></span><span class="token function">Begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// Start of data.</span>
                  <span class="token class-name">size_t</span> size_<span class="token operator">=</span>dex_file<span class="token operator">-></span><span class="token function">Size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// Length of data.</span>

                  <span class="token function">memset</span><span class="token punctuation">(</span>dexfilepath<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                  <span class="token keyword">int</span> size_int_<span class="token operator">=</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>size_<span class="token punctuation">;</span>

                  <span class="token function">memset</span><span class="token punctuation">(</span>dexfilepath<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                  <span class="token function">sprintf</span><span class="token punctuation">(</span>dexfilepath<span class="token punctuation">,</span><span class="token string">"%s"</span><span class="token punctuation">,</span><span class="token string">"/sdcard/fart"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                  <span class="token function">mkdir</span><span class="token punctuation">(</span>dexfilepath<span class="token punctuation">,</span><span class="token number">0777</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                  <span class="token function">memset</span><span class="token punctuation">(</span>dexfilepath<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                  <span class="token function">sprintf</span><span class="token punctuation">(</span>dexfilepath<span class="token punctuation">,</span><span class="token string">"/sdcard/fart/%s"</span><span class="token punctuation">,</span>szProcName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                  <span class="token function">mkdir</span><span class="token punctuation">(</span>dexfilepath<span class="token punctuation">,</span><span class="token number">0777</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                  <span class="token function">memset</span><span class="token punctuation">(</span>dexfilepath<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                  <span class="token function">sprintf</span><span class="token punctuation">(</span>dexfilepath<span class="token punctuation">,</span><span class="token string">"/sdcard/fart/%s/%d_dexfile.dex"</span><span class="token punctuation">,</span>szProcName<span class="token punctuation">,</span>size_int_<span class="token punctuation">)</span><span class="token punctuation">;</span>
                  <span class="token keyword">int</span> dexfilefp<span class="token operator">=</span><span class="token function">open</span><span class="token punctuation">(</span>dexfilepath<span class="token punctuation">,</span>O_RDONLY<span class="token punctuation">,</span><span class="token number">0666</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                  <span class="token keyword">if</span><span class="token punctuation">(</span>dexfilefp<span class="token operator">></span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
                      <span class="token function">close</span><span class="token punctuation">(</span>dexfilefp<span class="token punctuation">)</span><span class="token punctuation">;</span>
                      dexfilefp<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>

                      <span class="token punctuation">&#125;</span><span class="token keyword">else</span><span class="token punctuation">&#123;</span>
                                  <span class="token keyword">int</span> fp<span class="token operator">=</span><span class="token function">open</span><span class="token punctuation">(</span>dexfilepath<span class="token punctuation">,</span>O_CREAT<span class="token operator">|</span>O_APPEND<span class="token operator">|</span>O_RDWR<span class="token punctuation">,</span><span class="token number">0666</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                  <span class="token keyword">if</span><span class="token punctuation">(</span>fp<span class="token operator">></span><span class="token number">0</span><span class="token punctuation">)</span>
                                  <span class="token punctuation">&#123;</span>
                                      result<span class="token operator">=</span><span class="token function">write</span><span class="token punctuation">(</span>fp<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span>begin_<span class="token punctuation">,</span>size_<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                      <span class="token keyword">if</span><span class="token punctuation">(</span>result<span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span>
                                        <span class="token punctuation">&#123;</span>
                                            <span class="token function">LOG</span><span class="token punctuation">(</span>ERROR<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"ArtMethod::dumpdexfilebyArtMethod,open dexfilepath file error"</span><span class="token punctuation">;</span>

                                        <span class="token punctuation">&#125;</span>
                                      <span class="token function">fsync</span><span class="token punctuation">(</span>fp<span class="token punctuation">)</span><span class="token punctuation">;</span> 
                                      <span class="token function">close</span><span class="token punctuation">(</span>fp<span class="token punctuation">)</span><span class="token punctuation">;</span>  
                                      <span class="token function">memset</span><span class="token punctuation">(</span>dexfilepath<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                      <span class="token function">sprintf</span><span class="token punctuation">(</span>dexfilepath<span class="token punctuation">,</span><span class="token string">"/sdcard/fart/%s/%d_classlist.txt"</span><span class="token punctuation">,</span>szProcName<span class="token punctuation">,</span>size_int_<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                      <span class="token keyword">int</span> classlistfile<span class="token operator">=</span><span class="token function">open</span><span class="token punctuation">(</span>dexfilepath<span class="token punctuation">,</span>O_CREAT<span class="token operator">|</span>O_APPEND<span class="token operator">|</span>O_RDWR<span class="token punctuation">,</span><span class="token number">0666</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                        <span class="token keyword">if</span><span class="token punctuation">(</span>classlistfile<span class="token operator">></span><span class="token number">0</span><span class="token punctuation">)</span>
                                        <span class="token punctuation">&#123;</span>
                                            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">size_t</span> ii<span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> ii<span class="token operator">&lt;</span> dex_file<span class="token operator">-></span><span class="token function">NumClassDefs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">++</span>ii<span class="token punctuation">)</span> 
                                            <span class="token punctuation">&#123;</span>
                                                <span class="token keyword">const</span> DexFile<span class="token operator">::</span>ClassDef<span class="token operator">&amp;</span> class_def <span class="token operator">=</span> dex_file<span class="token operator">-></span><span class="token function">GetClassDef</span><span class="token punctuation">(</span>ii<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                                <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> descriptor <span class="token operator">=</span> dex_file<span class="token operator">-></span><span class="token function">GetClassDescriptor</span><span class="token punctuation">(</span>class_def<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                                result<span class="token operator">=</span><span class="token function">write</span><span class="token punctuation">(</span>classlistfile<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span>descriptor<span class="token punctuation">,</span><span class="token function">strlen</span><span class="token punctuation">(</span>descriptor<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                                <span class="token keyword">if</span><span class="token punctuation">(</span>result<span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span>
                                                <span class="token punctuation">&#123;</span>
                                                    <span class="token function">LOG</span><span class="token punctuation">(</span>ERROR<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"ArtMethod::dumpdexfilebyArtMethod,write classlistfile file error"</span><span class="token punctuation">;</span>

                                                    <span class="token punctuation">&#125;</span>
                                                <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> temp<span class="token operator">=</span><span class="token string">"\n"</span><span class="token punctuation">;</span>
                                                result<span class="token operator">=</span><span class="token function">write</span><span class="token punctuation">(</span>classlistfile<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span>temp<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                                <span class="token keyword">if</span><span class="token punctuation">(</span>result<span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span>
                                                <span class="token punctuation">&#123;</span>
                                                    <span class="token function">LOG</span><span class="token punctuation">(</span>ERROR<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"ArtMethod::dumpdexfilebyArtMethod,write classlistfile file error"</span><span class="token punctuation">;</span>

                                                    <span class="token punctuation">&#125;</span>
                                                <span class="token punctuation">&#125;</span>
                                              <span class="token function">fsync</span><span class="token punctuation">(</span>classlistfile<span class="token punctuation">)</span><span class="token punctuation">;</span> 
                                              <span class="token function">close</span><span class="token punctuation">(</span>classlistfile<span class="token punctuation">)</span><span class="token punctuation">;</span> 

                                            <span class="token punctuation">&#125;</span>
                                      <span class="token punctuation">&#125;</span>


                                  <span class="token punctuation">&#125;</span>
                    <span class="token comment">//获取code_item</span>
                      <span class="token keyword">const</span> DexFile<span class="token operator">::</span>CodeItem<span class="token operator">*</span> code_item <span class="token operator">=</span> artmethod<span class="token operator">-></span><span class="token function">GetCodeItem</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">LIKELY</span><span class="token punctuation">(</span>code_item <span class="token operator">!=</span> nullptr<span class="token punctuation">)</span><span class="token punctuation">)</span> 
                      <span class="token punctuation">&#123;</span>				  
                              <span class="token keyword">int</span> code_item_len <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                              <span class="token class-name">uint8_t</span> <span class="token operator">*</span>item<span class="token operator">=</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> <span class="token operator">*</span><span class="token punctuation">)</span> code_item<span class="token punctuation">;</span>
                              <span class="token keyword">if</span> <span class="token punctuation">(</span>code_item<span class="token operator">-></span>tries_size_<span class="token operator">></span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                                  <span class="token keyword">const</span> <span class="token class-name">uint8_t</span> <span class="token operator">*</span>handler_data <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token class-name">uint8_t</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>DexFile<span class="token operator">::</span><span class="token function">GetTryItems</span><span class="token punctuation">(</span><span class="token operator">*</span>code_item<span class="token punctuation">,</span> code_item<span class="token operator">-></span>tries_size_<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                  <span class="token class-name">uint8_t</span> <span class="token operator">*</span> tail <span class="token operator">=</span> <span class="token function">codeitem_end</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>handler_data<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                  code_item_len <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">(</span>tail <span class="token operator">-</span> item<span class="token punctuation">)</span><span class="token punctuation">;</span>
                              <span class="token punctuation">&#125;</span><span class="token keyword">else</span><span class="token punctuation">&#123;</span>
                                  code_item_len <span class="token operator">=</span> <span class="token number">16</span><span class="token operator">+</span>code_item<span class="token operator">-></span>insns_size_in_code_units_<span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">;</span>
                              <span class="token punctuation">&#125;</span>  
                                  <span class="token function">memset</span><span class="token punctuation">(</span>dexfilepath<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                  <span class="token keyword">int</span> size_int<span class="token operator">=</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>dex_file<span class="token operator">-></span><span class="token function">Size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
                                  <span class="token class-name">uint32_t</span> method_idx<span class="token operator">=</span>artmethod<span class="token operator">-></span><span class="token function">GetDexMethodIndexUnchecked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                  <span class="token function">sprintf</span><span class="token punctuation">(</span>dexfilepath<span class="token punctuation">,</span><span class="token string">"/sdcard/fart/%s/%d_ins_%d.bin"</span><span class="token punctuation">,</span>szProcName<span class="token punctuation">,</span>size_int<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token function">gettidv1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                  <span class="token keyword">int</span> fp2<span class="token operator">=</span><span class="token function">open</span><span class="token punctuation">(</span>dexfilepath<span class="token punctuation">,</span>O_CREAT<span class="token operator">|</span>O_APPEND<span class="token operator">|</span>O_RDWR<span class="token punctuation">,</span><span class="token number">0666</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                  <span class="token keyword">if</span><span class="token punctuation">(</span>fp2<span class="token operator">></span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
                                      <span class="token function">lseek</span><span class="token punctuation">(</span>fp2<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token constant">SEEK_END</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                      <span class="token function">memset</span><span class="token punctuation">(</span>dexfilepath<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                      <span class="token keyword">int</span> offset<span class="token operator">=</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">(</span>item <span class="token operator">-</span> begin_<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                      <span class="token function">sprintf</span><span class="token punctuation">(</span>dexfilepath<span class="token punctuation">,</span><span class="token string">"&#123;name:%s,method_idx:%d,offset:%d,code_item_len:%d,ins:"</span><span class="token punctuation">,</span>artmethod<span class="token operator">-></span><span class="token function">PrettyMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>method_idx<span class="token punctuation">,</span>offset<span class="token punctuation">,</span>code_item_len<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                      <span class="token keyword">int</span> contentlength<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
                                      <span class="token keyword">while</span><span class="token punctuation">(</span>dexfilepath<span class="token punctuation">[</span>contentlength<span class="token punctuation">]</span><span class="token operator">!=</span><span class="token number">0</span><span class="token punctuation">)</span> contentlength<span class="token operator">++</span><span class="token punctuation">;</span>
                                      result<span class="token operator">=</span><span class="token function">write</span><span class="token punctuation">(</span>fp2<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span>dexfilepath<span class="token punctuation">,</span>contentlength<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                      <span class="token keyword">if</span><span class="token punctuation">(</span>result<span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span>
                                                <span class="token punctuation">&#123;</span>
                                                    <span class="token function">LOG</span><span class="token punctuation">(</span>ERROR<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"ArtMethod::dumpdexfilebyArtMethod,write ins file error"</span><span class="token punctuation">;</span>

                                                    <span class="token punctuation">&#125;</span>
                                      <span class="token keyword">long</span> outlen<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
                                      <span class="token keyword">char</span><span class="token operator">*</span> base64result<span class="token operator">=</span><span class="token function">base64_encode</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span>item<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span>code_item_len<span class="token punctuation">,</span><span class="token operator">&amp;</span>outlen<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                      result<span class="token operator">=</span><span class="token function">write</span><span class="token punctuation">(</span>fp2<span class="token punctuation">,</span>base64result<span class="token punctuation">,</span>outlen<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                      <span class="token keyword">if</span><span class="token punctuation">(</span>result<span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span>
                                                <span class="token punctuation">&#123;</span>
                                                    <span class="token function">LOG</span><span class="token punctuation">(</span>ERROR<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"ArtMethod::dumpdexfilebyArtMethod,write ins file error"</span><span class="token punctuation">;</span>

                                                    <span class="token punctuation">&#125;</span>
                                      result<span class="token operator">=</span><span class="token function">write</span><span class="token punctuation">(</span>fp2<span class="token punctuation">,</span><span class="token string">"&#125;;"</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                      <span class="token keyword">if</span><span class="token punctuation">(</span>result<span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span>
                                                <span class="token punctuation">&#123;</span>
                                                    <span class="token function">LOG</span><span class="token punctuation">(</span>ERROR<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"ArtMethod::dumpdexfilebyArtMethod,write ins file error"</span><span class="token punctuation">;</span>

                                                    <span class="token punctuation">&#125;</span>
                                      <span class="token function">fsync</span><span class="token punctuation">(</span>fp2<span class="token punctuation">)</span><span class="token punctuation">;</span> 
                                      <span class="token function">close</span><span class="token punctuation">(</span>fp2<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                      <span class="token keyword">if</span><span class="token punctuation">(</span>base64result<span class="token operator">!=</span>nullptr<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
                                          <span class="token function">free</span><span class="token punctuation">(</span>base64result<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                          base64result<span class="token operator">=</span>nullptr<span class="token punctuation">;</span>
                                          <span class="token punctuation">&#125;</span>
                                       <span class="token punctuation">&#125;</span>

                        <span class="token punctuation">&#125;</span>


        <span class="token punctuation">&#125;</span>

        <span class="token keyword">if</span><span class="token punctuation">(</span>dexfilepath<span class="token operator">!=</span>nullptr<span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            <span class="token function">free</span><span class="token punctuation">(</span>dexfilepath<span class="token punctuation">)</span><span class="token punctuation">;</span>
            dexfilepath<span class="token operator">=</span>nullptr<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>Codeltem起始地址的获取：artMethod-&gt;GetCodeltem()</p>
<p>Codeltem长度的计算：dex_file-&gt;GetCodeItemSize(const Codeltem&amp; code)</p>
<p>MethodIndex的获取：artMethod-&gt;GetDexMethodIndex()</p>
<h3 id="将FART迁移到安卓10"><a href="#将FART迁移到安卓10" class="headerlink" title="将FART迁移到安卓10"></a>将FART迁移到安卓10</h3><p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/QQx%E6%88%AA%E5%9B%BE20230918144525.png"></p>
<p>先在core-java-com下创建一个文件夹whitebird，然后创建了一个类saveDex，里面装了一些工具方法</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/0230918144705.png"></p>
<p>将fart源码中的图中方法进行移植过来，我们先看fartthread，修改名字为whitebirdthread，里面开启了一个线程，防止app卡顿，然后休眠60秒后开始脱壳</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/QQ%E6%88%AA%E5%9B%BE20230918151606.png"></p>
<p>上面代码之前我们分析过，后面都一样，修复一下，然后将自己实现的类和包加入白名单</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/QQ%E6%88%AA%E5%9B%BE20230918211506.png"></p>
<p>我们需要在ActivityThread中启动脱壳的线程，需要在makeApplication之后，为了让壳的代码跑完，类加载，防止出问题</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/QQ%E6%88%AA%E5%9B%BE202309s18211601.png"></p>
<p>现在saveMethodCode是在c层实现，我们需要去clion中修改，进行函数注册</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/QQ%E6%88%AA%E5%9B%BE20230918211808.png"></p>
<p>函数的实现</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/QQ%E6%88%AA%E5%9B%BE20230918211835.png"></p>
<p>还需要对调用的函数进行声明</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/QQ%E6%88%AA%E5%9B%BE20230918211905.png"></p>
<p>在java_lang_reflect_Method.cc进行实现</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/x.png"></p>
<p>在art_method.cc进行实现</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/QQ%E6%88%AA%E5%9B%BE20230918212632.png"></p>
<p>Invoke里我们也要修改</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/QQ%E6%88%AA%E5%9B%BE20230918212738.png"></p>
<p>由于参数是我们乱传的，所以当判断self为nullptr时，说明是我们自己调用，此时dump完就可以返回了，往后面继续执行可能会报错</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/QQ%E6%88%AA%E5%9B%BE20230918231923.png"></p>
<p>前面是整体加固脱壳，我们重点关注后面抽取加固脱壳</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">const</span> dex<span class="token operator">::</span>CodeItem<span class="token operator">*</span> code_item <span class="token operator">=</span> artMethod<span class="token operator">-></span><span class="token function">GetCodeItem</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">LIKELY</span><span class="token punctuation">(</span>code_item <span class="token operator">!=</span> nullptr<span class="token punctuation">)</span><span class="token punctuation">)</span>
       <span class="token punctuation">&#123;</span>
           <span class="token class-name">uint8_t</span> <span class="token operator">*</span>item<span class="token operator">=</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> <span class="token operator">*</span><span class="token punctuation">)</span> code_item<span class="token punctuation">;</span>
           <span class="token class-name">uint32_t</span> code_item_len <span class="token operator">=</span> dex_file<span class="token operator">-></span><span class="token function">GetCodeItemSize</span><span class="token punctuation">(</span><span class="token operator">*</span>code_item<span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token function">memset</span><span class="token punctuation">(</span>dexFilePath<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token keyword">int</span> size_int<span class="token operator">=</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>dex_file<span class="token operator">-></span><span class="token function">Size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token class-name">uint32_t</span> method_idx<span class="token operator">=</span>artMethod<span class="token operator">-></span><span class="token function">GetDexMethodIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token function">sprintf</span><span class="token punctuation">(</span>dexFilePath<span class="token punctuation">,</span><span class="token string">"/data/data/%s/whitebird/%d_ins_%d.bin"</span><span class="token punctuation">,</span>szProcName<span class="token punctuation">,</span>size_int<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token function">gettidv1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token keyword">int</span> fp2<span class="token operator">=</span><span class="token function">open</span><span class="token punctuation">(</span>dexFilePath<span class="token punctuation">,</span>O_CREAT<span class="token operator">|</span>O_APPEND<span class="token operator">|</span>O_RDWR<span class="token punctuation">,</span><span class="token number">0666</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token keyword">if</span><span class="token punctuation">(</span>fp2<span class="token operator">></span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
               <span class="token function">lseek</span><span class="token punctuation">(</span>fp2<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token constant">SEEK_END</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
               <span class="token function">memset</span><span class="token punctuation">(</span>dexFilePath<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
               <span class="token keyword">int</span> offset<span class="token operator">=</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">(</span>item <span class="token operator">-</span> begin_<span class="token punctuation">)</span><span class="token punctuation">;</span>
               <span class="token function">sprintf</span><span class="token punctuation">(</span>dexFilePath<span class="token punctuation">,</span><span class="token string">"&#123;name: '%s',method_idx: %d,offset:%d,code_item_len:%d,ins:'"</span><span class="token punctuation">,</span>
                       artMethod<span class="token operator">-></span><span class="token function">PrettyMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                       method_idx<span class="token punctuation">,</span>
                       offset<span class="token punctuation">,</span>
                       code_item_len<span class="token punctuation">)</span><span class="token punctuation">;</span>
               <span class="token keyword">int</span> contentlength<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
               <span class="token keyword">while</span><span class="token punctuation">(</span>dexFilePath<span class="token punctuation">[</span>contentlength<span class="token punctuation">]</span><span class="token operator">!=</span><span class="token number">0</span><span class="token punctuation">)</span> contentlength<span class="token operator">++</span><span class="token punctuation">;</span>
               result<span class="token operator">=</span><span class="token function">write</span><span class="token punctuation">(</span>fp2<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span>dexFilePath<span class="token punctuation">,</span>contentlength<span class="token punctuation">)</span><span class="token punctuation">;</span>
               <span class="token keyword">if</span><span class="token punctuation">(</span>result<span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span>
               <span class="token punctuation">&#123;</span>
                   <span class="token function">LOG</span><span class="token punctuation">(</span>ERROR<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"ArtMethod::saveArtMethod,write ins file error"</span><span class="token punctuation">;</span>

               <span class="token punctuation">&#125;</span>
               <span class="token keyword">long</span> outlen<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
               <span class="token keyword">char</span><span class="token operator">*</span> base64result<span class="token operator">=</span><span class="token function">base64_encode</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span>item<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span>code_item_len<span class="token punctuation">,</span><span class="token operator">&amp;</span>outlen<span class="token punctuation">)</span><span class="token punctuation">;</span>
               result<span class="token operator">=</span><span class="token function">write</span><span class="token punctuation">(</span>fp2<span class="token punctuation">,</span>base64result<span class="token punctuation">,</span>outlen<span class="token punctuation">)</span><span class="token punctuation">;</span>
               <span class="token keyword">if</span><span class="token punctuation">(</span>result<span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span>
               <span class="token punctuation">&#123;</span>
                   <span class="token function">LOG</span><span class="token punctuation">(</span>ERROR<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"ArtMethod::saveArtMethod,write ins file error"</span><span class="token punctuation">;</span>

               <span class="token punctuation">&#125;</span>
               result<span class="token operator">=</span><span class="token function">write</span><span class="token punctuation">(</span>fp2<span class="token punctuation">,</span><span class="token string">"'&#125;;"</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
               <span class="token keyword">if</span><span class="token punctuation">(</span>result<span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span>
               <span class="token punctuation">&#123;</span>
                   <span class="token function">LOG</span><span class="token punctuation">(</span>ERROR<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"ArtMethod::saveArtMethod,write ins file error"</span><span class="token punctuation">;</span>

               <span class="token punctuation">&#125;</span>
               <span class="token function">fsync</span><span class="token punctuation">(</span>fp2<span class="token punctuation">)</span><span class="token punctuation">;</span>
               <span class="token function">close</span><span class="token punctuation">(</span>fp2<span class="token punctuation">)</span><span class="token punctuation">;</span>
               <span class="token keyword">if</span><span class="token punctuation">(</span>base64result<span class="token operator">!=</span>nullptr<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
                   <span class="token function">free</span><span class="token punctuation">(</span>base64result<span class="token punctuation">)</span><span class="token punctuation">;</span>
                   base64result<span class="token operator">=</span>nullptr<span class="token punctuation">;</span>
               <span class="token punctuation">&#125;</span>
           <span class="token punctuation">&#125;</span>

       <span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>然后就可以编译刷机了，运行完查看目录下文件</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/QQ%E6%88%AA%E5%9B%BE2ss02309152122730.png"></p>
<p>重点关注</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/QQ1%E6%88%AA%E5%9B%BE20230919003116.png"></p>
<p>这里的dex是通过整体加固方式脱下来的，bin是通过抽取加固脱下来的</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/QQ%E6%88%AA%E5%9B%BE20230919004933.png"></p>
<p>MainActivity已经修复了，但是AES、DES这些没有，因为MainActivity在程序执行时被动调用了且没有还原回去，所以我们等待60s后通过整体加固可以脱下来，但是AES、DES等并没有被执行，需要通过bin文件修复</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/QQ%E6%88%AA%E5%9B%BE20230919005117.png"></p>
<p>如果把上面的dex直接拖入新版jadx会报错，需要修改jadx的配置，在文件-&gt;首选项，yes改为no</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/QQ%E6%88%AA%E5%9B%BE20230919005800.png"></p>
<h2 id="13、dex重构"><a href="#13、dex重构" class="headerlink" title="13、dex重构"></a>13、dex重构</h2><p>项目地址:<a target="_blank" rel="noopener" href="https://github.com/dqzg12300/dexfixer">https://github.com/dqzg12300/dexfixer</a></p>
<p>导入idea，对项目做一些修改</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/QQ%E6%88%AA%E5%9B%BE20230919125836.png"></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>dx<span class="token punctuation">.</span>unpacker</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>dex<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">ByteInput</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>dex<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">ByteOutput</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>google<span class="token punctuation">.</span>gson<span class="token punctuation">.</span></span><span class="token class-name">Gson</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">ByteArrayOutputStream</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">File</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">FileInputStream</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">FileNotFoundException</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IOException</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">InputStream</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>nio<span class="token punctuation">.</span></span><span class="token class-name">ByteBuffer</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>nio<span class="token punctuation">.</span></span><span class="token class-name">ByteOrder</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Base64</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">HashMap</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Map</span></span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MethodCodeItemFile</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">private</span> <span class="token class-name">ByteBuffer</span> data<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">,</span> <span class="token class-name">MethodCodeItem</span><span class="token punctuation">></span></span> map<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> jsondata<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">MethodCodeItemFile</span><span class="token punctuation">(</span><span class="token class-name">File</span> file<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">InputStream</span> inputStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileInputStream</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            <span class="token comment">//把读取后的结果放到jsondata中</span>
            <span class="token function">loadFrom</span><span class="token punctuation">(</span>inputStream<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Gson</span> gson<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">Gson</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//将jsondata数据按;分割，因为bin文件中以;分割</span>
            <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> items<span class="token operator">=</span><span class="token keyword">this</span><span class="token punctuation">.</span>jsondata<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">";"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>items<span class="token punctuation">.</span>length<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
                <span class="token comment">//解析json数据并且赋值</span>
                <span class="token class-name">String</span> codeJson<span class="token operator">=</span>items<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
                <span class="token class-name">JsonCodeItem</span> codedata<span class="token operator">=</span> gson<span class="token punctuation">.</span><span class="token function">fromJson</span><span class="token punctuation">(</span>codeJson<span class="token punctuation">,</span><span class="token class-name">JsonCodeItem</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">MethodCodeItem</span> codeItem <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MethodCodeItem</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                codeItem<span class="token punctuation">.</span>index <span class="token operator">=</span> codedata<span class="token punctuation">.</span>method_idx<span class="token punctuation">;</span>
                codeItem<span class="token punctuation">.</span>descriptor <span class="token operator">=</span> codedata<span class="token punctuation">.</span>name<span class="token punctuation">;</span>
                codeItem<span class="token punctuation">.</span>size <span class="token operator">=</span> codedata<span class="token punctuation">.</span>code_item_len<span class="token punctuation">;</span>
                <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> buff<span class="token operator">=</span> <span class="token class-name">Base64</span><span class="token punctuation">.</span><span class="token function">getDecoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span>codedata<span class="token punctuation">.</span>ins<span class="token punctuation">)</span><span class="token punctuation">;</span>
                codeItem<span class="token punctuation">.</span>code <span class="token operator">=</span> buff<span class="token punctuation">;</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>codeItem<span class="token punctuation">.</span>index<span class="token punctuation">,</span> codeItem<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>

<span class="token comment">//            while (data.hasRemaining())</span>
<span class="token comment">//            &#123;</span>
<span class="token comment">//                MethodCodeItem codeItem = new MethodCodeItem();</span>
<span class="token comment">//                codeItem.index = readInt();</span>
<span class="token comment">//                codeItem.descriptor = readCString();</span>
<span class="token comment">//                codeItem.size = readInt();</span>
<span class="token comment">//                codeItem.code = readByteArray(codeItem.size);</span>
<span class="token comment">//                this.map.put(codeItem.index, codeItem);</span>
<span class="token comment">//            &#125;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Warn: "</span> <span class="token operator">+</span> file<span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" maybe invalid format!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">,</span> <span class="token class-name">MethodCodeItem</span><span class="token punctuation">></span></span> <span class="token function">getMethodCodeItems</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>map<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">readByteArray</span><span class="token punctuation">(</span><span class="token keyword">int</span> length<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span>length<span class="token punctuation">]</span><span class="token punctuation">;</span>
        data<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">readInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> data<span class="token punctuation">.</span><span class="token function">getInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">readCString</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token keyword">byte</span> b<span class="token punctuation">;</span>
        <span class="token class-name">StringBuilder</span> s <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">do</span>
        <span class="token punctuation">&#123;</span>
            b <span class="token operator">=</span> data<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>b <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token punctuation">&#123;</span>
                s<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token punctuation">)</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>b <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">loadFrom</span><span class="token punctuation">(</span><span class="token class-name">InputStream</span> in<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span>
    <span class="token punctuation">&#123;</span>
        <span class="token class-name">ByteArrayOutputStream</span> bytesOut <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ByteArrayOutputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> buffer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token number">8192</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

        <span class="token keyword">int</span> count<span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>count <span class="token operator">=</span> in<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            bytesOut<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>buffer<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

<span class="token comment">//        this.data = ByteBuffer.wrap(bytesOut.toByteArray());</span>
<span class="token comment">//        this.data.order(ByteOrder.LITTLE_ENDIAN);</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>jsondata<span class="token operator">=</span>bytesOut<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>删除了对json数据加引号的操作，因为我们在保存bin时已经加了引号</p>
<p>配置参数然后运行</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/QQ%E6%88%AA%E5%9B%BE20230919133127.png"></p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/QQ%E6%88%AA%E5%9B%BE20230919133203.png"></p>
<p>拖入jadx看看</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/QQ%E6%88%AA%E5%9B%BE20230919133239.png"></p>
<p>已经修复完成了</p>
<p>将项目打包成jar包</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/QQ%E6%88%AA%E5%9B%BE20230919133724.png"></p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/QQ%E6%88%AA%E5%9B%BE2s0230919133840.png"></p>
<p>已经编译好了，可以直接拿来修复dex</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/QQ%E6%88%AA%E5%9B%BE20230x919134007.png"></p>
<h2 id="14、FART存在的问题"><a href="#14、FART存在的问题" class="headerlink" title="14、FART存在的问题"></a>14、FART存在的问题</h2><p>1、调用链深度不够，有些壳将原有函数体替换为解密代码，运行时才解密执行</p>
<p>2、有些壳设置一些垃圾类，当该类被初始化时自动退出</p>
<p>3、有些壳设置一些垃圾类，实时检测这些类是否加载</p>
<p>4、动态加载的dex文件，如果没有修正ClassLoader，不会出现在双亲委派关系中，也不会被FART遍历到</p>
<h2 id="15、FART改进方案"><a href="#15、FART改进方案" class="headerlink" title="15、FART改进方案"></a>15、FART改进方案</h2><p>1、学习youpk的调用链深度</p>
<p>2、不进行类的初始化，或者不主动调用该类</p>
<p>通过过滤类或者使用loadclass，而不是Class.forName</p>
<p>3、设置配置文件，类似白名单，对指定类进行主动调用，或者避开指定类的调用</p>
<p>利用Frida主动调用FART的函数，对指定类进行脱壳</p>
<p>4、利用Frida枚举所有ClassLoader，再主动调用FART的函数进行脱壳</p>
<p>Exexute脱壳点对于动态加载的dex也可以脱，除非这个dex没有类的初始化函数</p>
<h2 id="16、使用frida调用fart函数接口"><a href="#16、使用frida调用fart函数接口" class="headerlink" title="16、使用frida调用fart函数接口"></a>16、使用frida调用fart函数接口</h2><h3 id="对某个dex进行脱壳"><a href="#对某个dex进行脱壳" class="headerlink" title="对某个dex进行脱壳"></a>对某个dex进行脱壳</h3><p>先给自动开启抽取脱壳的线程注释掉，这样就不会在app启动时进行抽取脱壳，但是实现抽取脱壳的函数仍然在系统中，可以作为api调用</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/QQ%E6%88%AA%E5%9B%BE20230919164548.png"></p>
<p>先获取一下类加载器</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">Java<span class="token punctuation">.</span><span class="token function">perform</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    Java<span class="token punctuation">.</span><span class="token function">choose</span><span class="token punctuation">(</span><span class="token string">"dalvik.system.DexClassLoader"</span><span class="token punctuation">,</span><span class="token punctuation">&#123;</span>
        <span class="token function-variable function">onMatch</span><span class="token operator">:</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">instance</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>instance<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token function-variable function">onComplete</span><span class="token operator">:</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>

        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/QQ%E6%88%AA%E5%9B%BE20230919182444.png"></p>
<p>拿到DexClassLoader，我们就可以传入fartwithClassloader</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">Java<span class="token punctuation">.</span><span class="token function">perform</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    Java<span class="token punctuation">.</span><span class="token function">choose</span><span class="token punctuation">(</span><span class="token string">"dalvik.system.DexClassLoader"</span><span class="token punctuation">,</span><span class="token punctuation">&#123;</span>
        <span class="token function-variable function">onMatch</span><span class="token operator">:</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">instance</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>instance<span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token keyword">var</span> saveDex <span class="token operator">=</span> Java<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">"com.whitebird.saveDex"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
           console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>saveDex<span class="token punctuation">)</span><span class="token punctuation">;</span>
           saveDex<span class="token punctuation">.</span><span class="token function">whietbirdwithClassloader</span><span class="token punctuation">(</span>instance<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token function-variable function">onComplete</span><span class="token operator">:</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>

        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>我对fart源码做了改名，fartwithClassloader就是下面的witebirdwithClassloader</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/QQ%E6%88%AA%E5%9B%BE20230919183459.png"></p>
<p>调用完看看&#x2F;data&#x2F;data&#x2F;com.xiaojianbang.app&#x2F;whitebird</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/QQ%E6%88%AA%E5%9B%BE20230919183421.png"></p>
<p>已经有一些bin文件了</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/QQ%E6%88%AA%E5%9B%BE20230919183746.png"></p>
<h3 id="对某个类进行脱壳"><a href="#对某个类进行脱壳" class="headerlink" title="对某个类进行脱壳"></a>对某个类进行脱壳</h3><p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/QQ%E6%88%AA%E5%9B%BE2023a0x919193358.png"></p>
<p>比如我们想要脱DES，代码如下</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">Java<span class="token punctuation">.</span><span class="token function">perform</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">var</span> saveDex <span class="token operator">=</span> Java<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">"com.whitebird.saveDex"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> classloader <span class="token operator">=</span> saveDex<span class="token punctuation">.</span><span class="token function">getClassloader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"classloader:"</span><span class="token punctuation">,</span>classloader<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">var</span> dexFile <span class="token operator">=</span> Java<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">"dalvik.system.DexFile"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> params <span class="token operator">=</span> <span class="token punctuation">[</span>Java<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">"java.lang.Object"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>class<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> dexFileclszz <span class="token operator">=</span> dexFile<span class="token punctuation">.</span>class<span class="token punctuation">;</span>
    <span class="token keyword">var</span> saveMethodCode <span class="token operator">=</span> dexFileclszz<span class="token punctuation">.</span><span class="token function">getDeclaredMethod</span><span class="token punctuation">(</span><span class="token string">'saveMethodCode'</span><span class="token punctuation">,</span>params<span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"saveMethodCode: "</span><span class="token punctuation">,</span> saveMethodCode<span class="token punctuation">)</span><span class="token punctuation">;</span>
    saveMethodCode<span class="token punctuation">.</span><span class="token function">setAccessible</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    saveDex<span class="token punctuation">.</span><span class="token function">loadClassAndInvoke</span><span class="token punctuation">(</span>classloader<span class="token punctuation">,</span><span class="token string">'com.xiaojianbang.encrypt.DES'</span><span class="token punctuation">,</span>saveMethodCode<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="17、其他加固形式"><a href="#17、其他加固形式" class="headerlink" title="17、其他加固形式"></a>17、其他加固形式</h2><h3 id="1、VMP"><a href="#1、VMP" class="headerlink" title="1、VMP"></a>1、VMP</h3><p>VMP保护一般针对部分函数，这些函数会被native化</p>
<p>定位解释器是关键，找到映射关系便可恢复</p>
<p>VMP通常共用一个解释器</p>
<p>被VMP保护的函数，通常会注册到同一个地址上，或者函数逻辑相似</p>
<h3 id="2、dex2c"><a href="#2、dex2c" class="headerlink" title="2、dex2c"></a>2、dex2c</h3><p>通过词法分析、语法分析等，进行Java到C的等价转换，彻底还原难度大</p>
<p>会有大量的JNI相关的api调用</p>
<p>dex2c通常注册在不同的地址上，并且函数逻辑不相似</p>
<h3 id="3、多种方式混合加固"><a href="#3、多种方式混合加固" class="headerlink" title="3、多种方式混合加固"></a>3、多种方式混合加固</h3><p>先部分函数VMP加固，再抽取加固，再整体加固</p>
<p>也就会出现别人所说的脱不干净，可能就是某些函数是VMP加固的</p>
<h1 id="三、代码追踪"><a href="#三、代码追踪" class="headerlink" title="三、代码追踪"></a>三、代码追踪</h1><h2 id="1、方法调用流程回顾"><a href="#1、方法调用流程回顾" class="headerlink" title="1、方法调用流程回顾"></a>1、方法调用流程回顾</h2><h3 id="java层直接调用"><a href="#java层直接调用" class="headerlink" title="java层直接调用"></a>java层直接调用</h3><p>method的invoke是一个native函数，我们去安卓源码里看</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/QQ%E6%88%AA%E5%9B%BE20230920143937.png"></p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/QQ%E6%88%AA%E5%9B%BE202130920144454.png"></p>
<p>还得看InvokeMethod</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/QQ%E6%88%AA%E5%9B%BE20230920144739.png"></p>
<p>这里的方法把javaMethod转成了ArtMethod</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/QQ%E6%88%AA%E5%9B%BE202130920145221.png"></p>
<p>往下找到InvokeMethodImpl，传入了artmethod，进去分析</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/QQ%E6%88%AA%E5%9B%BE20230920150054.png"></p>
<p>继续跟进去</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/QQ%E6%88%AA%E5%9B%BE201230920150134.png"></p>
<p>最终就走到了method-&gt;Invoke了</p>
<h3 id="通过jni调用"><a href="#通过jni调用" class="headerlink" title="通过jni调用"></a>通过jni调用</h3><p>通过jni调用其实就是CallVoidMethod</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/QQ%E6%88%AA%E5%9B%BE20230920150407.png"></p>
<p>然后继续跟InvokeVirtualOrInterfaceWithVarArgs</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/QQ%E6%88%AA%E5%9B%BE20230920150517.png"></p>
<p>还是走到了 InvokeWithArgArray，后面的流程就一样了，也是调用method-&gt;Invoke</p>
<h2 id="2、方法的解释执行流程"><a href="#2、方法的解释执行流程" class="headerlink" title="2、方法的解释执行流程"></a>2、方法的解释执行流程</h2><p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/QQ%E6%88%AA%E5%9B%BE20230920155514.png"></p>
<p>首先把函数放入函数栈中，然后判断是否走解释执行，如果是则进入EnterInterpreterFromInvoke，进去分析</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/QQ1%E6%88%AA%E5%9B%BE20230920155657.png"></p>
<p>如果不是native方法，就进行Excute，而Excute是我们整体加固的脱壳点</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/QQ%E6%88%AA%E5%9B%BE20230920160019.png"></p>
<p>我们需要注意下面的代码</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/QQ%E6%88%AA%E5%9B%BE20230920160122.png"></p>
<p>在文件中搜索kMterpImplKind，表示选择解释器</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/QQ%E6%88%AA%E5%9B%BE20230920160204.png"></p>
<p>kMterpImplKind代表汇编实现的解释器，kSwitchImplKind代表C++实现的switch解释器</p>
<p>我们改成走C++的代码，方便我们后续修改代码</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/QQ%E6%88%AA%E5%9B%BE20230920164610.png"></p>
<p>设置好后我们继续往后面分析</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/QQ%E6%88%AA%E5%9B%BE20230920164817.png"></p>
<p>都走的同一个函数</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/QQ%E6%88%AA%E5%9B%BE20230920170327.png"></p>
<p>里面就是执行函数了</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/QQ%E6%88%AA%E5%9B%BE20230920170820.png"></p>
<p>获取dexpc，也就是指向smali指令的地址，然后取出指令，在while循环中进行执行</p>
<h2 id="3、invoke指令的执行流程"><a href="#3、invoke指令的执行流程" class="headerlink" title="3、invoke指令的执行流程"></a>3、invoke指令的执行流程</h2><p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/QQ%E6%88%AA%E5%9B%BE20230920223841.png"></p>
<p>上面过程结束后，对于smali中的函数调用就会调用DoInvoke执行</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/QQ%E6%88%AA%E5%9B%BE210230920215029.png"></p>
<p>当我们走到   invoke-static {v1}, Ljavax&#x2F;crypto&#x2F;Cipher;-&gt;getInstance(Ljava&#x2F;lang&#x2F;String;)Ljavax&#x2F;crypto&#x2F;Cipher;的时候，这个时候shadow_frame是decryptAES的栈帧</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/Q1Q%E6%88%AA%E5%9B%BE20230920224424.png"></p>
<p>此时shadow_frame.GetMethod()就是decryptAES</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/QQ%E6%88%AA%E5%9B%BE2023092021247018.png"></p>
<p>called_method就是在decryptAES里面被调用的函数，因此我们在下面可以打印调用关系</p>
<p>sf_method-&gt;called_method</p>
<p>而且此时我们只能获得sf_method的参数，而不能得到called_method的参数，因为called_method还没有执行，因此还得往后分析</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/QQ%E6%88%AA%E5%9B%BE20230920230326.png"></p>
<p>这里传入了called_method，所以要进去分析</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/xc0230920230430.png"></p>
<p>还得进度DoCallCommon分析</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/QQ%E6%88%AA%E5%9B%BE20230920232724.png"></p>
<p>进行参数赋值和创建一个新的栈帧</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/QQ%E6%88%AA1%E5%9B%BE20230920232913.png"></p>
<p>这时候参数和寄存器已经处理好了，callee_frame是被调用函数的栈帧</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/QQ%E6%88%AA%E5%9B%BE202309202332221.png"></p>
<p>通过判断是否走解释模式，进入ArtInterpreterToInterpreterBridge或者ArtInterpreterToCompiledCodeBridge</p>
<p>又进行Execute执行，属于递归套娃</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/QQ%E6%88%AA%E5%9B%BE20230x920233442.png"></p>
<h2 id="4、强制解释执行原理"><a href="#4、强制解释执行原理" class="headerlink" title="4、强制解释执行原理"></a>4、强制解释执行原理</h2><p>我们上面的分析都走的解释执行，所以解释执行是前提</p>
<p>之前我们分析class_linker的时候，LoadClass会执行LoadMethod和LinkCode，而LinkCode里去判断了是否走解释执行模式</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/QQ%E6%88%AA1%E5%9B%BE20230921000116.png"></p>
<p>ShouldUseInterpreterEntrypoint去申请是否走解释执行模式，所以我们要让这个函数返回true</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/QQ%E6%88%AA%E5%9B%BE20230x921000407.png"></p>
<p>如果是native函数，返回false</p>
<p>如果quickcode是空，返回true</p>
<p>如果InterpreOnly，表示只能解释执行，返回true</p>
<p>看一下InterpreOnly这个函数</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/QQ%E6%88%AA%E5%9B%BE202309210s00557.png"></p>
<p>InterpreOnly返回interpret_only_，interpret_only_由ForceInterpretOnly()赋值，所以我们想让ForceInterpretOnly()执行，所以我们可以在安卓系统中主动调用这个函数</p>
<h2 id="5、追踪Java函数调用关系"><a href="#5、追踪Java函数调用关系" class="headerlink" title="5、追踪Java函数调用关系"></a>5、追踪Java函数调用关系</h2><pre class="line-numbers language-java" data-language="java"><code class="language-java">所在文件：art<span class="token operator">/</span>runtime<span class="token operator">/</span>common_dex_operations<span class="token punctuation">.</span>h  <span class="token class-name">PerformCall</span>函数
    <span class="token comment">// add</span>
    <span class="token class-name">ArtMethod</span><span class="token operator">*</span> callee <span class="token operator">=</span> callee_frame<span class="token operator">-></span><span class="token class-name">GetMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    std<span class="token operator">::</span><span class="token function">ostringstream</span> oss<span class="token punctuation">;</span>
    oss <span class="token operator">&lt;&lt;</span> <span class="token string">"[PerformCall] "</span> <span class="token operator">&lt;&lt;</span> caller_method<span class="token operator">-></span><span class="token class-name">PrettyMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">" --> "</span> <span class="token operator">&lt;&lt;</span> callee<span class="token operator">-></span><span class="token class-name">PrettyMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">strstr</span><span class="token punctuation">(</span>oss<span class="token punctuation">.</span><span class="token function">str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">"PerformCallBefore"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token function">LOG</span><span class="token punctuation">(</span><span class="token constant">ERROR</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> oss<span class="token punctuation">.</span><span class="token function">str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token comment">// add</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>我们先以360加固的app为例，因为它是走在解释执行模式的，用frida去hook strstr的参数</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">Java<span class="token punctuation">.</span><span class="token function">perform</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">var</span> strStr <span class="token operator">=</span> Module<span class="token punctuation">.</span><span class="token function">findExportByName</span><span class="token punctuation">(</span><span class="token string">"libc.so"</span><span class="token punctuation">,</span> <span class="token string">"strstr"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"[*] strstr addr: "</span> <span class="token operator">+</span> strStr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    Interceptor<span class="token punctuation">.</span><span class="token function">attach</span><span class="token punctuation">(</span>strStr<span class="token punctuation">,</span><span class="token punctuation">&#123;</span>
        <span class="token function-variable function">onEnter</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">args</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            <span class="token keyword">var</span> arg0<span class="token operator">=</span> <span class="token function">ptr</span><span class="token punctuation">(</span>args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">readCString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">var</span> arg1<span class="token operator">=</span> <span class="token function">ptr</span><span class="token punctuation">(</span>args<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">readCString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>arg1<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">"PerformCallBefore"</span><span class="token punctuation">)</span><span class="token operator">>=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
                console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"[*] strstr hooked"</span><span class="token operator">+</span>arg0<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>

        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
        <span class="token function-variable function">onLeave</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">retval</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/QQ%E6%88%AA%E5%9B%BE20230921151924.png"></p>
<p>当点击MD5加密后，就打印日志了，输入onClick定位关键代码</p>
<p>但是这里有个native函数，而native函数里的jni函数执行流程并没有打印出来，也就说明jni函数没有走perform流程</p>
<h2 id="6、追踪jni函数调用关系"><a href="#6、追踪jni函数调用关系" class="headerlink" title="6、追踪jni函数调用关系"></a>6、追踪jni函数调用关系</h2><p>JniMethodStart是jni函数调用的最开始执行的方法</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/QQ%E6%88%AA%E5%9B%BE20230921171811.png"></p>
<p>我们注意图中的圈出来的代码</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">ArtMethod</span><span class="token operator">*</span> native_method <span class="token operator">=</span> <span class="token operator">*</span>self<span class="token operator">-></span><span class="token class-name">GetManagedStack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token class-name">GetTopQuickFrame</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>通过self，其实也就是Thread对象，然后调用了GetManagedStack，获取了ManagedStack对象，从里面调用</p>
<p>GetTopQuickFrame拿到了native_method</p>
<p>我们的思路就由此得到，代码如下</p>
<pre class="line-numbers language-JAVA" data-language="JAVA"><code class="language-JAVA">&#x2F;&#x2F; add
ArtMethod* artMethod &#x3D; nullptr;
Thread* self &#x3D; Thread::Current();
const ManagedStack* managedStack &#x3D; self-&gt;GetManagedStack();
if(managedStack !&#x3D; nullptr) &#123;
    ArtMethod** tmpArtMethod &#x3D; managedStack-&gt;GetTopQuickFrame();
    if(tmpArtMethod !&#x3D; nullptr) &#123;
        artMethod &#x3D; *tmpArtMethod;
    &#125;
&#125;
if(artMethod !&#x3D; nullptr) &#123;
    std::ostringstream oss;
    oss &lt;&lt; &quot;[InvokeWithArgArray before] &quot; &lt;&lt; artMethod-&gt;PrettyMethod() &lt;&lt; &quot; --&gt; &quot;&lt;&lt; method-&gt;PrettyMethod();
    if(strstr(oss.str().c_str(),&quot;InvokeWithArgArrayBefore&quot;))&#123;
        LOG(ERROR) &lt;&lt; oss.str();
    &#125;
&#125;
&#x2F;&#x2F; add<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/QQ%E6%88%AA%E5%9B%BE20230921172307.png"></p>
<p>jni函数执行到这时，此时的method其实被调用函数，soa.Self就是Thread*,所以我们可以使用soa.Self()，或者Thread::Current()，而函数调用其实有管理栈的，就是managedStack，如果我们以a-&gt;b-&gt;c为例，c在执行时，我们通过GetTopQuickFrame得到的就是栈顶函数，也就是b，这样我们就得到了调用函数，剩下的就和java函数调用一样进行打印就行了。</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/QQ%E6%88%AA%E5%9B%BE202309211172844.png"></p>
<h3 id="ManagerStack介绍"><a href="#ManagerStack介绍" class="headerlink" title="ManagerStack介绍"></a>ManagerStack介绍</h3><p>ManagerStack是用来表示函数栈的,它有三个成员</p>
<pre class="line-numbers language-JAVA" data-language="JAVA"><code class="language-JAVA">TaggedTopQuickFrame tagged_top_quick_frame_;
ManagedStack* link_;
ShadowFrame* top_shadow_frame_;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>link_可以取出再上一层的ManagerStack</p>
<p>tagged_top_quick_frame_指向Quick Frame Stack的栈顶成员，类型是ArtMethod*,所以tagged_top_quick_frame_是ArtMethod**类型</p>
<p>top_shadow_frame_指向Shadow Frame Stack的栈顶成员，是一个结构体，里面的第一个成员保存函数的栈帧，第二个成员link指向上一个函数的结构体，第三个成员是指向ArtMethod，所以通过shadow_frame的getMethod，可以得到ArtMethod</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/IMG_0145.JPG"></p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/QQ%E6%88%AA%E5%9B%BE20230921175947.png"></p>
<p>测试一下效果</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/QQ%E6%88%AA%E5%9B%BE20230921191644.png"></p>
<p>比之前多了一些输出，说明我们的修改是成功的，jni函数调用输出功能正常</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">Java<span class="token punctuation">.</span><span class="token function">perform</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>

    <span class="token keyword">var</span> strStr <span class="token operator">=</span> Module<span class="token punctuation">.</span><span class="token function">findExportByName</span><span class="token punctuation">(</span><span class="token string">"libc.so"</span><span class="token punctuation">,</span> <span class="token string">"strstr"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"[*] strstr addr: "</span> <span class="token operator">+</span> strStr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    Interceptor<span class="token punctuation">.</span><span class="token function">attach</span><span class="token punctuation">(</span>strStr<span class="token punctuation">,</span><span class="token punctuation">&#123;</span>
        <span class="token function-variable function">onEnter</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">args</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            <span class="token keyword">var</span> arg0<span class="token operator">=</span> <span class="token function">ptr</span><span class="token punctuation">(</span>args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">readCString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">var</span> arg1<span class="token operator">=</span> <span class="token function">ptr</span><span class="token punctuation">(</span>args<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">readCString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>arg1<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">"PerformCallBefore"</span><span class="token punctuation">)</span><span class="token operator">>=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
                console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"[*] PerformCallBefore hooked"</span><span class="token operator">+</span>arg0<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>arg1<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">"InvokeWithArgArrayBefore"</span><span class="token punctuation">)</span><span class="token operator">>=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
                console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"[*] InvokeWithArgArrayBefore hooked"</span><span class="token operator">+</span>arg0<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
        <span class="token function-variable function">onLeave</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">retval</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>

<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="7、强制运行在解释模式下"><a href="#7、强制运行在解释模式下" class="headerlink" title="7、强制运行在解释模式下"></a>7、强制运行在解释模式下</h2><p>   在文件：art&#x2F;runtime&#x2F;interpreter&#x2F;interpreter.cc 增加函数</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">// add</span>
extern <span class="token string">"C"</span> <span class="token keyword">void</span> <span class="token function">forceInterpret</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token class-name">Runtime</span><span class="token operator">*</span> runtime <span class="token operator">=</span> <span class="token class-name">Runtime</span><span class="token operator">::</span><span class="token class-name">Current</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    runtime<span class="token operator">-></span><span class="token class-name">GetInstrumentation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token class-name">ForceInterpretOnly</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">LOG</span><span class="token punctuation">(</span><span class="token constant">WARNING</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"forceInterpret is called"</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token comment">// add</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这个之前说过原理，同时将解释器改为switch</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">hook_strstr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">var</span> strStr <span class="token operator">=</span> Module<span class="token punctuation">.</span><span class="token function">findExportByName</span><span class="token punctuation">(</span><span class="token string">"libc.so"</span><span class="token punctuation">,</span> <span class="token string">"strstr"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"[*] strstr addr: "</span> <span class="token operator">+</span> strStr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    Interceptor<span class="token punctuation">.</span><span class="token function">attach</span><span class="token punctuation">(</span>strStr<span class="token punctuation">,</span><span class="token punctuation">&#123;</span>
        <span class="token function-variable function">onEnter</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">args</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            <span class="token keyword">var</span> arg0<span class="token operator">=</span> <span class="token function">ptr</span><span class="token punctuation">(</span>args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">readCString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">var</span> arg1<span class="token operator">=</span> <span class="token function">ptr</span><span class="token punctuation">(</span>args<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">readCString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>arg1<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">"PerformCallBefore"</span><span class="token punctuation">)</span><span class="token operator">>=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
                console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"[*] PerformCallBefore hooked"</span><span class="token operator">+</span>arg0<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>arg1<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">"InvokeWithArgArrayBefore"</span><span class="token punctuation">)</span><span class="token operator">>=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
                console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"[*] InvokeWithArgArrayBefore hooked"</span><span class="token operator">+</span>arg0<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
        <span class="token function-variable function">onLeave</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">retval</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">function</span> <span class="token function">forceInterpret</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">var</span> artModule <span class="token operator">=</span> Process<span class="token punctuation">.</span><span class="token function">findModuleByName</span><span class="token punctuation">(</span><span class="token string">"libart.so"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> forInterpretAddr <span class="token operator">=</span> artModule<span class="token punctuation">.</span><span class="token function">getExportByName</span><span class="token punctuation">(</span><span class="token string">"forceInterpret"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"forceInterpret address:"</span><span class="token operator">+</span>forceInterpret<span class="token punctuation">)</span><span class="token punctuation">;</span>
    Interceptor<span class="token punctuation">.</span><span class="token function">attach</span><span class="token punctuation">(</span>forInterpretAddr<span class="token punctuation">,</span><span class="token punctuation">&#123;</span>
        <span class="token function-variable function">onEnter</span><span class="token operator">:</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">args</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"onEnter forceInterpret"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token function-variable function">onLeave</span> <span class="token operator">:</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">retval</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"onleave forceInterpret"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
    <span class="token keyword">var</span> forceInterpretFunc <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NativeFunction</span><span class="token punctuation">(</span>forInterpretAddr<span class="token punctuation">,</span><span class="token string">"void"</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">forceInterpretFunc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token function">setImmediate</span><span class="token punctuation">(</span>forceInterpret<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="8、追踪每一条smali指令"><a href="#8、追踪每一条smali指令" class="headerlink" title="8、追踪每一条smali指令"></a>8、追踪每一条smali指令</h2><p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/QQ%E6%88%AA%E5%9B%BE20230922131602.png"></p>
<p>也就是这里，只不过我们没开启。但是有个问题：如果直接开启，每个方法执行都会经过这里，就会导致手机很卡，所以我们需要做过滤</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/QQ%E6%88%AA%E5%9B%BE202309221612236.png"></p>
<p>可以看到可以打印每一条执行的smali代码和寄存器值</p>
<p>先定义一个函数，用来开启smail指令追踪功能</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/QQ%E6%88%AA%E5%9B%BE20230922162421.png"></p>
<pre class="line-numbers language-C" data-language="C"><code class="language-C">&#x2F;&#x2F; add
bool shouldTrace &#x3D; false;
if(strstr(shadow_frame.GetMethod()-&gt;PrettyMethod().c_str(), &quot;ExecuteSwitchImplCppBefore&quot;)) &#123;
    shouldTrace &#x3D; true;
&#125;
&#x2F;&#x2F; add


&#x2F;&#x2F;add
&#x2F;&#x2F;TraceExecution(shadow_frame, inst, dex_pc);
if (shouldTrace) &#123;
    MyTraceExecution(shadow_frame, inst, dex_pc);
&#125;
&#x2F;&#x2F;add<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>MyTraceExecution是我们自己实现的smali代码追踪功能，其实也就是利用了TraceExecution的代码</p>
<p>通过shouldTrace去开启，而shouldTrace是通过if(strstr(shadow_frame.GetMethod()-&gt;PrettyMethod().c_str(), “ExecuteSwitchImplCppBefore”))成立才会赋值为true，我们到时候直接frida去hook strstr，返回1就行了</p>
<pre class="line-numbers language-C" data-language="C"><code class="language-C">static inline void MyTraceExecution(const ShadowFrame&amp; shadow_frame, const Instruction* inst,const uint32_t dex_pc)REQUIRES_SHARED(Locks::mutator_lock_) &#123;
        std::ostringstream oss;
        oss &lt;&lt;&quot;[FuncName:]&quot;&lt;&lt; shadow_frame.GetMethod()-&gt;PrettyMethod()&lt;&lt;&quot;\t\t&quot;
            &lt;&lt; android::base::StringPrintf(&quot;[Address] 0x%x: &quot;, dex_pc)
            &lt;&lt; inst-&gt;DumpString(shadow_frame.GetMethod()-&gt;GetDexFile()) &lt;&lt; &quot;\t [Regs]&quot;;
        for (uint32_t i &#x3D; 0; i &lt; shadow_frame.NumberOfVRegs(); ++i) &#123;
            uint32_t raw_value &#x3D; shadow_frame.GetVReg(i);
            ObjPtr&lt;mirror::Object&gt; ref_value &#x3D; shadow_frame.GetVRegReference(i);
            oss &lt;&lt; android::base::StringPrintf(&quot; vreg%u&#x3D;0x%08X&quot;, i, raw_value);
            if (ref_value !&#x3D; nullptr) &#123;
                if (ref_value-&gt;GetClass()-&gt;IsStringClass() &amp;&amp;
                    !ref_value-&gt;AsString()-&gt;IsValueNull()) &#123;
                    oss &lt;&lt; &quot;&#x2F;java.lang.String \&quot;&quot; &lt;&lt; ref_value-&gt;AsString()-&gt;ToModifiedUtf8() &lt;&lt; &quot;\&quot;&quot;;
                &#125; else &#123;
                    oss &lt;&lt; &quot;&#x2F;&quot; &lt;&lt; ref_value-&gt;PrettyTypeOf();
                &#125;
            &#125;
        &#125;
    if(strstr(oss.str().c_str(), &quot;MyTraceExecutionBefore&quot;)) &#123;
        LOG(ERROR)&lt;&lt;oss.str().c_str();
    &#125;
    &#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>刷机就行了，frida代码</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">hook_strstr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">var</span> strStr <span class="token operator">=</span> Module<span class="token punctuation">.</span><span class="token function">findExportByName</span><span class="token punctuation">(</span><span class="token string">"libc.so"</span><span class="token punctuation">,</span> <span class="token string">"strstr"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"[*] strstr addr: "</span> <span class="token operator">+</span> strStr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    Interceptor<span class="token punctuation">.</span><span class="token function">attach</span><span class="token punctuation">(</span>strStr<span class="token punctuation">,</span><span class="token punctuation">&#123;</span>
        <span class="token function-variable function">onEnter</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">args</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>arg0<span class="token operator">=</span> <span class="token function">ptr</span><span class="token punctuation">(</span>args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">readCString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>arg1<span class="token operator">=</span> <span class="token function">ptr</span><span class="token punctuation">(</span>args<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">readCString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>arg1<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">"MyTraceExecutionBefore"</span><span class="token punctuation">)</span><span class="token operator">>=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
                console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"[*] MyTraceExecutionBefore hooked"</span><span class="token operator">+</span><span class="token keyword">this</span><span class="token punctuation">.</span>arg0<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
        <span class="token function-variable function">onLeave</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">retval</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>arg1<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">"ExecuteSwitchImplCppBefore"</span><span class="token punctuation">)</span><span class="token operator">>=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
               retval<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>建议APP启动后，再使用这个函数，否则APP会非常卡</p>
<h1 id="四、监控网络访问"><a href="#四、监控网络访问" class="headerlink" title="四、监控网络访问"></a>四、监控网络访问</h1><h2 id="1、常见的抓包方式"><a href="#1、常见的抓包方式" class="headerlink" title="1、常见的抓包方式"></a>1、常见的抓包方式</h2><h3 id="1-1、使用抓包工具"><a href="#1-1、使用抓包工具" class="headerlink" title="1.1、使用抓包工具"></a>1.1、使用抓包工具</h3><p>绕过抓包相关检测，让抓包工具能够正常抓包</p>
<p>好处是可以更舒服、更全的看到数据包</p>
<p>缺点是可能需要逆向寻找检测点，不同框架有不同的检测证书方法</p>
<h3 id="1-2、Hook抓包"><a href="#1-2、Hook抓包" class="headerlink" title="1.2、Hook抓包"></a>1.2、Hook抓包</h3><p>通过Hook直接获取通信过程中的明文数据</p>
<p>通信过程中的数据会一步步交给系统函数来进行加密，Java层和JNI层</p>
<p>比如libssl.so，可以Hook固定的系统相关函数</p>
<p>使用自定义ssl进行加密，需要逆向找到相关加密函数来Hook</p>
<h3 id="1-3、监控网络访问"><a href="#1-3、监控网络访问" class="headerlink" title="1.3、监控网络访问"></a>1.3、监控网络访问</h3><p>与Hook抓包差不多，区别是通过修改系统代码实现</p>
<h2 id="2、okhttp3源码分析"><a href="#2、okhttp3源码分析" class="headerlink" title="2、okhttp3源码分析"></a>2、okhttp3源码分析</h2><p>doGet</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>okhttp3</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">androidx<span class="token punctuation">.</span>appcompat<span class="token punctuation">.</span>app<span class="token punctuation">.</span></span><span class="token class-name">AppCompatActivity</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">android<span class="token punctuation">.</span>os<span class="token punctuation">.</span></span><span class="token class-name">Bundle</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">android<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Log</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IOException</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">okhttp3<span class="token punctuation">.</span></span><span class="token class-name">OkHttpClient</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">okhttp3<span class="token punctuation">.</span></span><span class="token class-name">Request</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">okhttp3<span class="token punctuation">.</span></span><span class="token class-name">Response</span></span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MainActivity</span> <span class="token keyword">extends</span> <span class="token class-name">AppCompatActivity</span> <span class="token punctuation">&#123;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">onCreate</span><span class="token punctuation">(</span><span class="token class-name">Bundle</span> savedInstanceState<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onCreate</span><span class="token punctuation">(</span>savedInstanceState<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">setContentView</span><span class="token punctuation">(</span><span class="token class-name">R</span><span class="token punctuation">.</span>layout<span class="token punctuation">.</span>activity_main<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">OkHttpClient</span> client <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OkHttpClient<span class="token punctuation">.</span>Builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
             <span class="token class-name">Request</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Request<span class="token punctuation">.</span>Builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">url</span><span class="token punctuation">(</span><span class="token string">"https://www.baidu.com/"</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">addHeader</span><span class="token punctuation">(</span>
                        <span class="token string">"User-Agent"</span><span class="token punctuation">,</span>
                        <span class="token string">"Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/55.0.2883.87 UBrowser/6.2.4098.3 Safari/537.36"</span>
                <span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">Response</span> response <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">newCall</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span><span class="token string">"whitebird"</span><span class="token punctuation">,</span> <span class="token string">"response: "</span> <span class="token operator">+</span> response<span class="token punctuation">.</span><span class="token function">body</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>在xml中记得授予权限</p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>uses-permission</span> <span class="token attr-name"><span class="token namespace">android:</span>name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>android.permission.INTERNET<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>得到的结果</p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup">2023-09-22 18:02:30.711  7599-7633  whitebird               com.example.okhttp3                  D  response: <span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">></span></span><span class="token comment">&lt;!--STATUS OK--></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">http-equiv</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Content-Type<span class="token punctuation">"</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>text/html;charset=utf-8<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">http-equiv</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>X-UA-Compatible<span class="token punctuation">"</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>IE=edge,chrome=1<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>always<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>referrer<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>theme-color<span class="token punctuation">"</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>#ffffff<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>description<span class="token punctuation">"</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>全球领先的中文搜索引擎、致力于让网民更便捷地获取信息，找到所求。百度超过千亿的中文网页数据库，可以瞬间找到相关的搜索结果。<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>shortcut icon<span class="token punctuation">"</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>https://www.baidu.com/favicon.ico<span class="token punctuation">"</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>image/x-icon<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>search<span class="token punctuation">"</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>application/opensearchdescription+xml<span class="token punctuation">"</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/content-search.xml<span class="token punctuation">"</span></span> <span class="token attr-name">title</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>百度搜索<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>icon<span class="token punctuation">"</span></span> <span class="token attr-name">sizes</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>any<span class="token punctuation">"</span></span> <span class="token attr-name">mask</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>https://www.baidu.com/favicon.ico<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>dns-prefetch<span class="token punctuation">"</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>//dss0.bdstatic.com<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>dns-prefetch<span class="token punctuation">"</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>//dss1.bdstatic.com<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>dns-prefetch<span class="token punctuation">"</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>//ss1.bdstatic.com<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>dns-prefetch<span class="token punctuation">"</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>//sp0.baidu.com<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>dns-prefetch<span class="token punctuation">"</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>//sp1.baidu.com<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>dns-prefetch<span class="token punctuation">"</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>//sp2.baidu.com<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>dns-prefetch<span class="token punctuation">"</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>//pss.bdstatic.com<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>apple-touch-icon-precomposed<span class="token punctuation">"</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>https://psstatic.cdn.bcebos.com/video/wiseindex/aa6eef91f8b5b1a33b454c401_1660835115000.png<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">></span></span>百度一下，你就知道<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span> <span class="token attr-name">index</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>newi<span class="token punctuation">"</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>text/css<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>#form .bdsug&#123;top:39px&#125;.bdsug&#123;display:none;position:absolute;width:535px;background:#fff;border:1px solid #ccc!important;_overflow:hidden;box-shadow:1px 1px 3px #ededed;-webkit-box-shadow:1px 1px 3px #ededed;-moz-box-shadow:1px 1px 3px #ededed;-o-box-shadow:1px 1px 3px #ededed&#125;.bdsug li&#123;width:519px;color:#000;font:14px arial;line-height:25px;padding:0 8px;position:relative;cursor:default&#125;.bdsug li.bdsug-s&#123;background:#f0f0f0&#125;.bdsug-store span,.bdsug-store b&#123;color:#7A77C8&#125;.bdsug-store-del&#123;font-size:12px;color:#666;text-decoration:underline;position:absolute;right:8px;top:0;cursor:pointer;display:none&#125;.bdsug-s .bdsug-store-del&#123;display:inline-block&#125;.bdsug-ala&#123;display:inline-block;border-bottom:1px solid #e6e6e6&#125;.bdsug-ala h3&#123;line-height:14px;background:url(//www.baidu.com/img/sug_bd.png?v=09816787.png) no-repeat left center;margin:6px 0 4px;font-size:12px;font-weight:400;color:#7B7B7B;padding-left:20px&#125;.bdsug-ala p&#123;font-size:14px;font-weight:700;padding-left:20px&#125;#m .bdsug .bdsug-direct p&#123;color:#00c;font-weight:700;line-height:34px;padding:0 8px;margin-top:0;cursor:pointer;white-space:nowrap;overflow:hidden&#125;#m .bdsug .bdsug-direct p img&#123;width:16px;height:16px;margin:7px 6px 9px 0;vertical-align:middle&#125;#m .bdsug .bdsug-direct p span&#123;margin-left:8px&#125;#form .bdsug .bdsug-direct&#123;width:auto;padding:0;border-bottom:1px solid #f1f1f1&#125;#form .bdsug .bdsug-direct p i&#123;font-size:12px;line-height:100%;font-style:normal;font-weight:400;color:#fff;background-color:#2b99ff;display:inline;text-align:center;padding:1px 5px;*padding:2px 5px 0;margin-left:8px;overflow:hidden&#125;.bdsug .bdsug-pcDirect&#123;color:#000;font-size:14px;line-height:30px;height:30px;background-color:#f8f8f8&#125;.bdsug .bdsug-pc-direct-tip&#123;position:absolute;right:15px;top:8px;width:55px;height:15px;display:block;background:url(https://pss.bdstatic.com/r/www/cache/static/protocol/https/global/img/pc_direct_42d6311.png) no-repeat 0 0&#125;.bdsug li.bdsug-pcDirect-s&#123;background-color:#f0f0f0&#125;.bdsug .bdsug-pcDirect-is&#123;color:#000;font-size:14px;line-height:22px;background-color:#f5f5f5&#125;.bdsug .bdsug-pc-direct-tip-is&#123;position:absolute;right:15px;top:3px;width:55px;height:15px;display:block;background:url(https://pss.bdstatic.com/r/www/cache/static/protocol/https/global/img/pc_direct_42d6311.png) no-repeat 0 0&#125;.bdsug li.bdsug-pcDirect-is-s&#123;background-color:#f0f0f0&#125;.bdsug .bdsug-pcDirect-s .bdsug-pc-direct-tip,.bdsug .bdsug-pcDirect-is-s .bdsug-pc-direct-tip-is&#123;background-position:0 -15px&#125;.bdsug .bdsug-newicon&#123;color:#929292;opacity:.7;font-size:12px;display:inline-block;line-height:22px;letter-spacing:2px&#125;.bdsug .bdsug-s .bdsug-newicon&#123;opacity:1&#125;.bdsug .bdsug-newicon i&#123;letter-spacing:0;font-style:normal&#125;.bdsug .bdsug-feedback-wrap&#123;display:none&#125;.tog<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>doPost</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>okhttp3</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">androidx<span class="token punctuation">.</span>appcompat<span class="token punctuation">.</span>app<span class="token punctuation">.</span></span><span class="token class-name">AppCompatActivity</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">android<span class="token punctuation">.</span>os<span class="token punctuation">.</span></span><span class="token class-name">Bundle</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">android<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Log</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IOException</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">okhttp3<span class="token punctuation">.</span></span><span class="token class-name">FormBody</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">okhttp3<span class="token punctuation">.</span></span><span class="token class-name">OkHttpClient</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">okhttp3<span class="token punctuation">.</span></span><span class="token class-name">Request</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">okhttp3<span class="token punctuation">.</span></span><span class="token class-name">Response</span></span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MainActivity</span> <span class="token keyword">extends</span> <span class="token class-name">AppCompatActivity</span> <span class="token punctuation">&#123;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">onCreate</span><span class="token punctuation">(</span><span class="token class-name">Bundle</span> savedInstanceState<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onCreate</span><span class="token punctuation">(</span>savedInstanceState<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">setContentView</span><span class="token punctuation">(</span><span class="token class-name">R</span><span class="token punctuation">.</span>layout<span class="token punctuation">.</span>activity_main<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">OkHttpClient</span> client <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OkHttpClient<span class="token punctuation">.</span>Builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
                <span class="token class-name">FormBody</span> formBody <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FormBody<span class="token punctuation">.</span>Builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"user"</span><span class="token punctuation">,</span> <span class="token string">"whitebird"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"pass"</span><span class="token punctuation">,</span> <span class="token string">"123456"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
             <span class="token class-name">Request</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Request<span class="token punctuation">.</span>Builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">url</span><span class="token punctuation">(</span><span class="token string">"https://www.baidu.com/"</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span>formBody<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">addHeader</span><span class="token punctuation">(</span>
                        <span class="token string">"User-Agent"</span><span class="token punctuation">,</span>
                        <span class="token string">"Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/55.0.2883.87 UBrowser/6.2.4098.3 Safari/537.36"</span>
                <span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">Response</span> response <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">newCall</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span><span class="token string">"whitebird"</span><span class="token punctuation">,</span> <span class="token string">"response: "</span> <span class="token operator">+</span> response<span class="token punctuation">.</span><span class="token function">body</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>通过调试源码发现</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/QQ%E6%88%AA%E5%9B%BE20230923113618.png"></p>
<p>此时的socket是java.net.Socket，里面还没有装数据</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/QQ%E6%88%AA%E5%9B%BE20230923115126.png"></p>
<p>通过Socket对象的getOutputStream()方法可以获取到一个用于向服务器发送数据的OutputStream对象。这个方法返回的是一个字节输出流。</p>
<p>okhttp的三个检测点</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/QQ%E6%88%AA%E5%9B%BE20230923115708.png"></p>
<p>检测tls，检测hostname，检测证书</p>
<p>往下继续看</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/QQ%E6%88%AA%E5%9B%BE20230923115928.png"></p>
<p>这里的socket是我们需要的，里面有数据，类型class com.android.org.conscrypt.Java8FileDescriptorSocket</p>
<p>我们现在去安卓源码网站分析Java8FileDescriptorSocket的getOutputStream</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/QQ%E6%88%AA%E5%9B%BE20230923120353.png"></p>
<p>没有搜到，去父类里面看看</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/QQ%E6%88%AA%E5%9B%BE20230923122331.png"></p>
<p>继续关注SSLOutputStream</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/QQ%E6%88%AA%E5%9B%BE20230923122601.png"></p>
<p>是一个内部类，我们的数据很有可能通过这里的write写入</p>
<p>继续往下分析</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/QQ%E6%88%AA%E5%9B%BE20230923122757.png"></p>
<p>这里的ssl是一个NativeSsl</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/QQ%E6%88%AA%E5%9B%BE20230923122818.png"></p>
<p>在里面找到write方法</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/QQ%E6%88%AA%E5%9B%BE20230923122943.png"></p>
<p>这里需要关注</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">NativeCrypto<span class="token punctuation">.</span>SSL_write</span><span class="token punctuation">(</span>ssl<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">,</span> fd<span class="token punctuation">,</span> handshakeCallbacks<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> offset<span class="token punctuation">,</span> len<span class="token punctuation">,</span> timeoutMillis<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/QQ%E6%88%AA%E5%9B%BE20230923123218.png"></p>
<p>是一个native函数</p>
<p>所以我们只要hook这里的write就能获得提交的数据，同理hook read就能获得返回的响应数据</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/QQ%E6%88%AA%E5%9B%BE20230923123426.png"></p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/QQ%E6%88%AA%E5%9B%BE201230923125302.png"></p>
<p>先获取了数据长度，然后把java字节数组转换成了c中的数组中，判断发生数据的大小，如果小于1024(1M)就直接调用sslWrite，否则就循环发送数据，还是走sslWrite，所以只需要分析sslWrite就行了</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/QQ%E6%88%AA%E5%9B%BE20230923125632.png"></p>
<p>里面又调用了SSL_write(ssl, buf, len);</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/QQ%E6%88%AA%E5%9B%BE20230923130211.png"></p>
<p>boringssl是由谷歌从openssl改过来的，ssl_lib.cc编译以后libssl.so中</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/111223312sss.png"></p>
<p>这两个就是r0capture的hook点</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/QQ%E6%88%AA%E5%9B%BE20230923134442.png"></p>
<p>直接点击write_app_data搜索不到，需要前面加上版本ssl3_write_app_data</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/QQ%E6%88%AA%E5%9B%BE20230923134805.png"></p>
<p>in就是之前的buf，传入了do_ssl3_write</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/QQ%E6%88%AA%E5%9B%BE20230923160051.png"></p>
<p>这里后面就开始进行数据加密了</p>
<p>后面我们不怎么关注了，最后会走到sock_write</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/QQ%E6%88%AA%E5%9B%BE20230923164858.png"></p>
<p>里面用的send和write都是libc里面的函数了</p>
<p>最终选择的hook点</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">libssl<span class="token punctuation">.</span>so中<span class="token comment">//明文状态</span>
<span class="token keyword">int</span> <span class="token function">SSL_write</span><span class="token punctuation">(</span>SSL <span class="token operator">*</span>ssl<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span>buf<span class="token punctuation">,</span> <span class="token keyword">int</span> num<span class="token punctuation">)</span> <span class="token comment">//提交</span>
<span class="token keyword">int</span> <span class="token function">SSL_read</span><span class="token punctuation">(</span>SSL <span class="token operator">*</span>ssl<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>buf<span class="token punctuation">,</span> <span class="token keyword">int</span> num<span class="token punctuation">)</span><span class="token comment">//返回</span>
libc<span class="token punctuation">.</span>so中 <span class="token comment">//考虑到有些app会绕过正常流程，直接使用write和read</span>
<span class="token class-name">ssize_t</span> <span class="token function">write</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span> buf<span class="token punctuation">,</span> <span class="token class-name">size_t</span> count<span class="token punctuation">)</span>
<span class="token class-name">ssize_t</span> <span class="token function">read</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span> buf<span class="token punctuation">,</span> <span class="token class-name">size_t</span> count<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>代码添加位置，注意还得添加头文件</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/1221SADSA.png"></p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">//add</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;ctype.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;sys/stat.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;unistd.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;fcntl.h></span></span>
<span class="token comment">//add</span>

<span class="token operator">/</span>add
<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">getuid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">></span><span class="token number">10000</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>SSL_LOG_PATH <span class="token operator">==</span> nullptr<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            <span class="token keyword">char</span> szCmdline<span class="token punctuation">[</span><span class="token number">64</span><span class="token punctuation">]</span><span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token number">0</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
            <span class="token keyword">char</span> szProcName<span class="token punctuation">[</span><span class="token number">256</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token number">0</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> procid <span class="token operator">=</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">sprintf</span><span class="token punctuation">(</span>szCmdline<span class="token punctuation">,</span><span class="token string">"/proc/%d/cmdline"</span><span class="token punctuation">,</span> procid<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> fcmdline <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span>szCmdline<span class="token punctuation">,</span> O_RDONLY<span class="token operator">|</span>O_CREAT<span class="token punctuation">,</span><span class="token number">0644</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>fcmdline <span class="token operator">></span><span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token punctuation">&#123;</span>
                <span class="token keyword">int</span> result<span class="token operator">=</span><span class="token function">read</span><span class="token punctuation">(</span>fcmdline<span class="token punctuation">,</span> szProcName<span class="token punctuation">,</span><span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                 <span class="token keyword">if</span><span class="token punctuation">(</span>result<span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span>
                <span class="token punctuation">&#123;</span>

                 <span class="token function">close</span><span class="token punctuation">(</span>fcmdline<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token function">close</span><span class="token punctuation">(</span>fcmdline<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>szProcName<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            <span class="token punctuation">&#123;</span>
            SSL_LOG_PATH<span class="token operator">=</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">memset</span><span class="token punctuation">(</span>SSL_LOG_PATH<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">sprintf</span><span class="token punctuation">(</span>SSL_LOG_PATH<span class="token punctuation">,</span><span class="token string">"/data/data/%s/whitebird1"</span><span class="token punctuation">,</span>szProcName<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">mkdir</span><span class="token punctuation">(</span>SSL_LOG_PATH<span class="token punctuation">,</span><span class="token number">0777</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token function">memset</span><span class="token punctuation">(</span>SSL_LOG_PATH<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">sprintf</span><span class="token punctuation">(</span>SSL_LOG_PATH<span class="token punctuation">,</span><span class="token string">"/data/data/%s/whitebird1/SSL_LOG.txt"</span><span class="token punctuation">,</span>szProcName<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>

        <span class="token punctuation">&#125;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>SSL_LOG_PATH<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">int</span> fp<span class="token operator">=</span><span class="token function">open</span><span class="token punctuation">(</span>SSL_LOG_PATH<span class="token punctuation">,</span>O_CREAT<span class="token operator">|</span>O_APPEND<span class="token operator">|</span>O_RDWR<span class="token punctuation">,</span><span class="token number">0666</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>fp<span class="token operator">></span><span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
                <span class="token keyword">char</span> <span class="token operator">*</span>retval<span class="token operator">=</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span> <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token punctuation">)</span><span class="token operator">*</span>num<span class="token operator">*</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">hexdump</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span>num<span class="token punctuation">,</span><span class="token operator">&amp;</span>retval<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">int</span> result<span class="token operator">=</span><span class="token function">write</span><span class="token punctuation">(</span>fp<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span>retval<span class="token punctuation">,</span><span class="token function">strlen</span><span class="token punctuation">(</span>retval<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span>result<span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span>
                <span class="token punctuation">&#123;</span>
                    <span class="token function">close</span><span class="token punctuation">(</span>fp<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
                result <span class="token operator">=</span> <span class="token function">write</span><span class="token punctuation">(</span>fp<span class="token punctuation">,</span><span class="token string">"\n================================================================\n"</span><span class="token punctuation">,</span><span class="token number">66</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span>result<span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span>
                <span class="token punctuation">&#123;</span>
                    <span class="token function">close</span><span class="token punctuation">(</span>fp<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
                <span class="token function">fsync</span><span class="token punctuation">(</span>fp<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">close</span><span class="token punctuation">(</span>fp<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span>retval<span class="token operator">!=</span>nullptr<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
                    <span class="token function">free</span><span class="token punctuation">(</span>retval<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
                <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token comment">//add</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>在函数SSL_write外面，我们定义了hexdump用于打印使用，和定义了一个变量SSL_LOG_PATH</p>
<pre class="line-numbers language-none"><code class="language-none">&#x2F;&#x2F; add
char*SSL_LOG_PATH &#x3D; nullptr;

void hexdump(const void *pdata, int len, char** result) &#123;
    int i, j, k, l;
    const char *data &#x3D; (const char*)pdata;
    char buf[256], str[64], t[] &#x3D; &quot;0123456789ABCDEF&quot;;
    for (i &#x3D; j &#x3D; k &#x3D; 0; i &lt; len; i++) &#123;
        if (0 &#x3D;&#x3D; i % 16)
            j +&#x3D; sprintf(buf + j, &quot;%04xh: &quot;, i);
        buf[j++] &#x3D; t[0x0f &amp; (data[i] &gt;&gt; 4)];
        buf[j++] &#x3D; t[0x0f &amp; data[i]];
        buf[j++] &#x3D; &#39; &#39;;
        str[k++] &#x3D; isprint(data[i]) ? data[i] : &#39;.&#39;;
        if (0 &#x3D;&#x3D; (i + 1) % 16) &#123;
            str[k] &#x3D; 0;
            j +&#x3D; sprintf(buf + j, &quot;; %s\n&quot;, str);
            &#x2F;&#x2F;printf(&quot;%s&quot;, buf);
            strcat(*result, buf);
            j &#x3D; k &#x3D; buf[0] &#x3D; str[0] &#x3D; 0;
        &#125;
    &#125;
    str[k] &#x3D; 0;
    if (k) &#123;
        for (l &#x3D; 0; l &lt; 3 * (16 - k); l++)
            buf[j++] &#x3D; &#39; &#39;;
        j +&#x3D; sprintf(buf + j, &quot;; %s\n&quot;, str);
    &#125;
    if (buf[0]) &#x2F;&#x2F;printf(&quot;%s&quot;, buf);
        strcat(*result, buf);;
&#125;

&#x2F;&#x2F;add<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/QQ%E6%88%AA%E5%9B%BE20233091231200427.png"></p>
<p>编译刷机后，修改手机时间和连接网络，成功抓取请求</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/QQ%E6%88%AA%E5%9B%BE20230923200047.png"></p>
<h1 id="五、定制内核"><a href="#五、定制内核" class="headerlink" title="五、定制内核"></a>五、定制内核</h1><h2 id="1、安卓系统组成结构"><a href="#1、安卓系统组成结构" class="headerlink" title="1、安卓系统组成结构"></a>1、安卓系统组成结构</h2><p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/20230923233321.png"></p>
<h2 id="2、什么是Linux系统调用-syscall"><a href="#2、什么是Linux系统调用-syscall" class="headerlink" title="2、什么是Linux系统调用(syscall)"></a>2、什么是Linux系统调用(syscall)</h2><p>app的相关操作，最终都会经过安卓系统函数</p>
<p>安卓系统函数，最终通过Linux系统调用号，交给内核处理</p>
<p>系统调用号与对应的函数</p>
<p><a target="_blank" rel="noopener" href="https://chromium.googlesource.com/chromiumos/docs/+/master/constants/syscalls.md">https://chromium.googlesource.com/chromiumos/docs/+/master/constants/syscalls.md</a></p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/QQ%E6%88%AA%E5%9B%BE20230923233456.png"></p>
<h2 id="3、如何hook-Linux内核级别的函数"><a href="#3、如何hook-Linux内核级别的函数" class="headerlink" title="3、如何hook Linux内核级别的函数"></a>3、如何hook Linux内核级别的函数</h2><p>安卓分为用户空间和内核空间</p>
<p>普通的Hook框架是无法到达内核空间的</p>
<p>通过可加载内核模块，或者直接修改内核代码，可以实现syscall hook</p>
<h2 id="4、逆向分析系统调用"><a href="#4、逆向分析系统调用" class="headerlink" title="4、逆向分析系统调用"></a>4、逆向分析系统调用</h2><p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/QQ%E6%88%AA%E5%9B%BE20230923233804.png">****</p>
<p>代码很简单，看一下汇编</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/QQ%E6%88%AA%E5%9B%BE2081230923233810.png"></p>
<p>把系统调用号赋给了x8，然后使用svc 0指令的软中断进入内核模式</p>
<h2 id="5、获取源码编译内核"><a href="#5、获取源码编译内核" class="headerlink" title="5、获取源码编译内核"></a>5、获取源码编译内核</h2><p>参考了文章<a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/8F2uNlvAp56e77l8HSemoA">https://mp.weixin.qq.com/s/8F2uNlvAp56e77l8HSemoA</a></p>
<p>现在谷歌修改了策略，取消了通过build.sh去编译内核，改成了bazel，但是我找人要了一份build目录，直接对源码目录中的build进行替换就行了</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/QQ%E6%88%AA%E5%9B%BE2023092171619119.png"></p>
<p>已经刷好了，手机也可以正常运行</p>
<h2 id="6、修改内核源码，实现SVC监控"><a href="#6、修改内核源码，实现SVC监控" class="headerlink" title="6、修改内核源码，实现SVC监控"></a>6、修改内核源码，实现SVC监控</h2><p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/QQ%E6%88%AA%E5%9B%BE2023011927215432.png"></p>
<p>我在do_sys_open里加了如下代码，在执行open打开文件时就会打印要打开的文件名</p>
<pre class="line-numbers language-C" data-language="C"><code class="language-C">&#x2F;&#x2F; add
const struct cred *cred &#x3D; current_cred();
kuid_t uid &#x3D; cred-&gt;uid;
int pid &#x3D; current-&gt;pid;
int myuid &#x3D; uid.val;
if(myuid &gt; 10000) &#123;
    char bufname[256]&#x3D;&#123;0&#125;;
    strncpy_from_user(bufname, filename, 255);
    printk(&quot;openat pathname:%s  uid:%d pid:%d\n&quot;, bufname, myuid, pid);
&#125;
&#x2F;&#x2F; add
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>重新编译内核，替换内核，编译aosp源码，然后刷机</p>
<p>adb shell进入手机终端</p>
<p>su获取root权限</p>
<p>demsg监控内核打印</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/QQ%E6%88%AA%E5%9B%BE20230927215634.png"></p>
<p>已经成功打印了</p>

      
       <hr><span style="font-style: italic;color: gray;"> 转载请注明来源，欢迎对文章中的引用来源进行考证，欢迎指出任何有错误或不够清晰的表达。可以在下面评论区评论，也可以邮件至 767778848@qq.com </span>
    </div>
</article>





    <div id="comments"></div>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css">

<script type="text/javascript">
    $.getScript('/js/gitalk.js', function () {
        var gitalk = new Gitalk({
            clientID: '6c49373fe3729f3c2b02',
            clientSecret: '4b38338216282f43430b6118f27ae24e4732ecec',
            repo: 'Whitebird0.github.io',
            owner: 'Whitebird0',
            admin: ['Whitebird0'],
            id: decodeURI(location.pathname),
            distractionFreeMode: 'true',
            language: 'zh-CN',
            perPage: parseInt('10',10)
        })
        gitalk.render('comments')
    })
</script>




    




    </div>
    <div class="copyright">
        <p class="footer-entry">
    ©2020-2022 Whitebird
</p>
<p class="footer-entry">Built with <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/yelog/hexo-theme-3-hexo" target="_blank">3-hexo</a> theme</p>

    </div>
    <div class="full-toc">
        <button class="full" data-title="切换全屏 快捷键 s"><span class="min "></span></button>
<a class="" id="rocket" ></a>

    </div>
</div>

</body>
<script src="/js/jquery.pjax.js?v=1.1.0" ></script>

<script src="/js/script.js?v=1.1.0" ></script>
<script>
    var img_resize = 'default';
    function initArticle() {
        /*渲染对应的表格样式*/
        
            $("#post .pjax table").addClass("green_title");
        

        /*渲染打赏样式*/
        

        /*高亮代码块行号*/
        

        /*访问数量*/
        
        $.getScript("//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js");
        

        /*代码高亮，行号对齐*/
        $('.pre-numbering').css('line-height',$('.has-numbering').css('line-height'));

        
        
    }

    /*打赏页面隐藏与展示*/
    

</script>

<!--加入行号的高亮代码块样式-->

<!--自定义样式设置-->
<style>
    
    
    .nav {
        width: 542px;
    }
    .nav.fullscreen {
        margin-left: -542px;
    }
    .nav-left {
        width: 120px;
    }
    
    
    @media screen and (max-width: 1468px) {
        .nav {
            width: 492px;
        }
        .nav.fullscreen {
            margin-left: -492px;
        }
        .nav-left {
            width: 100px;
        }
    }
    
    
    @media screen and (max-width: 1024px) {
        .nav {
            width: 492px;
            margin-left: -492px
        }
        .nav.fullscreen {
            margin-left: 0;
        }
    }
    
    @media screen and (max-width: 426px) {
        .nav {
            width: 100%;
        }
        .nav-left {
            width: 100%;
        }
    }
    
    
    .nav-right .title-list nav a .post-title, .nav-right .title-list #local-search-result a .post-title {
        color: #383636;
    }
    
    
    .nav-right .title-list nav a .post-date, .nav-right .title-list #local-search-result a .post-date {
        color: #5e5e5f;
    }
    
    
    .nav-right nav a.hover, #local-search-result a.hover{
        background-color: #e2e0e0;
    }
    
    

    /*列表样式*/
    

    /* 背景图样式 */
    
    


    /*引用块样式*/
    

    /*文章列表背景图*/
    

    
</style>







</html>
