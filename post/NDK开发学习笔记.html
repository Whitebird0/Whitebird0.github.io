<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Android开发学习笔记——NDK开发 | Whitebird&#39;s Home</title>
  <meta name="keywords" content=" Android ">
  <meta name="description" content="Android开发学习笔记——NDK开发 | Whitebird&#39;s Home">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta property="og:type" content="website">
<meta property="og:title" content="about">
<meta property="og:url" content="https://whitebird0.github.io/about/index.html">
<meta property="og:site_name" content="Whitebird&#39;s Home">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2022-07-09T11:26:44.000Z">
<meta property="article:modified_time" content="2022-07-09T11:26:44.827Z">
<meta property="article:author" content="Whitebird">
<meta name="twitter:card" content="summary">


<link rel="icon" href="/img/avatar.jpg">

<link href="/css/style.css?v=1.1.0" rel="stylesheet">

<link href="/css/hl_theme/github.css?v=1.1.0" rel="stylesheet">

<link href="//cdn.jsdelivr.net/npm/animate.css@4.1.0/animate.min.css" rel="stylesheet">

<script src="//cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js"></script>
<script src="/js/titleTip.js?v=1.1.0" ></script>

<script src="//cdn.jsdelivr.net/npm/highlightjs@9.16.2/highlight.pack.min.js"></script>
<script>
    hljs.initHighlightingOnLoad();
</script>

<script src="//cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.js"></script>



<script src="//cdn.jsdelivr.net/npm/jquery.cookie@1.4.1/jquery.cookie.min.js" ></script>

<script src="/js/iconfont.js?v=1.1.0" ></script>

<meta name="generator" content="Hexo 5.4.2"></head>
<div style="display: none">
  <input class="theme_disqus_on" value="false">
  <input class="theme_preload_comment" value="">
  <input class="theme_blog_path" value="">
  <input id="theme_shortcut" value="true" />
  <input id="theme_highlight_on" value="true" />
  <input id="theme_code_copy" value="true" />
</div>



<body>
<aside class="nav">
    <div class="nav-left">
        <a href="/"
   class="avatar_target">
    <img class="avatar"
         src="/img/avatar.jpg"/>
</a>
<div class="author">
    <span>Whitebird</span>
</div>

<div class="icon">
    
        
            <a title="github"
               href="https://github.com/Whitebird0"
               target="_blank">
                
                    <svg class="iconfont-svg" aria-hidden="true">
                        <use xlink:href="#icon-github"></use>
                    </svg>
                
            </a>
        
    
        
            <a title="csdn"
               href="https://blog.csdn.net/jxnu_666?type=blog"
               target="_blank">
                
                    <svg class="iconfont-svg" aria-hidden="true">
                        <use xlink:href="#icon-csdn"></use>
                    </svg>
                
            </a>
        
    
        
            <a title="email"
               href="mailto:767778848@qq.com"
               target="_blank">
                
                    <svg class="iconfont-svg" aria-hidden="true">
                        <use xlink:href="#icon-email"></use>
                    </svg>
                
            </a>
        
    
        
            <a title="qq"
               href="http://wpa.qq.com/msgrd?v=3&uin=767778848&site=qq&menu=yes"
               target="_blank">
                
                    <svg class="iconfont-svg" aria-hidden="true">
                        <use xlink:href="#icon-qq"></use>
                    </svg>
                
            </a>
        
    
</div>




<ul>
    <li>
        <div class="all active" data-rel="全部文章">全部文章
            
                <small>(28)</small>
            
        </div>
    </li>
    
        
            
                <li>
                    <div data-rel="CTF">
                        
                        CTF
                        <small>(6)</small>
                        
                    </div>
                    
                </li>
            
        
    
        
            
                <li>
                    <div data-rel="Reverse">
                        
                        Reverse
                        <small>(8)</small>
                        
                    </div>
                    
                </li>
            
        
    
        
            
                <li>
                    <div data-rel="Android开发">
                        
                        Android开发
                        <small>(10)</small>
                        
                    </div>
                    
                </li>
            
        
    
        
            
                <li>
                    <div data-rel="Android逆向">
                        
                        Android逆向
                        <small>(3)</small>
                        
                    </div>
                    
                </li>
            
        
    
        
            
                <li>
                    <div data-rel="Windows内核">
                        
                        Windows内核
                        <small>(1)</small>
                        
                    </div>
                    
                </li>
            
        
    
</ul>
<div class="left-bottom">
    <div class="menus">
        
            
            
    </div>
    <div>
        
            <a class="about  hasFriend  site_url"
               
               href="/about">关于</a>
        
        <a style="width: 50%"
                
                                           class="friends">友链</a>
        
    </div>
</div>
<input type="hidden" id="yelog_site_posts_number" value="28">
<input type="hidden" id="yelog_site_word_count" value="167.3k">
<div style="display: none">
    <span id="busuanzi_value_site_uv"></span>
    <span id="busuanzi_value_site_pv"></span>
</div>

    </div>
    <div class="nav-right">
        <div class="friends-area">
    <div class="friends-title">
        友情链接
        <i class="iconfont icon-left"></i>
    </div>
    <div class="friends-content">
        <ul>
            
            <li><a target="_blank" href="https://www.codetea.top/">Codetea</a></li>
            
        </ul>
    </div>
</div>
        <div class="title-list">
    <div class="right-top">
        <div id="default-panel">
            <i class="iconfont icon-search" data-title="搜索 快捷键 i"></i>
            <div class="right-title">全部文章</div>
            <i class="iconfont icon-file-tree" data-title="切换到大纲视图 快捷键 w"></i>
        </div>
        <div id="search-panel">
            <i class="iconfont icon-left" data-title="返回"></i>
            <input id="local-search-input" autocomplete="off"/>
            <label class="border-line" for="input"></label>
            <i class="iconfont icon-case-sensitive" data-title="大小写敏感"></i>
            <i class="iconfont icon-tag" data-title="标签"></i>
        </div>
        <div id="outline-panel" style="display: none">
            <div class="right-title">大纲</div>
            <i class="iconfont icon-list" data-title="切换到文章列表"></i>
        </div>
    </div>

    <div class="tags-list">
    <input id="tag-search" />
    <div class="tag-wrapper">
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>Android</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>CTF</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>Reverse</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>Windows内核</a>
            </li>
        
    </div>

</div>

    
    <div id="local-search-result">

    </div>
    
    <nav id="title-list-nav">
        
        
        <a  class="全部文章 Android逆向 "
           href="/post/Android%E7%B3%BB%E7%BB%9F%E6%B2%99%E7%9B%92%E5%AE%9A%E5%88%B6%E4%B8%93%E9%A2%98.html"
           data-tag="Android"
           data-author="" >
            <span class="post-title" title="Android系统沙盒定制">Android系统沙盒定制</span>
            <span class="post-date" title="2023-09-15 12:40:21">2023/09/15</span>
        </a>
        
        
        <a  class="全部文章 Android逆向 "
           href="/post/unidbg%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0.html"
           data-tag="Android"
           data-author="" >
            <span class="post-title" title="Android逆向学习笔记——Unidbg学习与实战">Android逆向学习笔记——Unidbg学习与实战</span>
            <span class="post-date" title="2023-07-01 09:00:15">2023/07/01</span>
        </a>
        
        
        <a  class="全部文章 Android逆向 "
           href="/post/Frida%E7%9A%84Python%E5%BA%93%E4%BD%BF%E7%94%A8.html"
           data-tag="Android"
           data-author="" >
            <span class="post-title" title="Android逆向学习笔记——使用Python库调用Frida">Android逆向学习笔记——使用Python库调用Frida</span>
            <span class="post-date" title="2023-06-01 09:00:15">2023/06/01</span>
        </a>
        
        
        <a  class="全部文章 Android开发 "
           href="/post/NDK%E5%BC%80%E5%8F%91%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0.html"
           data-tag="Android"
           data-author="" >
            <span class="post-title" title="Android开发学习笔记——NDK开发">Android开发学习笔记——NDK开发</span>
            <span class="post-date" title="2023-03-31 09:00:14">2023/03/31</span>
        </a>
        
        
        <a  class="全部文章 Android开发 "
           href="/post/the_first_code1.html"
           data-tag="Android"
           data-author="" >
            <span class="post-title" title="Android开发学习笔记(1)——初识安卓">Android开发学习笔记(1)——初识安卓</span>
            <span class="post-date" title="2023-03-30 09:00:21">2023/03/30</span>
        </a>
        
        
        <a  class="全部文章 Android开发 "
           href="/post/the_first_code2.html"
           data-tag="Android"
           data-author="" >
            <span class="post-title" title="Android开发学习笔记(2)——探究活动">Android开发学习笔记(2)——探究活动</span>
            <span class="post-date" title="2023-03-30 09:00:20">2023/03/30</span>
        </a>
        
        
        <a  class="全部文章 Android开发 "
           href="/post/the_first_code3.html"
           data-tag="Android"
           data-author="" >
            <span class="post-title" title="Android开发学习笔记(3)——UI开发">Android开发学习笔记(3)——UI开发</span>
            <span class="post-date" title="2023-03-30 09:00:19">2023/03/30</span>
        </a>
        
        
        <a  class="全部文章 Android开发 "
           href="/post/the_first_code4.html"
           data-tag="Android"
           data-author="" >
            <span class="post-title" title="Android开发学习笔记(4)——探究碎片">Android开发学习笔记(4)——探究碎片</span>
            <span class="post-date" title="2023-03-30 09:00:18">2023/03/30</span>
        </a>
        
        
        <a  class="全部文章 Android开发 "
           href="/post/the_first_code5.html"
           data-tag="Android"
           data-author="" >
            <span class="post-title" title="Android开发学习笔记(5)——详解广播机制">Android开发学习笔记(5)——详解广播机制</span>
            <span class="post-date" title="2023-03-30 09:00:17">2023/03/30</span>
        </a>
        
        
        <a  class="全部文章 Android开发 "
           href="/post/the_first_code6.html"
           data-tag="Android"
           data-author="" >
            <span class="post-title" title="Android开发学习笔记(6)——数据存储全方案">Android开发学习笔记(6)——数据存储全方案</span>
            <span class="post-date" title="2023-03-30 09:00:16">2023/03/30</span>
        </a>
        
        
        <a  class="全部文章 Android开发 "
           href="/post/the_first_code7.html"
           data-tag="Android"
           data-author="" >
            <span class="post-title" title="Android开发学习笔记(7)——跨程序共享数据">Android开发学习笔记(7)——跨程序共享数据</span>
            <span class="post-date" title="2023-03-30 09:00:15">2023/03/30</span>
        </a>
        
        
        <a  class="全部文章 Android开发 "
           href="/post/the_first_code8.html"
           data-tag="Android"
           data-author="" >
            <span class="post-title" title="Android开发学习笔记(8)——运用手机多媒体">Android开发学习笔记(8)——运用手机多媒体</span>
            <span class="post-date" title="2023-03-30 09:00:14">2023/03/30</span>
        </a>
        
        
        <a  class="全部文章 Android开发 "
           href="/post/the_first_code9.html"
           data-tag="Android"
           data-author="" >
            <span class="post-title" title="Android开发学习笔记(9)——网络技术">Android开发学习笔记(9)——网络技术</span>
            <span class="post-date" title="2023-03-30 09:00:13">2023/03/30</span>
        </a>
        
        
        <a  class="全部文章 CTF "
           href="/post/2022%E5%B9%B4%E6%B1%9F%E8%A5%BF%E7%9C%81%E2%80%9C%E8%B5%A3%E8%82%B2%E6%9D%AF%E2%80%9D%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%A4%A7%E8%B5%9B.html"
           data-tag="CTF"
           data-author="" >
            <span class="post-title" title="2022年江西省“赣育杯”网络安全大赛初赛 Re WriteUp">2022年江西省“赣育杯”网络安全大赛初赛 Re WriteUp</span>
            <span class="post-date" title="2022-10-08 22:40:21">2022/10/08</span>
        </a>
        
        
        <a  class="全部文章 CTF "
           href="/post/qwb.html"
           data-tag="CTF"
           data-author="" >
            <span class="post-title" title="第六届强网杯全国网络安全挑战赛 Re WriteUp">第六届强网杯全国网络安全挑战赛 Re WriteUp</span>
            <span class="post-date" title="2022-08-08 15:49:21">2022/08/08</span>
        </a>
        
        
        <a  class="全部文章 CTF "
           href="/post/bluecup.html"
           data-tag="CTF"
           data-author="" >
            <span class="post-title" title="第六届蓝帽杯初赛CTF题目 Re WriteUp">第六届蓝帽杯初赛CTF题目 Re WriteUp</span>
            <span class="post-date" title="2022-07-13 22:49:21">2022/07/13</span>
        </a>
        
        
        <a  class="全部文章 CTF "
           href="/post/CISCN2022.html"
           data-tag="CTF"
           data-author="" >
            <span class="post-title" title="第十五届全国大学生信息安全竞赛创新实践能力赛CISCN">第十五届全国大学生信息安全竞赛创新实践能力赛CISCN</span>
            <span class="post-date" title="2022-06-03 20:49:21">2022/06/03</span>
        </a>
        
        
        <a  class="全部文章 CTF "
           href="/post/2022DASCTF%20Apr%20X%20FATE%20%E9%98%B2%E7%96%AB%E6%8C%91%E6%88%98%E8%B5%9B.html"
           data-tag="CTF"
           data-author="" >
            <span class="post-title" title="2022DASCTF Apr X FATE 防疫挑战赛">2022DASCTF Apr X FATE 防疫挑战赛</span>
            <span class="post-date" title="2022-06-01 20:49:21">2022/06/01</span>
        </a>
        
        
        <a  class="全部文章 Reverse "
           href="/post/PE%E6%98%A0%E5%83%8F%E5%88%87%E6%8D%A2.html"
           data-tag="Reverse"
           data-author="" >
            <span class="post-title" title="逆向工程核心原理——PE映像切换">逆向工程核心原理——PE映像切换</span>
            <span class="post-date" title="2022-04-02 10:49:21">2022/04/02</span>
        </a>
        
        
        <a  class="全部文章 Reverse "
           href="/post/%E5%8F%8D%E8%B0%83%E8%AF%95%E6%8A%80%E6%9C%AF.html"
           data-tag="Reverse"
           data-author="" >
            <span class="post-title" title="逆向工程核心原理——反调试技术">逆向工程核心原理——反调试技术</span>
            <span class="post-date" title="2022-03-28 10:30:21">2022/03/28</span>
        </a>
        
        
        <a  class="全部文章 CTF "
           href="/post/2022-3-26-2022DASCTF-X-SU-Re-WriteUp.html"
           data-tag="CTF"
           data-author="" >
            <span class="post-title" title="2022DASCTF X SU Re WriteUp">2022DASCTF X SU Re WriteUp</span>
            <span class="post-date" title="2022-03-26 20:49:21">2022/03/26</span>
        </a>
        
        
        <a  class="全部文章 Reverse "
           href="/post/SEH.html"
           data-tag="Reverse"
           data-author="" >
            <span class="post-title" title="逆向工程核心原理——SEH原理分析">逆向工程核心原理——SEH原理分析</span>
            <span class="post-date" title="2022-03-19 10:49:21">2022/03/19</span>
        </a>
        
        
        <a  class="全部文章 Reverse "
           href="/post/TLS%E5%9B%9E%E8%B0%83%E5%87%BD%E6%95%B0.html"
           data-tag="Reverse"
           data-author="" >
            <span class="post-title" title="逆向工程核心原理——TLS回调函数">逆向工程核心原理——TLS回调函数</span>
            <span class="post-date" title="2022-03-15 22:49:21">2022/03/15</span>
        </a>
        
        
        <a  class="全部文章 Reverse "
           href="/post/%E5%85%A8%E5%B1%80API%E9%92%A9%E5%8F%96-IE%E9%93%BE%E6%8E%A5%E6%8E%A7%E5%88%B6.html"
           data-tag="Reverse"
           data-author="" >
            <span class="post-title" title="逆向工程核心原理——全局API钩取">逆向工程核心原理——全局API钩取</span>
            <span class="post-date" title="2022-03-11 16:49:21">2022/03/11</span>
        </a>
        
        
        <a  class="全部文章 Reverse "
           href="/post/%E8%AE%A1%E7%AE%97%E5%99%A8%E6%98%BE%E7%A4%BA%E4%B8%AD%E6%96%87%E6%95%B0%E5%AD%97.html"
           data-tag="Reverse"
           data-author="" >
            <span class="post-title" title="逆向工程核心原理——IAT_HOOK">逆向工程核心原理——IAT_HOOK</span>
            <span class="post-date" title="2022-03-08 22:49:21">2022/03/08</span>
        </a>
        
        
        <a  class="全部文章 Reverse "
           href="/post/%E9%80%9A%E8%BF%87%E4%BF%AE%E6%94%B9PE%E5%8A%A0%E8%BD%BDDLL.html"
           data-tag="Reverse"
           data-author="" >
            <span class="post-title" title="逆向工程核心原理——通过修改PE加载DLL">逆向工程核心原理——通过修改PE加载DLL</span>
            <span class="post-date" title="2022-02-28 22:49:21">2022/02/28</span>
        </a>
        
        
        <a  class="全部文章 Reverse "
           href="/post/DLL%E6%B3%A8%E5%85%A5.html"
           data-tag="Reverse"
           data-author="" >
            <span class="post-title" title="逆向工程核心原理——DLL注入">逆向工程核心原理——DLL注入</span>
            <span class="post-date" title="2022-02-26 00:49:21">2022/02/26</span>
        </a>
        
        
        <a  class="全部文章 Windows内核 "
           href="/post/%E6%AE%B5%E4%B8%8E%E9%A1%B5%E7%9A%84%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5.html"
           data-tag="Windows内核"
           data-author="" >
            <span class="post-title" title="Windows内核基础知识-段选择子与段描述符">Windows内核基础知识-段选择子与段描述符</span>
            <span class="post-date" title="2021-10-03 12:40:21">2021/10/03</span>
        </a>
        
        <div id="no-item-tips">

        </div>
    </nav>
    <div id="outline-list">
    </div>
</div>

    </div>
    <div class="hide-list">
        <div class="semicircle" data-title="切换全屏 快捷键 s">
            <div class="brackets first"><</div>
            <div class="brackets">&gt;</div>
        </div>
    </div>
</aside>
<div id="post">
    <div class="pjax">
        <article id="post-NDK开发学习笔记" class="article article-type-post" itemscope itemprop="blogPost">
    
        <h1 class="article-title">Android开发学习笔记——NDK开发</h1>
    
    <div class="article-meta">
        
        
        
        <span class="book">
            <i class="iconfont icon-category"></i>
            
            
            <a  data-rel="Android开发">Android开发</a>
            
        </span>
        
        
        <span class="tag">
            <i class="iconfont icon-tag"></i>
            
            <a class="color3">Android</a>
            
        </span>
        
    </div>
    <div class="article-meta">
        
            发布时间 : <time class="date" title='最后更新: 2023-05-09 14:26:45'>2023-03-31 09:00</time>
        
    </div>
    <div class="article-meta">
        
        <span>字数:5.1k</span>
        
        
        <span id="busuanzi_container_page_pv">
            阅读 :<span id="busuanzi_value_page_pv">
                <span class="count-comment">
                    <span class="spinner">
                      <div class="cube1"></div>
                      <div class="cube2"></div>
                    </span>
                </span>
            </span>
        </span>
        
        
        <span class="top-comment" title="跳转至评论区">
            <a href="#comments">
                评论:<span class="count-comment">
                    <span class="spinner">
                      <div class="cube1"></div>
                      <div class="cube2"></div>
                    </span>
                </span>
            </a>
        </span>
        
    </div>
    
    <div class="toc-ref">
    
        <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#1%E3%80%81NDK%E4%BB%8B%E7%BB%8D"><span class="toc-text">1、NDK介绍</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-1%E3%80%81app%E4%B8%BA%E4%BB%80%E4%B9%88%E6%8A%8A%E4%BB%A3%E7%A0%81%E6%94%BE%E5%88%B0so%E4%B8%AD"><span class="toc-text">1.1、app为什么把代码放到so中</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-2%E3%80%81%E4%B8%BA%E4%BB%80%E4%B9%88%E8%A6%81%E5%AD%A6%E4%B9%A0NDK%E5%BC%80%E5%8F%91"><span class="toc-text">1.2、为什么要学习NDK开发</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-3%E3%80%81%E4%BB%80%E4%B9%88%E6%98%AFJNI"><span class="toc-text">1.3、什么是JNI</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-4%E3%80%81%E4%BB%80%E4%B9%88%E6%98%AFNDK"><span class="toc-text">1.4、什么是NDK</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-5%E3%80%81ABI%E4%B8%8E%E6%8C%87%E4%BB%A4%E9%9B%86"><span class="toc-text">1.5、ABI与指令集</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2%E3%80%81NDK%E4%B8%8EJava%E5%B7%A5%E7%A8%8B%E7%9A%84%E5%8C%BA%E5%88%AB"><span class="toc-text">2、NDK与Java工程的区别</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#3%E3%80%81%E7%AC%AC%E4%B8%80%E4%B8%AANDK%E5%B7%A5%E7%A8%8B"><span class="toc-text">3、第一个NDK工程</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#4%E3%80%81so%E4%B8%AD%E5%B8%B8%E7%94%A8%E7%9A%84Log%E8%BE%93%E5%87%BA"><span class="toc-text">4、so中常用的Log输出</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#5%E3%80%81NDK%E5%A4%9A%E7%BA%BF%E7%A8%8B"><span class="toc-text">5、NDK多线程</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#6%E3%80%81JNI-OnLoad"><span class="toc-text">6、JNI_OnLoad</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#7%E3%80%81JavaVM"><span class="toc-text">7、JavaVM</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#7-1%E3%80%81JavaVM%E6%98%AF%E4%BB%80%E4%B9%88"><span class="toc-text">7.1、JavaVM是什么</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-2%E3%80%81JavaVM%E7%9A%84%E8%8E%B7%E5%8F%96%E6%96%B9%E5%BC%8F"><span class="toc-text">7.2、JavaVM的获取方式</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#8%E3%80%81JNIEnv"><span class="toc-text">8、JNIEnv</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#8-1%E3%80%81JNIEnv%E6%98%AF%E4%BB%80%E4%B9%88"><span class="toc-text">8.1、JNIEnv是什么</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-2%E3%80%81JNIEnv%E7%9A%84%E8%8E%B7%E5%8F%96%E6%96%B9%E5%BC%8F"><span class="toc-text">8.2、JNIEnv的获取方式</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#9%E3%80%81JNI%E5%87%BD%E6%95%B0%E7%9A%84%E6%B3%A8%E5%86%8C"><span class="toc-text">9、JNI函数的注册</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#9-1%E3%80%81%E9%9D%99%E6%80%81%E6%B3%A8%E5%86%8C"><span class="toc-text">9.1、静态注册</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#9-2%E3%80%81%E5%8A%A8%E6%80%81%E6%B3%A8%E5%86%8C"><span class="toc-text">9.2、动态注册</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#10%E3%80%81%E5%A4%9A%E4%B8%AAcpp%E6%96%87%E4%BB%B6%E7%BC%96%E8%AF%91%E6%88%90%E4%B8%80%E4%B8%AAso"><span class="toc-text">10、多个cpp文件编译成一个so</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#11%E3%80%81%E7%BC%96%E8%AF%91%E5%A4%9A%E4%B8%AAso"><span class="toc-text">11、编译多个so</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#12%E3%80%81so%E8%B7%AF%E5%BE%84%E7%9A%84%E5%8A%A8%E6%80%81%E8%8E%B7%E5%8F%96"><span class="toc-text">12、so路径的动态获取</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#13%E3%80%81so%E4%B9%8B%E9%97%B4%E7%9B%B8%E4%BA%92%E8%B0%83%E7%94%A8"><span class="toc-text">13、so之间相互调用</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#14%E3%80%81%E9%80%9A%E8%BF%87JNI%E5%88%9B%E5%BB%BAJava%E5%AF%B9%E8%B1%A1"><span class="toc-text">14、通过JNI创建Java对象</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#NewObject%E5%88%9B%E5%BB%BA%E5%AF%B9%E8%B1%A1"><span class="toc-text">NewObject创建对象</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#AllocObject%E5%88%9B%E5%BB%BA%E5%AF%B9%E8%B1%A1"><span class="toc-text">AllocObject创建对象</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#15%E3%80%81%E9%80%9A%E8%BF%87JNI%E8%AE%BF%E9%97%AEJava%E5%B1%9E%E6%80%A7"><span class="toc-text">15、通过JNI访问Java属性</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#a%E3%80%81%E8%8E%B7%E5%8F%96%E9%9D%99%E6%80%81%E5%AD%97%E6%AE%B5"><span class="toc-text">a、获取静态字段</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#b%E3%80%81%E8%8E%B7%E5%8F%96%E5%AF%B9%E8%B1%A1%E5%AD%97%E6%AE%B5"><span class="toc-text">b、获取对象字段</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#c%E3%80%81%E8%AE%BE%E7%BD%AE%E5%AF%B9%E8%B1%A1%E5%AD%97%E6%AE%B5"><span class="toc-text">c、设置对象字段</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#16%E3%80%81%E9%80%9A%E8%BF%87JNI%E8%AE%BF%E9%97%AE%E5%92%8C%E4%BF%AE%E6%94%B9Java%E6%95%B0%E7%BB%84"><span class="toc-text">16、通过JNI访问和修改Java数组</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#17%E3%80%81%E9%80%9A%E8%BF%87jni%E8%AE%BF%E9%97%AEJava%E6%96%B9%E6%B3%95"><span class="toc-text">17、通过jni访问Java方法</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1%E3%80%81%E8%B0%83%E7%94%A8%E9%9D%99%E6%80%81%E5%87%BD%E6%95%B0"><span class="toc-text">1、调用静态函数</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2%E3%80%81%E8%B0%83%E7%94%A8%E5%AF%B9%E8%B1%A1%E5%87%BD%E6%95%B0"><span class="toc-text">2、调用对象函数</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#18%E3%80%81CallVoidMethod%E3%80%81A%E3%80%81V%E7%89%88%E6%9C%AC%E5%8C%BA%E5%88%AB"><span class="toc-text">18、CallVoidMethod、A、V版本区别</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#19%E3%80%81%E9%80%9A%E8%BF%87jni%E8%AE%BF%E9%97%AEJava%E7%88%B6%E7%B1%BB%E6%96%B9%E6%B3%95"><span class="toc-text">19、通过jni访问Java父类方法</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#20%E3%80%81%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86"><span class="toc-text">20、内存管理</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1%E3%80%81%E5%B1%80%E9%83%A8%E5%BC%95%E7%94%A8"><span class="toc-text">1、局部引用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2%E3%80%81%E5%B1%80%E9%83%A8%E5%BC%95%E7%94%A8%E7%9B%B8%E5%85%B3%E7%9A%84%E5%85%B6%E4%BB%96%E5%87%BD%E6%95%B0"><span class="toc-text">2、局部引用相关的其他函数</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3%E3%80%81%E5%85%A8%E5%B1%80%E5%BC%95%E7%94%A8"><span class="toc-text">3、全局引用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4%E3%80%81%E5%BC%B1%E5%85%A8%E5%B1%80%E5%BC%95%E7%94%A8"><span class="toc-text">4、弱全局引用</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#21%E3%80%81%E5%AD%90%E7%BA%BF%E7%A8%8B%E4%B8%AD%E8%8E%B7%E5%8F%96Java%E7%B1%BB"><span class="toc-text">21、子线程中获取Java类</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#22%E3%80%81init%E4%B8%8Einitarray"><span class="toc-text">22、init与initarray</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%8D%E7%BC%96%E8%AF%91so"><span class="toc-text">反编译so</span></a></li></ol></li></ol>
    
<style>
    .left-col .switch-btn,
    .left-col .switch-area {
        display: none;
    }
    .toc-level-3 i,
    .toc-level-3 ol {
        display: none !important;
    }
</style>
</div>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="1、NDK介绍"><a href="#1、NDK介绍" class="headerlink" title="1、NDK介绍"></a>1、NDK介绍</h1><h2 id="1-1、app为什么把代码放到so中"><a href="#1-1、app为什么把代码放到so中" class="headerlink" title="1.1、app为什么把代码放到so中"></a>1.1、app为什么把代码放到so中</h2><p>a) C语言历史悠久，有很多现成的代码可用</p>
<p>b) C代码执行效率比Java高</p>
<p>c) Java代码很容易被反编译，而且反编译以后的逻辑很清晰</p>
<h2 id="1-2、为什么要学习NDK开发"><a href="#1-2、为什么要学习NDK开发" class="headerlink" title="1.2、为什么要学习NDK开发"></a>1.2、为什么要学习NDK开发</h2><p>在安卓的so开发中，基本与C&#x2F;C++开发一致，而与Java交互需要用到JNI</p>
<p>在本部分的NDK开发讲解中，主要就是介绍JNI相关内容，so中会接触的：系统库函数、jni调用、加密算法、魔改算法、系统调用、自定义算法</p>
<h2 id="1-3、什么是JNI"><a href="#1-3、什么是JNI" class="headerlink" title="1.3、什么是JNI"></a>1.3、什么是JNI</h2><p>JNI是Java Native Interface的缩写。从Java1.1开始，JNI标准成为Java平台的一部分，允许Java代码和其他语言写的代码进行交互</p>
<h2 id="1-4、什么是NDK"><a href="#1-4、什么是NDK" class="headerlink" title="1.4、什么是NDK"></a>1.4、什么是NDK</h2><p>NDK是一套工具，使我们能够在 Android 应用中使用 C 和 C++ 代码</p>
<p>交叉编译工具链</p>
<p>NDK的配置</p>
<p>NDK、CMake、LLDB的作用 <a target="_blank" rel="noopener" href="https://developer.android.com/ndk/guides">https://developer.android.com/ndk/guides</a></p>
<h2 id="1-5、ABI与指令集"><a href="#1-5、ABI与指令集" class="headerlink" title="1.5、ABI与指令集"></a>1.5、ABI与指令集</h2><p>不同的 Android 设备使用不同的 CPU，而不同的 CPU 支持不同的指令集。CPU 与指令集的每种组合都有专属的应用二进制接口 (ABI)。</p>
<p><a target="_blank" rel="noopener" href="https://developer.android.com/ndk/guides/abis">https://developer.android.com/ndk/guides/abis</a></p>
<h1 id="2、NDK与Java工程的区别"><a href="#2、NDK与Java工程的区别" class="headerlink" title="2、NDK与Java工程的区别"></a>2、NDK与Java工程的区别</h1><p>1、Java代码中多了加载so和声明所需使用的so中的函数代码</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/202305041152608.png"></p>
<p>2、编写CMakeLists.txt和C文件</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/202305041153075.png"></p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/202305041154553.png"></p>
<p>3、build.gradle中添加一些代码</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/202305041157191.png"></p>
<h1 id="3、第一个NDK工程"><a href="#3、第一个NDK工程" class="headerlink" title="3、第一个NDK工程"></a>3、第一个NDK工程</h1><p>1、CMakeLists介绍</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/202305041329093.png"></p>
<p>2、so的加载</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">static</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">loadLibrary</span><span class="token punctuation">(</span><span class="token string">"javaandso"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>3、native函数的声明</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">native</span> <span class="token class-name">String</span> <span class="token function">stringFromJNI</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>4、JNI函数的静态注册规则</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;jni.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string></span></span>

<span class="token keyword">extern</span> <span class="token string">"C"</span> JNIEXPORT jstring JNICALL
<span class="token function">Java_com_example_javaandso_MainActivity_stringFromJNI</span><span class="token punctuation">(</span>
        JNIEnv<span class="token operator">*</span> env<span class="token punctuation">,</span>
        jobject <span class="token comment">/* this */</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    std<span class="token double-colon punctuation">::</span>string hello <span class="token operator">=</span> <span class="token string">"Hello from C++"</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> env<span class="token operator">-></span><span class="token function">NewStringUTF</span><span class="token punctuation">(</span>hello<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>Java_包名_类_方法名</p>
<p>5、JNIEnv、jobject&#x2F;jclass</p>
<p>jobject 在native函数的声明改为static时，使用jclass，因为静态方法可以通过类直接调用</p>
<p> 6、NewstringUTF</p>
<p>Java的数据和so的数据不互通，如果so的数据最后要转到java层处理就需要NewstringUTF，因此NewstringUTF可以成为一个hook点。</p>
<p>7、在NDK开发中，一定要注意哪些是Java的类型，哪些是C&#x2F;C++的类型，在适当的时候需要转换</p>
<p>hello.c_str()获取C字符串的类型，jstring是JAVA字符串类型</p>
<p>8、extern “C” JNIEXPORT jstring JNICALL</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/202305041341116.png"></p>
<p>JNICALL是空的，JNIEXPORT代表把函数导出，给函数添加了默认的可见属性</p>
<ol start="9">
<li><p>指定只编译arm64的so</p>
<pre class="line-numbers language-none"><code class="language-none">ndk &#123;
    abiFilters &#39;arm64-v8a&#39;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/202305041349414.png"></p>
</li>
<li><p>指定编译后的so名字<img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/202305041402972.png"></p>
</li>
</ol>
<p>修改地方如下</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/202305041403397.png"></p>
<h1 id="4、so中常用的Log输出"><a href="#4、so中常用的Log输出" class="headerlink" title="4、so中常用的Log输出"></a>4、so中常用的Log输出</h1><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;jni.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;android/log.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">TAG</span> <span class="token string">"whitebird"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">LOGD</span><span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span> <span class="token function">__android_log_print</span><span class="token punctuation">(</span>ANDROID_LOG_DEBUG<span class="token punctuation">,</span> TAG<span class="token punctuation">,</span> __VA_ARGS__<span class="token punctuation">)</span><span class="token punctuation">;</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">LOGI</span><span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span> <span class="token function">__android_log_print</span><span class="token punctuation">(</span>ANDROID_LOG_INFO <span class="token punctuation">,</span> TAG<span class="token punctuation">,</span> __VA_ARGS__<span class="token punctuation">)</span><span class="token punctuation">;</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">LOGE</span><span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span> <span class="token function">__android_log_print</span><span class="token punctuation">(</span>ANDROID_LOG_ERROR<span class="token punctuation">,</span> TAG<span class="token punctuation">,</span> __VA_ARGS__<span class="token punctuation">)</span><span class="token punctuation">;</span></span></span>


<span class="token keyword">extern</span> <span class="token string">"C"</span> JNIEXPORT jstring JNICALL
<span class="token function">Java_com_example_javaandso_MainActivity_stringFromJNI</span><span class="token punctuation">(</span>
        JNIEnv<span class="token operator">*</span> env<span class="token punctuation">,</span>
        jobject <span class="token comment">/* this */</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

    std<span class="token double-colon punctuation">::</span>string hello <span class="token operator">=</span> <span class="token string">"Hello from C++"</span><span class="token punctuation">;</span>
    <span class="token function">LOGD</span><span class="token punctuation">(</span><span class="token string">"LOGD test%d"</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">LOGI</span><span class="token punctuation">(</span><span class="token string">"LOGI test%d,%d"</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">LOGE</span><span class="token punctuation">(</span><span class="token string">"LOGE test%d,%d,%d"</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> env<span class="token operator">-></span><span class="token function">NewStringUTF</span><span class="token punctuation">(</span>hello<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/202305041815166.png"></p>
<h1 id="5、NDK多线程"><a href="#5、NDK多线程" class="headerlink" title="5、NDK多线程"></a>5、NDK多线程</h1><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">int</span> <span class="token function">pthread_create</span><span class="token punctuation">(</span>pthread_t<span class="token operator">*</span> __pthread_ptr<span class="token punctuation">,</span> pthread_attr_t <span class="token keyword">const</span><span class="token operator">*</span> __attr<span class="token punctuation">,</span> <span class="token keyword">void</span><span class="token operator">*</span> <span class="token punctuation">(</span><span class="token operator">*</span>__start_routine<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>第一个是指向pthread的指针，也是线程id，第二个是线程属性，第三个是线程执行的函数，第四个是函数参数</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;jni.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;android/log.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">TAG</span> <span class="token string">"whitebird"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">LOGD</span><span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span> <span class="token function">__android_log_print</span><span class="token punctuation">(</span>ANDROID_LOG_DEBUG<span class="token punctuation">,</span> TAG<span class="token punctuation">,</span> __VA_ARGS__<span class="token punctuation">)</span><span class="token punctuation">;</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">LOGI</span><span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span> <span class="token function">__android_log_print</span><span class="token punctuation">(</span>ANDROID_LOG_INFO <span class="token punctuation">,</span> TAG<span class="token punctuation">,</span> __VA_ARGS__<span class="token punctuation">)</span><span class="token punctuation">;</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">LOGE</span><span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span> <span class="token function">__android_log_print</span><span class="token punctuation">(</span>ANDROID_LOG_ERROR<span class="token punctuation">,</span> TAG<span class="token punctuation">,</span> __VA_ARGS__<span class="token punctuation">)</span><span class="token punctuation">;</span></span></span>
<span class="token keyword">void</span> <span class="token function">myThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    std<span class="token double-colon punctuation">::</span>string test<span class="token operator">=</span><span class="token string">"this is a thread function"</span><span class="token punctuation">;</span>
    <span class="token function">LOGD</span><span class="token punctuation">(</span>test<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">extern</span> <span class="token string">"C"</span> JNIEXPORT jstring JNICALL
<span class="token function">Java_com_example_javaandso_MainActivity_stringFromJNI</span><span class="token punctuation">(</span>
        JNIEnv<span class="token operator">*</span> env<span class="token punctuation">,</span>
        jobject <span class="token comment">/* this */</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

    std<span class="token double-colon punctuation">::</span>string hello <span class="token operator">=</span> <span class="token string">"Hello from C++"</span><span class="token punctuation">;</span>
    pthread_t pthread<span class="token punctuation">;</span>
    <span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pthread<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">,</span> <span class="token generic-function"><span class="token function">reinterpret_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">></span></span></span><span class="token punctuation">(</span>myThread<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> env<span class="token operator">-></span><span class="token function">NewStringUTF</span><span class="token punctuation">(</span>hello<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/202305041852040.png"></p>
<p>默认的线程属性是joinable 随着主线程结束而结束</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;jni.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;android/log.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">TAG</span> <span class="token string">"whitebird"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">LOGD</span><span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span> <span class="token function">__android_log_print</span><span class="token punctuation">(</span>ANDROID_LOG_DEBUG<span class="token punctuation">,</span> TAG<span class="token punctuation">,</span> __VA_ARGS__<span class="token punctuation">)</span><span class="token punctuation">;</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">LOGI</span><span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span> <span class="token function">__android_log_print</span><span class="token punctuation">(</span>ANDROID_LOG_INFO <span class="token punctuation">,</span> TAG<span class="token punctuation">,</span> __VA_ARGS__<span class="token punctuation">)</span><span class="token punctuation">;</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">LOGE</span><span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span> <span class="token function">__android_log_print</span><span class="token punctuation">(</span>ANDROID_LOG_ERROR<span class="token punctuation">,</span> TAG<span class="token punctuation">,</span> __VA_ARGS__<span class="token punctuation">)</span><span class="token punctuation">;</span></span></span>

<span class="token keyword">void</span> <span class="token function">myThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    std<span class="token double-colon punctuation">::</span>string test<span class="token operator">=</span><span class="token string">"this is a thread function"</span><span class="token punctuation">;</span>
    <span class="token function">LOGD</span><span class="token punctuation">(</span>test<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//子线程中使用它来退出线程</span>
    <span class="token function">pthread_exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">extern</span> <span class="token string">"C"</span> JNIEXPORT jstring JNICALL
<span class="token function">Java_com_example_javaandso_MainActivity_stringFromJNI</span><span class="token punctuation">(</span>
        JNIEnv<span class="token operator">*</span> env<span class="token punctuation">,</span>
        jobject <span class="token comment">/* this */</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    pthread_t pthread<span class="token punctuation">;</span>
    <span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pthread<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">,</span> <span class="token generic-function"><span class="token function">reinterpret_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">></span></span></span><span class="token punctuation">(</span>myThread<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//线程属性是dettach，可以分离执行</span>
    <span class="token function">pthread_join</span><span class="token punctuation">(</span>pthread<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> env<span class="token operator">-></span><span class="token function">NewStringUTF</span><span class="token punctuation">(</span>hello<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/202305041855663.png"></p>
<h1 id="6、JNI-OnLoad"><a href="#6、JNI-OnLoad" class="headerlink" title="6、JNI_OnLoad"></a>6、JNI_OnLoad</h1><p>在使用native方法前都会先加载该native方法的so文件，通常在一个类的静态代码块中进行加载，当然也可以在构造函数，或者调用前加载。jvm在加载so时都会先调用so中的JNI_OnLoad函数，如果你没有重写该方法，那么系统会给你自动生成一个。我们先来测试一下JNI_OnLoad的调用时机</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/202305041932381.png"></p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp">JNIEXPORT jint <span class="token function">JNI_OnLoad</span><span class="token punctuation">(</span>JavaVM <span class="token operator">*</span>vm<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>reserved<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    JNIEnv <span class="token operator">*</span>env <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>vm<span class="token operator">-></span><span class="token function">GetEnv</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>env<span class="token punctuation">,</span> JNI_VERSION_1_6<span class="token punctuation">)</span> <span class="token operator">!=</span> JNI_OK<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">LOGD</span><span class="token punctuation">(</span><span class="token string">"GetEnv failed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">return</span> JNI_VERSION_1_6<span class="token punctuation">;</span>
  <span class="token comment">//如果我们的*.so中没有提供JNI_OnLoad()函数，VM会默认该*.so档是使用最老的JNI 1.1版本。</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>注意事项</strong></p>
<p>1、一个so中可以不定义JNI_OnLoad，一旦定义了JNI_OnLoad，在so被加载的时候会自动执行，必须返回JNI版本 JNI_VERSION_1_6</p>
<p>2、在so被成功卸载时，会回调另一个JNI方法：JNI_UnOnLoad。这两个方法声明如下：</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp">JNIEXPORT jint JNICALL <span class="token function">JNI_OnLoad</span><span class="token punctuation">(</span>JavaVM<span class="token operator">*</span> vm<span class="token punctuation">,</span> <span class="token keyword">void</span><span class="token operator">*</span> reserved<span class="token punctuation">)</span><span class="token punctuation">;</span>
JNIEXPORT <span class="token keyword">void</span> JNICALL <span class="token function">JNI_OnUnload</span><span class="token punctuation">(</span>JavaVM<span class="token operator">*</span> vm<span class="token punctuation">,</span> <span class="token keyword">void</span><span class="token operator">*</span> reserved<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>其中第一个参数vm表示DVM虚拟机，该vm在应用进程中仅有一个，可以保存在native的静态变量中，供其他函数或其他线程使用。其返回值表示当前需要native library需要的版本。</p>
<h1 id="7、JavaVM"><a href="#7、JavaVM" class="headerlink" title="7、JavaVM"></a>7、JavaVM</h1><h2 id="7-1、JavaVM是什么"><a href="#7-1、JavaVM是什么" class="headerlink" title="7.1、JavaVM是什么"></a>7.1、JavaVM是什么</h2><p>JavaVM是虚拟机在JNI中的表示，一个JVM中只有一个JavaVM实例，这个实例是线程共享的。通过JNIEnv可以获取一个Java虚拟机实例，其函数如下：</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp">jint <span class="token function">GetJavaVM</span><span class="token punctuation">(</span>JNIEnv <span class="token operator">*</span>env<span class="token punctuation">,</span> JavaVM <span class="token operator">*</span><span class="token operator">*</span>vm<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>vm用来存放获得的虚拟机指针的指针，成功返回0，失败返回其它值。</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token function">defined</span><span class="token punctuation">(</span>__cplusplus<span class="token punctuation">)</span></span></span>
<span class="token keyword">typedef</span> _JNIEnv JNIEnv<span class="token punctuation">;</span>
<span class="token keyword">typedef</span> _JavaVM JavaVM<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span>
<span class="token keyword">typedef</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">JNINativeInterface</span><span class="token operator">*</span> JNIEnv<span class="token punctuation">;</span>
<span class="token keyword">typedef</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">JNIInvokeInterface</span><span class="token operator">*</span> JavaVM<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>如果是C++，则用_JavaVM定义，如果是C，就用JNIInvokeInterface定义。</p>
<p>_JavaVM和JNIInvokeInterface分别如下：</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">struct</span> <span class="token class-name">JNIInvokeInterface</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">void</span><span class="token operator">*</span>       reserved0<span class="token punctuation">;</span>
    <span class="token keyword">void</span><span class="token operator">*</span>       reserved1<span class="token punctuation">;</span>
    <span class="token keyword">void</span><span class="token operator">*</span>       reserved2<span class="token punctuation">;</span>

    <span class="token function">jint</span>        <span class="token punctuation">(</span><span class="token operator">*</span>DestroyJavaVM<span class="token punctuation">)</span><span class="token punctuation">(</span>JavaVM<span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">jint</span>        <span class="token punctuation">(</span><span class="token operator">*</span>AttachCurrentThread<span class="token punctuation">)</span><span class="token punctuation">(</span>JavaVM<span class="token operator">*</span><span class="token punctuation">,</span> JNIEnv<span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">jint</span>        <span class="token punctuation">(</span><span class="token operator">*</span>DetachCurrentThread<span class="token punctuation">)</span><span class="token punctuation">(</span>JavaVM<span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">jint</span>        <span class="token punctuation">(</span><span class="token operator">*</span>GetEnv<span class="token punctuation">)</span><span class="token punctuation">(</span>JavaVM<span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">void</span><span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">,</span> jint<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">jint</span>        <span class="token punctuation">(</span><span class="token operator">*</span>AttachCurrentThreadAsDaemon<span class="token punctuation">)</span><span class="token punctuation">(</span>JavaVM<span class="token operator">*</span><span class="token punctuation">,</span> JNIEnv<span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token keyword">struct</span> <span class="token class-name">_JavaVM</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">JNIInvokeInterface</span><span class="token operator">*</span> functions<span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token function">defined</span><span class="token punctuation">(</span>__cplusplus<span class="token punctuation">)</span></span></span>
    jint <span class="token function">DestroyJavaVM</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span> <span class="token keyword">return</span> functions<span class="token operator">-></span><span class="token function">DestroyJavaVM</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
    jint <span class="token function">AttachCurrentThread</span><span class="token punctuation">(</span>JNIEnv<span class="token operator">*</span><span class="token operator">*</span> p_env<span class="token punctuation">,</span> <span class="token keyword">void</span><span class="token operator">*</span> thr_args<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span> <span class="token keyword">return</span> functions<span class="token operator">-></span><span class="token function">AttachCurrentThread</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> p_env<span class="token punctuation">,</span> thr_args<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
    jint <span class="token function">DetachCurrentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span> <span class="token keyword">return</span> functions<span class="token operator">-></span><span class="token function">DetachCurrentThread</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
    jint <span class="token function">GetEnv</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token operator">*</span> env<span class="token punctuation">,</span> jint version<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span> <span class="token keyword">return</span> functions<span class="token operator">-></span><span class="token function">GetEnv</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> env<span class="token punctuation">,</span> version<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
    jint <span class="token function">AttachCurrentThreadAsDaemon</span><span class="token punctuation">(</span>JNIEnv<span class="token operator">*</span><span class="token operator">*</span> p_env<span class="token punctuation">,</span> <span class="token keyword">void</span><span class="token operator">*</span> thr_args<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span> <span class="token keyword">return</span> functions<span class="token operator">-></span><span class="token function">AttachCurrentThreadAsDaemon</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> p_env<span class="token punctuation">,</span> thr_args<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/*__cplusplus*/</span></span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>_JavaVM其实是对JNIInvokeInterface的封装，底层还是调用JNIInvokeInterface的函数。</p>
<p>JavaVM中的常用方法：GetEnv和AttachCurrentThread(在子线程中获取JNIEnv)</p>
<h2 id="7-2、JavaVM的获取方式"><a href="#7-2、JavaVM的获取方式" class="headerlink" title="7.2、JavaVM的获取方式"></a>7.2、JavaVM的获取方式</h2><p>JNI_OnLoad的第一个参数</p>
<p>JNI_OnUnload的第一个参数</p>
<p>env-&gt;GetJavaVM</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp">JNIEXPORT jint <span class="token function">JNI_OnLoad</span><span class="token punctuation">(</span>JavaVM <span class="token operator">*</span>vm<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>reserved<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    JNIEnv <span class="token operator">*</span>env <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>vm<span class="token operator">-></span><span class="token function">GetEnv</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>env<span class="token punctuation">,</span> JNI_VERSION_1_6<span class="token punctuation">)</span> <span class="token operator">!=</span> JNI_OK<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">LOGD</span><span class="token punctuation">(</span><span class="token string">"GetEnv failed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token function">LOGD</span><span class="token punctuation">(</span><span class="token string">"JavaVM %p"</span><span class="token punctuation">,</span>vm<span class="token punctuation">)</span><span class="token punctuation">;</span>
    JavaVM<span class="token operator">*</span><span class="token operator">*</span> vm1<span class="token punctuation">;</span>
    env<span class="token operator">-></span><span class="token function">GetJavaVM</span><span class="token punctuation">(</span>vm1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">LOGD</span><span class="token punctuation">(</span><span class="token string">"env->GetJavaVM %p"</span><span class="token punctuation">,</span><span class="token operator">*</span>vm1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> JNI_VERSION_1_6<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/202305050143741.png"></p>
<h1 id="8、JNIEnv"><a href="#8、JNIEnv" class="headerlink" title="8、JNIEnv"></a>8、JNIEnv</h1><h2 id="8-1、JNIEnv是什么"><a href="#8-1、JNIEnv是什么" class="headerlink" title="8.1、JNIEnv是什么"></a>8.1、JNIEnv是什么</h2><p>JNIEnv一般是是由虚拟机传入，而且与线程相关的变量，也就说线程A不能使用线程B的JNIEnv。而作为一个结构体，它里面定义了JNI系统操作函数。JNIEnv的定义如下：</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token function">defined</span><span class="token punctuation">(</span>__cplusplus<span class="token punctuation">)</span></span></span>
<span class="token keyword">typedef</span> _JNIEnv JNIEnv<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span>
<span class="token keyword">typedef</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">JNINativeInterface</span><span class="token operator">*</span> JNIEnv<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>JNIEnv在C语言环境和C++语言环境中的实现是不一样。在C中定义为JNINativeInterface，在C++中定义为_JNIEnv。</p>
<p>_JNIEnv结构体的定义如下：</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">struct</span> <span class="token class-name">_JNIEnv</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">/* do not rename this; it does not seem to be entirely opaque */</span>
    <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">JNINativeInterface</span><span class="token operator">*</span> functions<span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token function">defined</span><span class="token punctuation">(</span>__cplusplus<span class="token punctuation">)</span></span></span>

    jint <span class="token function">GetVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span> <span class="token keyword">return</span> functions<span class="token operator">-></span><span class="token function">GetVersion</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>

    jclass <span class="token function">DefineClass</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>name<span class="token punctuation">,</span> jobject loader<span class="token punctuation">,</span> <span class="token keyword">const</span> jbyte<span class="token operator">*</span> buf<span class="token punctuation">,</span>
        jsize bufLen<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span> <span class="token keyword">return</span> functions<span class="token operator">-></span><span class="token function">DefineClass</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> loader<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> bufLen<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>

    jclass <span class="token function">FindClass</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> name<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span> <span class="token keyword">return</span> functions<span class="token operator">-></span><span class="token function">FindClass</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
    
    
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    
 <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span>   </span>
    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>在_JNIEnv中定义了一个functions变量，这个变量是指向JNINativeInterface的指针。所以如果我们在写native函数时，当接收到类型为JNIEnv*的变量env时，可以使用如下方式调用JNIEnv中的函数（准确说是通过函数指针来调用函数，因为JNIEnv的数据结构聚合了所有 JNI 函数的函数指针），我们可在C++中通过如下方式调用：</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp">env<span class="token operator">-></span><span class="token function">FindClass</span><span class="token punctuation">(</span><span class="token string">"java/lang/String"</span><span class="token punctuation">)</span>   <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>而在C中可以通过如下方式调用：</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">FindClass</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> <span class="token string">"java/lang/String"</span><span class="token punctuation">)</span> <span class="token comment">// C中的写法 </span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>由于变量functions是定义在结构体_JNIEnv的第1个变量，所以我们通过*env就能获取到functions变量的值，然后通过JNINativeInterface中的函数指针来调用对应的函数。</p>
<p>JNINativeInterface结构体的定义如下</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">struct</span> <span class="token class-name">JNINativeInterface</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">void</span><span class="token operator">*</span>       reserved0<span class="token punctuation">;</span>
    <span class="token keyword">void</span><span class="token operator">*</span>       reserved1<span class="token punctuation">;</span>
    <span class="token keyword">void</span><span class="token operator">*</span>       reserved2<span class="token punctuation">;</span>
    <span class="token keyword">void</span><span class="token operator">*</span>       reserved3<span class="token punctuation">;</span>

    <span class="token function">jint</span>        <span class="token punctuation">(</span><span class="token operator">*</span>GetVersion<span class="token punctuation">)</span><span class="token punctuation">(</span>JNIEnv <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">jclass</span>      <span class="token punctuation">(</span><span class="token operator">*</span>DefineClass<span class="token punctuation">)</span><span class="token punctuation">(</span>JNIEnv<span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">,</span> jobject<span class="token punctuation">,</span> <span class="token keyword">const</span> jbyte<span class="token operator">*</span><span class="token punctuation">,</span>
                        jsize<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">jclass</span>      <span class="token punctuation">(</span><span class="token operator">*</span>FindClass<span class="token punctuation">)</span><span class="token punctuation">(</span>JNIEnv<span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="8-2、JNIEnv的获取方式"><a href="#8-2、JNIEnv的获取方式" class="headerlink" title="8.2、JNIEnv的获取方式"></a>8.2、JNIEnv的获取方式</h2><p>1、函数静态&#x2F;动态注册，传的第一个参数</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/202305051057947.png"></p>
<p>2、vm-&gt;GetEnv</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/202305051058265.png"></p>
<p>3、globalVM-&gt;AttachCurrentThread</p>
<p>用于子线程中获取Env</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/202305051105883.png"></p>
<p>JNIEnv是每个线程单独拥有一个，对于JNI_OnLoad和Java_com_example_javaandso_MainActivity_stringFromJNI都在主线程中，所以他们的值相等，myThread是一个新开的线程，所以打印出来的JNIEnv值不一样。</p>
<h1 id="9、JNI函数的注册"><a href="#9、JNI函数的注册" class="headerlink" title="9、JNI函数的注册"></a>9、JNI函数的注册</h1><h2 id="9-1、静态注册"><a href="#9-1、静态注册" class="headerlink" title="9.1、静态注册"></a>9.1、静态注册</h2><p>必须遵循一定的命名规则，一般是Java_包名_类名_方法名</p>
<p>系统会通过dlopen加载对应的so，通过dlsym来获取指定名字的函数地址，然后调用静态注册的jni函数，必然在导出表里</p>
<h2 id="9-2、动态注册"><a href="#9-2、动态注册" class="headerlink" title="9.2、动态注册"></a>9.2、动态注册</h2><p>通过env-&gt;RegisterNatives注册函数，通常在JNI_OnLoad中注册</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/202305051526363.png"></p>
<p>JNINativeMethod是一个结构体，第一个成员是Java层的函数名，第二个是签名，通常格式为(参数类型)返回值类型，第三个参数是Native层的函数指针。</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp">jstring <span class="token function">FunctionTest</span><span class="token punctuation">(</span>JNIEnv<span class="token operator">*</span> env<span class="token punctuation">,</span>jobject<span class="token punctuation">,</span><span class="token keyword">int</span> a<span class="token punctuation">,</span>jstring b<span class="token punctuation">,</span> jobjectArray c<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> env<span class="token operator">-></span><span class="token function">NewStringUTF</span><span class="token punctuation">(</span><span class="token string">"this is FunctionTest"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

JNIEXPORT jint <span class="token function">JNI_OnLoad</span><span class="token punctuation">(</span>JavaVM <span class="token operator">*</span>vm<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>reserved<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    JNIEnv <span class="token operator">*</span>env <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
    globalvm <span class="token operator">=</span>vm<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>vm<span class="token operator">-></span><span class="token function">GetEnv</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>env<span class="token punctuation">,</span> JNI_VERSION_1_6<span class="token punctuation">)</span> <span class="token operator">!=</span> JNI_OK<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">LOGD</span><span class="token punctuation">(</span><span class="token string">"GetEnv failed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    jclass MainActivityClazz <span class="token operator">=</span> env<span class="token operator">-></span><span class="token function">FindClass</span><span class="token punctuation">(</span><span class="token string">"com/example/javaandso/MainActivity"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    JNINativeMethod methods<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
            <span class="token punctuation">&#123;</span><span class="token string">"stringFromJNI1"</span><span class="token punctuation">,</span> <span class="token string">"(ILjava/lang/String;[Ljava/lang/Byte;)Ljava/lang/String;"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>FunctionTest<span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    env<span class="token operator">-></span><span class="token function">RegisterNatives</span><span class="token punctuation">(</span>MainActivityClazz<span class="token punctuation">,</span> methods<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>methods<span class="token punctuation">)</span><span class="token operator">/</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>JNINativeMethod<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> JNI_VERSION_1_6<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/202305051525833.png"></p>
<p>可以给同一个Java函数注册多个native函数，以最后一次为准</p>
<h1 id="10、多个cpp文件编译成一个so"><a href="#10、多个cpp文件编译成一个so" class="headerlink" title="10、多个cpp文件编译成一个so"></a>10、多个cpp文件编译成一个so</h1><p>新建了一个cpp文件</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/202305051554836.png"></p>
<p>如果想要把多个cpp文件编译成一个so，就需要修改CMakeLists.txt文件</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/202305051555550.png"></p>
<p>然后我们在JNI_OnLoad中调用这个函数</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/202305051547443.png"></p>
<h1 id="11、编译多个so"><a href="#11、编译多个so" class="headerlink" title="11、编译多个so"></a>11、编译多个so</h1><p>1、编写多个cpp文件</p>
<p>2、修改CMakeLists.txt</p>
<p>3、Java静态代码块加载多个so</p>
<pre class="line-numbers language-none"><code class="language-none"># 编译so的CMAKE的最低版本
cmake_minimum_required(VERSION 3.22.1)
# Declares and names the project.
project(&quot;javaandso&quot;)

# 设置so的名字，属性为共享库，so的源文件为native-lib.cpp
add_library( # Sets the name of the library.
        whitebirdA
        # Sets the library as a shared library.
        SHARED
        # Provides a relative path to your source file(s).
        native-lib.cpp
        )

add_library( # Sets the name of the library.
        whitebirdB
        # Sets the library as a shared library.
        SHARED
        # Provides a relative path to your source file(s).
        test.cpp
        )
#查找依赖库，并且设置依赖库的名字log-lib
find_library( # Sets the name of the path variable.
        log-lib
        # Specifies the name of the NDK library that
        # you want CMake to locate.
        log)

#链接依赖库，名字就是上面定义的log-lib
target_link_libraries( # Specifies the target library.
        whitebirdA

        # Links the target library to the log library
        # included in the NDK.
        $&#123;log-lib&#125;)

target_link_libraries( # Specifies the target library.
        whitebirdB

        # Links the target library to the log library
        # included in the NDK.
        $&#123;log-lib&#125;)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/202305051613831.png"></p>
<h1 id="12、so路径的动态获取"><a href="#12、so路径的动态获取" class="headerlink" title="12、so路径的动态获取"></a>12、so路径的动态获取</h1><p>先来探讨一下apk中的so文件将来要放在安卓哪一个目录下</p>
<p>放在&#x2F;data&#x2F;app&#x2F;包名&#x2F;lib下</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/202305051846911.png"></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getPath</span><span class="token punctuation">(</span><span class="token class-name">Context</span> cxt<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
       <span class="token comment">//包管理器</span>
       <span class="token class-name">PackageManager</span> pm <span class="token operator">=</span> cxt<span class="token punctuation">.</span><span class="token function">getPackageManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token comment">//得到已经安装的APP的信息</span>
       <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PackageInfo</span><span class="token punctuation">></span></span> pkgList <span class="token operator">=</span> pm<span class="token punctuation">.</span><span class="token function">getInstalledPackages</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token keyword">if</span> <span class="token punctuation">(</span>pkgList <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> pkgList<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
       <span class="token comment">//遍历</span>
       <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">PackageInfo</span> pi <span class="token operator">:</span> pkgList<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
           <span class="token comment">//判断是否为/data/app/开头</span>
           <span class="token keyword">if</span> <span class="token punctuation">(</span>pi<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>nativeLibraryDir<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">"/data/app/"</span><span class="token punctuation">)</span>
                   <span class="token operator">&amp;&amp;</span> pi<span class="token punctuation">.</span>packageName<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">"com.example.javaandso"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
               <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span><span class="token string">"whitetird"</span><span class="token punctuation">,</span> pi<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>nativeLibraryDir<span class="token punctuation">)</span><span class="token punctuation">;</span>
               <span class="token keyword">return</span> pi<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>nativeLibraryDir<span class="token punctuation">;</span>
           <span class="token punctuation">&#125;</span>
       <span class="token punctuation">&#125;</span>
       <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
   <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h1 id="13、so之间相互调用"><a href="#13、so之间相互调用" class="headerlink" title="13、so之间相互调用"></a>13、so之间相互调用</h1><p>需要用到dlopen函数,需要导入dlfcn.h</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/202305071949862.png"></p>
<p>两个参数，第一个是so的路径，第二个是下面定义的常量，表示解析符号，常用RTLD_NOW</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">void</span> <span class="token operator">*</span>soinfo <span class="token operator">=</span> <span class="token function">dlopen</span><span class="token punctuation">(</span>nativePath<span class="token punctuation">,</span> RTLD_NOW<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//加载打开so</span>
<span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>funptr<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span><span class="token comment">//定义函数指针</span>
funptr <span class="token operator">=</span> <span class="token generic-function"><span class="token function">reinterpret_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token function">dlsym</span><span class="token punctuation">(</span>soinfo<span class="token punctuation">,</span><span class="token string">"TestMain"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">funptr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/202305072346295.png"></p>
<p>另外一种方法就是通过link so实现</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/202305080009713.png"></p>
<p>然后声明后就可以调用了</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/202305080009716.png"></p>
<p>打印了两次this is TestMain for many cpp</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/202305080009444.png"></p>
<h1 id="14、通过JNI创建Java对象"><a href="#14、通过JNI创建Java对象" class="headerlink" title="14、通过JNI创建Java对象"></a>14、通过JNI创建Java对象</h1><p>有两种方法可以实现</p>
<h2 id="NewObject创建对象"><a href="#NewObject创建对象" class="headerlink" title="NewObject创建对象"></a>NewObject创建对象</h2><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp">jclass clazz <span class="token operator">=</span> env<span class="token operator">-></span><span class="token function">FindClass</span><span class="token punctuation">(</span><span class="token string">"com/xiaojianbang/ndk/NDKDemo"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
jmethodID methodID <span class="token operator">=</span> env<span class="token operator">-></span><span class="token function">GetMethodID</span><span class="token punctuation">(</span>clazz<span class="token punctuation">,</span> <span class="token string">"&lt;init>"</span><span class="token punctuation">,</span> <span class="token string">"()V"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
jobject ReflectDemoObj <span class="token operator">=</span> env<span class="token operator">-></span><span class="token function">NewObject</span><span class="token punctuation">(</span>clazz<span class="token punctuation">,</span> methodID<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">LOGD</span><span class="token punctuation">(</span><span class="token string">"ReflectDemoObj %p"</span><span class="token punctuation">,</span> ReflectDemoObj<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="AllocObject创建对象"><a href="#AllocObject创建对象" class="headerlink" title="AllocObject创建对象"></a>AllocObject创建对象</h2><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp">jclass clazz <span class="token operator">=</span> env<span class="token operator">-></span><span class="token function">FindClass</span><span class="token punctuation">(</span><span class="token string">"com/xiaojianbang/ndk/NDKDemo"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
jmethodID methodID2 <span class="token operator">=</span> env<span class="token operator">-></span><span class="token function">GetMethodID</span><span class="token punctuation">(</span>clazz<span class="token punctuation">,</span> <span class="token string">"&lt;init>"</span><span class="token punctuation">,</span> <span class="token string">"(Ljava/lang/String;I)V"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
jobject ReflectDemoObj2 <span class="token operator">=</span> env<span class="token operator">-></span><span class="token function">AllocObject</span><span class="token punctuation">(</span>clazz<span class="token punctuation">)</span><span class="token punctuation">;</span>
jstring jstr <span class="token operator">=</span> env<span class="token operator">-></span><span class="token function">NewStringUTF</span><span class="token punctuation">(</span><span class="token string">"from jni str"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
env<span class="token operator">-></span><span class="token function">CallNonvirtualVoidMethod</span><span class="token punctuation">(</span>ReflectDemoObj2<span class="token punctuation">,</span> clazz<span class="token punctuation">,</span> methodID2<span class="token punctuation">,</span> jstr<span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/202305080207536.png"></p>
<h1 id="15、通过JNI访问Java属性"><a href="#15、通过JNI访问Java属性" class="headerlink" title="15、通过JNI访问Java属性"></a>15、通过JNI访问Java属性</h1><h2 id="a、获取静态字段"><a href="#a、获取静态字段" class="headerlink" title="a、获取静态字段"></a>a、获取静态字段</h2><p>1、先调用获取静态字段ID的方法：GetStaticFieldID</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp">jfieldID privateStaticStringField <span class="token operator">=</span>
           env<span class="token operator">-></span><span class="token function">GetStaticFieldID</span><span class="token punctuation">(</span>clazz<span class="token punctuation">,</span> <span class="token string">"privateStaticStringField"</span><span class="token punctuation">,</span> <span class="token string">"Ljava/lang/String;"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>2、根据字段属性选择对应的Get方法</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">//    env->GetStaticBooleanField();</span>
<span class="token comment">//    env->GetStaticIntField();</span>
<span class="token comment">//    env->GetStaticShortField();</span>
<span class="token comment">//    env->GetStaticByteField();</span>
<span class="token comment">//    env->GetStaticCharField();</span>
<span class="token comment">//    env->GetStaticFloatField();</span>
<span class="token comment">//    env->GetStaticDoubleField();</span>
<span class="token comment">//    env->GetStaticLongField();</span>
<span class="token comment">//    env->GetStaticObjectField();</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>我们的privateStaticStringField是String类型，其实也就是Object，所以选择env-&gt;GetStaticObjectField()</p>
<p>3、获取jstring的静态字段privateStaticString</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp">jstring privateStaticString <span class="token operator">=</span>
        <span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span>jstring<span class="token operator">></span></span></span><span class="token punctuation">(</span>env<span class="token operator">-></span><span class="token function">GetStaticObjectField</span><span class="token punctuation">(</span>clazz<span class="token punctuation">,</span> privateStaticStringField<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>这里把jobject强转jstring类型</p>
<p>4、由于我们在so层，所以要转化成C语言类型</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> privatecstr <span class="token operator">=</span>
         env<span class="token operator">-></span><span class="token function">GetStringUTFChars</span><span class="token punctuation">(</span>privateStaticString<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>5、打印</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token function">LOGD</span><span class="token punctuation">(</span><span class="token string">"privateStaticString: %s"</span><span class="token punctuation">,</span> privatecstr<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>6、释放</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp">env<span class="token operator">-></span><span class="token function">ReleaseStringUTFChars</span><span class="token punctuation">(</span>privateStaticString<span class="token punctuation">,</span> privatecstr<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/202305080220701.png"></p>
<h2 id="b、获取对象字段"><a href="#b、获取对象字段" class="headerlink" title="b、获取对象字段"></a>b、获取对象字段</h2><p>1、先获取FieldId</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp">jfieldID publicStringField <span class="token operator">=</span>
           env<span class="token operator">-></span><span class="token function">GetFieldID</span><span class="token punctuation">(</span>clazz<span class="token punctuation">,</span> <span class="token string">"publicStringField"</span><span class="token punctuation">,</span> <span class="token string">"Ljava/lang/String;"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>2、获取jstring</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp">jclass clazz <span class="token operator">=</span> env<span class="token operator">-></span><span class="token function">FindClass</span><span class="token punctuation">(</span><span class="token string">"com/example/javaandso/NDKDemo"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
jmethodID methodID <span class="token operator">=</span> env<span class="token operator">-></span><span class="token function">GetMethodID</span><span class="token punctuation">(</span>clazz<span class="token punctuation">,</span> <span class="token string">"&lt;init>"</span><span class="token punctuation">,</span> <span class="token string">"()V"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
jobject ReflectDemoObj <span class="token operator">=</span> env<span class="token operator">-></span><span class="token function">NewObject</span><span class="token punctuation">(</span>clazz<span class="token punctuation">,</span> methodID<span class="token punctuation">)</span><span class="token punctuation">;</span>  

jstring publicString <span class="token operator">=</span>
            <span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span>jstring<span class="token operator">></span></span></span><span class="token punctuation">(</span>env<span class="token operator">-></span><span class="token function">GetObjectField</span><span class="token punctuation">(</span>ReflectDemoObj<span class="token punctuation">,</span> publicStringField<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>由于我们是获取对象字段，所以一定要有个对象，因此GetObjectField的第一个参数是对象</p>
<p>3、转化成c语言字符串</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> publiccstr <span class="token operator">=</span>
            env<span class="token operator">-></span><span class="token function">GetStringUTFChars</span><span class="token punctuation">(</span>publicString<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>4、打印输出</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token function">LOGD</span><span class="token punctuation">(</span><span class="token string">"publicStringField: %s"</span><span class="token punctuation">,</span> publiccstr<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>5、对字符串进行释放</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp">env<span class="token operator">-></span><span class="token function">ReleaseStringUTFChars</span><span class="token punctuation">(</span>publicString<span class="token punctuation">,</span> publiccstr<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/202305080234619.png"></p>
<h2 id="c、设置对象字段"><a href="#c、设置对象字段" class="headerlink" title="c、设置对象字段"></a>c、设置对象字段</h2><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp">env<span class="token operator">-></span><span class="token function">SetObjectField</span><span class="token punctuation">(</span>ReflectDemoObj<span class="token punctuation">,</span> privateStringFieldID<span class="token punctuation">,</span> env<span class="token operator">-></span><span class="token function">NewStringUTF</span><span class="token punctuation">(</span><span class="token string">"whitebird"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>通过SetObjectField就行了，第一个参数是对象，第二个参数是字段ID，第三个参数是要修改的值</p>
<p>进行修改前后对比</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp">jfieldID privateStringFieldID <span class="token operator">=</span>
          env<span class="token operator">-></span><span class="token function">GetFieldID</span><span class="token punctuation">(</span>clazz<span class="token punctuation">,</span> <span class="token string">"privateStringField"</span><span class="token punctuation">,</span> <span class="token string">"Ljava/lang/String;"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  

jstring privateString <span class="token operator">=</span>
        <span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span>jstring<span class="token operator">></span></span></span><span class="token punctuation">(</span>env<span class="token operator">-></span><span class="token function">GetObjectField</span><span class="token punctuation">(</span>ReflectDemoObj<span class="token punctuation">,</span> privateStringFieldID<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> privateCstr <span class="token operator">=</span>
        env<span class="token operator">-></span><span class="token function">GetStringUTFChars</span><span class="token punctuation">(</span>privateString<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">LOGD</span><span class="token punctuation">(</span><span class="token string">"privateStringField old: %s"</span><span class="token punctuation">,</span> privateCstr<span class="token punctuation">)</span><span class="token punctuation">;</span>
env<span class="token operator">-></span><span class="token function">ReleaseStringUTFChars</span><span class="token punctuation">(</span>privateString<span class="token punctuation">,</span> privateCstr<span class="token punctuation">)</span><span class="token punctuation">;</span>

env<span class="token operator">-></span><span class="token function">SetObjectField</span><span class="token punctuation">(</span>ReflectDemoObj<span class="token punctuation">,</span> privateStringFieldID<span class="token punctuation">,</span> env<span class="token operator">-></span><span class="token function">NewStringUTF</span><span class="token punctuation">(</span><span class="token string">"whitebird"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

privateString <span class="token operator">=</span> <span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span>jstring<span class="token operator">></span></span></span><span class="token punctuation">(</span>env<span class="token operator">-></span><span class="token function">GetObjectField</span><span class="token punctuation">(</span>ReflectDemoObj<span class="token punctuation">,</span> privateStringFieldID<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
privateCstr <span class="token operator">=</span> env<span class="token operator">-></span><span class="token function">GetStringUTFChars</span><span class="token punctuation">(</span>privateString<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">LOGD</span><span class="token punctuation">(</span><span class="token string">"privateStringField new: %s"</span><span class="token punctuation">,</span> privateCstr<span class="token punctuation">)</span><span class="token punctuation">;</span>
env<span class="token operator">-></span><span class="token function">ReleaseStringUTFChars</span><span class="token punctuation">(</span>privateString<span class="token punctuation">,</span> privateCstr<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/202305080238115.png"></p>
<p>同时我们也能知道不管是public还是private我们都能获取</p>
<h1 id="16、通过JNI访问和修改Java数组"><a href="#16、通过JNI访问和修改Java数组" class="headerlink" title="16、通过JNI访问和修改Java数组"></a>16、通过JNI访问和修改Java数组</h1><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"> <span class="token comment">//获取Java对象的class和byte数组的字段ID。  </span>
	jfieldID byteArrayID <span class="token operator">=</span> env<span class="token operator">-></span><span class="token function">GetFieldID</span><span class="token punctuation">(</span>clazz<span class="token punctuation">,</span> <span class="token string">"byteArray"</span><span class="token punctuation">,</span> <span class="token string">"[B"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//通过GetObjectField获取byte数组对象，并且通过GetArrayLength获取byte数组的长度。</span>
   jbyteArray byteArray <span class="token operator">=</span> <span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span>jbyteArray<span class="token operator">></span></span></span><span class="token punctuation">(</span>env<span class="token operator">-></span><span class="token function">GetObjectField</span><span class="token punctuation">(</span>ReflectDemoObj<span class="token punctuation">,</span> byteArrayID<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">int</span> _byteArrayLength <span class="token operator">=</span> env<span class="token operator">-></span><span class="token function">GetArrayLength</span><span class="token punctuation">(</span>byteArray<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//在C++中创建一个char类型的数组cByteArray，并且为其赋值。</span>
   <span class="token keyword">char</span> cByteArray<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
   <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
       cByteArray<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">char</span><span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token number">100</span> <span class="token operator">-</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">&#125;</span>
<span class="token comment">//将cByteArray中的元素转换成jbyte类型的数组。</span>
   <span class="token keyword">const</span> jbyte <span class="token operator">*</span>java_array <span class="token operator">=</span> <span class="token generic-function"><span class="token function">reinterpret_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">const</span> jbyte <span class="token operator">*</span><span class="token operator">></span></span></span><span class="token punctuation">(</span>cByteArray<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//使用SetByteArrayRegion函数将java数组元素设置为cByteArray中的元素。</span>
   env<span class="token operator">-></span><span class="token function">SetByteArrayRegion</span><span class="token punctuation">(</span>byteArray<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> _byteArrayLength<span class="token punctuation">,</span> java_array<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//再次获取Java对象的byte数组，并且获取byte数组的元素。</span>
   byteArray <span class="token operator">=</span> <span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span>jbyteArray<span class="token operator">></span></span></span><span class="token punctuation">(</span>env<span class="token operator">-></span><span class="token function">GetObjectField</span><span class="token punctuation">(</span>ReflectDemoObj<span class="token punctuation">,</span> byteArrayID<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   _byteArrayLength <span class="token operator">=</span> env<span class="token operator">-></span><span class="token function">GetArrayLength</span><span class="token punctuation">(</span>byteArray<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//使用GetByteArrayElements函数将byte数组的元素转换到C++中的char数组CBytes中。</span>
   <span class="token keyword">char</span><span class="token operator">*</span> CBytes <span class="token operator">=</span> <span class="token generic-function"><span class="token function">reinterpret_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">></span></span></span><span class="token punctuation">(</span>env<span class="token operator">-></span><span class="token function">GetByteArrayElements</span><span class="token punctuation">(</span>byteArray<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//遍历CBytes数组元素，输出数组内容。</span>
   <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> _byteArrayLength<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
       <span class="token function">LOGD</span><span class="token punctuation">(</span><span class="token string">"CArray: %d"</span><span class="token punctuation">,</span> CBytes<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">&#125;</span>
<span class="token comment">//释放CBytes数组元素，将其转移回byte数组中。</span>
   env<span class="token operator">-></span><span class="token function">ReleaseByteArrayElements</span><span class="token punctuation">(</span>byteArray<span class="token punctuation">,</span> <span class="token punctuation">(</span>jbyte<span class="token operator">*</span><span class="token punctuation">)</span>CBytes<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/202305081653550.png"></p>
<h1 id="17、通过jni访问Java方法"><a href="#17、通过jni访问Java方法" class="headerlink" title="17、通过jni访问Java方法"></a>17、通过jni访问Java方法</h1><h2 id="1、调用静态函数"><a href="#1、调用静态函数" class="headerlink" title="1、调用静态函数"></a>1、调用静态函数</h2><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">//    env->CallBooleanMethod();</span>
<span class="token comment">//    env->CallVoidMethod();</span>
<span class="token comment">//    env->CallByteMethod();</span>
<span class="token comment">//    env->CallShortMethod();</span>
<span class="token comment">//    env->CallIntMethod();</span>
<span class="token comment">//    env->CallCharMethod();</span>
<span class="token comment">//    env->CallDoubleMethod();</span>
<span class="token comment">//    env->CallLongMethod();</span>
<span class="token comment">//    env->CallFloatMethod();</span>
<span class="token comment">//    env->CallObjectMethod();</span>
    jmethodID publicStaticFuncID <span class="token operator">=</span>
            env<span class="token operator">-></span><span class="token function">GetStaticMethodID</span><span class="token punctuation">(</span>clazz<span class="token punctuation">,</span> <span class="token string">"publicStaticFunc"</span><span class="token punctuation">,</span> <span class="token string">"()V"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    env<span class="token operator">-></span><span class="token function">CallStaticVoidMethod</span><span class="token punctuation">(</span>clazz<span class="token punctuation">,</span> publicStaticFuncID<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>静态方法很简单，只要调用CallStaticVoidMethod就行了</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/202305081728526.png"></p>
<h2 id="2、调用对象函数"><a href="#2、调用对象函数" class="headerlink" title="2、调用对象函数"></a>2、调用对象函数</h2><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp">jmethodID privateFuncID <span class="token operator">=</span>
          env<span class="token operator">-></span><span class="token function">GetMethodID</span><span class="token punctuation">(</span>clazz<span class="token punctuation">,</span><span class="token string">"privateFunc"</span><span class="token punctuation">,</span><span class="token string">"(Ljava/lang/String;I)Ljava/lang/String;"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  jstring str1 <span class="token operator">=</span> env<span class="token operator">-></span><span class="token function">NewStringUTF</span><span class="token punctuation">(</span><span class="token string">"this is from JNI"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  jstring retval_jstring <span class="token operator">=</span> <span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span>jstring<span class="token operator">></span></span></span><span class="token punctuation">(</span>env<span class="token operator">-></span><span class="token function">CallObjectMethod</span><span class="token punctuation">(</span>ReflectDemoObj<span class="token punctuation">,</span> privateFuncID<span class="token punctuation">,</span> str1<span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> retval_cstr <span class="token operator">=</span> env<span class="token operator">-></span><span class="token function">GetStringUTFChars</span><span class="token punctuation">(</span>retval_jstring<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">LOGD</span><span class="token punctuation">(</span><span class="token string">"privateStaticString: %s"</span><span class="token punctuation">,</span> retval_cstr<span class="token punctuation">)</span><span class="token punctuation">;</span>
  env<span class="token operator">-></span><span class="token function">ReleaseStringUTFChars</span><span class="token punctuation">(</span>retval_jstring<span class="token punctuation">,</span> retval_cstr<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>通过CallObjectMethod调用对象函数，需要先创建一个对象</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/202305081732151.png"></p>
<h1 id="18、CallVoidMethod、A、V版本区别"><a href="#18、CallVoidMethod、A、V版本区别" class="headerlink" title="18、CallVoidMethod、A、V版本区别"></a>18、CallVoidMethod、A、V版本区别</h1><p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/202305081748966.png"></p>
<p>可以看到CallVoidMethod底层调用的是CallVoidMethodV，他们两个的区别在于CallVoidMethod会帮我们封装参数，而CallVoidMethodV需要我们自己封装参数，可以看成它只能有一个参数。而对于CallVoidMethodA，它的参数是jvalue*</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/202305081751840.png"></p>
<p>jvalue是一个联合体</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp">jmethodID privateFuncID <span class="token operator">=</span>
        env<span class="token operator">-></span><span class="token function">GetMethodID</span><span class="token punctuation">(</span>clazz<span class="token punctuation">,</span><span class="token string">"privateFunc"</span><span class="token punctuation">,</span><span class="token string">"(Ljava/lang/String;I)Ljava/lang/String;"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
jstring str2 <span class="token operator">=</span> env<span class="token operator">-></span><span class="token function">NewStringUTF</span><span class="token punctuation">(</span><span class="token string">"this is from JNI2"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
jvalue args<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>l <span class="token operator">=</span> str2<span class="token punctuation">;</span>
args<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>i <span class="token operator">=</span> <span class="token number">1000</span><span class="token punctuation">;</span>
jstring retval <span class="token operator">=</span> <span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span>jstring<span class="token operator">></span></span></span><span class="token punctuation">(</span>env<span class="token operator">-></span><span class="token function">CallObjectMethodA</span><span class="token punctuation">(</span>ReflectDemoObj<span class="token punctuation">,</span> privateFuncID<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> cpp_retval <span class="token operator">=</span> env<span class="token operator">-></span><span class="token function">GetStringUTFChars</span><span class="token punctuation">(</span>retval<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">LOGD</span><span class="token punctuation">(</span><span class="token string">"cpp_retval: %s"</span><span class="token punctuation">,</span> cpp_retval<span class="token punctuation">)</span><span class="token punctuation">;</span>
env<span class="token operator">-></span><span class="token function">ReleaseStringUTFChars</span><span class="token punctuation">(</span>retval<span class="token punctuation">,</span> cpp_retval<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>通过jvalue里面放参数，然后进行调用</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/202305081755051.png"></p>
<h1 id="19、通过jni访问Java父类方法"><a href="#19、通过jni访问Java父类方法" class="headerlink" title="19、通过jni访问Java父类方法"></a>19、通过jni访问Java父类方法</h1><p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/202305090101972.png"></p>
<p>这里的onCreate就是调用父类方法，所以我们现在尝试把onCreate Native化</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/202305090103534.png"></p>
<p>直接快捷操作生成JNI函数</p>
<p>我们需要用到这个JNI函数帮我们调用父类方法</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/202305090104860.png"></p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">extern</span> <span class="token string">"C"</span>
JNIEXPORT <span class="token keyword">void</span> JNICALL
<span class="token function">Java_com_example_javaandso_MainActivity_onCreate</span><span class="token punctuation">(</span>JNIEnv <span class="token operator">*</span>env<span class="token punctuation">,</span> jobject thiz<span class="token punctuation">,</span>
                                                 jobject saved_instance_state<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// TODO: implement onCreate()</span>
    jclass ComponentActivityzz<span class="token operator">=</span>env<span class="token operator">-></span><span class="token function">FindClass</span><span class="token punctuation">(</span><span class="token string">"androidx/activity/ComponentActivity"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    jmethodID onCreateMethodId<span class="token operator">=</span> env<span class="token operator">-></span><span class="token function">GetMethodID</span><span class="token punctuation">(</span>ComponentActivityzz<span class="token punctuation">,</span><span class="token string">"onCreate"</span><span class="token punctuation">,</span> <span class="token string">"(Landroid/os/Bundle;)V"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    env<span class="token operator">-></span><span class="token function">CallNonvirtualVoidMethod</span><span class="token punctuation">(</span>thiz<span class="token punctuation">,</span>ComponentActivityzz<span class="token punctuation">,</span>onCreateMethodId<span class="token punctuation">,</span>saved_instance_state<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/202305090112240.png"></p>
<p>可以正常运行</p>
<h1 id="20、内存管理"><a href="#20、内存管理" class="headerlink" title="20、内存管理"></a>20、内存管理</h1><h2 id="1、局部引用"><a href="#1、局部引用" class="headerlink" title="1、局部引用"></a>1、局部引用</h2><p>1、大多数的jni函数，调用以后返回的结果都是局部引用，因此，env-&gt;NewLocalRef 基本不用</p>
<p>2、一个函数内的局部引用数量是有限制的，在早期的安卓系统中，体现的更为明显</p>
<p>3、当函数体内需要大量使用局部引用时，比如大循环中，最好及时删除不用的局部引用，可以使用 env-&gt;DeleteLocalRef 来删除局部引用</p>
<p>4、局部引用和局部变量不同</p>
<h2 id="2、局部引用相关的其他函数"><a href="#2、局部引用相关的其他函数" class="headerlink" title="2、局部引用相关的其他函数"></a>2、局部引用相关的其他函数</h2><p>env-&gt;EnsureLocalCapacity(num) 判断是否有足够的局部引用可以使用，足够则返回0，需大量使用局部引用时，手动删除太过麻烦，可使用以下两个函数来批量管理局部引用</p>
<p>env-&gt;PushLocalFrame(num)</p>
<p>env-&gt;PopLocalFrame(nullptr)</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp">env<span class="token operator">-></span><span class="token function">PushLocalFrame</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span><span class="token punctuation">(</span>env<span class="token operator">-></span><span class="token function">EnsureLocalCapacity</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">3</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        jstring tempString <span class="token operator">=</span> env<span class="token operator">-></span><span class="token function">NewStringUTF</span><span class="token punctuation">(</span><span class="token string">"whitebird"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        env<span class="token operator">-></span><span class="token function">SetObjectArrayElement</span><span class="token punctuation">(</span>_jstringArray<span class="token punctuation">,</span> i<span class="token punctuation">,</span> tempString<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//env->DeleteLocalRef(tempString);</span>
        <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">LOGD</span><span class="token punctuation">(</span><span class="token string">"env->EnsureLocalCapacity"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
env<span class="token operator">-></span><span class="token function">PopLocalFrame</span><span class="token punctuation">(</span><span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="3、全局引用"><a href="#3、全局引用" class="headerlink" title="3、全局引用"></a>3、全局引用</h2><p>在jni开发中，需要跨函数使用变量时，直接定义全局变量是没用的，需要使用以下两个方法，来创建和删除全局引用</p>
<p>env-&gt;NewGlobalRef</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp">jobject tempClassLoaderObj <span class="token operator">=</span> env<span class="token operator">-></span><span class="token function">CallObjectMethod</span><span class="token punctuation">(</span>MainActivityClazz<span class="token punctuation">,</span> getClassLoaderID<span class="token punctuation">)</span><span class="token punctuation">;</span>
ClassLoaderObj <span class="token operator">=</span> env<span class="token operator">-></span><span class="token function">NewGlobalRef</span><span class="token punctuation">(</span>tempClassLoaderObj<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>env-&gt;DeleteGlobalRef</p>
<h2 id="4、弱全局引用"><a href="#4、弱全局引用" class="headerlink" title="4、弱全局引用"></a>4、弱全局引用</h2><p>与全局引用基本相同，区别是弱全局引用有可能会被回收</p>
<p>env-&gt;NewWeakGlobalRef</p>
<p>env-&gt;DeleteWeakGlobalRef</p>
<h1 id="21、子线程中获取Java类"><a href="#21、子线程中获取Java类" class="headerlink" title="21、子线程中获取Java类"></a>21、子线程中获取Java类</h1><ol>
<li>在子线程中，findClass可以直接获取系统类</li>
</ol>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp">jclass ClassLoaderClazz <span class="token operator">=</span> env<span class="token operator">-></span><span class="token function">FindClass</span><span class="token punctuation">(</span><span class="token string">"java/lang/ClassLoader"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">LOGD</span><span class="token punctuation">(</span><span class="token string">"myThread ClassLoaderClazz: %p"</span><span class="token punctuation">,</span> ClassLoaderClazz<span class="token punctuation">)</span><span class="token punctuation">;</span>
jclass StringClasszz<span class="token operator">=</span>env<span class="token operator">-></span><span class="token function">FindClass</span><span class="token punctuation">(</span><span class="token string">"java/lang/String"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">LOGD</span><span class="token punctuation">(</span><span class="token string">"myThread StringClasszz: %p"</span><span class="token punctuation">,</span> StringClasszz<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/202305090219890.png"></p>
<p>可以看到系统类是有值的，但是自己的类就没有值</p>
<ol start="2">
<li>在主线程中获取类，使用全局引用来传递到子线程中</li>
</ol>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp">  jclass MainActivityClazz <span class="token operator">=</span> env<span class="token operator">-></span><span class="token function">FindClass</span><span class="token punctuation">(</span><span class="token string">"com/example/javaandso/MainActivity"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    globalClass<span class="token operator">=</span> <span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span>jclass<span class="token operator">></span></span></span><span class="token punctuation">(</span>env<span class="token operator">-></span><span class="token function">NewGlobalRef</span><span class="token punctuation">(</span>MainActivityClazz<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

子线程中调用
  <span class="token function">LOGD</span><span class="token punctuation">(</span><span class="token string">"myThread globalClass: %p"</span><span class="token punctuation">,</span> globalClass<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/202305090231813.png"></p>
<p>3、在主线程中获取正确的ClassLoader，在子线程中去加载类</p>
<p>在Java中，可以先获取类字节码，然后使用getClassLoader()来获取ClassLoader</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">Demo</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">new</span> <span class="token class-name">Demo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token class-name">Class</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>在native层进行转换,获取ClassLoader</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">//MainActivity.class.getClassLoader</span>
  jclass MainActivityClazz <span class="token operator">=</span> env<span class="token operator">-></span><span class="token function">FindClass</span><span class="token punctuation">(</span><span class="token string">"com/example/javaandso/MainActivity"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  jclass classClasszz<span class="token operator">=</span>env<span class="token operator">-></span><span class="token function">FindClass</span><span class="token punctuation">(</span><span class="token string">"java/lang/Class"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  jmethodID getClassLoaderMethoid<span class="token operator">=</span>env<span class="token operator">-></span><span class="token function">GetMethodID</span><span class="token punctuation">(</span>classClasszz<span class="token punctuation">,</span><span class="token string">"getClassLoader"</span><span class="token punctuation">,</span> <span class="token string">"()Ljava/lang/ClassLoader;"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  jobject tempClassLoader <span class="token operator">=</span> env<span class="token operator">-></span><span class="token function">CallObjectMethod</span><span class="token punctuation">(</span>MainActivityClazz<span class="token punctuation">,</span>getClassLoaderMethoid<span class="token punctuation">)</span><span class="token punctuation">;</span>
  globalClassLoader<span class="token operator">=</span>env<span class="token operator">-></span><span class="token function">NewGlobalRef</span><span class="token punctuation">(</span>tempClassLoader<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>在jni的子线程中loadClass</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">//jclass MainActivityClasszz=FindClass("com/example/javaandso/MainActivity")</span>
jclass LoadClassClazz<span class="token operator">=</span>env<span class="token operator">-></span><span class="token function">FindClass</span><span class="token punctuation">(</span><span class="token string">"java/lang/ClassLoader"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
jmethodID LoadClassmMethoid<span class="token operator">=</span>env<span class="token operator">-></span><span class="token function">GetMethodID</span><span class="token punctuation">(</span>LoadClassClazz<span class="token punctuation">,</span><span class="token string">"loadClass"</span><span class="token punctuation">,</span> <span class="token string">"(Ljava/lang/String;)Ljava/lang/Class;"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
jclass MainActivityClasszz<span class="token operator">=</span> <span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span>jclass<span class="token operator">></span></span></span><span class="token punctuation">(</span>env<span class="token operator">-></span><span class="token function">CallObjectMethod</span><span class="token punctuation">(</span>globalClassLoader<span class="token punctuation">,</span>
                                                                              LoadClassmMethoid<span class="token punctuation">,</span>
                                                                              env<span class="token operator">-></span><span class="token function">NewStringUTF</span><span class="token punctuation">(</span>
                                                                                      <span class="token string">"com.example.javaandso.MainActivity"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>我们要得到的MainActivityClasszz其实在主线程已经获取过一次了，所以第三种方法其实有点麻烦，不如第二种使用全局引用</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/202305091159773.png"></p>
<h1 id="22、init与initarray"><a href="#22、init与initarray" class="headerlink" title="22、init与initarray"></a>22、init与initarray</h1><p>1、so在执行JNI_Onload之前，还会执行两个构造函数init、initarray</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/202305091301176.png"></p>
<p>2、so加固、so中字符串加密等等，一般会把相关代码放到这里，所以JNI_Onload的时候一般so都是已经被解密了</p>
<p>3、init的使用</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">extern</span> <span class="token string">"C"</span> <span class="token keyword">void</span> <span class="token function">_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span> <span class="token comment">//函数名必须为_init</span>

    <span class="token function">LOGD</span><span class="token punctuation">(</span><span class="token string">"_init "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>4、initarray的使用</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/202305091308932.png"></p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token function">__attribute__</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>constructor<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">void</span> <span class="token function">initArrayTest3</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token function">LOGD</span><span class="token punctuation">(</span><span class="token string">"initArrayTest3"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token function">__attribute__</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>constructor<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">void</span> <span class="token function">initArrayTest1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token function">LOGD</span><span class="token punctuation">(</span><span class="token string">"initArrayTest1 "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token function">__attribute__</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>constructor<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">void</span> <span class="token function">initArrayTest2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token function">LOGD</span><span class="token punctuation">(</span><span class="token string">"initArrayTest2 "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>如果不加任何修饰，会安装我们代码写的顺序执行</p>
<p>constructor后面的值，较小的先执行，最好从100以后开始用</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token function">__attribute__</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">constructor</span><span class="token punctuation">(</span><span class="token number">101</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">void</span> <span class="token function">initArrayTest3</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token function">LOGD</span><span class="token punctuation">(</span><span class="token string">"initArrayTest3"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token function">__attribute__</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">constructor</span><span class="token punctuation">(</span><span class="token number">303</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">void</span> <span class="token function">initArrayTest1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token function">LOGD</span><span class="token punctuation">(</span><span class="token string">"initArrayTest1 "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token function">__attribute__</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">constructor</span><span class="token punctuation">(</span><span class="token number">202</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">void</span> <span class="token function">initArrayTest2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token function">LOGD</span><span class="token punctuation">(</span><span class="token string">"initArrayTest2 "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/202305091311994.png"></p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token function">__attribute__</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">constructor</span><span class="token punctuation">(</span><span class="token number">101</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">void</span> <span class="token function">initArrayTest3</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token function">LOGD</span><span class="token punctuation">(</span><span class="token string">"initArrayTest3"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token function">__attribute__</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>constructor<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">void</span> <span class="token function">initArrayTest5</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token function">LOGD</span><span class="token punctuation">(</span><span class="token string">"initArrayTest5"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token function">__attribute__</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">constructor</span><span class="token punctuation">(</span><span class="token number">303</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">void</span> <span class="token function">initArrayTest1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token function">LOGD</span><span class="token punctuation">(</span><span class="token string">"initArrayTest1 "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token function">__attribute__</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>constructor<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">void</span> <span class="token function">initArrayTest2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token function">LOGD</span><span class="token punctuation">(</span><span class="token string">"initArrayTest2 "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token function">__attribute__</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">constructor</span><span class="token punctuation">(</span><span class="token number">202</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">void</span> <span class="token function">initArrayTest4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token function">LOGD</span><span class="token punctuation">(</span><span class="token string">"initArrayTest4"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>对于这种有值和没值都有的，先执行有值的顺序，然后再按没值的顺序</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/202305091315020.png"></p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token function">__attribute__</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>constructor<span class="token punctuation">,</span> <span class="token function">visibility</span><span class="token punctuation">(</span><span class="token string">"hidden"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">void</span> <span class="token function">initArrayTest6</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token function">LOGD</span><span class="token punctuation">(</span><span class="token string">"initArrayTest6"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>反编译so时会抹去initArrayTest6符号</p>
<h2 id="反编译so"><a href="#反编译so" class="headerlink" title="反编译so"></a><strong>反编译so</strong></h2><p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/202305091318139.png"></p>
<p>_init在ida反编译后为.init_proc</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/202305091319690.png"></p>
<p>通过段表，可以看到init_array段，跟过去看看</p>
<p><img src="https://raw.githubusercontent.com/Whitebird0/tuchuang/main/202305091320637.png"></p>
<p>存放顺序已经排好序了，而且initArrayTest6符号已经没了，变成了sub_1F824</p>

      
       <hr><span style="font-style: italic;color: gray;"> 转载请注明来源，欢迎对文章中的引用来源进行考证，欢迎指出任何有错误或不够清晰的表达。可以在下面评论区评论，也可以邮件至 767778848@qq.com </span>
    </div>
</article>





    <div id="comments"></div>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css">

<script type="text/javascript">
    $.getScript('/js/gitalk.js', function () {
        var gitalk = new Gitalk({
            clientID: '6c49373fe3729f3c2b02',
            clientSecret: '4b38338216282f43430b6118f27ae24e4732ecec',
            repo: 'Whitebird0.github.io',
            owner: 'Whitebird0',
            admin: ['Whitebird0'],
            id: decodeURI(location.pathname),
            distractionFreeMode: 'true',
            language: 'zh-CN',
            perPage: parseInt('10',10)
        })
        gitalk.render('comments')
    })
</script>




    




    </div>
    <div class="copyright">
        <p class="footer-entry">
    ©2020-2022 Whitebird
</p>
<p class="footer-entry">Built with <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/yelog/hexo-theme-3-hexo" target="_blank">3-hexo</a> theme</p>

    </div>
    <div class="full-toc">
        <button class="full" data-title="切换全屏 快捷键 s"><span class="min "></span></button>
<a class="" id="rocket" ></a>

    </div>
</div>

</body>
<script src="/js/jquery.pjax.js?v=1.1.0" ></script>

<script src="/js/script.js?v=1.1.0" ></script>
<script>
    var img_resize = 'default';
    function initArticle() {
        /*渲染对应的表格样式*/
        
            $("#post .pjax table").addClass("green_title");
        

        /*渲染打赏样式*/
        

        /*高亮代码块行号*/
        

        /*访问数量*/
        
        $.getScript("//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js");
        

        /*代码高亮，行号对齐*/
        $('.pre-numbering').css('line-height',$('.has-numbering').css('line-height'));

        
        
    }

    /*打赏页面隐藏与展示*/
    

</script>

<!--加入行号的高亮代码块样式-->

<!--自定义样式设置-->
<style>
    
    
    .nav {
        width: 542px;
    }
    .nav.fullscreen {
        margin-left: -542px;
    }
    .nav-left {
        width: 120px;
    }
    
    
    @media screen and (max-width: 1468px) {
        .nav {
            width: 492px;
        }
        .nav.fullscreen {
            margin-left: -492px;
        }
        .nav-left {
            width: 100px;
        }
    }
    
    
    @media screen and (max-width: 1024px) {
        .nav {
            width: 492px;
            margin-left: -492px
        }
        .nav.fullscreen {
            margin-left: 0;
        }
    }
    
    @media screen and (max-width: 426px) {
        .nav {
            width: 100%;
        }
        .nav-left {
            width: 100%;
        }
    }
    
    
    .nav-right .title-list nav a .post-title, .nav-right .title-list #local-search-result a .post-title {
        color: #383636;
    }
    
    
    .nav-right .title-list nav a .post-date, .nav-right .title-list #local-search-result a .post-date {
        color: #5e5e5f;
    }
    
    
    .nav-right nav a.hover, #local-search-result a.hover{
        background-color: #e2e0e0;
    }
    
    

    /*列表样式*/
    

    /* 背景图样式 */
    
    


    /*引用块样式*/
    

    /*文章列表背景图*/
    

    
</style>







</html>
